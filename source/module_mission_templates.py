from source.mission_template_triggers import *
#from header_animations import *
#from header_sounds import *
from header_music import *
from header_mission_types import charge
#from header_items import *
#from module_constants import *

from header_items import *
import game_start
from game_start import quest_merchant
import multiplayer
####################################################################################################################
#   Each mission-template is a tuple that contains the following fields:
#  1) Mission-template id (string): used for referencing mission-templates in other files.
#     The prefix mt_ is automatically added before each mission-template id
#
#  2) Mission-template flags (int): See header_mission-templates.py for a list of available flags
#  3) Mission-type(int): Which mission types this mission template matches.
#     For mission-types to be used with the default party-meeting system,
#     this should be 'charge' or 'charge_with_ally' otherwise must be -1.
#     
#  4) Mission description text (string).
#  5) List of spawn records (list): Each spawn record is a tuple that contains the following fields:
#    5.1) entry-no: Troops spawned from this spawn record will use this entry
#    5.2) spawn flags.
#    5.3) alter flags. which equipment will be overriden
#    5.4) ai flags.
#    5.5) Number of troops to spawn.
#    5.6) list of equipment to add to troops spawned from here (maximum 8).
#  6) List of triggers (list).
#     See module_triggers.py for infomation about triggers.
#
#  Please note that mission templates is work in progress and can be changed in the future versions.
# 
####################################################################################################################

pilgrim_disguise = ["itm_pilgrim_hood","itm_pilgrim_disguise","itm_quarter_staff"]
af_castle_lord = af_override_horse | af_override_weapons| af_require_civilian
prisoner_gear = ["itm_gaelic_jacketgrn","itm_club_stick","itm_clubcudgel","itm_clubsmooth","itm_staff1","itm_mineral"]
# battle_mode_triggers = [common_ai_order_toggle,AI_triggers,heridas_chel,common_weapon_check,dplmc_battle_mode_triggers,formations_triggers,order_volley_triggers,rider_damage, warcry_chel, flail_triggers,
# #AI_triggers + heridas_chel + dplmc_battle_mode_triggers + formations_triggers + order_volley_triggers + rider_damage + warcry_chel + flail_triggers + common_wpn_swapping,

# ]
mission_templates = [
  (
    "town_default",0,-1,
    "Default town visit",
    [(0,mtef_scene_source|mtef_team_0,af_override_horse,0,1,pilgrim_disguise),
     (1,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (2,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (3,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (4,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (5,mtef_scene_source,af_override_horse,0,1,[]), #chief cambia para que quastuosa huya cuando hay problemas con borracho
     (6,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (7,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (8,mtef_scene_source,af_override_horse,0,1,[]),
     (9,mtef_scene_source,af_override_horse,0,1,[]),
     (10,mtef_scene_source,af_override_horse,0,1,[]),
     (11,mtef_scene_source,af_override_horse,0,1,[]),
     (12,mtef_scene_source,af_override_horse,0,1,[]),
     (13,mtef_scene_source,0,0,1,[]),
     (14,mtef_scene_source,0,0,1,[]),
     (15,mtef_scene_source,0,0,1,[]),
     (16,mtef_visitor_source,af_override_horse,0,1,[]),
     (17,mtef_visitor_source,af_override_horse,0,1,[]),
     (18,mtef_visitor_source,af_override_horse,0,1,[]),
     (19,mtef_visitor_source,af_override_horse,0,1,[]),
     (20,mtef_visitor_source,af_override_horse,0,1,[]),
     (21,mtef_visitor_source,af_override_horse,0,1,[]),
     (22,mtef_visitor_source,af_override_horse,0,1,[]),
     (23,mtef_visitor_source,af_override_horse,0,1,[]),
     (24,mtef_visitor_source,af_override_horse,0,1,[]),
     (25,mtef_visitor_source,af_override_horse,0,1,[]),
     (26,mtef_visitor_source,af_override_horse,0,1,[]),
     (27,mtef_visitor_source,af_override_horse,0,1,[]),
     (28,mtef_visitor_source,af_override_horse,0,1,[]),
     (29,mtef_visitor_source,af_override_horse,0,1,[]),
     (30,mtef_visitor_source,af_override_horse,0,1,[]),
     (31,mtef_visitor_source,af_override_horse,0,1,[]),
     ],     
     [
      (1, 0, ti_once, [], 
      [
        (store_current_scene, ":cur_scene"),
        (scene_set_slot, ":cur_scene", "slot_scene_visited", 1),
        (try_begin),
          (eq, "$sneaked_into_town", 1),
          (call_script, "script_music_set_situation_with_culture", mtf_sit_town_infiltrate),
        (else_try),
          (eq, "$talk_context", tc_tavern_talk),
          (call_script, "script_music_set_situation_with_culture", mtf_sit_tavern),
        (else_try),
          (call_script, "script_music_set_situation_with_culture", mtf_sit_town),
        (try_end),
      ]),
	  		  	        
      (ti_before_mission_start, 0, 0, [], 
      [
        (call_script, "script_change_banners_and_chest"),
        (call_script, "script_initialize_tavern_variables"),
	  ]),

      (ti_inventory_key_pressed, 0, 0, 
      [
        (set_trigger_result,1)
      ], []),
      
      #tavern - belligerent drunk leaving/fading out
      (1, 0, 0, 
      [
        (gt, "$g_belligerent_drunk_leaving", 0),
        (entry_point_get_position, pos0, 0),
        (agent_get_position, pos1, "$g_belligerent_drunk_leaving"),
        (get_distance_between_positions, ":dist", pos0, pos1),
        (le, ":dist", 150),
      ],
      [
        (agent_fade_out, "$g_belligerent_drunk_leaving"),
        (assign, "$g_belligerent_drunk_leaving", 0),
      ]),
      
      (ti_tab_pressed, 0, 0, 
      [
        (try_begin),
          (eq, "$g_main_attacker_agent", 0),
          (set_trigger_result, 1),
        (try_end),  
      ], []),

	  #tavern brawl triggers - drunk
      (2, 0, 0, 
      [
	    (neg|conversation_screen_is_active),

		(eq, "$talk_context", tc_tavern_talk),
		
		(neg|troop_slot_eq, "trp_hired_assassin", "slot_troop_cur_center", "$g_encountered_party"),
		(troop_slot_eq, "trp_belligerent_drunk", "slot_troop_cur_center", "$g_encountered_party"),
		(eq, "$drunks_dont_pick_fights", 0),		
	  ], 
	  [	  
	    (try_begin),
	      (eq, "$g_start_belligerent_drunk_fight", 0),
	      (assign, "$g_start_belligerent_drunk_fight", 1),
	      
	      (try_for_agents, ":cur_agent"),
	        (agent_get_troop_id, ":cur_agent_troop", ":cur_agent"),
	        (eq, ":cur_agent_troop", "trp_belligerent_drunk"),
	        (assign, "$g_belligerent_drunk", ":cur_agent"),
	      (try_end),
	    (else_try),
	      (eq, "$g_start_belligerent_drunk_fight", 1),	 
	           
	      (agent_is_active, "$g_belligerent_drunk"),
	      (agent_is_alive, "$g_belligerent_drunk"),
	      (get_player_agent_no, ":player_agent"),
	      (agent_get_position, pos0, ":player_agent"),
	      (agent_get_position, pos1, "$g_belligerent_drunk"),
	      (get_distance_between_positions, ":dist", pos0, pos1),
	      (position_get_z, ":pos0_z", pos0),
	      (position_get_z, ":pos1_z", pos1),
	      (store_sub, ":z_difference", ":pos1_z", ":pos0_z"),
	      (try_begin),
	        (le, ":z_difference", 0),
	        (val_mul, ":z_difference", -1),
	      (try_end),
	      (store_mul, ":z_difference_mul_3", ":z_difference", 3),
	      (val_add, ":dist", ":z_difference_mul_3"),
	      (store_random_in_range, ":random_value", 0, 200),
	      (store_add, ":400_plus_random_200", 400, ":random_value"),
	      (le, ":dist", ":400_plus_random_200"),
	      
 		  (call_script, "script_activate_tavern_attackers"),
  		  (start_mission_conversation, "trp_belligerent_drunk"),
  		  (assign, "$g_start_belligerent_drunk_fight", 2),
	    (try_end),  
	  ]),
	  	  
	  #tavern brawl triggers - assassin
      (2, 0, 0, [
	    (neg|conversation_screen_is_active),
		(eq, "$talk_context", tc_tavern_talk),
		(troop_slot_eq, "trp_hired_assassin", "slot_troop_cur_center", "$g_encountered_party"),
	  ], 
	  [
	    (try_begin),
	      (eq, "$g_start_hired_assassin_fight", 0),
	      (assign, "$g_start_hired_assassin_fight", 1),
	      
	      (try_for_agents, ":cur_agent"),
	        (agent_get_troop_id, ":cur_agent_troop", ":cur_agent"),
	        (eq, ":cur_agent_troop", "trp_hired_assassin"),
	        (assign, "$g_hired_assassin", ":cur_agent"),
	      (try_end),	      
	    (else_try),  
	      (eq, "$g_start_hired_assassin_fight", 1),

	      (agent_is_active, "$g_hired_assassin"),
	      (agent_is_alive, "$g_hired_assassin"),
	      (get_player_agent_no, ":player_agent"),
	      (agent_get_position, pos0, ":player_agent"),
	      (agent_get_position, pos1, "$g_hired_assassin"),
	      (get_distance_between_positions, ":dist", pos0, pos1),
	      (position_get_z, ":pos0_z", pos0),
	      (position_get_z, ":pos1_z", pos1),
	      (store_sub, ":z_difference", ":pos1_z", ":pos0_z"),
	      (try_begin),
	        (le, ":z_difference", 0),
	        (val_mul, ":z_difference", -1),
	      (try_end),
	      (store_mul, ":z_difference_mul_3", ":z_difference", 3),
	      (val_add, ":dist", ":z_difference_mul_3"),
	      (store_random_in_range, ":random_value", 0, 200),
	      (store_add, ":400_plus_random_200", 400, ":random_value"),
	      (le, ":dist", ":400_plus_random_200"),

		  (call_script, "script_activate_tavern_attackers"),
		  (assign, "$g_start_hired_assassin_fight", 2),
		(try_end),  
	  ]),
	  	  
	  #Aftermath talks
      (3, 0, ti_once, 
      [
	    (neg|conversation_screen_is_active),
		(eq, "$talk_context", tc_tavern_talk),
		(gt, "$g_main_attacker_agent", 0),
				
		(this_or_next|neg|agent_is_alive, "$g_main_attacker_agent"),
		(agent_is_wounded, "$g_main_attacker_agent"),
      ],
      [
        (mission_enable_talk),
      
		(try_for_agents, ":agent"),
		  (agent_is_alive, ":agent"),
		  (agent_get_position, pos4, ":agent"),
		  (agent_set_scripted_destination, ":agent", pos4),
		(try_end),
		
		(party_get_slot, ":tavernkeeper", "$g_encountered_party", "slot_town_tavernkeeper"),
		(start_mission_conversation, ":tavernkeeper"),	 
	  ]),

	  
	  #Aftermath talks
      (3, 0, ti_once, 
      [
	    (neg|conversation_screen_is_active),
		(eq, "$talk_context", tc_tavern_talk),
		(gt, "$g_main_attacker_agent", 0),
		(main_hero_fallen),		
      ],
      [
	  (jump_to_menu, "mnu_lost_tavern_duel"),
	  (finish_mission,0)
	  
	  ]),	  
	  
	  
	  #No shooting in the tavern
      (1, 0, 0, 
      [
	    (neg|conversation_screen_is_active),
		(eq, "$talk_context", tc_tavern_talk),
		(gt, "$g_main_attacker_agent", 0),
		
		(get_player_agent_no, ":player_agent"),
		(agent_is_alive, ":player_agent"),
		
		(agent_get_wielded_item, ":wielded_item", ":player_agent", 0),
		(is_between, ":wielded_item", "itm_darts", "itm_torch"),
		(neq, ":wielded_item", "itm_javelins_melee"),
		(neq, ":wielded_item", "itm_throwing_spear_melee"),
		(neq, ":wielded_item", "itm_throwing_spear_melee"),
		(neq, ":wielded_item", "itm_gaebolgajavel"),
		(neq, ":wielded_item", "itm_gaebolgajavel_melee"),
		(neq, ":wielded_item", "itm_light_throwing_axes_melee"),
		(neq, ":wielded_item", "itm_throwing_axes_melee"),
		(neq, ":wielded_item", "itm_throwing_axes_melee"),
      ], 
      [
		(party_get_slot, ":tavernkeeper", "$g_encountered_party", "slot_town_tavernkeeper"),
		(start_mission_conversation, ":tavernkeeper"),	 
	  ]),
	  	  	  
	  #Check for weapon in hand of attacker, also, everyone gets out of the way
      (1, 0, 0, 
      [
		(gt, "$g_main_attacker_agent", 0),	
 		(agent_is_active,"$g_main_attacker_agent"),	#MOTO chief avoid invalid agent messages from script_neutral_behavior_in_fight
     ],
      [
        (agent_get_wielded_item, ":wielded_item", "$g_main_attacker_agent", 0),
        (val_max, "$g_attacker_drawn_weapon", ":wielded_item"),               
        
        (call_script, "script_neutral_behavior_in_fight"),
      ]),	  			
    ], #chief bodyboard caba'drin + bodyguard_triggersgdwremoved
  ),

# This template is used in party encounters and such.
# 
  (
    "conversation_encounter",0,-1,
    "Conversation_encounter",
    [( 0,mtef_visitor_source,af_override_fullhelm,0,1,[]),( 1,mtef_visitor_source,af_override_fullhelm,0,1,[]),
     ( 2,mtef_visitor_source,af_override_fullhelm,0,1,[]),( 3,mtef_visitor_source,af_override_fullhelm,0,1,[]),( 4,mtef_visitor_source,af_override_fullhelm,0,1,[]),( 5,mtef_visitor_source,af_override_fullhelm,0,1,[]),( 6,mtef_visitor_source,af_override_fullhelm,0,1,[]),
     ( 7,mtef_visitor_source,af_override_fullhelm,0,1,[]),( 8,mtef_visitor_source,af_override_fullhelm,0,1,[]),( 9,mtef_visitor_source,af_override_fullhelm,0,1,[]),(10,mtef_visitor_source,af_override_fullhelm,0,1,[]),(11,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    #prisoners now...
     (12,mtef_visitor_source,af_override_fullhelm,0,1,[]),(13,mtef_visitor_source,af_override_fullhelm,0,1,[]),(14,mtef_visitor_source,af_override_fullhelm,0,1,[]),(15,mtef_visitor_source,af_override_fullhelm,0,1,[]),(16,mtef_visitor_source,af_override_fullhelm,0,1,[]),
    #Other party
     (17,mtef_visitor_source,af_override_fullhelm,0,1,[]),(18,mtef_visitor_source,af_override_fullhelm,0,1,[]),(19,mtef_visitor_source,af_override_fullhelm,0,1,[]),(20,mtef_visitor_source,af_override_fullhelm,0,1,[]),(21,mtef_visitor_source,af_override_fullhelm,0,1,[]),
     (22,mtef_visitor_source,af_override_fullhelm,0,1,[]),(23,mtef_visitor_source,af_override_fullhelm,0,1,[]),(24,mtef_visitor_source,af_override_fullhelm,0,1,[]),(25,mtef_visitor_source,af_override_fullhelm,0,1,[]),(26,mtef_visitor_source,af_override_fullhelm,0,1,[]),
     (27,mtef_visitor_source,af_override_fullhelm,0,1,[]),(28,mtef_visitor_source,af_override_fullhelm,0,1,[]),(29,mtef_visitor_source,af_override_fullhelm,0,1,[]),(30,mtef_visitor_source,af_override_fullhelm,0,1,[]),(31,mtef_visitor_source,af_override_fullhelm,0,1,[]),
     ],
    [],
  ),
  
#----------------------------------------------------------------
#mission templates before this point are hardwired into the game.
#-----------------------------------------------------------------

  (
    "town_center",0,-1,
    "Default town visit",
    [(0,mtef_scene_source|mtef_team_0,af_override_horse,0,1,pilgrim_disguise),
     (1,mtef_scene_source|mtef_team_0,0,0,1,[]),
     (2,mtef_scene_source|mtef_team_0,af_override_horse,0,1,pilgrim_disguise),
     (3,mtef_scene_source|mtef_team_0,af_override_horse,0,1,pilgrim_disguise),
     (4,mtef_scene_source|mtef_team_0,af_override_horse,0,1,pilgrim_disguise),
     (5,mtef_scene_source|mtef_team_0,af_override_horse,0,1,pilgrim_disguise),
     (6,mtef_scene_source|mtef_team_0,af_override_horse,0,1,pilgrim_disguise),
     (7,mtef_scene_source|mtef_team_0,af_override_horse,0,1,pilgrim_disguise),     
     (8,mtef_visitor_source,af_override_horse,0,1,[]),
     (9,mtef_visitor_source,af_override_horse,0,1,[]),(10,mtef_visitor_source,af_override_horse,0,1,[]),(11,mtef_visitor_source,af_override_horse,0,1,[]),(12,mtef_visitor_source,af_override_horse,0,1,[]),(13,mtef_visitor_source,0,0,1,[]),(14,mtef_scene_source,0,0,1,[]),(15,mtef_scene_source,0,0,1,[]),
     (16,mtef_visitor_source,af_override_horse,0,1,[]),(17,mtef_visitor_source,af_override_horse,0,1,[]),(18,mtef_visitor_source,af_override_horse,0,1,[]),(19,mtef_visitor_source,af_override_horse,0,1,[]),(20,mtef_visitor_source,af_override_horse,0,1,[]),(21,mtef_visitor_source,af_override_horse,0,1,[]),(22,mtef_visitor_source,af_override_horse,0,1,[]),
	 (23,mtef_visitor_source,af_override_horse,0,1,[]), #guard
     (24,mtef_visitor_source,af_override_horse,0,1,[]), #guard
	 (25,mtef_visitor_source,af_override_horse,0,1,[]), #guard
	 (26,mtef_visitor_source,af_override_horse,0,1,[]), #guard
	 (27,mtef_visitor_source,af_override_horse,0,1,[]), #guard
	 (28,mtef_visitor_source,af_override_horse,0,1,[]), #guard
	 (29,mtef_visitor_source,af_override_horse,0,1,[]),
	 (30,mtef_visitor_source,af_override_horse,0,1,[]),
	 (31,mtef_visitor_source,af_override_horse,0,1,[]),
     (32,mtef_visitor_source,af_override_horse,0,1,[]),
	 (33,mtef_visitor_source,af_override_horse,0,1,[]),
	 (34,mtef_visitor_source,af_override_horse,0,1,[]),
	 (35,mtef_visitor_source,af_override_horse,0,1,[]),
	 (36,mtef_visitor_source,af_override_horse,0,1,[]), #town walker point
	 (37,mtef_visitor_source,af_override_horse,0,1,[]), #town walker point
	 (38,mtef_visitor_source,af_override_horse,0,1,[]),
	 (39,mtef_visitor_source,af_override_horse,0,1,[]),
     (40,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]), #in towns, can be used for guard reinforcements
	 (41,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]), #in towns, can be used for guard reinforcements
	 (42,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]), #in towns, can be used for guard reinforcements
	 (43,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]), #in towns, can be used for guard reinforcements
     (44,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
	 (45,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
	 (46,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
	 (47,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
	 ],
    [
      (ti_on_agent_spawn, 0, 0, [],
      [
        (store_trigger_param_1, ":agent_no"),
        (call_script, "script_init_town_agent", ":agent_no"),
        (try_begin),
          (this_or_next|eq, "$talk_context", tc_escape),
          (eq, "$talk_context", tc_prison_break),
          (agent_get_troop_id, ":troop_no", ":agent_no"),		  
          (troop_slot_eq, ":troop_no", "slot_troop_will_join_prison_break", 1),
          (agent_set_team, ":agent_no", 0),
          (agent_ai_set_aggressiveness, ":agent_no", 5),
          (troop_set_slot, ":troop_no", "slot_troop_will_join_prison_break", 0),
          (try_begin),
            (troop_slot_eq, ":troop_no", "slot_troop_mission_participation", mp_prison_break_stand_back),
            (agent_get_position, pos1, ":agent_no"),            
            (agent_set_scripted_destination, ":agent_no", pos1),
          (try_end),
        (try_end),         
      ]),

      (ti_before_mission_start, 0, 0, [],
      [
        (assign, "$g_main_attacker_agent", 0),
	  ]),
		 
      (1, 0, ti_once, 
      [],
      [
        (try_begin),
          (eq, "$g_mt_mode", tcm_default),
          (store_current_scene, ":cur_scene"),
          (scene_set_slot, ":cur_scene", "slot_scene_visited", 1),
        (try_end),
        (call_script, "script_init_town_walker_agents"),
        (try_begin),
          (eq, "$sneaked_into_town", 1),
          (call_script, "script_music_set_situation_with_culture", mtf_sit_town_infiltrate),
        (else_try),
          (call_script, "script_music_set_situation_with_culture", mtf_sit_town),
        (try_end),
      ]),

      (ti_before_mission_start, 0, 0, 
      [], 
      [
        (call_script, "script_change_banners_and_chest")
      ]),
        
      (ti_inventory_key_pressed, 0, 0,
      [
        (try_begin),
          (eq, "$g_mt_mode", tcm_default),
          (set_trigger_result,1),
        (else_try),
          (eq, "$g_mt_mode", tcm_disguised),
          (display_message,"str_cant_use_inventory_disguised"),
        (else_try),
          (display_message, "str_cant_use_inventory_now"),
        (try_end),
      ], 
      []),
       
      (ti_tab_pressed, 0, 0,
      [
        (try_begin),
          (this_or_next|eq, "$talk_context", tc_escape),
          (eq, "$talk_context", tc_prison_break),
          (display_message, "str_cannot_leave_now"),
        (else_try),
          (this_or_next|eq, "$g_mt_mode", tcm_default),
          (eq, "$g_mt_mode", tcm_disguised),
          (mission_enable_talk),
          (set_trigger_result,1),
        (else_try),
          (display_message, "str_cannot_leave_now"),
        (try_end),
      ], 
      []),

      (ti_on_leave_area, 0, 0,
      [
        (try_begin),
          (eq, "$g_defending_against_siege", 0),
          (assign,"$g_leave_town",1),
        (try_end),			
      ], 
      [
        (try_begin),
          (eq, "$talk_context", tc_escape),
          (call_script, "script_deduct_casualties_from_garrison"),
          (jump_to_menu,"mnu_sneak_into_town_caught_dispersed_guards"),
        (try_end),
        
        (mission_enable_talk),
      ]),            

     (0, 0, ti_once, 
     [], 
     [
       (party_slot_eq, "$current_town", "slot_party_type", spt_town),
       (call_script, "script_town_init_doors", 0),
       (try_begin),
         (eq, "$town_nighttime", 0),
         (play_sound, "snd_town_ambiance", sf_looping),
       (try_end),
     ]),

	(3, 0, 0, 
	[
	  (call_script, "script_tick_town_walkers")
	], 
	[]),
	
         common_play_instrument, #chief entretenimiento bardo

    (2, 0, 0, 
    [
      (call_script, "script_center_ambiance_sounds")
    ], 
    []),
      
	#JAILBREAK TRIGGERS 
	#Civilians get out of the way
    (1, 0, 0,
	[
	  (this_or_next|eq, "$talk_context", tc_prison_break),
      (eq, "$talk_context", tc_escape),		
		(agent_is_active,"$g_main_attacker_agent"),	#MOTO chief avoid invalid agent messages from script_neutral_behavior_in_fight
	],
	[
	  #(agent_get_team, ":prisoner_agent", 0),
	  (call_script, "script_neutral_behavior_in_fight"),
	  (mission_disable_talk),	  	  
	]),

	#The game begins with the town alerted
    (1, 0, ti_once, 
      [
        #If I set this to 1, 0, ti_once, then the prisoner spawns twice
        (eq, "$talk_context", tc_escape),
	  ],	  
	  [
		(get_player_agent_no, ":player_agent"),
	    (assign, reg6, ":player_agent"),
		(call_script, "script_activate_town_guard"),		
		
		(get_player_agent_no, ":player_agent"),
		(agent_get_position, pos4, ":player_agent"),
		
		(try_for_range, ":prisoner", active_npcs_begin, kingdom_ladies_end),		
		  (troop_slot_ge, ":prisoner", "slot_troop_mission_participation", mp_prison_break_fight),

		  (str_store_troop_name, s4, ":prisoner"),
		  (display_message, "str_s4_joins_prison_break"),
			
		  (store_current_scene, ":cur_scene"), #this might be a better option?
		  (modify_visitors_at_site, ":cur_scene"),
			            
          #<entry_no>,<troop_id>,<number_of_troops>, <team_no>, <group_no>), 
          #team no and group no are used in multiplayer mode only. default team in entry is used in single player mode            
          (store_current_scene, ":cur_scene"),
          (modify_visitors_at_site, ":cur_scene"),                      
          (add_visitors_to_current_scene, 24, ":prisoner", 1, 0, 0),
          (troop_set_slot, ":prisoner", "slot_troop_will_join_prison_break", 1),
        (try_end),
	  ]),
	
   (3, 0, 0, 
   [     
     (main_hero_fallen, 0),
   ],	  
   [
     (try_begin),
       (this_or_next|eq, "$talk_context", tc_prison_break),
       (eq, "$talk_context", tc_escape),
       
       (call_script, "script_deduct_casualties_from_garrison"),
	   (jump_to_menu,"mnu_captivity_start_castle_defeat"), 
	 
	   (assign, ":end_cond", kingdom_ladies_end),
       (try_for_range, ":prisoner", active_npcs_begin, ":end_cond"),
  	     (troop_set_slot, ":prisoner", "slot_troop_mission_participation", 0), #new
  	   (try_end),  
	 
	   (mission_enable_talk),
	   (finish_mission, 0),
	 (else_try),  
	   (set_trigger_result,1),
	 (try_end),	 	 
   ]),
		
   (3, 0, 0, 
   [
     (eq, "$talk_context", tc_escape),
	 (neg|main_hero_fallen,0),
     (store_mission_timer_a, ":time"),
     (ge, ":time", 10),
		
     (all_enemies_defeated), #1 is default enemy team for in-town battles
   ],	  
   [
     (call_script, "script_deduct_casualties_from_garrison"),
	 (try_for_agents, ":agent"),
	 (agent_get_troop_id, ":troop", ":agent"),
       (troop_slot_ge, ":troop", "slot_troop_mission_participation", mp_prison_break_fight),
       (try_begin),
         (agent_is_alive, ":agent"),
         (troop_set_slot, ":troop", "slot_troop_mission_participation", mp_prison_break_escaped),
       (else_try),	
         (troop_set_slot, ":troop", "slot_troop_mission_participation", mp_prison_break_caught),
       (try_end),
     (try_end),
     (jump_to_menu,"mnu_sneak_into_town_caught_ran_away"),
     
     (mission_enable_talk),
     (finish_mission,0)
   ]),
   
   (ti_on_agent_killed_or_wounded, 0, 0, [],
   [
     (store_trigger_param_1, ":dead_agent_no"),
     (store_trigger_param_2, ":killer_agent_no"),
     #(store_trigger_param_3, ":is_wounded"),
        
     (agent_get_troop_id, ":dead_agent_troop_no", ":dead_agent_no"),
     (agent_get_troop_id, ":killer_agent_troop_no", ":killer_agent_no"),
                
     (try_begin), 
       (this_or_next|eq, ":dead_agent_troop_no", "trp_briton_prisoner_guard"),
       (this_or_next|eq, ":dead_agent_troop_no", "trp_saxon_prison_guard"),
       (this_or_next|eq, ":dead_agent_troop_no", "trp_pict_prison_guard"),
       (this_or_next|eq, ":dead_agent_troop_no", "trp_engle_prison_guard"),
       (this_or_next|eq, ":dead_agent_troop_no", "trp_irish_prison_guard"),
       (eq, ":dead_agent_troop_no", "trp_jute_prison_guard"),
          
       (eq, ":killer_agent_troop_no", "trp_player"),
          
       (display_message, "@You got keys of dungeon."),
     (try_end),
   ]),     
  ]# + bodyguard_triggers, #chief bodyboard caba'drin
    ),

  (
    "village_center",0,-1,
    "village center",
    [(0,mtef_scene_source|mtef_team_0,0,0,1,[]),
     (1,mtef_scene_source|mtef_team_0,0,0,1,[]),
     (2,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (3,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (4,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (5,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (6,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (7,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     
     (8,mtef_visitor_source,0,0,1,[]),
     (9,mtef_visitor_source,0,0,1,[]),(10,mtef_visitor_source,af_override_horse,0,1,[]),(11,mtef_visitor_source,af_override_horse,0,1,[]),(12,mtef_visitor_source,af_override_horse,0,1,[]),(13,mtef_visitor_source,0,0,1,[]),(14,mtef_visitor_source,0,0,1,[]),(15,mtef_visitor_source,0,0,1,[]),
     (16,mtef_visitor_source,af_override_horse,0,1,[]),(17,mtef_visitor_source,0,0,1,[]),(18,mtef_visitor_source,af_override_horse,0,1,[]),(19,mtef_visitor_source,af_override_horse,0,1,[]),(20,mtef_visitor_source,af_override_horse,0,1,[]),(21,mtef_visitor_source,af_override_horse,0,1,[]),(22,mtef_visitor_source,af_override_horse,0,1,[]),(23,mtef_visitor_source,af_override_horse,0,1,[]),
     (24,mtef_visitor_source,af_override_horse,0,1,[]),(25,mtef_visitor_source,0,0,1,[]),(26,mtef_visitor_source,0,0,1,[]),(27,mtef_visitor_source,0,0,1,[]),(28,mtef_visitor_source,0,0,1,[]),(29,mtef_visitor_source,af_override_horse,0,1,[]),(30,mtef_visitor_source,af_override_horse,0,1,[]),(31,mtef_visitor_source,af_override_horse,0,1,[]),
     (32,mtef_visitor_source,af_override_horse,0,1,[]),(33,mtef_visitor_source,0,0,1,[]),(34,mtef_visitor_source,0,0,1,[]),(35,mtef_visitor_source,0,0,1,[]),(36,mtef_visitor_source,0,0,1,[]),(37,mtef_visitor_source,af_override_horse,0,1,[]),(38,mtef_visitor_source,af_override_horse,0,1,[]),(39,mtef_visitor_source,af_override_horse,0,1,[]),
     (40,mtef_visitor_source,af_override_horse,0,1,[]),(41,mtef_visitor_source,0,0,1,[]),(42,mtef_visitor_source,af_override_horse,0,1,[]),(43,mtef_visitor_source,af_override_horse,0,1,[]),(44,mtef_visitor_source,af_override_horse,0,1,[]),(45,mtef_visitor_source,af_override_horse,0,1,[]),(46,mtef_visitor_source,af_override_horse,0,1,[]),(47,mtef_visitor_source,af_override_horse,0,1,[]),
     ],
    [
      (1, 0, ti_once, [], [
          (store_current_scene, ":cur_scene"),
          (scene_set_slot, ":cur_scene", "slot_scene_visited", 1),
          (call_script, "script_init_town_walker_agents"),
          (call_script, "script_music_set_situation_with_culture", mtf_sit_travel),
        ]),
      (ti_before_mission_start, 0, 0, [], [(call_script, "script_change_banners_and_chest")]),
      (ti_inventory_key_pressed, 0, 0, [(set_trigger_result,1)], []),
      (ti_tab_pressed, 0, 0, [(try_begin),
                                (check_quest_active, "qst_hunt_down_fugitive"),
                                (neg|check_quest_succeeded, "qst_hunt_down_fugitive"),
                                (neg|check_quest_failed, "qst_hunt_down_fugitive"),
                                (quest_slot_eq, "qst_hunt_down_fugitive", "slot_quest_current_state", 1),
                                (try_begin),
                                  (call_script, "script_cf_troop_agent_is_alive", "trp_fugitive"),
                                  (call_script, "script_fail_quest", "qst_hunt_down_fugitive"),
                                (else_try),
                                  (call_script, "script_succeed_quest", "qst_hunt_down_fugitive"),
                                (try_end),
                              (try_end),
                              (set_trigger_result,1)], []),
      (ti_on_leave_area, 0, 0, [
          (try_begin),
            (assign,"$g_leave_town",1),
          (try_end),
          ], []),
      (3, 0, 0, [(call_script, "script_tick_town_walkers")], []),
      (2, 0, 0, [(call_script, "script_center_ambiance_sounds")], []),

         common_play_instrument, #chief entretenimiento bardo

#chief bounty
      # Bounty Hunting triggers
      (ti_tab_pressed, 0, 0, [(try_begin),
                                (check_quest_active, "qst_bounty_1"),
                                (neg|check_quest_succeeded, "qst_bounty_1"),
                                (neg|check_quest_failed, "qst_bounty_1"),
                                (quest_slot_eq, "qst_bounty_1", "slot_quest_current_state", 1),
                                (try_begin),
                                  (call_script, "script_cf_troop_agent_is_alive", "$bounty_target_1"),
                                  (call_script, "script_fail_quest", "qst_bounty_1"),
                                (else_try),
                                  (call_script, "script_succeed_quest", "qst_bounty_1"),
                                (try_end),
                              (try_end),
                              (set_trigger_result,1)], []),
      (ti_tab_pressed, 0, 0, [(try_begin),
                                (check_quest_active, "qst_bounty_2"),
                                (neg|check_quest_succeeded, "qst_bounty_2"),
                                (neg|check_quest_failed, "qst_bounty_2"),
                                (quest_slot_eq, "qst_bounty_2", "slot_quest_current_state", 1),
                                (try_begin),
                                  (call_script, "script_cf_troop_agent_is_alive", "$bounty_target_2"),
                                  (call_script, "script_fail_quest", "qst_bounty_2"),
                                (else_try),
                                  (call_script, "script_succeed_quest", "qst_bounty_2"),
                                (try_end),
                              (try_end),
                              (set_trigger_result,1)], []),
      (ti_tab_pressed, 0, 0, [(try_begin),
                                (check_quest_active, "qst_bounty_3"),
                                (neg|check_quest_succeeded, "qst_bounty_3"),
                                (neg|check_quest_failed, "qst_bounty_3"),
                                (quest_slot_eq, "qst_bounty_3", "slot_quest_current_state", 1),
                                (try_begin),
                                  (call_script, "script_cf_troop_agent_is_alive", "$bounty_target_3"),
                                  (call_script, "script_fail_quest", "qst_bounty_3"),
                                (else_try),
                                  (call_script, "script_succeed_quest", "qst_bounty_3"),
                                (try_end),
                              (try_end),
                              (set_trigger_result,1)], []),
      (ti_tab_pressed, 0, 0, [(try_begin),
                                (check_quest_active, "qst_bounty_4"),
                                (neg|check_quest_succeeded, "qst_bounty_4"),
                                (neg|check_quest_failed, "qst_bounty_4"),
                                (quest_slot_eq, "qst_bounty_4", "slot_quest_current_state", 1),
                                (try_begin),
                                  (call_script, "script_cf_troop_agent_is_alive", "$bounty_target_4"),
                                  (call_script, "script_fail_quest", "qst_bounty_4"),
                                (else_try),
                                  (call_script, "script_succeed_quest", "qst_bounty_4"),
                                (try_end),
                              (try_end),
                              (set_trigger_result,1)], []),
      (ti_tab_pressed, 0, 0, [(try_begin),
                                (check_quest_active, "qst_bounty_5"),
                                (neg|check_quest_succeeded, "qst_bounty_5"),
                                (neg|check_quest_failed, "qst_bounty_5"),
                                (quest_slot_eq, "qst_bounty_5", "slot_quest_current_state", 1),
                                (try_begin),
                                  (call_script, "script_cf_troop_agent_is_alive", "$bounty_target_5"),
                                  (call_script, "script_fail_quest", "qst_bounty_5"),
                                (else_try),
                                  (call_script, "script_succeed_quest", "qst_bounty_5"),
                                (try_end),
                              (try_end),
                              (set_trigger_result,1)], []),
      (ti_tab_pressed, 0, 0, [(try_begin),
                                (check_quest_active, "qst_bounty_6"),
                                (neg|check_quest_succeeded, "qst_bounty_6"),
                                (neg|check_quest_failed, "qst_bounty_6"),
                                (quest_slot_eq, "qst_bounty_6", "slot_quest_current_state", 1),
                                (try_begin),
                                  (call_script, "script_cf_troop_agent_is_alive", "$bounty_target_6"),
                                  (call_script, "script_fail_quest", "qst_bounty_6"),
                                (else_try),
                                  (call_script, "script_succeed_quest", "qst_bounty_6"),
                                (try_end),
                              (try_end),
                              (set_trigger_result,1)], []),

      (1, 0, ti_once, [(check_quest_active, "qst_bounty_1"),
                       (neg|check_quest_succeeded, "qst_bounty_1"),
                       (neg|check_quest_failed, "qst_bounty_1"),
                       (quest_slot_eq, "qst_bounty_1", "slot_quest_current_state", 1),
                       (assign, ":not_alive", 0),
                       (try_begin),
                         (call_script, "script_cf_troop_agent_is_alive", "$bounty_target_1"),
                       (else_try),
                         (assign, ":not_alive", 1),
                       (try_end),
                       (this_or_next|main_hero_fallen),
                       (eq, ":not_alive", 1),
                       ],
       [(try_begin),
          (main_hero_fallen),
          (jump_to_menu, "mnu_village_hunt_down_fugitive_defeated"),
          (call_script, "script_fail_quest", "qst_bounty_1"),
          (finish_mission, 4),
        (else_try),
          (call_script, "script_change_player_relation_with_center", "$current_town", -1), #chief cambia odio aldeas  #TML Seemed a bit high to me, probably intended but I changed it to 1 anyway. F123 - Submod -> 1.41
          (call_script, "script_succeed_quest", "qst_bounty_1"),
        (try_end),
        ]),
      (1, 0, ti_once, [(check_quest_active, "qst_bounty_2"),
                       (neg|check_quest_succeeded, "qst_bounty_2"),
                       (neg|check_quest_failed, "qst_bounty_2"),
                       (quest_slot_eq, "qst_bounty_2", "slot_quest_current_state", 1),
                       (assign, ":not_alive", 0),
                       (try_begin),
                         (call_script, "script_cf_troop_agent_is_alive", "$bounty_target_2"),
                       (else_try),
                         (assign, ":not_alive", 1),
                       (try_end),
                       (this_or_next|main_hero_fallen),
                       (eq, ":not_alive", 1),
                       ],
       [(try_begin),
          (main_hero_fallen),
          (jump_to_menu, "mnu_village_hunt_down_fugitive_defeated"),
          (call_script, "script_fail_quest", "qst_bounty_2"),
          (finish_mission, 4),
        (else_try),
          (call_script, "script_change_player_relation_with_center", "$current_town", -1), #chief cambia odio aldeas  #TML Seemed a bit high to me, probably intended but I changed it to 1 anyway. F123 - Submod -> 1.41
          (call_script, "script_succeed_quest", "qst_bounty_2"),
        (try_end),
        ]),
      (1, 0, ti_once, [(check_quest_active, "qst_bounty_3"),
                       (neg|check_quest_succeeded, "qst_bounty_3"),
                       (neg|check_quest_failed, "qst_bounty_3"),
                       (quest_slot_eq, "qst_bounty_3", "slot_quest_current_state", 1),
                       (assign, ":not_alive", 0),
                       (try_begin),
                         (call_script, "script_cf_troop_agent_is_alive", "$bounty_target_3"),
                       (else_try),
                         (assign, ":not_alive", 1),
                       (try_end),
                       (this_or_next|main_hero_fallen),
                       (eq, ":not_alive", 1),
                       ],
       [(try_begin),
          (main_hero_fallen),
          (jump_to_menu, "mnu_village_hunt_down_fugitive_defeated"),
          (call_script, "script_fail_quest", "qst_bounty_3"),
          (finish_mission, 4),
        (else_try),
          (call_script, "script_change_player_relation_with_center", "$current_town", -1), #chief cambia odio aldeas  #TML Seemed a bit high to me, probably intended but I changed it to 1 anyway. F123 - Submod -> 1.41
          (call_script, "script_succeed_quest", "qst_bounty_3"),
        (try_end),
        ]),
      (1, 0, ti_once, [(check_quest_active, "qst_bounty_4"),
                       (neg|check_quest_succeeded, "qst_bounty_4"),
                       (neg|check_quest_failed, "qst_bounty_4"),
                       (quest_slot_eq, "qst_bounty_4", "slot_quest_current_state", 1),
                       (assign, ":not_alive", 0),
                       (try_begin),
                         (call_script, "script_cf_troop_agent_is_alive", "$bounty_target_4"),
                       (else_try),
                         (assign, ":not_alive", 1),
                       (try_end),
                       (this_or_next|main_hero_fallen),
                       (eq, ":not_alive", 1),
                       ],
       [(try_begin),
          (main_hero_fallen),
          (jump_to_menu, "mnu_village_hunt_down_fugitive_defeated"),
          (call_script, "script_fail_quest", "qst_bounty_4"),
          (finish_mission, 4),
        (else_try),
          (call_script, "script_change_player_relation_with_center", "$current_town", -1), #chief cambia odio aldeas  #TML Seemed a bit high to me, probably intended but I changed it to 1 anyway. F123 - Submod -> 1.41
          (call_script, "script_succeed_quest", "qst_bounty_4"),
        (try_end),
        ]),
      (1, 0, ti_once, [(check_quest_active, "qst_bounty_5"),
                       (neg|check_quest_succeeded, "qst_bounty_5"),
                       (neg|check_quest_failed, "qst_bounty_5"),
                       (quest_slot_eq, "qst_bounty_5", "slot_quest_current_state", 1),
                       (assign, ":not_alive", 0),
                       (try_begin),
                         (call_script, "script_cf_troop_agent_is_alive", "$bounty_target_5"),
                       (else_try),
                         (assign, ":not_alive", 1),
                       (try_end),
                       (this_or_next|main_hero_fallen),
                       (eq, ":not_alive", 1),
                       ],
       [(try_begin),
          (main_hero_fallen),
          (jump_to_menu, "mnu_village_hunt_down_fugitive_defeated"),
          (call_script, "script_fail_quest", "qst_bounty_5"),
          (finish_mission, 4),
        (else_try),
          (call_script, "script_change_player_relation_with_center", "$current_town", -1), #chief cambia odio aldeas  #TML Seemed a bit high to me, probably intended but I changed it to 1 anyway. F123 - Submod -> 1.41
          (call_script, "script_succeed_quest", "qst_bounty_5"),
        (try_end),
        ]),
      (1, 0, ti_once, [(check_quest_active, "qst_bounty_6"),
                       (neg|check_quest_succeeded, "qst_bounty_6"),
                       (neg|check_quest_failed, "qst_bounty_6"),
                       (quest_slot_eq, "qst_bounty_6", "slot_quest_current_state", 1),
                       (assign, ":not_alive", 0),
                       (try_begin),
                         (call_script, "script_cf_troop_agent_is_alive", "$bounty_target_6"),
                       (else_try),
                         (assign, ":not_alive", 1),
                       (try_end),
                       (this_or_next|main_hero_fallen),
                       (eq, ":not_alive", 1),
                       ],
       [(try_begin),
          (main_hero_fallen),
          (jump_to_menu, "mnu_village_hunt_down_fugitive_defeated"),
          (call_script, "script_fail_quest", "qst_bounty_6"),
          (finish_mission, 4),
        (else_try),
          (call_script, "script_change_player_relation_with_center", "$current_town", -1), #chief cambia odio aldeas  #TML Seemed a bit high to me, probably intended but I changed it to 1 anyway. F123 - Submod -> 1.41
          (call_script, "script_succeed_quest", "qst_bounty_6"),
        (try_end),
        ]),
# Bounty Hunting Triggers end chief

      (1, 0, ti_once, [(check_quest_active, "qst_hunt_down_fugitive"),
                       (neg|check_quest_succeeded, "qst_hunt_down_fugitive"),
                       (neg|check_quest_failed, "qst_hunt_down_fugitive"),
                       (quest_slot_eq, "qst_hunt_down_fugitive", "slot_quest_current_state", 1),
                       (assign, ":not_alive", 0),
                       (try_begin),
                         (call_script, "script_cf_troop_agent_is_alive", "trp_fugitive"),
                       (else_try),
                         (assign, ":not_alive", 1),
                       (try_end),
                       (this_or_next|main_hero_fallen),
                       (eq, ":not_alive", 1),
                       ],
       [(try_begin),
          (main_hero_fallen),
          (jump_to_menu, "mnu_village_hunt_down_fugitive_defeated"),
          (call_script, "script_fail_quest", "qst_hunt_down_fugitive"),
          (finish_mission, 4),
        (else_try),
          (call_script, "script_change_player_relation_with_center", "$current_town", -1), #chief cambia odio aldeas  #TML Seemed a bit high to me, probably intended but I changed it to 1 anyway. F123 - Submod -> 1.41
          (call_script, "script_succeed_quest", "qst_hunt_down_fugitive"),
        (try_end),
        ]),
    ] + bodyguard_triggers, #chief bodyboard caba'drin   
  ),

  (
    "bandits_at_night",0,-1,
    "Default town visit",
    [(0,mtef_scene_source|mtef_team_0, af_override_horse, aif_start_alarmed, 1, pilgrim_disguise),
     (1,mtef_scene_source|mtef_team_0,0,0,1,[]),
     (2,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (3,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (4,mtef_visitor_source|mtef_team_0, af_override_horse, aif_start_alarmed, 1, []),
     (5,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (6,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (7,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     
     (8,mtef_scene_source,af_override_horse,0,1,[]),
     (9,mtef_visitor_source,af_override_horse,0,1,[]),(10,mtef_visitor_source,af_override_horse,0,1,[]),(11,mtef_visitor_source,af_override_horse,aif_start_alarmed,1,[]),(12,mtef_visitor_source,af_override_horse,0,1,[]),(13,mtef_scene_source,0,0,1,[]),(14,mtef_scene_source,0,0,1,[]),(15,mtef_scene_source,0,0,1,[]),
     (16,mtef_visitor_source,af_override_horse,0,1,[]),(17,mtef_visitor_source,af_override_horse,0,1,[]),(18,mtef_visitor_source,af_override_horse,0,1,[]),(19,mtef_visitor_source,af_override_horse,0,1,[]),(20,mtef_visitor_source,af_override_horse,0,1,[]),(21,mtef_visitor_source,af_override_horse,0,1,[]),(22,mtef_visitor_source,af_override_horse,0,1,[]),(23,mtef_visitor_source,af_override_horse,0,1,[]),
     (24,mtef_visitor_source,af_override_horse,0,1,[]),(25,mtef_visitor_source,af_override_horse,0,1,[]),(26,mtef_visitor_source,af_override_horse,0,1,[]),(27,mtef_visitor_source,af_override_horse,aif_start_alarmed,1,[]),(28,mtef_visitor_source,af_override_horse,aif_start_alarmed,1,[]),(29,mtef_visitor_source,af_override_horse,0,1,[]),(30,mtef_visitor_source,af_override_horse,0,1,[]),(31,mtef_visitor_source,af_override_horse,0,1,[]),
     (32,mtef_visitor_source,af_override_horse,0,1,[]),(33,mtef_visitor_source,af_override_horse,0,1,[]),(34,mtef_visitor_source,af_override_horse,0,1,[]),(35,mtef_visitor_source,af_override_horse,0,1,[]),(36,mtef_visitor_source,af_override_horse,0,1,[]),(37,mtef_visitor_source,af_override_horse,0,1,[]),(38,mtef_visitor_source,af_override_horse,0,1,[]),(39,mtef_visitor_source,af_override_horse,0,1,[]),
     (40,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),(41,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),(42,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),(43,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (44,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),(45,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),(46,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),(47,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     ],
    [
      (ti_on_agent_spawn, 0, 0, [],
       [
         (store_trigger_param_1, ":agent_no"),
         (agent_get_troop_id, ":troop_no", ":agent_no"),
         (neq, ":troop_no", "trp_player"),
         (agent_set_team, ":agent_no", 1),
         ]),

      (ti_before_mission_start, 0, 0, [], [(call_script, "script_change_banners_and_chest")]),

      common_inventory_not_available,
      (ti_tab_pressed, 0, 0,
       [
         (display_message, "str_cannot_leave_now"),
         ], []),
      (ti_on_leave_area, 0, 0,
       [
         (try_begin),
           (eq, "$g_defending_against_siege", 0),
           (assign,"$g_leave_town",1),
         (try_end),
         ], []),

      (0, 0, ti_once, [],
       [
         (call_script, "script_music_set_situation_with_culture", mtf_sit_ambushed),
         (set_party_battle_mode),
         (party_slot_eq, "$current_town", "slot_party_type", spt_town),
         (call_script, "script_town_init_doors", 0),
        ]),

      (1, 4, ti_once,
       [
         (store_mission_timer_a,":cur_time"),
         (ge, ":cur_time", 5),
         (this_or_next|main_hero_fallen),
         (num_active_teams_le,1)
         ],
       [
         (try_begin),
           (main_hero_fallen),
           (jump_to_menu, "mnu_town_bandits_failed"),
         (else_try),
           (jump_to_menu, "mnu_town_bandits_succeeded"),
         (try_end),
         (finish_mission),
         ]),
      ] + bodyguard_triggers, #chief bodyboard caba'drin 
    ),

  
  (
    "village_training", mtf_arena_fight, -1,
    "village_training",
    [(2,mtef_visitor_source|mtef_team_0,af_override_everything,aif_start_alarmed,1,["itm_practice_staff", "itm_cheap_shoes"]),
     (4,mtef_visitor_source|mtef_team_1,af_override_everything,aif_start_alarmed,1,["itm_practice_staff", "itm_cheap_shoes"]),
     ],
    [
      (ti_before_mission_start, 0, 0, [],
       [
         (assign, "$g_train_peasants_against_bandits_training_succeeded", 0),
         (call_script, "script_change_banners_and_chest"),
         ]),
      
      common_arena_fight_tab_press,
      
      (ti_question_answered, 0, 0, [],
       [
         (store_trigger_param_1,":answer"),
         (eq,":answer",0),
         (finish_mission),
         ]),
      
      common_inventory_not_available,

      (1, 4, ti_once,
       [
         (this_or_next|main_hero_fallen),
         (num_active_teams_le, 1)
         ],
       [
         (try_begin),
           (neg|main_hero_fallen),
           (assign, "$g_train_peasants_against_bandits_training_succeeded", 1),
         (try_end),
         (finish_mission),
         ]),
      ],
    ),
    
  (
    "visit_town_castle",0,-1,
    "You enter the halls of the lord.",
    [(0,mtef_scene_source|mtef_team_0,af_override_horse|af_override_weapons|af_override_head,0,1,[]),
     (1,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (2,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (3,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]), 
     (4,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]), #for doors
     (5,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (6,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (7,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (8,mtef_visitor_source,af_override_horse,0,1,[]),
     (9,mtef_visitor_source,af_override_horse,0,1,[]),
     (10,mtef_scene_source,af_override_horse,0,1,[]),
     (11,mtef_scene_source,af_override_horse,0,1,[]),
     (12,mtef_visitor_source,af_override_horse,0,1,[]),
     (13,mtef_visitor_source,0,0,1,[]),
     (14,mtef_visitor_source,0,0,1,[]),
     (15,mtef_visitor_source,0,0,1,[]),
     (16,mtef_visitor_source,af_castle_lord,0,1,[]),
     (17,mtef_visitor_source,af_castle_lord,0,1,[]),
     (18,mtef_visitor_source,af_castle_lord,0,1,[]),
     (19,mtef_visitor_source,af_castle_lord,0,1,[]),
     (20,mtef_visitor_source,af_castle_lord,0,1,[]),
     (21,mtef_visitor_source,af_castle_lord,0,1,[]),
     (22,mtef_visitor_source,af_castle_lord,0,1,[]),
     (23,mtef_visitor_source,af_castle_lord,0,1,[]),
     (24,mtef_visitor_source,af_castle_lord,0,1,[]),
     (25,mtef_visitor_source,af_castle_lord,0,1,[]),
     (26,mtef_visitor_source,af_castle_lord,0,1,[]),
     (27,mtef_visitor_source,af_castle_lord,0,1,[]),
     (28,mtef_visitor_source,af_castle_lord,0,1,[]),
     (29,mtef_visitor_source,af_castle_lord,0,1,[]),
     (30,mtef_visitor_source,af_castle_lord,0,1,[]),
     (31,mtef_visitor_source,af_castle_lord,0,1,[])
     ],
    [
      (ti_on_agent_spawn, 0, 0, [],
      [
        (store_trigger_param_1, ":agent_no"),
        (call_script, "script_init_town_agent", ":agent_no"),
      ]),
      
      (ti_before_mission_start, 0, 0, [],
      [
        (call_script, "script_change_banners_and_chest"),
      ]),
       
      (ti_inventory_key_pressed, 0, 0, 
      [
        (set_trigger_result,1)
      ], []),
	  
	  #adjust for prison break
      (ti_tab_pressed, 0, 0,
	  [
	    (neq, "$talk_context", tc_prison_break),
	    (set_trigger_result,1)
	  ], []),
	  
      (ti_on_leave_area, 0, 0,
      [
 	    (eq, "$talk_context", tc_prison_break),
 	  ], 
	  [
	    (display_message, "str_leaving_area_during_prison_break"),
	    (set_jump_mission, "mt_sneak_caught_fight"),
	  ]),
	 	  
      (0, 0, ti_once, [], [
        #(set_fog_distance, 150, 0xFF736252)
        (try_begin),
          (eq, "$talk_context", tc_court_talk),
          (try_begin),
            (store_faction_of_party, ":center_faction", "$current_town"),
            (faction_slot_eq, ":center_faction", "slot_faction_ai_state", sfai_feast),
            (faction_slot_eq, ":center_faction", "slot_faction_ai_object", "$current_town"),
            (call_script, "script_music_set_situation_with_culture", mtf_sit_feast),
            #(call_script, "script_music_set_situation_with_culture", mtf_sit_lords_hall),
          (try_end),
        (else_try),
          (call_script, "script_music_set_situation_with_culture", 0), #prison
        (try_end),
        ]),
    ],
  ),

		  
  (
    "back_alley_kill_local_merchant",mtf_battle_mode,-1,
    "You enter the back alley",
    [
      (0,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
      (3,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    ],
    [
      common_inventory_not_available,
      (ti_tab_pressed, 0, 0, [(display_message,"str_cannot_leave_now")], []),
      (ti_before_mission_start, 0, 0, [], [(call_script, "script_change_banners_and_chest")]),

      (0, 0, ti_once, [],
       [
         (call_script, "script_music_set_situation_with_culture", mtf_sit_ambushed),
         ]),

      (0, 0, ti_once, [
          (store_mission_timer_a,":cur_time"),
          (ge,":cur_time",1), 
          (assign, ":merchant_hp", 0),
          (assign, ":player_hp", 0),
          (assign, ":merchant_hp", 0),
          (assign, ":merchant_agent", -1),
          (assign, ":player_agent", -1),
          (try_for_agents, ":agent_no"),
            (agent_get_troop_id, ":troop_id", ":agent_no"),
            (try_begin),
              (eq, ":troop_id", "trp_local_merchant"),
              (store_agent_hit_points, ":merchant_hp", ":agent_no"),
              (assign, ":merchant_agent", ":agent_no"),
            (else_try),
              (eq, ":troop_id", "trp_player"),
              (store_agent_hit_points, ":player_hp",":agent_no"),
              (assign, ":player_agent", ":agent_no"),
            (try_end),
          (try_end),
          (ge, ":player_agent", 0),
          (ge, ":merchant_agent", 0),
          (agent_is_alive, ":player_agent"),
          (agent_is_alive, ":merchant_agent"),
          (is_between, ":merchant_hp", 1, 30),
          (gt, ":player_hp", 50),
          (start_mission_conversation, "trp_local_merchant"),
          ], []),
      
      (1, 4, ti_once, [(assign, ":not_alive", 0),
                       (try_begin),
                         (call_script, "script_cf_troop_agent_is_alive", "trp_local_merchant"),
                       (else_try),
                         (assign, ":not_alive", 1),
                       (try_end),
                       (this_or_next|main_hero_fallen),
                       (eq, ":not_alive", 1)],
       [
           (try_begin),
             (main_hero_fallen),
             (call_script, "script_fail_quest", "qst_kill_local_merchant"),
           (else_try),
             (call_script, "script_change_player_relation_with_center", "$current_town", -4),
             (call_script, "script_succeed_quest", "qst_kill_local_merchant"),
           (try_end),
           (finish_mission),
           ]),
    ],
  ),

  (
    "back_alley_revolt",mtf_battle_mode,charge,
    "You lead your men to battle.",
    [(0,mtef_team_0|mtef_use_exact_number,af_override_horse|af_override_weapons|af_override_head,aif_start_alarmed,4,["itm_quarter_staff"]),
     (3,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     ],
    [
      common_inventory_not_available,

      common_battle_init_banner,

      (ti_tab_pressed, 0, 0, [],
       [(question_box,"str_do_you_want_to_retreat"),
        ]),
      (ti_question_answered, 0, 0, [],
       [(store_trigger_param_1,":answer"),
        (eq,":answer",0),
        (jump_to_menu, "mnu_collect_taxes_failed"),
        (finish_mission),]),

      (ti_tab_pressed, 0, 0, [(display_message,"str_cannot_leave_now")], []),
      (ti_before_mission_start, 0, 0, [], [(call_script, "script_change_banners_and_chest")]),

      (0, 0, ti_once, [],
       [
         (call_script, "script_music_set_situation_with_culture", mtf_sit_fight),
         ]),

      (1, 4, ti_once, [(this_or_next|main_hero_fallen),(num_active_teams_le,1)],
       [
           (try_begin),
             (main_hero_fallen),
             (jump_to_menu, "mnu_collect_taxes_failed"),
           (else_try),
             (jump_to_menu, "mnu_collect_taxes_rebels_killed"),
           (try_end),
           (finish_mission),
           ]),
    ],
  ),

  (
    "lead_charge",mtf_battle_mode|mtf_synch_inventory,charge,
    "You lead your men to battle.",
    [
     (1,mtef_defenders|mtef_team_0,0,aif_start_alarmed,12,[]),
     (0,mtef_defenders|mtef_team_0,0,aif_start_alarmed,0,[]),
     (4,mtef_attackers|mtef_team_1,0,aif_start_alarmed,12,[]),
     (4,mtef_attackers|mtef_team_1,0,aif_start_alarmed,0,[]),
     ],# battle_mode_triggers,
 		common_weapon_check + common_ai_order_toggle +
     [
      (ti_on_agent_spawn, 0, 0, [], [
         (store_trigger_param_1, ":agent_no"),
         (call_script, "script_force_weapon", ":agent_no"), ###chief anadido para forzar jabalinas#line13here
         ##gdw put (call_script, "script_equip_best_melee_weapon", ":agent", 1, 0, ":fire_order"),
         ##it causes this message:
 #          SCRIPT ERROR ON OPCODE 23: Invalid Script Parameter ID: 1; LINE NO: 1: 
 # At script: equip_best_melee_weapon. SCRIPT ERROR ON OPCODE 23: Invalid Script Parameter ID: 2; LINE NO: 2: 
 # At script: equip_best_melee_weapon. SCRIPT ERROR ON OPCODE 23: Invalid Script Parameter ID: 3; LINE NO: 3: 
 # At script: equip_best_melee_weapon. SCRIPT ERROR ON OPCODE 23: Invalid Script Parameter ID: 1; LINE NO: 1:
         #(call_script, "script_equip_best_melee_weapon", ":agent_no"), ###chief anadido para forzar jabalinas#line13here
         (call_script, "script_agent_reassign_team", ":agent_no"),
         (assign, ":initial_courage_score", 4000), #chief cambia a 3500, menos corage al principio
             
         (agent_get_troop_id, ":troop_id", ":agent_no"),
         (store_character_level, ":troop_level", ":troop_id"),
         (val_mul, ":troop_level", 35), #chief aumenta a 35 moral por nivel de tropa
         (val_add, ":initial_courage_score", ":troop_level"), #average : 20 * 35 = 700
#anade corage a tropas al inicio de batalla chief
         (agent_get_troop_id, ":troop_id", ":agent_no"),
         (try_begin),
                (this_or_next|eq,":troop_id","trp_briton_bannerman"),
		(this_or_next|eq,":troop_id","trp_saxon_bannerman"),
                (this_or_next|eq,":troop_id","trp_picto_portaestandarte"),
		(this_or_next|eq,":troop_id","trp_engle_bannerman"),
		(this_or_next|eq,":troop_id","trp_irish_bannerman"),
                (eq,":troop_id","trp_jute_portaestandarte"),
         (val_add, ":initial_courage_score", 400), 
                (else_try), 
                (this_or_next|eq,":troop_id","trp_jute_cleric"),
		(this_or_next|eq,":troop_id","trp_briton_sacerdote"),
                (this_or_next|eq,":troop_id","trp_saxon_sacerdote"),
		(this_or_next|eq,":troop_id","trp_picto_sacerdote"),
		(this_or_next|eq,":troop_id","trp_pagan_priest"),
		(this_or_next|eq,":troop_id","trp_irish_priest"),
                (eq,":troop_id","trp_engle_rxpriest"),
         (val_add, ":initial_courage_score", 100), 
                (else_try), 
		(this_or_next|eq,":troop_id","trp_picto_cuerno"),
                (eq,":troop_id","trp_todos_cuerno"),
         (val_add, ":initial_courage_score", 300), 
                (try_end), 
#anade corage a tropas al inicio de batalla chief acaba       
         
         (store_random_in_range, ":randomized_addition_courage", 0, 2500), #average : 1500 chief reduce a 2500
         (val_add, ":initial_courage_score", ":randomized_addition_courage"), 
                   
         (agent_get_party_id, ":agent_party", ":agent_no"),         
         (party_get_morale, ":cur_morale", ":agent_party"),
         
         (store_sub, ":morale_effect_on_courage", ":cur_morale", 70),
         (val_mul, ":morale_effect_on_courage", 30), #this can effect morale with -2100..900
         (val_add, ":initial_courage_score", ":morale_effect_on_courage"), 
         
         #average = 5000 + 700 + 1500 = 7200; min : 5700, max : 8700
         #morale effect = min : -2100(party morale is 0), average : 0(party morale is 70), max : 900(party morale is 100)
         #min starting : 3600, max starting  : 9600, average starting : 7200
         (agent_set_slot, ":agent_no", "slot_agent_courage_score", ":initial_courage_score"),
         ]),

      common_battle_init_banner,
		 
      (ti_on_agent_killed_or_wounded, 0, 0, [],
       [
        (store_trigger_param_1, ":dead_agent_no"),
        (store_trigger_param_2, ":killer_agent_no"),
        (store_trigger_param_3, ":is_wounded"),

        (try_begin),
          (ge, ":dead_agent_no", 0),
          (neg|agent_is_ally, ":dead_agent_no"),
          (agent_is_human, ":dead_agent_no"),
          (agent_get_troop_id, ":dead_agent_troop_id", ":dead_agent_no"),
#menos casualties bajas chief blood
          (party_add_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1), #addition_to_p_total_enemy_casualties
          (eq, ":is_wounded", 1),
          (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1),
        (try_end),
#F123 - 1.41 -> Submod (Text related to casualties was here)
#puesto off chief para bajas reales
##          (str_store_troop_name, s6, ":dead_agent_troop_id"),
##          (assign, reg0, ":dead_agent_no"),
##          (assign, reg1, ":killer_agent_no"),
##          (assign, reg2, ":is_wounded"),
##          (agent_get_team, reg3, ":dead_agent_no"),          
##          #(display_message, "@{!}dead agent no : {reg0} ; killer agent no : {reg1} ; is_wounded : {reg2} ; dead agent team : {reg3} ; {s6} is added"), 
##          (party_add_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1), #addition_to_p_total_enemy_casualties
##          (eq, ":is_wounded", 1),
##          (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1), 
##        (try_end),

        (call_script, "script_apply_death_effect_on_courage_scores", ":dead_agent_no", ":killer_agent_no"),
       ]),
      
####escenas unicas chief para batallas unique battlefields
      (0, 0, 0,[(key_clicked, key_k)],[(tutorial_message, "@ ")]),

      (10,0,ti_once,[(gt,"$battle_type",0)], [
        (tutorial_message_set_size, 19, 19),
        (tutorial_message_set_position, 500, 650),
        (tutorial_message_set_center_justify, 0),
        (tutorial_message_set_background, 1),
# (team_give_order, 1, grc_everyone,  mordr_use_any_weapon),
# (team_give_order, 0, grc_everyone,  mordr_use_any_weapon),
(try_begin),
                        (ge, "$cheat_mode", 1),
                        (display_message, "@{!}DEBUG:calling use all weapons in battletype"),
        (try_end),

        (try_begin),
            (eq,"$battle_type",1),
            (tutorial_message, "@ Scout report: --Sir, be careful! The enemy is on the other side of the estuary.--^^One of your men sighes: --This site is beautiful. It's a shame that soon the water will run stained with blood.--^^(press K to finish reading)"),
            (display_log_message, "@ Scout report: Sir, be careful! The enemy is on the other side of the estuary.",color_good_news),
            (display_log_message, "@ One of your men sighes, \"This site is beautiful. It's a shame that soon the water will run stained with blood.\"",color_good_news),
        (else_try),
            (eq,"$battle_type",2),
            (tutorial_message, "@ Scout report: --Lord, I do not see the enemy. We lost their track.--^^One of your men screams: --By the Gods! there!, AMBUSH!!!--^^(press K to finish reading)"),
            (display_log_message, "@ Scout report: Lord, I do not see the enemy. We lost their track.",color_good_news),
            (display_log_message, "@ One of your men screams, \"By the Gods! there!, AMBUSH!!!.\"",color_good_news),
        (else_try),
            (eq,"$battle_type",3),
            (tutorial_message, "@ Scout report: --Sir, there, across the River. Can you see them?--^^One of your men smiles: --Hey, look at those chickens! go catch a few for the pot tonight.--^^Another man replies: --These people are hungry because of the war. Don't ever steal anything, OK?--^^(press K to finish reading)"),
            (display_log_message, "@ Scout report: Sir, there, across the River. Can you see them?",color_good_news),
            (display_log_message, "@ One of your men smiles, \"Hey, look at those chickens! I have to catch a few for the pot tonight.\"",color_good_news),
            (display_log_message, "@ Another man replies, \"These people are hungry because of the war. Don't ever steal anything, OK?\"",color_good_news),
        (else_try),
            (eq,"$battle_type",4),
            (tutorial_message, "@ Scout report: --Sir, I found a monastery there before. It seems to have been looted and the place is now in enemy hands.--^^One of your men cries out: --In the name of Christ, in this land nobody respects the sacred. Kill them all!--^^(press K to finish reading)"),
            (display_log_message, "@ Scout report: Sir, I found a monastery there before. It seems to have been looted and the place is now in enemy hands.",color_good_news),
            (display_log_message, "@ One of your men cries out, \"In the name of Christ, in this land nobody respects the sacred. Kill them all!\"",color_good_news),
        (else_try),
            (eq,"$battle_type",5),
            (tutorial_message, "@ Scout report: --Sir, this village is empty. The villagers have fled.--^^One of your men points to the horizon: --someone is coming!--^^(press K to finish reading)"),
            (display_log_message, "@ Scout report: Sir, this village is empty. The villagers have fled.",color_good_news),
            (display_log_message, "@ One of your men points to the horizon. \"Someone is coming!\"",color_good_news),
        (else_try),
            (eq,"$battle_type",6),
            (tutorial_message, "@ Scout report: --Sir, this is a perfect spot for an ambush. Our supply train is very exposed.--^^One of your men tells you: --The horses refuse to move. We're making a defensive circle with the carts.--^^(press K to finish reading)"),
            (display_log_message, "@ Scout report: Sir, this is a perfect spot for an ambush. Our supply train is very exposed.",color_good_news),
            (display_log_message, "@ One of your men tells you. \"The horses refuse to move. We're making a defensive circle with the carts.\"",color_good_news),
        (else_try),
            (eq,"$battle_type",7),
            (tutorial_message, "@ Scout report: --Sir, the hill is ours. The enemy is in full view below.--^^A man whispers to his companion: --Many battles are not what you expect. In the end we all die.--^^(press K to finish reading)"),
            (display_log_message, "@ Scout report: Sir, the hill is ours. The enemy is in full view below.",color_good_news),
            (display_log_message, "@ A man whispers to his companion, \"Many battles are not what you expect. In the end we all die.\"",color_good_news),
        (else_try),
            (eq,"$battle_type",8),
            (tutorial_message, "@ Scout report: --Sir, the enemy has occupied an abandoned city.^^(press K to finish reading)"),
            (display_log_message, "@ Scout report: Sir, the enemy has occupied an abandoned city.",color_good_news),
        (else_try),
            (eq,"$battle_type",9),
            (tutorial_message, "@ Scout report: --My Lord, we are in Haestingas territory. That hill would be a good position.--^^A man whispers to his companion: --It seems the enemy had the same thought.--^^(press K to finish reading)"),
            (display_log_message, "@ Scout report: My Lord, we are in Haestingas territory. That hill would be a good position.",color_good_news),
            (display_log_message, "@ A man whispers to his companion, \"It seems the enemy had the same thought.\"",color_good_news),
        (else_try),
            (eq,"$battle_type",10),
            (tutorial_message, "@ Scout report: --Sir, this place gives me chills. We could be ambushed at any time.--^^A man whispers to you: --Sir, this site is cursed.--^^(press K to finish reading)"),
            (display_log_message, "@ Scout report: Sir, this place gives me chills. We could be ambushed at any time.",color_good_news),
            (display_log_message, "@ A man whispers to you, \"Sir, this site is cursed.\"",color_good_news),
         (else_try),
            (eq,"$battle_type",11),
            (tutorial_message, "@ Scout report: --Sir, the enemy is down. They are already ours. Ambush him!--^^(press K to finish reading)"),
            (display_log_message, "@ Scout report: Sir, the enemy is down. They are already ours. Ambush him!",color_good_news),
         (else_try),
            (eq,"$battle_type",12),
            (tutorial_message, "@ Scout report: --Sir, look at that hill. There they are!--^^A man screams: --By the gods, victory or death!--^^(press K to finish reading)"),
            (display_log_message, "@ Scout report: Sir, look at that hill. There they are!",color_good_news),
            (display_log_message, "@ A man screams, \"By the gods, victory or death!\"",color_good_news),
         (else_try),
            (eq,"$battle_type",13),
            (tutorial_message, "@ Scout report: --Sir, we have cornered the enemy.--^^A man screams: --Everyone ready? They're coming!--^^(press K to finish reading)"),
            (display_log_message, "@ Scout report: Sir, we have cornered the enemy.",color_good_news),
            (display_log_message, "@ A man screams, \"Everyone ready? They're coming!",color_good_news),
         (else_try),
            (eq,"$battle_type",14),
            (tutorial_message, "@ Scout report: --The enemy has deployed near the stone circles. Our men are afraid of the magic of the old religion.--^^A man says to you: --My dear Lord, now would be a good time to raise the troops' morale!--^^(press K to finish reading)"),
            (display_log_message, "@ Scout report: The enemy has deployed near the stone circles. Our men are afraid of the magic of the old religion.",color_good_news),
            (display_log_message, "@ A man says to you, \"My dear Lord, now would be a good time to raise the troops' morale!\"",color_good_news),
         (else_try),
            (eq,"$battle_type",15),
            (tutorial_message, "@ Scout report: --We've reached an ancient monument, rows of stones. But the real obstacle is the enemy lining up on the other side of the brook.--^^You reply: --Rows of stones you say? Let us make them tomb stones for the enemy then!--^^(press K to finish reading)"),
            (display_log_message, "@ Scout report: We've reached an ancient monument, rows of stones. But the real obstacle is the enemy lining up on the other side of the brook.",color_good_news),
            (display_log_message, "@ You reply, \"Rows of stones you say? Let us make them tomb stones for the enemy then!\"",color_good_news),
         (else_try),
            (eq,"$battle_type",16),
            (tutorial_message, "@ Scout report: --We have taken up positions in an abandoned fort on the hill.--^^A man says: --This place smells of death.--^^(press K to finish reading)"),
            (display_log_message, "@ Scout report: We have taken up positions in an abandoned fort on the hill.",color_good_news),
            (display_log_message, "@ A man says, \"This place smells of death.\"",color_good_news),
         (else_try),
            (eq,"$battle_type",17),
            (tutorial_message, "@ Scout report: --A bog lies before us so we must be wary. Stay on the path!--^^A man tugs on your sleeve: --What is that in the trees up ahead? Evil lurks here.--^^(press K to finish reading)"),
            (display_log_message, "@ Scout report: A bog lies before us so we must be wary. Stay on the path!",color_good_news),
            (display_log_message, "@ A man tugs on your sleeve, \"What is that in the trees up ahead? Evil lurks here.\"",color_good_news),
         (else_try),
            (eq,"$battle_type",18),
            (tutorial_message, "@ While searching for useful items in a recently ransacked and abandoned Roman fort, the scout informs you:^^--Commander, we can not linger here much longer. The enemy is spotted behind the hill. What are your orders?--^^(press K to finish reading)"),
            (display_log_message, "@ While searching for useful items in a recently ransacked and abandoned Roman fort, the scout informs you:",color_good_news),
            (display_log_message, "@ Commander, we can not linger here much longer. The enemy is spotted behind the hill. What are your orders?",color_good_news),
         (else_try),
            (eq,"$battle_type",19),
            (tutorial_message, "@ Stretched out before you as far as the eye can see stand the remains of a once great wall. The enemy has taken up position just on the other side.^^A witty person next to you mutters: --Let's hope it will protect us better than it did the Romans.--^^(press K to finish reading)"),
         (else_try),
            (eq,"$battle_type",20),
            (tutorial_message, "@ The scout returns and informs you, \"The enemy is spotted behind the village. The villagers have fled the fields and sought safety in one of the houses. They know all too well the horrors of war.\"^^\"As do we... As do we...\" you find yourself mumbling.^^(press K to finish reading)"),
         (else_try),
            (eq,"$battle_type",21),
            (tutorial_message, "@ The scout returns and informs you, \"The enemy is spotted behind the forest. They have taken up position just on the other side of magic stones.\"^^(press K to finish reading)"),
         (else_try),
            (eq,"$battle_type",22),
            (tutorial_message, "@ Scout report: The chirping of birds has ceased. Like us, they know something is afoot. The enemy is just beyond the brooklet. This is where we take our stand!'^^(press K to finish reading)"),
         (else_try),
            (eq,"$battle_type",23),
            (tutorial_message, "@ Scout report: Sir, in front of us is a dam. We should be careful.'^^(press K to finish reading)"),
        (try_end),
        
        (assign,"$battle_type",0),
      ]),

####escenas unicas chief acaba

      common_battle_tab_press,
#chief bajas reales
##      (ti_question_answered, 0, 0, [],
##       [(store_trigger_param_1,":answer"),
##        (eq,":answer",0),
##        (assign, "$pin_player_fallen", 0),
##        (try_begin),
##          (store_mission_timer_a, ":elapsed_time"),
##          (gt, ":elapsed_time", 20),
##          (str_store_string, s5, "str_retreat"),
##          (call_script, "script_simulate_retreat", 10, 20, 1),
##        (try_end),
##        (call_script, "script_count_mission_casualties_from_agents"),
##        (finish_mission,0),]),

     (ti_question_answered, 0, 0, [],[
       (store_trigger_param_1,":answer"),
       (eq,":answer",0),
       (assign, "$pin_player_fallen", 0),
       (store_mission_timer_a, ":elapsed_time"),
       (try_begin),
           (gt, ":elapsed_time", 20),
           (assign, "$g_battle_result", -2),
           (str_store_string, s5, "str_retreat"),
           (call_script, "script_change_player_party_morale", -25), #chief cambia a mas
           (call_script, "script_simulate_retreat", 10, 20, 0),
       (else_try),
           (assign, "$g_battle_result", -3),
           (call_script, "script_change_player_party_morale", -50), #chief cambia a mas
       (try_end),
       (call_script, "script_count_mission_casualties_from_agents"),
       (finish_mission,0),]),
      ###chief bajas reales acaba


      (ti_before_mission_start, 0, 0, [],
       [
         (team_set_relation, 0, 2, 1),
         (team_set_relation, 1, 3, 1),
         (call_script, "script_place_player_banner_near_inventory_bms"),

         (party_clear, "p_routed_enemies"),

         (assign, "$g_latest_order_1", 1), 
         (assign, "$g_latest_order_2", 1), 
         (assign, "$g_latest_order_3", 1), 
         (assign, "$g_latest_order_4", 1), 
         ]),

      
      (0, 0, ti_once, [], [(assign,"$g_battle_won",0),
                           (assign,"$defender_reinforcement_stage",0),
                           (assign,"$attacker_reinforcement_stage",0),
                           (call_script, "script_place_player_banner_near_inventory"),
                           (call_script, "script_combat_music_set_situation_with_culture"),
#                           (assign, "$g_defender_reinforcement_limit", "$g_reinforcement_stage"), ## CC chief cambia
                           (assign, "$g_defender_reinforcement_limit", 2), #original
                           ##diplomacy chief begin
                           (assign, "$g_dplmc_cam_activated", 0),                          
                           ##diplomacy end
                           ]),

      common_music_situation_update,
      common_battle_check_friendly_kills,

      (1, 0, 5, [
                              
      #new (25.11.09) starts (sdsd = TODO : make a similar code to also helping ally encounters)
      #count all total (not dead) enemy soldiers (in battle area + not currently placed in battle area)
      (call_script, "script_party_count_members_with_full_health", "p_collective_enemy"),
      (assign, ":total_enemy_soldiers", reg0),
      
      #decrease number of agents already in battle area to find all number of reinforcement enemies
      (assign, ":enemy_soldiers_in_battle_area", 0),
      (try_for_agents,":cur_agent"),
        (agent_is_human, ":cur_agent"),
        (agent_get_party_id, ":agent_party", ":cur_agent"),
        (try_begin),
          (neq, ":agent_party", "p_main_party"),
          (neg|agent_is_ally, ":cur_agent"),
          (val_add, ":enemy_soldiers_in_battle_area", 1),
        (try_end),
      (try_end),
      (store_sub, ":total_enemy_reinforcements", ":total_enemy_soldiers", ":enemy_soldiers_in_battle_area"),

      (try_begin),
        (lt, ":total_enemy_reinforcements", 15),
        (ge, "$defender_reinforcement_stage", 2),
        (eq, "$defender_reinforcement_limit_increased", 0),
        (val_add, "$g_defender_reinforcement_limit", 1),                    
        (assign, "$defender_reinforcement_limit_increased", 1),
      (try_end),    
      #new (25.11.09) ends
      (lt,"$defender_reinforcement_stage","$g_defender_reinforcement_limit"),
                 (store_mission_timer_a,":mission_time"),
                 (ge,":mission_time",10),
                 (store_normalized_team_count,":num_defenders", 0),
                 (lt,":num_defenders",14)],
           [(add_reinforcements_to_entry,0,7),(assign, "$defender_reinforcement_limit_increased", 0),(val_add,"$defender_reinforcement_stage",1)]),
      
      (1, 0, 5, [(lt,"$attacker_reinforcement_stage",2), #original
#      (1, 0, 5, [(lt,"$attacker_reinforcement_stage","$g_reinforcement_stage"), ## CC chief cambia
                 (store_mission_timer_a,":mission_time"),
                 (ge,":mission_time",10),
                 (store_normalized_team_count,":num_attackers", 1),
                 (lt,":num_attackers",13)],
           [(add_reinforcements_to_entry,3,7),(val_add,"$attacker_reinforcement_stage",1)]),

      common_battle_check_victory_condition,
      common_battle_victory_display,

      (1, 4, 
      ##diplomacy chief begin
      0,
      ##diplomacy end 
      [(main_hero_fallen)],
          [
              ##diplomacy chief begin
              (try_begin),
                (eq, "$g_dplmc_battle_continuation", 0),
                (assign, ":num_allies", 0),
                (try_for_agents, ":agent"),
                 (agent_is_ally, ":agent"),
                 (agent_is_alive, ":agent"),
                 (val_add, ":num_allies", 1),
                (try_end),  
                (gt, ":num_allies", 0),              
                (try_begin),
                  (eq, "$g_dplmc_cam_activated", 0),
                  #(store_mission_timer_a, "$g_dplmc_main_hero_fallen_seconds"),
                  (assign, "$g_dplmc_cam_activated", 1),
              (display_message, "@You have been knocked out by the enemy. Watch your men continue the fight without you or press Tab to retreat."),
                 (display_message, "@To watch the fight you can use 'w, a, s, d', and rotate the cam."),
                (try_end),
              (else_try),
              ##diplomacy end              
              (assign, "$pin_player_fallen", 1),
              (str_store_string, s5, "str_retreat"),
              (call_script, "script_simulate_retreat", 10, 20, 1),
              (assign, "$g_battle_result", -1),
              (set_mission_result,-1),
              (call_script, "script_count_mission_casualties_from_agents"),
              (finish_mission,0),
              ##diplomacy chief begin
              (try_end),
              ##diplomacy end  
            ]),

      common_battle_inventory,
	
      (3, 0, 0, [
          (call_script, "script_apply_effect_of_other_people_on_courage_scores"),
              ], []), #calculating and applying effect of people on others courage scores

     (3, 0, 0, [
          (try_for_agents, ":agent_no"),
            (agent_is_human, ":agent_no"),
            (agent_is_alive, ":agent_no"),          
            (store_mission_timer_a,":mission_time"),
            (ge,":mission_time",3),          
            (call_script, "script_decide_run_away_or_not", ":agent_no", ":mission_time"),
          (try_end),          
              ], []), #controlling courage score and if needed deciding to run away for each agent

#anadido caba'drin para que la caballeria que le muere caballo actue con la infanteria chief desmontados
##      (ti_on_agent_spawn, 0, 0, [(store_trigger_param_1, ":agent"),(neg|agent_is_human, ":agent")],
##   [
##    (store_trigger_param_1, ":horse"),
##     
##     (agent_get_rider, ":rider", ":horse"),
##     (ge, ":rider", 0),
##     (agent_is_alive, ":rider"),
##     (agent_is_non_player, ":rider"),
##     
##     (agent_set_slot, ":horse", "slot_agent_horse_rider", ":rider"),
##   ]),
##   
##
## (ti_on_agent_killed_or_wounded, 0, 0, [(store_trigger_param_1, ":agent"),(neg|agent_is_human, ":agent")],
##   [
##    (store_trigger_param_1, ":dead_horse"),
##     
##     (agent_get_slot, ":rider", ":dead_horse", "slot_agent_horse_rider"),
##     (agent_is_active, ":rider"),
##     # (agent_is_alive, ":rider"),
##     (agent_is_non_player, ":rider"),
##     
##     (agent_set_division, ":rider", grc_infantry),
##   ]),
#chief acaba
      
##      (5, 0, 0, [
##          (store_mission_timer_a,":mission_time"),
##
##          (ge,":mission_time",3),
##          
##          (call_script, "script_battle_tactic_apply"),
##          ], []), #applying battle tactic
#puesto off chief acaba
		#flail_trigger = 
		(0, 0, 0, [
			(neg|multiplayer_is_dedicated_server),],
			    [
					(try_for_agents, ":agent_no"),
						(agent_is_active, ":agent_no"),
						(agent_is_alive, ":agent_no"),
						(agent_slot_eq, ":agent_no", "slot_agent_flail_using", 1),
						(agent_get_wielded_item, ":wielded_weapon", ":agent_no", 0),
						(try_begin),
							(this_or_next|eq, ":wielded_weapon", "itm_flail1_blunt"),
							(this_or_next|eq, ":wielded_weapon", "itm_flail2_blunt"),
							(eq, ":wielded_weapon", "itm_flailsteel_blunt"),
							(agent_get_wielded_item_slot_no, ":slot_no", ":agent_no"),
							(val_add, ":slot_no", bmm_item_1),
							(agent_get_animation, ":upper_anim", ":agent_no", 1),
							(try_begin),
								(this_or_next|eq, ":upper_anim", "anim_release_slashright_onehanded"),
								#(this_or_next|eq, ":upper_anim", "anim_release_slashright_onehanded_continue"),
								#(this_or_next|eq, ":upper_anim", "anim_release_slashleft_onehanded_continue"),
								(this_or_next|eq, ":upper_anim", "anim_release_slashleft_onehanded"),
								(this_or_next|eq, ":upper_anim", "anim_release_overswing_onehanded"),
								(this_or_next|eq, ":upper_anim", "anim_release_slash_horseback_right"),
								(eq, ":upper_anim", "anim_release_slash_horseback_left"),
										
								(agent_get_animation_progress, ":animation_progress", ":agent_no", 1),
								(store_mul, ":vertex_animation_time", 55, ":animation_progress"),
								(val_div, ":vertex_animation_time", 100),
								(val_add, ":vertex_animation_time", 10),
								(agent_body_meta_mesh_set_vertex_keys_time_point, ":agent_no", ":slot_no", ":vertex_animation_time"),
							(else_try),
								(agent_body_meta_mesh_set_vertex_keys_time_point, ":agent_no", ":slot_no", 65),
								(agent_set_slot, ":agent_no", "slot_agent_flail_using", 0),
							(try_end),
						(else_try),
							(agent_set_slot, ":agent_no", "slot_agent_flail_using", 0),
						(try_end),
					(try_end),
				]),
#flail_wielding_trigger = 
		(
		ti_on_item_wielded, 0, 0, [
		(neg|multiplayer_is_dedicated_server),],
	    [
			(store_trigger_param_1, ":agent_no"),
	        (store_trigger_param_2, ":item_no"),
			#(eq, ":item_no", "itm_flail"),
			(this_or_next|eq, ":item_no", "itm_flail1_blunt"),
			(this_or_next|eq, ":item_no", "itm_flail2_blunt"),
			(eq, ":item_no", "itm_flailsteel_blunt"),
			(agent_get_bone_position,pos1,":agent_no",hb_item_r, 1),##this was used for 1st flail pack -multiplayer
			#(play_sound_at_position, "snd_draw_flail", pos1),
			(agent_play_sound, ":agent_no", "snd_draw_flail"),
		]),

      common_battle_order_panel,
      common_battle_order_panel_tick,

   ]+ AI_triggers + heridas_chel + dplmc_battle_mode_triggers + formations_triggers + order_volley_triggers + rider_damage + warcry_chel +flail_triggers,
	 

  ),
#chief diplomacy anadido encima

####rigale chief emboscada

    # RIGALE AMBUSH SCENE
 
 (
    "lead_charge_ambush",mtf_battle_mode|mtf_synch_inventory,charge,
    "You lead your men to battle.",
    [
 #    (0,mtef_defenders|mtef_team_0,0,aif_start_alarmed,2,[]),
	 #MOTO have ambushed be surprised (not start_alarmed)
     (1,mtef_defenders|mtef_team_0,0,0,2,[]),
     (2,mtef_defenders|mtef_team_0,0,0,2,[]),
     (3,mtef_defenders|mtef_team_0,0,0,2,[]),
     (4,mtef_defenders|mtef_team_0,0,0,2,[]),
	 #MOTO have ambushed be surprised (not start_alarmed)
#     (0,mtef_defenders|mtef_team_0,0,aif_start_alarmed,2,[]),
     # (1,mtef_defenders|mtef_team_0,0,2,[]),
     # (2,mtef_defenders|mtef_team_0,0,2,[]),
     # (3,mtef_defenders|mtef_team_0,0,2,[]),
     # (4,mtef_defenders|mtef_team_0,0,2,[]),
	 
	 (5,mtef_attackers|mtef_team_1|mtef_archers_first,0,aif_start_alarmed,2,[]),
     (6,mtef_attackers|mtef_team_1|mtef_archers_first,0,aif_start_alarmed,2,[]),	 
     (7,mtef_attackers|mtef_team_1|mtef_archers_first,0,aif_start_alarmed,2,[]),
	 (8,mtef_attackers|mtef_team_1|mtef_archers_first,0,aif_start_alarmed,2,[]),	 
	 (9,mtef_attackers|mtef_team_1|mtef_cavalry_first,0,aif_start_alarmed,2,[]),
	 (10,mtef_attackers|mtef_team_1|mtef_cavalry_first,0,aif_start_alarmed,2,[]),
	 (11,mtef_attackers|mtef_team_1,0,aif_start_alarmed,2,[]),
     (12,mtef_attackers|mtef_team_1,0,aif_start_alarmed,2,[]),	 
     (13,mtef_attackers|mtef_team_1,0,aif_start_alarmed,2,[]),
	 (14,mtef_attackers|mtef_team_1,0,aif_start_alarmed,2,[]),	 
	 (15,mtef_attackers|mtef_team_1,0,aif_start_alarmed,2,[]),
	 (16,mtef_attackers|mtef_team_1,0,aif_start_alarmed,2,[]),
	 
     ],
     common_weapon_check + common_ai_order_toggle +
     [
      (ti_on_agent_spawn, 0, 0, [],
       [
#        (team_give_order, 1, grc_everyone,  mordr_use_any_weapon),
# (team_give_order, 0, grc_everyone,  mordr_use_any_weapon),
(try_begin),
                        (ge, "$cheat_mode", 1),
                        (display_message, "@{!}DEBUG:calling use all weapons in battletype"),
        (try_end),

         (store_trigger_param_1, ":agent_no"),
         (call_script, "script_agent_reassign_team", ":agent_no"),

         (assign, ":initial_courage_score", 4000), #chief cambia a 3500, menos corage al principio
                  
         (agent_get_troop_id, ":troop_id", ":agent_no"),
         (store_character_level, ":troop_level", ":troop_id"),
         (val_mul, ":troop_level", 35), #chief aumenta a 35 moral por nivel de tropa
         (val_add, ":initial_courage_score", ":troop_level"), #average : 20 * 35 = 700
#anade corage a tropas al inicio de batalla chief
         (agent_get_troop_id, ":troop_id", ":agent_no"),
         (try_begin),
                (this_or_next|eq,":troop_id","trp_briton_bannerman"),
		(this_or_next|eq,":troop_id","trp_saxon_bannerman"),
                (this_or_next|eq,":troop_id","trp_picto_portaestandarte"),
		(this_or_next|eq,":troop_id","trp_engle_bannerman"),
		(this_or_next|eq,":troop_id","trp_irish_bannerman"),
                (eq,":troop_id","trp_jute_portaestandarte"),
         (val_add, ":initial_courage_score", 400), 
                (else_try), 
                (this_or_next|eq,":troop_id","trp_jute_cleric"),
		(this_or_next|eq,":troop_id","trp_briton_sacerdote"),
                (this_or_next|eq,":troop_id","trp_saxon_sacerdote"),
		(this_or_next|eq,":troop_id","trp_picto_sacerdote"),
		(this_or_next|eq,":troop_id","trp_pagan_priest"),
		(this_or_next|eq,":troop_id","trp_irish_priest"),
                (eq,":troop_id","trp_engle_rxpriest"),
         (val_add, ":initial_courage_score", 100), 
                (else_try), 
		(this_or_next|eq,":troop_id","trp_picto_cuerno"),
                (eq,":troop_id","trp_todos_cuerno"),
         (val_add, ":initial_courage_score", 300), 
                (try_end), 
#anade corage a tropas al inicio de batalla chief acaba       
         (store_random_in_range, ":randomized_addition_courage", 0, 2000), #rigale tweak
         (val_add, ":initial_courage_score", ":randomized_addition_courage"), 
                   
         (agent_get_party_id, ":agent_party", ":agent_no"),         
         (party_get_morale, ":cur_morale", ":agent_party"),
         
         (store_sub, ":morale_effect_on_courage", ":cur_morale", 70),
         (val_mul, ":morale_effect_on_courage", 30), #this can effect morale with -2100..900
         (val_add, ":initial_courage_score", ":morale_effect_on_courage"), 
         
         #average = 5000 + 700 + 1500 = 7200; min : 5700, max : 8700
         #morale effect = min : -2100(party morale is 0), average : 0(party morale is 70), max : 900(party morale is 100)
         #min starting : 3600, max starting  : 9600, average starting : 7200
         (agent_set_slot, ":agent_no", "slot_agent_courage_score", ":initial_courage_score"),
         ]),
		  	  
      common_battle_init_banner,
      
      (ti_on_agent_killed_or_wounded, 0, 0, [],
       [
        (store_trigger_param_1, ":dead_agent_no"),
        (store_trigger_param_2, ":killer_agent_no"),
        (store_trigger_param_3, ":is_wounded"),

        (try_begin),
          (ge, ":dead_agent_no", 0),
          (neg|agent_is_ally, ":dead_agent_no"),
          (agent_is_human, ":dead_agent_no"),
          (agent_get_troop_id, ":dead_agent_troop_id", ":dead_agent_no"),
##          (str_store_troop_name, s6, ":dead_agent_troop_id"),
##          (assign, reg0, ":dead_agent_no"),
##          (assign, reg1, ":killer_agent_no"),
##          (assign, reg2, ":is_wounded"),
##          (agent_get_team, reg3, ":dead_agent_no"),          
          #(display_message, "@{!}dead agent no : {reg0} ; killer agent no : {reg1} ; is_wounded : {reg2} ; dead agent team : {reg3} ; {s6} is added"), 
          (party_add_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1), #addition_to_p_total_enemy_casualties
          (eq, ":is_wounded", 1),
          (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1), 
        (try_end),

        (call_script, "script_apply_death_effect_on_courage_scores", ":dead_agent_no", ":killer_agent_no"),
       ]),

      common_battle_tab_press,


      (ti_question_answered, 0, 0, [],
       [(store_trigger_param_1,":answer"),
        (eq,":answer",0),
        (assign, "$pin_player_fallen", 0),
        (try_begin),
          (store_mission_timer_a, ":elapsed_time"),
          (gt, ":elapsed_time", 20),
          (str_store_string, s5, "str_retreat"),
           (call_script, "script_change_player_party_morale", -25), #chief cambia a mas
          (call_script, "script_simulate_retreat", 10, 20, 1),
        (try_end),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission,0),]),

      (ti_before_mission_start, 0, 0, [],
       [
         (team_set_relation, 0, 2, 1),
         (team_set_relation, 1, 3, 1),
         (call_script, "script_place_player_banner_near_inventory_bms"),

         (party_clear, "p_routed_enemies"),

         (assign, "$g_latest_order_1", 1), 
         (assign, "$g_latest_order_2", 1), 
         (assign, "$g_latest_order_3", 1), 
         (assign, "$g_latest_order_4", 1), 
         ]),

      
      (0, 0, ti_once, [], [(assign,"$g_battle_won",0),
                           (assign,"$defender_reinforcement_stage",0),
                           (assign,"$attacker_reinforcement_stage",0),
                           (call_script, "script_place_player_banner_near_inventory"),
                           (call_script, "script_combat_music_set_situation_with_culture"),
                           (assign, "$g_defender_reinforcement_limit", 2),
                           ]),

      common_music_situation_update,
      common_battle_check_friendly_kills,

      (1, 0, 5, [
                              
      #new (25.11.09) starts (sdsd = TODO : make a similar code to also helping ally encounters)
      #count all total (not dead) enemy soldiers (in battle area + not currently placed in battle area)
      (call_script, "script_party_count_members_with_full_health", "p_collective_enemy"),
      (assign, ":total_enemy_soldiers", reg0),
      
      #decrease number of agents already in battle area to find all number of reinforcement enemies
      (assign, ":enemy_soldiers_in_battle_area", 0),
      (try_for_agents,":cur_agent"),
        (agent_is_human, ":cur_agent"),
        (agent_get_party_id, ":agent_party", ":cur_agent"),
        (try_begin),
          (neq, ":agent_party", "p_main_party"),
          (neg|agent_is_ally, ":cur_agent"),
          (val_add, ":enemy_soldiers_in_battle_area", 1),
        (try_end),
      (try_end),
      (store_sub, ":total_enemy_reinforcements", ":total_enemy_soldiers", ":enemy_soldiers_in_battle_area"),

      (try_begin),
        (lt, ":total_enemy_reinforcements", 15),
        (ge, "$defender_reinforcement_stage", 2),
        (eq, "$defender_reinforcement_limit_increased", 0),
        (val_add, "$g_defender_reinforcement_limit", 1),                    
        (assign, "$defender_reinforcement_limit_increased", 1),
      (try_end),    
      #new (25.11.09) ends
      
      (lt,"$defender_reinforcement_stage","$g_defender_reinforcement_limit"),
                 (store_mission_timer_a,":mission_time"),
                 (ge,":mission_time",10),
                 (store_normalized_team_count,":num_defenders", 0),
#MOTO fix ambush reinforcements
                 (lt,":num_defenders",9)],#gdw
           [#(add_reinforcements_to_entry,0,7),
		   (add_reinforcements_to_entry,0,1),
		   (add_reinforcements_to_entry,1,1),
		   (add_reinforcements_to_entry,2,1),
		   (add_reinforcements_to_entry,3,1),
		   (assign, "$defender_reinforcement_limit_increased", 0),
		   (val_add,"$defender_reinforcement_stage",1)]),
      
      (1, 0, 5, [(lt,"$attacker_reinforcement_stage",2),
                 (store_mission_timer_a,":mission_time"),
                 (ge,":mission_time",10),
                 (store_normalized_team_count,":num_attackers", 1),
                 (lt,":num_attackers",13)],
           [#(add_reinforcements_to_entry,3,7),
		   (add_reinforcements_to_entry,4,1),
		   (add_reinforcements_to_entry,5,1),
		   (add_reinforcements_to_entry,6,1),
		   (add_reinforcements_to_entry,7,1),
		   (add_reinforcements_to_entry,8,1),
		   (add_reinforcements_to_entry,9,1),
		   (add_reinforcements_to_entry,10,1),
		   (add_reinforcements_to_entry,11,1),
		   (add_reinforcements_to_entry,12,1),
		   (add_reinforcements_to_entry,13,1),
		   (add_reinforcements_to_entry,14,1),
		   (add_reinforcements_to_entry,15,1),
#MOTO end fix ambush reinforcements
		   (val_add,"$attacker_reinforcement_stage",1)]),

      common_battle_check_victory_condition,
      common_battle_victory_display,

      (1, 4, ti_once, [(main_hero_fallen)],
          [
              (assign, "$pin_player_fallen", 1),
              (str_store_string, s5, "str_retreat"),
              (call_script, "script_simulate_retreat", 10, 20, 1),
              (assign, "$g_battle_result", -1),
              (set_mission_result,-1),
              (call_script, "script_count_mission_casualties_from_agents"),
              (finish_mission,0)]),

      common_battle_inventory,
      
      (3, 0, 0, [
          (call_script, "script_apply_effect_of_other_people_on_courage_scores"),
              ], []), #calculating and applying effect of people on others courage scores

      (3, 0, 0, [
          (try_for_agents, ":agent_no"),
            (agent_is_human, ":agent_no"),
            (agent_is_alive, ":agent_no"),          
            (store_mission_timer_a,":mission_time"),
            (ge,":mission_time",3),          
            (call_script, "script_decide_run_away_or_not", ":agent_no", ":mission_time"),
          (try_end),          
              ], []), #controlling courage score and if needed deciding to run away for each agent

#anadido caba'drin para que la caballeria que le muere caballo actue con la infanteria chief desmontados
##      (ti_on_agent_spawn, 0, 0, [(store_trigger_param_1, ":agent"),(neg|agent_is_human, ":agent")],
##   [
##    (store_trigger_param_1, ":horse"),
##     
##     (agent_get_rider, ":rider", ":horse"),
##     (ge, ":rider", 0),
##     (agent_is_alive, ":rider"),
##     (agent_is_non_player, ":rider"),
##     
##     (agent_set_slot, ":horse", "slot_agent_horse_rider", ":rider"),
##   ]),
##   
##
## (ti_on_agent_killed_or_wounded, 0, 0, [(store_trigger_param_1, ":agent"),(neg|agent_is_human, ":agent")],
##   [
##    (store_trigger_param_1, ":dead_horse"),
##     
##     (agent_get_slot, ":rider", ":dead_horse", "slot_agent_horse_rider"),
##     (agent_is_active, ":rider"),
##     # (agent_is_alive, ":rider"),
##     (agent_is_non_player, ":rider"),
##     
##     (agent_set_division, ":rider", grc_infantry),
##   ]),
#chief acaba

      common_battle_order_panel,
      common_battle_order_panel_tick,

    ]+ AI_triggers + heridas_chel + dplmc_battle_mode_triggers + formations_triggers + order_volley_triggers + rider_damage + warcry_chel + flail_triggers,#+common_weapon_check + common_ai_order_toggle,

  ),


  
(
    "lead_charge_ambushed",mtf_battle_mode|mtf_synch_inventory,charge,
    "You lead your men to battle.",
    [
	
 #    (0,mtef_attackers|mtef_team_1,0,aif_start_alarmed,2,[]),
	 #MOTO have ambushed be surprised (not start_alarmed)
     (1,mtef_attackers|mtef_team_1,0,0,2,[]),
     (2,mtef_attackers|mtef_team_1,0,0,2,[]),
     (3,mtef_attackers|mtef_team_1,0,0,2,[]),
     (4,mtef_attackers|mtef_team_1,0,0,2,[]),
	 #MOTO end have ambushed be surprised (not start_alarmed)
#     (0,mtef_attackers|mtef_team_1,0,aif_start_alarmed,2,[]),	 
     # (1,mtef_attackers|mtef_team_1,0,2,[]),
     # (2,mtef_attackers|mtef_team_1,0,2,[]),
     # (3,mtef_attackers|mtef_team_1,0,2,[]),
     # (4,mtef_attackers|mtef_team_1,0,2,[]),
	 
	 (5,mtef_defenders|mtef_team_0|mtef_archers_first,0,aif_start_alarmed,2,[]),
     (6,mtef_defenders|mtef_team_0|mtef_archers_first,0,aif_start_alarmed,2,[]),	 
     (7,mtef_defenders|mtef_team_0|mtef_archers_first,0,aif_start_alarmed,2,[]),
	 (8,mtef_defenders|mtef_team_0|mtef_archers_first,0,aif_start_alarmed,2,[]),	 
	 (9,mtef_defenders|mtef_team_0|mtef_cavalry_first,0,aif_start_alarmed,2,[]),
	 (10,mtef_defenders|mtef_team_0|mtef_cavalry_first,0,aif_start_alarmed,2,[]),
	 (11,mtef_defenders|mtef_team_0,0,aif_start_alarmed,2,[]),
     (12,mtef_defenders|mtef_team_0,0,aif_start_alarmed,2,[]),	 
     (13,mtef_defenders|mtef_team_0,0,aif_start_alarmed,2,[]),
	 (14,mtef_defenders|mtef_team_0,0,aif_start_alarmed,2,[]),	 
	 (15,mtef_defenders|mtef_team_0,0,aif_start_alarmed,2,[]),
	 (16,mtef_defenders|mtef_team_0,0,aif_start_alarmed,2,[]),
	 
     ], common_weapon_check + common_ai_order_toggle +
    [
      (ti_on_agent_spawn, 0, 0, [],
       [
         (store_trigger_param_1, ":agent_no"),
         (call_script, "script_agent_reassign_team", ":agent_no"),

         (assign, ":initial_courage_score", 4000), #chief cambia a 3500, menos corage al principio
                  
         (agent_get_troop_id, ":troop_id", ":agent_no"),
         (store_character_level, ":troop_level", ":troop_id"),
         (val_mul, ":troop_level", 35), #chief aumenta a 35 moral por nivel de tropa
         (val_add, ":initial_courage_score", ":troop_level"), #average : 20 * 35 = 700
#anade corage a tropas al inicio de batalla chief
         (agent_get_troop_id, ":troop_id", ":agent_no"),
         (try_begin),
                (this_or_next|eq,":troop_id","trp_briton_bannerman"),
		(this_or_next|eq,":troop_id","trp_saxon_bannerman"),
                (this_or_next|eq,":troop_id","trp_picto_portaestandarte"),
		(this_or_next|eq,":troop_id","trp_engle_bannerman"),
		(this_or_next|eq,":troop_id","trp_irish_bannerman"),
                (eq,":troop_id","trp_jute_portaestandarte"),
         (val_add, ":initial_courage_score", 400), 
                (else_try), 
                (this_or_next|eq,":troop_id","trp_jute_cleric"),
		(this_or_next|eq,":troop_id","trp_briton_sacerdote"),
                (this_or_next|eq,":troop_id","trp_saxon_sacerdote"),
		(this_or_next|eq,":troop_id","trp_picto_sacerdote"),
		(this_or_next|eq,":troop_id","trp_pagan_priest"),
		(this_or_next|eq,":troop_id","trp_irish_priest"),
                (eq,":troop_id","trp_engle_rxpriest"),
         (val_add, ":initial_courage_score", 100), 
                (else_try), 
		(this_or_next|eq,":troop_id","trp_picto_cuerno"),
                (eq,":troop_id","trp_todos_cuerno"),
         (val_add, ":initial_courage_score", 300), 
                (try_end), 
#anade corage a tropas al inicio de batalla chief acaba       
         (store_random_in_range, ":randomized_addition_courage", 0, 2000), #rigale tweak
         (val_add, ":initial_courage_score", ":randomized_addition_courage"), 
                   
         (agent_get_party_id, ":agent_party", ":agent_no"),         
         (party_get_morale, ":cur_morale", ":agent_party"),
         
         (store_sub, ":morale_effect_on_courage", ":cur_morale", 70),
         (val_mul, ":morale_effect_on_courage", 30), #this can effect morale with -2100..900
         (val_add, ":initial_courage_score", ":morale_effect_on_courage"), 
         
         #average = 5000 + 700 + 1500 = 7200; min : 5700, max : 8700
         #morale effect = min : -2100(party morale is 0), average : 0(party morale is 70), max : 900(party morale is 100)
         #min starting : 3600, max starting  : 9600, average starting : 7200
         (agent_set_slot, ":agent_no", "slot_agent_courage_score", ":initial_courage_score"),
         ]),
  
      common_battle_init_banner,
		 
      (ti_on_agent_killed_or_wounded, 0, 0, [],
       [
        (store_trigger_param_1, ":dead_agent_no"),
        (store_trigger_param_2, ":killer_agent_no"),
        (store_trigger_param_3, ":is_wounded"),

        (try_begin),
          (ge, ":dead_agent_no", 0),
          (neg|agent_is_ally, ":dead_agent_no"),
          (agent_is_human, ":dead_agent_no"),
          (agent_get_troop_id, ":dead_agent_troop_id", ":dead_agent_no"),
##          (str_store_troop_name, s6, ":dead_agent_troop_id"),
##          (assign, reg0, ":dead_agent_no"),
##          (assign, reg1, ":killer_agent_no"),
##          (assign, reg2, ":is_wounded"),
##          (agent_get_team, reg3, ":dead_agent_no"),          
          #(display_message, "@{!}dead agent no : {reg0} ; killer agent no : {reg1} ; is_wounded : {reg2} ; dead agent team : {reg3} ; {s6} is added"), 
          (party_add_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1), #addition_to_p_total_enemy_casualties
          (eq, ":is_wounded", 1),
          (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1), 
        (try_end),

        (call_script, "script_apply_death_effect_on_courage_scores", ":dead_agent_no", ":killer_agent_no"),
       ]),

      common_battle_tab_press,


      (ti_question_answered, 0, 0, [],
       [(store_trigger_param_1,":answer"),
        (eq,":answer",0),
        (assign, "$pin_player_fallen", 0),
        (try_begin),
          (store_mission_timer_a, ":elapsed_time"),
          (gt, ":elapsed_time", 20),
          (str_store_string, s5, "str_retreat"),
           (call_script, "script_change_player_party_morale", -25), #chief cambia a mas
          (call_script, "script_simulate_retreat", 10, 20, 1),
        (try_end),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission,0),]),

      (ti_before_mission_start, 0, 0, [],
       [
         (team_set_relation, 0, 2, 1),
         (team_set_relation, 1, 3, 1),
         (call_script, "script_place_player_banner_near_inventory_bms"),

         (party_clear, "p_routed_enemies"),

         (assign, "$g_latest_order_1", 1), 
         (assign, "$g_latest_order_2", 1), 
         (assign, "$g_latest_order_3", 1), 
         (assign, "$g_latest_order_4", 1), 
         ]),

      
      (0, 0, ti_once, [], [(assign,"$g_battle_won",0),
                           (assign,"$defender_reinforcement_stage",0),
                           (assign,"$attacker_reinforcement_stage",0),
                           (call_script, "script_place_player_banner_near_inventory"),
                           (call_script, "script_combat_music_set_situation_with_culture"),
                           (assign, "$g_defender_reinforcement_limit", 2),
                           ]),

      common_music_situation_update,
      common_battle_check_friendly_kills,

      (1, 0, 5, [
                              
      #new (25.11.09) starts (sdsd = TODO : make a similar code to also helping ally encounters)
      #count all total (not dead) enemy soldiers (in battle area + not currently placed in battle area)
      (call_script, "script_party_count_members_with_full_health", "p_collective_enemy"),
      (assign, ":total_enemy_soldiers", reg0),
      
      #decrease number of agents already in battle area to find all number of reinforcement enemies
      (assign, ":enemy_soldiers_in_battle_area", 0),
      (try_for_agents,":cur_agent"),
        (agent_is_human, ":cur_agent"),
        (agent_get_party_id, ":agent_party", ":cur_agent"),
        (try_begin),
          (neq, ":agent_party", "p_main_party"),
          (neg|agent_is_ally, ":cur_agent"),
          (val_add, ":enemy_soldiers_in_battle_area", 1),
        (try_end),
      (try_end),
      (store_sub, ":total_enemy_reinforcements", ":total_enemy_soldiers", ":enemy_soldiers_in_battle_area"),

      (try_begin),
        (lt, ":total_enemy_reinforcements", 15),
        (ge, "$defender_reinforcement_stage", 2),
        (eq, "$defender_reinforcement_limit_increased", 0),
        (val_add, "$g_defender_reinforcement_limit", 1),                    
        (assign, "$defender_reinforcement_limit_increased", 1),
      (try_end),    
      #new (25.11.09) ends
      
      
      
      
      
      
      (lt,"$defender_reinforcement_stage","$g_defender_reinforcement_limit"),
                 (store_mission_timer_a,":mission_time"),
                 (ge,":mission_time",10),
                 (store_normalized_team_count,":num_defenders", 0),
#MOTO fix ambush reinforcements
                 (lt,":num_defenders",13)],	#1/2 starting numbers#Gdw8
           [#(add_reinforcements_to_entry,0,7),
		   (add_reinforcements_to_entry,4,1),
		   (add_reinforcements_to_entry,5,1),
		   (add_reinforcements_to_entry,6,1),
		   (add_reinforcements_to_entry,7,1),
		   (add_reinforcements_to_entry,8,1),
		   (add_reinforcements_to_entry,9,1),
		   (add_reinforcements_to_entry,10,1),
		   (add_reinforcements_to_entry,11,1),
		   (add_reinforcements_to_entry,12,1),
		   (add_reinforcements_to_entry,13,1),
		   (add_reinforcements_to_entry,14,1),
		   (add_reinforcements_to_entry,15,1),
		   (assign, "$defender_reinforcement_limit_increased", 0),
		   (val_add,"$defender_reinforcement_stage",1)]),
      
      (1, 0, 5, [(lt,"$attacker_reinforcement_stage",2),
                 (store_mission_timer_a,":mission_time"),
                 (ge,":mission_time",10),
                 (store_normalized_team_count,":num_attackers", 1),
                 (lt,":num_attackers",8),	#1/2 starting numbers#gdw5
				 ],
           [#(add_reinforcements_to_entry,3,7),
		   (add_reinforcements_to_entry,0,1),
		   (add_reinforcements_to_entry,1,1),
		   (add_reinforcements_to_entry,2,1),
		   (add_reinforcements_to_entry,3,1),
		   (val_add,"$attacker_reinforcement_stage",1)]),
#MOTO end fix ambush reinforcements

      common_battle_check_victory_condition,
      common_battle_victory_display,

      (1, 4, ti_once, [(main_hero_fallen)],
          [
              (assign, "$pin_player_fallen", 1),
              (str_store_string, s5, "str_retreat"),
              (call_script, "script_simulate_retreat", 10, 20, 1),
              (assign, "$g_battle_result", -1),
              (set_mission_result,-1),
              (call_script, "script_count_mission_casualties_from_agents"),
              (finish_mission,0)]),

      common_battle_inventory,
   
      (3, 0, 0, [
          (call_script, "script_apply_effect_of_other_people_on_courage_scores"),
              ], []), #calculating and applying effect of people on others courage scores

      (3, 0, 0, [
          (try_for_agents, ":agent_no"),
            (agent_is_human, ":agent_no"),
            (agent_is_alive, ":agent_no"),          
            (store_mission_timer_a,":mission_time"),
            (ge,":mission_time",3),          
            (call_script, "script_decide_run_away_or_not", ":agent_no", ":mission_time"),
          (try_end),          
              ], []), #controlling courage score and if needed deciding to run away for each agent

#anadido caba'drin para que la caballeria que le muere caballo actue con la infanteria chief desmontados
##      (ti_on_agent_spawn, 0, 0, [(store_trigger_param_1, ":agent"),(neg|agent_is_human, ":agent")],
##   [
##    (store_trigger_param_1, ":horse"),
##     
##     (agent_get_rider, ":rider", ":horse"),
##     (ge, ":rider", 0),
##     (agent_is_alive, ":rider"),
##     (agent_is_non_player, ":rider"),
##     
##     (agent_set_slot, ":horse", "slot_agent_horse_rider", ":rider"),
##   ]),
##   
##
## (ti_on_agent_killed_or_wounded, 0, 0, [(store_trigger_param_1, ":agent"),(neg|agent_is_human, ":agent")],
##   [
##    (store_trigger_param_1, ":dead_horse"),
##     
##     (agent_get_slot, ":rider", ":dead_horse", "slot_agent_horse_rider"),
##     (agent_is_active, ":rider"),
##     # (agent_is_alive, ":rider"),
##     (agent_is_non_player, ":rider"),
##     
##     (agent_set_division, ":rider", grc_infantry),
##   ]),
#chief acaba
      
      common_battle_order_panel,
      common_battle_order_panel_tick,

    ]+ AI_triggers + heridas_chel + dplmc_battle_mode_triggers + formations_triggers + order_volley_triggers + rider_damage + warcry_chel + flail_triggers,#+common_weapon_check + common_ai_order_toggle,

  ),
####emboscada chief acaba


#chief sot empieza##this is the old mission in ireland's iniau hideout
   (
    "assasination_cummoc",0,-1,
    "Default town visit",
    [(0,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (1,mtef_visitor_source,af_override_horse,0,1,[]),
     ],
    [
##	  (0,0,ti_once,[],
##		[	(mission_enable_talk),
##			(assign, "$talk_context", tc_hero_freed),
##			(try_for_agents,":cur_agent"),
##				(agent_get_troop_id,":cur_troop_id",":cur_agent"),
##				(try_begin),
##					(eq,":cur_troop_id","trp_sea_raider_leader"),
##					(assign,"$old_1",":cur_agent"),
##				(try_end),
##			(try_end),
##		]),

     (0, 0, ti_once, [],[
                       (assign, ":not_alive", 0),
                       (try_begin),
                         (call_script, "script_cf_troop_agent_is_alive", "trp_sea_raider_leader"),
                       (else_try),
                         (assign, ":not_alive", 1),
                       (try_end),
                       (try_begin),
                       (main_hero_fallen),
          (finish_mission),        
         (leave_encounter),
        (change_screen_return),
                       (else_try),
                       (eq, ":not_alive",1),
                (display_message, "@ You have beaten the old hero, you have begun your journey to the legend."),
                       (troop_add_item, "trp_player", "itm_dux_ridge_helm_goldres",0),
                       (troop_add_item, "trp_player", "itm_mailnoble_dkgrnclk",0),
                (call_script, "script_troop_add_gold", "trp_player", 550),
		(call_script, "script_change_troop_renown", "trp_player", 20),
                       		 (assign,"$g_hero_result",1),
                       (finish_mission),
                       (leave_encounter),
                       (change_screen_return),
                       (try_end),
                       ]),

                        (0.1, 0, ti_once, [
            (store_skill_level,":player_sneaking_skill","skl_athletics","trp_player"),

                       
                       (try_begin),
                       (eq,":player_sneaking_skill",10),
                (assign,":sneak_distance",500),
            (else_try),
                (eq,":player_sneaking_skill",9),
                (assign,":sneak_distance",600),
            (else_try),
                (eq,":player_sneaking_skill",8),
                (assign,":sneak_distance",700),
            (else_try),
                (eq,":player_sneaking_skill",7),
                (assign,":sneak_distance",800),
            (else_try),
                (eq,":player_sneaking_skill",6),
                (assign,":sneak_distance",900),
            (else_try),
                (eq,":player_sneaking_skill",5),
                (assign,":sneak_distance",1000),
            (else_try),
                (eq,":player_sneaking_skill",4),
                (assign,":sneak_distance",1100),
            (else_try),
                (eq,":player_sneaking_skill",3),
                (assign,":sneak_distance",1200),
            (else_try),
                (eq,":player_sneaking_skill",2),
                (assign,":sneak_distance",1300),
            (else_try),
                (eq,":player_sneaking_skill",1),
                (assign,":sneak_distance",1400),
            (else_try),
                (assign,":sneak_distance",1500),
           (try_end),
        (get_player_agent_no,":player_agent"),
	(agent_get_position,pos1,":player_agent"),
	(assign,":continue",0),
	(try_for_agents, ":cur_agent"),
		(agent_get_troop_id, ":cur_agent_troop", ":cur_agent"),
		(eq, ":cur_agent_troop", "trp_sea_raider_leader"),
             (assign,"$old_1",":cur_agent"),
		(agent_get_position,pos2,":cur_agent"),
		(get_distance_between_positions,":distance",pos1,pos2),
		(lt,":distance",":sneak_distance"),
		(assign,":continue",1),
	(try_end),
	(eq,":continue",1),
            ],
           [(set_party_battle_mode),
            (try_for_agents, ":cur_agent"),
              (agent_get_troop_id, ":cur_agent_troop", ":cur_agent"),
              (eq, ":cur_agent_troop", "trp_sea_raider_leader"),
            (agent_set_team, ":cur_agent", 1),
            (try_end),
             ]),

###para items si esta vivo
      (2, 0, ti_once, [ (neg|agent_is_alive,"$old_1"),], 
	   [
                (display_message, "@ You have beaten the old hero, you have begun your journey to the legend."),
                       (troop_add_item, "trp_player", "itm_dux_ridge_helm_goldres",0),
                (call_script, "script_troop_add_gold", "trp_player", 550),
		(call_script, "script_change_troop_renown", "trp_player", 20),
                       		 (assign,"$g_hero_result",1),
       ]),
###chief acaba                       


      (ti_inventory_key_pressed, 0, 0, [(set_trigger_result,1)], []),
      (ti_tab_pressed, 0, 0, [(set_trigger_result,1)], []),


    ],
  ),
  #chief sot
#roman baths mision chief
     (
    "dungeon_romanbath",mtf_battle_mode,-1,
    "dungeon",
    [(0,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (1,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
	 (2,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
	 (3,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
	 (4,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
     (5,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
	 (6,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),#slave hunter
	 (7,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
     (8,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
	 (9,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
	 (10,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
	 (11,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
	 (12,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
	 (13,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
	 (14,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),#slave crusher
	 (15,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
	 (16,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
	 (17,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),#slaver chief
	 (18,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
	 (19,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
	 (20,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
	 (21,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
	 (22,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
	 (23,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
	 (24,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),#slave crusher
	 (25,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),#PRISONERS BEGIN
	 (26,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
	 (27,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
	 (28,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
	 (29,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
	 (30,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),#PRISONERS END
     ],
    [
	  
##      (ti_on_agent_spawn, 0, 0, [],
##       [ (store_trigger_param_1, ":agent_no"),
##		 (agent_get_troop_id,":troop_id",":agent_no"),
##		 (try_begin),
##			(is_between,":troop_id",dungeon_prisoners_begin,dungeon_prisoners_end),
##			(agent_set_slot,":agent_no","slot_agent_tournament_point",0),#using slot to store if agent has been talked to or not in dialogs.py
##		 (try_end),
##         ]),
		 
      (ti_before_mission_start, 0, 0, [],
       [
		 (assign,"$g_battle_result",0),
		 (team_set_relation, 0, 2, -1), # -1 for enemy, 1 for friend, 0 for neutral
		 (team_set_relation,1,2,0),
		 (team_set_relation,0,1,0),		 
         ]),

	(0, 0, ti_once,
					[
					(assign, "$defender_team_2", 2),
					], []
	),

	(0, 0, ti_once,
					[
					(set_show_messages, 1),#gdw
					(team_give_order, "$defender_team_2", grc_infantry, mordr_stand_ground),
					(team_give_order, "$defender_team_2", grc_archers, mordr_stand_ground),
					(team_give_order, "$defender_team_2", grc_cavalry, mordr_stand_ground),
					#(set_show_messages, 1),
					], []
	),

                        (0.1, 0, ti_once, [
            (store_skill_level,":player_sneaking_skill","skl_athletics","trp_player"),

                       
                       (try_begin),
                       (eq,":player_sneaking_skill",10),
                (assign,":sneak_distance",500),
            (else_try),
                (eq,":player_sneaking_skill",9),
                (assign,":sneak_distance",600),
            (else_try),
                (eq,":player_sneaking_skill",8),
                (assign,":sneak_distance",700),
            (else_try),
                (eq,":player_sneaking_skill",7),
                (assign,":sneak_distance",800),
            (else_try),
                (eq,":player_sneaking_skill",6),
                (assign,":sneak_distance",900),
            (else_try),
                (eq,":player_sneaking_skill",5),
                (assign,":sneak_distance",1000),
            (else_try),
                (eq,":player_sneaking_skill",4),
                (assign,":sneak_distance",1100),
            (else_try),
                (eq,":player_sneaking_skill",3),
                (assign,":sneak_distance",1200),
            (else_try),
                (eq,":player_sneaking_skill",2),
                (assign,":sneak_distance",1300),
            (else_try),
                (eq,":player_sneaking_skill",1),
                (assign,":sneak_distance",1400),
            (else_try),
                (assign,":sneak_distance",1500),
           (try_end),
        (get_player_agent_no,":player_agent"),
	(agent_get_position,pos1,":player_agent"),
	(assign,":continue",0),
	(try_for_agents, ":cur_agent"),
		(agent_get_troop_id, ":cur_agent_troop", ":cur_agent"),
		(this_or_next|eq, ":cur_agent_troop", "trp_desert_bandit_hero"),
		(this_or_next|eq, ":cur_agent_troop", "trp_slaver_chief"),
		(this_or_next|eq, ":cur_agent_troop", "trp_sea_raider"),
		(this_or_next|eq, ":cur_agent_troop", "trp_slave_crusher"),
		(this_or_next|eq, ":cur_agent_troop", "trp_slave_punisher"),
		(eq, ":cur_agent_troop", "trp_manhunter"),
		(agent_get_position,pos2,":cur_agent"),
		(get_distance_between_positions,":distance",pos1,pos2),
		(lt,":distance",":sneak_distance"),
		(assign,":continue",1),
	(try_end),
	(eq,":continue",1),
            ],
           [(set_party_battle_mode),
            (try_for_agents, ":cur_agent"),
              (agent_get_troop_id, ":cur_agent_troop", ":cur_agent"),
              (eq, ":cur_agent_troop", "trp_sea_raider_leader"),
              (agent_set_team, ":cur_agent", 2),
            (try_end),
             ]),

#TEMPERED      SETUP KEY AGENTS

	  (0,0,ti_once,[],
		[	(mission_enable_talk),
			(assign, "$talk_context", tc_roman_dungeon),#tc_roman_dungeon
			(try_for_agents,":cur_agent"),
				(agent_get_troop_id,":cur_troop_id",":cur_agent"),
				(try_begin),
					(eq,":cur_troop_id","trp_sea_raider"),
					(assign,"$slaver_1",":cur_agent"),
				(else_try),
					(eq,":cur_troop_id","trp_slaver_chief"),
					(assign,"$slaver_2",":cur_agent"),
				(else_try),
					(eq,":cur_troop_id","trp_desert_bandit_hero"),
					(assign,"$slaver_3",":cur_agent"),
				(try_end),
			(try_end),
		]),
		
#TEMPERED     CHECK FOR DEFEAT AGAINST GUARDS
	  (5, 3, ti_once,
	   [
		 (main_hero_fallen,0),
		 (assign,"$g_spy_rescue_active",-2),
		 (assign,"$g_battle_result",-1),
		 (assign,"$g_encountered_party",-1),
		(call_script, "script_change_troop_renown", "trp_player", -5),
		(display_message, "@ Bandits strike you with anger and you fall into a puddle of blood. They think you're dead...",color_good_news),
            (store_troop_gold, ":gold", "trp_player"),
	   (try_begin),
		(ge, ":gold", 100),
		(troop_remove_gold, "trp_player", 100),
		(else_try),
		(call_script, "script_change_troop_renown", "trp_player", -5),
		(try_end),		 
	   ],
	   [ 
			(finish_mission), 
       ]),
	   
#TEMPERED     SCRIPT PRISONERS TO FOLLOW PLAYER 
	  (1,1,1,[],
		[(get_player_agent_no,":player_agent"),
		 (agent_get_position,pos1,":player_agent"),
		 (try_for_agents,":cur_agent"),
		 (agent_get_team  ,":team_no",":cur_agent"),
		 (agent_get_wielded_item,":has_weapon",":cur_agent",0),#Tempered get right hand weapon (-1 for none)
			(try_begin),
				(neq,":cur_agent",":player_agent"),
				(eq,":team_no",0),
				(eq,":has_weapon",-1),
			    (agent_set_scripted_destination,":cur_agent",pos1,1),
			(try_end),
		 (try_end),
		 ]),
#TEMPERED RELEASE PRISONERS FROM SCRIPTED MODE

	 (2,0,0,[],
		[(get_player_agent_no,":player_agent"),
		 (try_for_agents,":cur_agent"),
		 (agent_get_team  ,":team_no",":cur_agent"),
		 (agent_get_wielded_item,":has_weapon",":cur_agent",0),
			(try_begin),
				(neq,":cur_agent",":player_agent"),
				(eq,":team_no",0),
				(neq,":has_weapon",-1),
			    (agent_clear_scripted_mode,":cur_agent"),
			(try_end),
		 (try_end),
		 ]),
		 
#TEMPERED     CHECK FOR VICTORY OVER GUARDS
	  ( 1, 1, ti_once,
	   [
		 (num_active_teams_le, 2),
		 (neg|main_hero_fallen),		 
	    ],
        [
		 (assign, "$g_battle_result", 1),
		 (assign,"$g_encountered_party",-1),
		 (display_message,"@ The bandits and slavers have been dealt with. Get the prisoners and leave through the air shaft.",color_good_news),
		]),	
#TEMPERED     CHECK FOR TAB PRESS		 
##      (ti_tab_pressed, 0, 0, [], 
##	   [	
##			(display_message,"@There is no turning back now!!"),
##		]),
      (ti_inventory_key_pressed, 0, 0, [(set_trigger_result,1)], []),
      (ti_tab_pressed, 0, 0, [(set_trigger_result,1)], []),
		
		
#TEMPERED     SET DARKNESS AND MUSIC FOR DUNGEON
      (0, 0, ti_once, [], 
	   [
        (call_script, "script_music_set_situation_with_culture", 0), #prison
##					(store_random_in_range, ":fog_distance", 25, 100),
##					(store_random_in_range, ":haze_power", 25, 65),
##					(set_global_haze_amount, ":haze_power"),
##                                        (set_fog_distance, ":fog_distance", 0x0D0B0B),
       ]),
	   
#TEMPERED     check for key 1
    #  (2, 0, ti_once, [ (neg|agent_is_alive,"$slaver_1"),
    #                    (eq,"$g_romanruins1",0),
    #                    ], 
	#   [
	#		(display_message,"@__You just killed the bandit king's main bodyguards. Rummaging through his stuff you find some treasures:",color_good_news),
   # (call_script, "script_change_player_honor", 2),
   # (call_script, "script_troop_add_gold", "trp_player", 200),
   #         (troop_add_item, "trp_player","itm_mailtunic_ltbrown",0),
    #                    (assign,"$g_romanruins1",1),
    #   ]),	   

#TEMPERED     check for key 2
    #  (2, 0, ti_once, [ (neg|agent_is_alive,"$slaver_2"),
    #                    (eq,"$g_romanruins2",0),
   #                     ], 
	#   [
	#		(display_message,"@__You have killed the slaver chief, an ugly guy, big and crooked, smelling like a rat. Picking through the remains are a few useful things:",color_good_news),
   # (call_script, "script_change_player_honor", 5),
   # (call_script, "script_troop_add_gold", "trp_player", 300),
    #        (troop_add_item, "trp_player","itm_spangenhelma1",0),
    #        (troop_add_item, "trp_player","itm_noble_shoesorange",0),
   #                     (assign,"$g_romanruins2",1),
   #    ]),
	   
#TEMPERED     check for key 3
		(2, 0, ti_once, [ (neg|agent_is_alive,"$slaver_1"),
						(neg|agent_is_alive,"$slaver_2"),
	                    (neg|agent_is_alive,"$slaver_3"),
	                    ],
	   [
			(display_message,"@__Rising victoriously over the body of the Slaver Chief, your steel stained with blood, you have put an end to a long life of terror and banditry, and all its horrors. You claim the best 6 items before your party loots the rest."),
    		(call_script, "script_change_player_honor", 5),
		    (call_script, "script_change_troop_renown", "trp_player", 25),
		    #(call_script, "script_troop_add_gold", "trp_player", 1000),
            (troop_add_item, "trp_player","itm_ornate_seaxt3",0),
            (troop_add_item, "trp_player","itm_mailtunic_ltbrown",0),
            (troop_add_item, "trp_player","itm_espada_banditking", 0),
		    (troop_add_item, "trp_player","itm_spangenhelma_gold",0),
            (troop_add_item, "trp_player","itm_noble_shoesorange",0),
            (troop_add_item, "trp_player","itm_elite2_2haxeresrv",0),


       (mission_disable_talk),
	                    (assign,"$falcata_quest_got",2),
	                    (assign,"$g_historia2", 1),#gdw thanks to Produno
                            
       ]),   

(0, 0, 0,[(key_clicked, key_k),
            (tutorial_message, "@ "),
], []),
      
	  (10,0,ti_once,[],
		[
        (tutorial_message_set_size, 19, 19),
        (tutorial_message_set_position, 500, 650),
        (tutorial_message_set_center_justify, 0),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@ It's cold and smells old, taking you back to another time... a time when Rome ruled the world, and men knew how to construct huge stone buildings with several storeys.^^(press K to finish read)"),

#		 (display_message,"@It's cold and smells old, taking you back to another time... a time when Rome ruled the world, and men knew how to construct huge stone buildings with several storeys.",color_good_news),
		]),

	  (100,0,ti_once,[],
		[
        (tutorial_message_set_size, 19, 19),
        (tutorial_message_set_position, 500, 650),
        (tutorial_message_set_center_justify, 0),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@ The pools, old recreation rooms, changing rooms ... everything is covered in dust and brambles, all is abandoned.^^(press K to finish read)"),

#                (display_message,"@ The pools, old recreation rooms, changing rooms ... everything is covered in dust and brambles, all is abandoned.",color_good_news),
		]),

	  (250,0,ti_once,[],
		[
        (tutorial_message_set_size, 19, 19),
        (tutorial_message_set_position, 500, 650),
        (tutorial_message_set_center_justify, 0),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@ The superstitious say that the Roman ruins are always populated with ghosts...^^(press K to finish read)"),

#			(display_message,"@ The superstitious say that the Roman ruins are always populated with ghosts...",color_good_news),
		]),

	  (400,0,ti_once,[],
		[
        (tutorial_message_set_size, 19, 19),
        (tutorial_message_set_position, 500, 650),
        (tutorial_message_set_center_justify, 0),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@ At your right hand on the wall, you see a graffito that says: Livia pulchra est, Marcus dixit.^^(press K to finish read)"),
#			(display_message,"@ At your right hand on the wall, you see a graffito that says: Livia pulchra est, Marcus dixit.",color_good_news),
                                 (play_sound,"snd_horn"),
		]),

	  (550,0,ti_once,[],
		[
        (tutorial_message_set_size, 19, 19),
        (tutorial_message_set_position, 500, 650),
        (tutorial_message_set_center_justify, 0),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@ You have a sense of being overwhelmed, you feel small. Men built this, men are gone. We are dust and our life is so ephemeral... Who could live forever?^^(press K to finish read)"),
#			(display_message,"@ You have a sense of being overwhelmed, you feel small. Men built this, men are gone. We are dust and our life is so ephemeral... Who could live forever?",color_good_news),
                       (play_sound,"snd_horn"),
                        ]),

	  (800,0,ti_once,[],
		[
        (tutorial_message_set_size, 19, 19),
        (tutorial_message_set_position, 500, 650),
        (tutorial_message_set_center_justify, 0),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@Life is short, live it intensely.^^(press K to finish read)"),
#			(display_message,"@ Life is short, live it intensely.",color_good_news),
		]),

    ] + bodyguard_triggers,
  ),
       #roman baths chief acaba
  #####cueva de odin chief
       (
    "cueva_odin",mtf_battle_mode,-1,
    "dungeon",
    [(0,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (1,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
	 (2,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
	 (3,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
	 (4,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
     (5,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
	 (6,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),#slave hunter
	 (7,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
     (8,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
	 (9,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
	 (10,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
	 (11,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
	 (12,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
	 (13,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
	 (14,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),#slave crusher
	 (15,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
	 (16,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
	 (17,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),#slaver chief
	 (18,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
	 (19,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
	 (20,mtef_visitor_source|mtef_team_2,af_override_horse,0,1,[]),
	 (21,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),#PRISONERS BEGIN
	 (22,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
	 (23,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
	 (24,mtef_visitor_source|mtef_team_1,af_override_horse,0,1,[]),
     ],
    [
	  
##      (ti_on_agent_spawn, 0, 0, [],
##       [ (store_trigger_param_1, ":agent_no"),
##		 (agent_get_troop_id,":troop_id",":agent_no"),
##		 (try_begin),
##			(is_between,":troop_id",dungeon_prisoners_begin,dungeon_prisoners_end),
##			(agent_set_slot,":agent_no","slot_agent_tournament_point",0),#using slot to store if agent has been talked to or not in dialogs.py
##		 (try_end),
##         ]),
		 
      (ti_before_mission_start, 0, 0, [],
       [
		 (assign,"$g_battle_result",0),
		 (team_set_relation, 0, 2, -1), # -1 for enemy, 1 for friend, 0 for neutral
		 (team_set_relation,1,2,0),
		 (team_set_relation,0,1,0),		 
         ]),

	(0, 0, ti_once,
					[
					(assign, "$defender_team_2", 2),
					], []
	),

	(0, 0, ti_once,
					[
					(set_show_messages, 1),
					(team_give_order, "$defender_team_2", grc_infantry, mordr_stand_ground),
					(team_give_order, "$defender_team_2", grc_archers, mordr_stand_ground),
					(team_give_order, "$defender_team_2", grc_cavalry, mordr_stand_ground),
					#(set_show_messages, 0),
					], []
	),

                        (0.1, 0, ti_once, [
            (store_skill_level,":player_sneaking_skill","skl_athletics","trp_player"),

                       
                       (try_begin),
                       (eq,":player_sneaking_skill",10),
                (assign,":sneak_distance",500),
            (else_try),
                (eq,":player_sneaking_skill",9),
                (assign,":sneak_distance",600),
            (else_try),
                (eq,":player_sneaking_skill",8),
                (assign,":sneak_distance",700),
            (else_try),
                (eq,":player_sneaking_skill",7),
                (assign,":sneak_distance",800),
            (else_try),
                (eq,":player_sneaking_skill",6),
                (assign,":sneak_distance",900),
            (else_try),
                (eq,":player_sneaking_skill",5),
                (assign,":sneak_distance",1000),
            (else_try),
                (eq,":player_sneaking_skill",4),
                (assign,":sneak_distance",1100),
            (else_try),
                (eq,":player_sneaking_skill",3),
                (assign,":sneak_distance",1200),
            (else_try),
                (eq,":player_sneaking_skill",2),
                (assign,":sneak_distance",1300),
            (else_try),
                (eq,":player_sneaking_skill",1),
                (assign,":sneak_distance",1400),
            (else_try),
                (assign,":sneak_distance",1500),
           (try_end),
        (get_player_agent_no,":player_agent"),
	(agent_get_position,pos1,":player_agent"),
	(assign,":continue",0),
	(try_for_agents, ":cur_agent"),
		(agent_get_troop_id, ":cur_agent_troop", ":cur_agent"),
		(this_or_next|eq, ":cur_agent_troop", "trp_desert_bandit_hero"),
		(this_or_next|eq, ":cur_agent_troop", "trp_sea_raider_leader2"),
		(this_or_next|eq, ":cur_agent_troop", "trp_sea_raider"),
		(this_or_next|eq, ":cur_agent_troop", "trp_slave_crusher"),
		(this_or_next|eq, ":cur_agent_troop", "trp_slave_punisher"),
		(eq, ":cur_agent_troop", "trp_manhunter"),
		(agent_get_position,pos2,":cur_agent"),
		(get_distance_between_positions,":distance",pos1,pos2),
		(lt,":distance",":sneak_distance"),
		(assign,":continue",1),
	(try_end),
	(eq,":continue",1),
            ],
           [(set_party_battle_mode),
            (try_for_agents, ":cur_agent"),
              (agent_get_troop_id, ":cur_agent_troop", ":cur_agent"),
              (eq, ":cur_agent_troop", "trp_sea_raider_leader"),
              (agent_set_team, ":cur_agent", 2),
            (try_end),
             ]),

#TEMPERED      SETUP KEY AGENTS

	  (0,0,ti_once,[],
		[	(mission_enable_talk),
			(assign, "$talk_context", tc_odin_cave),
			(try_for_agents,":cur_agent"),
				(agent_get_troop_id,":cur_troop_id",":cur_agent"),
				(try_begin),
					(eq,":cur_troop_id","trp_sea_raider"),
					(assign,"$slaver_1",":cur_agent"),
				(else_try),
					(eq,":cur_troop_id","trp_sea_raider_leader2"),
					(assign,"$slaver_2",":cur_agent"),
				(else_try),
					(eq,":cur_troop_id","trp_desert_bandit_hero"),
					(assign,"$slaver_3",":cur_agent"),
				(try_end),
			(try_end),
		]),
		
#TEMPERED     CHECK FOR DEFEAT AGAINST GUARDS
	  (5, 3, ti_once,
	   [
		 (main_hero_fallen,0),
		 (assign,"$g_spy_rescue_active",-2),
		 (assign,"$g_battle_result",-1),
		 (assign,"$g_encountered_party",-1),
		(call_script, "script_change_troop_renown", "trp_player", -5),
		(display_message, "@ Bandits strike you with anger and you fall into a puddle of blood. They think you're dead...",color_good_news),
            (store_troop_gold, ":gold", "trp_player"),
	   (try_begin),
		(ge, ":gold", 100),
		(troop_remove_gold, "trp_player", 100),
		(else_try),
		(call_script, "script_change_troop_renown", "trp_player", -5),
		(try_end),		 
	   ],
	   [ 
			(finish_mission), 
       ]),
	   
#TEMPERED     SCRIPT PRISONERS TO FOLLOW PLAYER 
	  (1,1,1,[],
		[(get_player_agent_no,":player_agent"),
		 (agent_get_position,pos1,":player_agent"),
		 (try_for_agents,":cur_agent"),
		 (agent_get_team  ,":team_no",":cur_agent"),
		 (agent_get_wielded_item,":has_weapon",":cur_agent",0),#Tempered get right hand weapon (-1 for none)
			(try_begin),
				(neq,":cur_agent",":player_agent"),
				(eq,":team_no",0),
				(eq,":has_weapon",-1),
			    (agent_set_scripted_destination,":cur_agent",pos1,1),
			(try_end),
		 (try_end),
		 ]),
#TEMPERED RELEASE PRISONERS FROM SCRIPTED MODE

	 (2,0,0,[],
		[(get_player_agent_no,":player_agent"),
		 (try_for_agents,":cur_agent"),
		 (agent_get_team  ,":team_no",":cur_agent"),
		 (agent_get_wielded_item,":has_weapon",":cur_agent",0),
			(try_begin),
				(neq,":cur_agent",":player_agent"),
				(eq,":team_no",0),
				(neq,":has_weapon",-1),
			    (agent_clear_scripted_mode,":cur_agent"),
			(try_end),
		 (try_end),
		 ]),
		 
#TEMPERED     CHECK FOR VICTORY OVER GUARDS
	  ( 1, 1, ti_once,
	   [
		 (num_active_teams_le, 2),
		 (neg|main_hero_fallen),		 
	    ],
        [
		 (assign, "$g_battle_result", 1),
		 (assign,"$g_encountered_party",-1),
		 (display_message,"@ The bandits and slavers have been dealt with. Get the prisoners and leave through the air shaft.",color_good_news),
		]),	
#TEMPERED     CHECK FOR TAB PRESS		 
##      (ti_tab_pressed, 0, 0, [], 
##	   [	
##			(display_message,"@There is no turning back now!!"),
##		]),
      (ti_inventory_key_pressed, 0, 0, [(set_trigger_result,1)], []),
      (ti_tab_pressed, 0, 0, [(set_trigger_result,1)], []),
		
		
#TEMPERED     SET DARKNESS AND MUSIC FOR DUNGEON
      (0, 0, ti_once, [], 
	   [
        (call_script, "script_music_set_situation_with_culture", 0), #prison
##					(store_random_in_range, ":fog_distance", 25, 100),
##					(store_random_in_range, ":haze_power", 25, 65),
##					(set_global_haze_amount, ":haze_power"),
##                                        (set_fog_distance, ":fog_distance", 0x0D0B0B),
       ]),
	   
#TEMPERED     check for key 1
  #    (2, 0, ti_once, [ (neg|agent_is_alive,"$slaver_1"),
  #                      (eq,"$g_odin1",0), #odin1 chief
   #                     ], 
	#   [
	#		(display_message,"@__You just killed the bandit king's main bodyguards. Rummaging through his stuff you find some treasures:",color_good_news),
   # (call_script, "script_change_player_honor", 2),
   # (call_script, "script_troop_add_gold", "trp_player", 200),
   ##         (troop_add_item, "trp_player","itm_noblearmor4res",0),
   #         (troop_add_item, "trp_player","itm_ornate_seaxt3",0),
	#	(assign,"$g_odin1",1),                        
   #    ]),	   

#TEMPERED     check for key 2
   #   (2, 0, ti_once, [ (neg|agent_is_alive,"$slaver_2"),
   #                     (eq,"$g_odin2",0), #odin1 chief
    #                    ], 
	#   [
	#		(display_message,"@__You have killed the captain, an ugly guy, big and crooked, smelling like a rat. Picking through the remains are a few useful things:",color_good_news),
  #  (call_script, "script_change_player_honor", 5),
   # (call_script, "script_troop_add_gold", "trp_player", 300),
    #        (troop_add_item, "trp_player","itm_shield_roundengle7",0),#gdwkingroundshield
	#	(assign,"$g_odin2",1),                        
   #    ]),
	   
#TEMPERED     check for key 3
      (2, 0, ti_once, [ (neg|agent_is_alive,"$slaver_1"),
						(neg|agent_is_alive,"$slaver_2"),
	                    (neg|agent_is_alive,"$slaver_3"),
	                    ],	


       [
			(display_message,"@__Rising victoriously over the body of the Bandit King, your steel stained with blood, you have put an end to a long life of terror and banditry, and all its horrors. You claim 6 items and your party grabs the rest"),
    	(call_script, "script_change_player_honor", 10),
		(call_script, "script_change_troop_renown", "trp_player", 25),
   		#(call_script, "script_troop_add_gold", "trp_player", 600),#gdw companions get the rest
            (troop_add_item, "trp_player","itm_lorica_olive",0),
            (troop_add_item, "trp_player","itm_noblearmor4res",0),
            (troop_add_item, "trp_player","itm_elite2_2haxeresrv",0),
            (troop_add_item, "trp_player","itm_shield_roundengle7", 0),
            (troop_add_item, "trp_player","itm_iniauhorn", 0),
       		 (troop_add_item, "trp_player","itm_elite1_2haxeresrv", 0),
        (mission_disable_talk),
                        (assign,"$g_historia21",1), 
             (assign,"$cummoc_quest_got",3),#gdw see dialog for rheged quest                    
       ]),

(0, 0, 0,[(key_clicked, key_k),
            (tutorial_message, "@ "),
], []),
      
	  (10,0,ti_once,[],
		[
        (tutorial_message_set_size, 19, 19),
        (tutorial_message_set_position, 500, 650),
        (tutorial_message_set_center_justify, 0),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@ The mouth of a rock opens before you. You behold distinguished marks in a language you do not know. What surprises are hidden here? (BE SURE TO HAVE 6 INVENTORY SLOTS FREE!).^^(press K to finish read)"),

#		 (display_message,"@It's cold and smells old, taking you back to another time... a time when Rome ruled the world, and men knew how to construct huge stone buildings with several storeys.",color_good_news),
		]),

	  (100,0,ti_once,[],
		[
        (tutorial_message_set_size, 19, 19),
        (tutorial_message_set_position, 500, 650),
        (tutorial_message_set_center_justify, 0),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@ As you advance, you find there is a light inside. It seems this place is not as deserted as you expected.^^(press K to finish read)"),

#                (display_message,"@ The pools, old recreation rooms, changing rooms ... everything is covered in dust and brambles, all is abandoned.",color_good_news),
		]),

	  (250,0,ti_once,[],
		[
        (tutorial_message_set_size, 19, 19),
        (tutorial_message_set_position, 500, 650),
        (tutorial_message_set_center_justify, 0),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@ Faces turn towards you, amazed by your presence...^^(press K to finish read)"),

#			(display_message,"@ The superstitious say that the Roman ruins are always populated with ghosts...",color_good_news),
		]),


	  (600,0,ti_once,[],
		[
        (tutorial_message_set_size, 19, 19),
        (tutorial_message_set_position, 500, 650),
        (tutorial_message_set_center_justify, 0),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@The steel of the sword and linden wood shield is the only medicine for this place.^^(press K to finish read)"),
#			(display_message,"@ Life is short, live it intensely.",color_good_news),
		]),

    ]+ bodyguard_triggers,
  ),
####cueva de odin chief acaba
#stone circle druidas chief
       (
    "stone_circle",0,-1,
    "druids",
    [(0,mtef_scene_source|mtef_team_0,0,0,1,[]),
     (1,mtef_scene_source|mtef_team_0,0,0,1,[]),
     (2,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (3,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (4,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (5,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (6,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (7,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     
     (8,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (9,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (10,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (11,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (12,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (13,mtef_visitor_source|mtef_team_0,0,0,1,[]),
     (14,mtef_visitor_source|mtef_team_0,0,0,1,[]),
     (15,mtef_visitor_source|mtef_team_0,0,0,1,[]),
     (16,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (17,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (18,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (19,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (20,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (21,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (22,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (23,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (24,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (25,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (26,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (27,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (28,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (29,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (30,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(31,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (32,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(33,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (34,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(35,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (36,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(37,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (38,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(39,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (40,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(41,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (42,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(43,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (44,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(45,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (46,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(47,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     ],
    [

      (1, 0, ti_once, [], [
          (call_script, "script_music_set_situation_with_culture", mtf_sit_travel),
        ]),
      (ti_before_mission_start, 0, 0, [], [(call_script, "script_change_banners_and_chest")]),
      (ti_inventory_key_pressed, 0, 0, [(set_trigger_result,1)], []),

      (ti_tab_pressed, 0, 0, [(set_trigger_result,1)], []),

(0, 0, 0,[(key_clicked, key_k),
            (tutorial_message, "@ "),
], []),
      
	  (10,0,ti_once,[],
		[
        (tutorial_message_set_size, 19, 19),
        (tutorial_message_set_position, 500, 650),
        (tutorial_message_set_center_justify, 0),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@ Not far away, on hills, you distinguish several stone circles of the ancients. On this site you can feel the magic, as if a bit of the old religion of the Celts still struggle to survive.^^(press K to finish read)"),

		]),

	  (100,0,ti_once,[],
		[
        (tutorial_message_set_size, 19, 19),
        (tutorial_message_set_position, 500, 650),
        (tutorial_message_set_center_justify, 0),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@ Refugees and desertors have made this place their home. They are protected under the mantle of the last Druid and the blood of their sacrifices.^^(press K to finish read)"),
		]),


      (ti_on_leave_area, 0, 0, [
          (try_begin),
            (assign,"$g_leave_town",1),
          (try_end),
          ], []),
      (2, 0, 0, [(call_script, "script_center_ambiance_sounds")], []),
    ],
  ),
  ##chief acaba stone druids
  ####quarry chief
         (
    "quarry_place",0,-1,
    "quarry",
    [(0,mtef_scene_source|mtef_team_0,0,0,1,[]),
     (1,mtef_scene_source|mtef_team_0,0,0,1,[]),
     (2,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (3,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (4,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (5,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (6,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (7,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     
     (8,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (9,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (10,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (11,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (12,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (13,mtef_visitor_source|mtef_team_0,0,0,1,[]),
     (14,mtef_visitor_source|mtef_team_0,0,0,1,[]),
     (15,mtef_visitor_source|mtef_team_0,0,0,1,[]),
     (16,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (17,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (18,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (19,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (20,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (21,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (22,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (23,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (24,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (25,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (26,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (27,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (28,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (29,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (30,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(31,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (32,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(33,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (34,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(35,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (36,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(37,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (38,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(39,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (40,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(41,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (42,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(43,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (44,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(45,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (46,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(47,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     ],
    [

      (1, 0, ti_once, [], [
          (call_script, "script_music_set_situation_with_culture", mtf_sit_travel),
        ]),
      (ti_before_mission_start, 0, 0, [], [(call_script, "script_change_banners_and_chest")]),
      (ti_inventory_key_pressed, 0, 0, [(set_trigger_result,1)], []),

      (ti_tab_pressed, 0, 0, [(set_trigger_result,1)], []),

(0, 0, 0,[(key_clicked, key_k),
            (tutorial_message, "@ "),
], []),
      
	  (10,0,ti_once,[],
		[
        (tutorial_message_set_size, 19, 19),
        (tutorial_message_set_position, 500, 650),
        (tutorial_message_set_center_justify, 0),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@ The rattle of spikes on the stone is deafening. Below, you can see people working hard under the command of a foreman.^^(press K to finish read)"),

		]),

	  (100,0,ti_once,[],
		[
        (tutorial_message_set_size, 19, 19),
        (tutorial_message_set_position, 500, 650),
        (tutorial_message_set_center_justify, 0),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@ Your own life seems not so bad, as you see these poor wretches working themselves to an early grave just for the bread to survive.^^(press K to finish read)"),
		]),

      (ti_on_leave_area, 0, 0, [
          (try_begin),
            (assign,"$g_leave_town",1),
          (try_end),
          ], []),
      (2, 0, 0, [(call_script, "script_center_ambiance_sounds"),
                                 (play_sound,"snd_pickaxesound"),
                                 (play_sound,"snd_rockslide"),
                 ], []),
    ],
  ),
####quarry acaba
  ####hadrian wall
           (
    "hadrian_place",0,-1,
    "Hadrian Wall",
    [(0,mtef_scene_source|mtef_team_0,0,0,1,[]),
     (1,mtef_scene_source|mtef_team_0,0,0,1,[]),
     (2,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (3,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (4,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (5,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (6,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (7,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     
     (8,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (9,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (10,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (11,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (12,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (13,mtef_visitor_source|mtef_team_0,0,0,1,[]),
     (14,mtef_visitor_source|mtef_team_0,0,0,1,[]),
     (15,mtef_visitor_source|mtef_team_0,0,0,1,[]),
     (16,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (17,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (18,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (19,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (20,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (21,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (22,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (23,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (24,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (25,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (26,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (27,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (28,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (29,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (30,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(31,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (32,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(33,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (34,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(35,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (36,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(37,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (38,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(39,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (40,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(41,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (42,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(43,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (44,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(45,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (46,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(47,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     ],
    [

      (1, 0, ti_once, [], [
          (call_script, "script_music_set_situation_with_culture", mtf_sit_travel),
        ]),
      (ti_before_mission_start, 0, 0, [], [(call_script, "script_change_banners_and_chest")]),
      (ti_inventory_key_pressed, 0, 0, [(set_trigger_result,1)], []),

      (ti_tab_pressed, 0, 0, [(set_trigger_result,1)], []),

(0, 0, 0,[(key_clicked, key_k),
            (tutorial_message, "@ "),
], []),
      
	  (10,0,ti_once,[],
		[
        (tutorial_message_set_size, 19, 19),
        (tutorial_message_set_position, 500, 650),
        (tutorial_message_set_center_justify, 0),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@ Time and neglect has ruined what once was. in Roman times this was the main wall defending the southern towns from the ravages of Caledonia. But life can still be found in the rubble...^^(press K to finish read)"),

		]),

	  (100,0,ti_once,[],
		[
        (tutorial_message_set_size, 19, 19),
        (tutorial_message_set_position, 500, 650),
        (tutorial_message_set_center_justify, 0),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@ The magnificence of this place still surprises you. When will men return to build defenses like this?.^^(press K to finish read)"),
		]),

    ],
  ),

  #######hadrian wall acaba
  ############player lair chief
           (
    "fort_interior",0,-1,
    "monasterio",
    [(0,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (1,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (2,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (3,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (4,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (5,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (6,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (7,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     
     (8,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (9,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (10,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (11,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (12,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (13,mtef_visitor_source|mtef_team_0,0,0,1,[]),
     (14,mtef_visitor_source|mtef_team_0,0,0,1,[]),
     (15,mtef_visitor_source|mtef_team_0,0,0,1,[]),
     (16,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (17,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (18,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (19,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (20,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (21,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (22,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (23,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (24,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (25,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (26,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (27,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (28,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (29,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (30,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(31,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (32,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(33,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (34,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(35,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (36,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(37,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (38,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(39,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (40,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(41,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (42,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(43,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (44,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(45,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (46,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(47,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     ],
    [

      (1, 0, ti_once, [], [
          (call_script, "script_music_set_situation_with_culture", mtf_sit_travel),
        ]),
      (ti_before_mission_start, 0, 0, [], [(call_script, "script_change_banners_and_chest")]),
      (ti_inventory_key_pressed, 0, 0, [(set_trigger_result,1)], []),

      (ti_tab_pressed, 0, 0, [(set_trigger_result,1)], []),


      (ti_on_leave_area, 0, 0, [
          (try_begin),
            (assign,"$g_leave_town",1),
          (try_end),
          ], []),
    ],
  ),
###player lair acaba chief
################3monasterio chief
         (
    "monasterio",0,-1,
    "monasterio",
    [(0,mtef_scene_source|mtef_team_0,0,0,1,[]),
     (1,mtef_scene_source|mtef_team_0,0,0,1,[]),
     (2,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (3,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (4,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (5,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (6,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (7,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     
     (8,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (9,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (10,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (11,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (12,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (13,mtef_visitor_source|mtef_team_0,0,0,1,[]),
     (14,mtef_visitor_source|mtef_team_0,0,0,1,[]),
     (15,mtef_visitor_source|mtef_team_0,0,0,1,[]),
     (16,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (17,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (18,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (19,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (20,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (21,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (22,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (23,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (24,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (25,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (26,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (27,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (28,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (29,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (30,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(31,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (32,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(33,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (34,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(35,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (36,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(37,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (38,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(39,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (40,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(41,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (42,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(43,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (44,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(45,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (46,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(47,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     ],
    [

##      (1, 0, ti_once, [], [
##          (call_script, "script_music_set_situation_with_culture", mtf_sit_travel),
##       (play_track, "track_gregoriano", 1),
##        ]),
      (ti_before_mission_start, 0, 0, [], [(call_script, "script_change_banners_and_chest")]),
      (ti_inventory_key_pressed, 0, 0, [(set_trigger_result,1)], []),

      (ti_tab_pressed, 0, 0, [(set_trigger_result,1)], []),


(0, 0, 0,[(key_clicked, key_k),
            (tutorial_message, "@ "),
], []),
      
	  (10,0,ti_once,[],
		[
        (tutorial_message_set_size, 19, 19),
        (tutorial_message_set_position, 500, 650),
        (tutorial_message_set_center_justify, 0),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@ All around you unfolds God's world, Ora et Labora, where men wearing habit, and they are busy in their work and only stop to praying or sleeping.^^(press K to finish read)"),
		]),

	  (100,0,ti_once,[],
		[
        (tutorial_message_set_size, 19, 19),
        (tutorial_message_set_position, 500, 650),
        (tutorial_message_set_center_justify, 0),
        (tutorial_message_set_background, 1),
        (tutorial_message, "@ Christianity in Britannia and Hibernnia is young, but it has attracted people with enthusiasm, a population eager to find peace and happiness in a life after death, because actual life brings them only misery.^^(press K to finish read)"),
		]),


      (ti_on_leave_area, 0, 0, [
          (try_begin),
            (assign,"$g_leave_town",1),
          (try_end),
          ], []),
      (2, 0, 0, [(call_script, "script_center_ambiance_sounds"),
                            (play_track, "track_gregoriano", 1),
                 ], []),
    ],
  ),

         (
    "monasterio_interior",0,-1,
    "monasterio",
    [(0,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (1,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (2,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (3,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (4,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (5,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (6,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     (7,mtef_scene_source|mtef_team_0,af_override_horse,0,1,[]),
     
     (8,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (9,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (10,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (11,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (12,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (13,mtef_visitor_source|mtef_team_0,0,0,1,[]),
     (14,mtef_visitor_source|mtef_team_0,0,0,1,[]),
     (15,mtef_visitor_source|mtef_team_0,0,0,1,[]),
     (16,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (17,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (18,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (19,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (20,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (21,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (22,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (23,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (24,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (25,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (26,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (27,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (28,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (29,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (30,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(31,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (32,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(33,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (34,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(35,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (36,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(37,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (38,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(39,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (40,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(41,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (42,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(43,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (44,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(45,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (46,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(47,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     ],
    [

      (1, 0, ti_once, [], [
          (call_script, "script_music_set_situation_with_culture", mtf_sit_travel),
        ]),
      (ti_before_mission_start, 0, 0, [], [(call_script, "script_change_banners_and_chest")]),
      (ti_inventory_key_pressed, 0, 0, [(set_trigger_result,1)], []),

      (ti_tab_pressed, 0, 0, [(set_trigger_result,1)], []),


      (ti_on_leave_area, 0, 0, [
          (try_begin),
            (assign,"$g_leave_town",1),
          (try_end),
          ], []),
    ],
  ),

###  #atacar monasterio
           (
    "monasterio_atacado",0,-1,
    "monasterio",
    [(0,mtef_team_0|mtef_use_exact_number,af_override_horse,aif_start_alarmed,4,[]),
     (1,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (3,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (8,mtef_team_0|mtef_use_exact_number,af_override_horse,aif_start_alarmed,4,[]),
     ],
    [

      
      common_inventory_not_available,

      common_battle_init_banner,

      (ti_before_mission_start, 0, 0, [],
       [
		 (assign,"$g_battle_result",0),
##		 (team_set_relation, 0, 2, -1), # -1 for enemy, 1 for friend, 0 for neutral
##		 (team_set_relation,1,2,0),
##		 (team_set_relation,0,1,0),		 
         ]),

##	(0, 0, ti_once,
##					[
##					(assign, "$defender_team_2", 2),
##					], []
##	),
##
##	(0, 0, ti_once,
##					[
##					(set_show_messages, 0),
##					(team_give_order, "$defender_team_2", grc_infantry, mordr_stand_ground),
##					(team_give_order, "$defender_team_2", grc_archers, mordr_stand_ground),
##					(team_give_order, "$defender_team_2", grc_cavalry, mordr_stand_ground),
##					(set_show_messages, 1),
##					], []
##	),
##
##	(500, 0, ti_once,
##					[
##					(set_show_messages, 0),
##					(team_give_order, "$defender_team_2", grc_infantry, mordr_charge),
##					(team_give_order, "$defender_team_2", grc_archers, mordr_charge),
##					(team_give_order, "$defender_team_2", grc_cavalry, mordr_charge),
##					(set_show_messages, 1),
##					], []
##	),

###corage empieza
      (ti_on_agent_spawn, 0, 0, [],
       [
         (store_trigger_param_1, ":agent_no"),
         (call_script, "script_agent_reassign_team", ":agent_no"),
         (assign, ":initial_courage_score", 3000), #chief cambia a 3500, menos corage al principio
                  
         (agent_get_troop_id, ":troop_id", ":agent_no"),
         (store_character_level, ":troop_level", ":troop_id"),
         (val_mul, ":troop_level", 15), #chief aumenta a 35 moral por nivel de tropa
         (val_add, ":initial_courage_score", ":troop_level"), #average : 20 * 35 = 700
         
         (store_random_in_range, ":randomized_addition_courage", 0, 1500), #average : 1500 chief reduce a 2500
         (val_add, ":initial_courage_score", ":randomized_addition_courage"), 
                   
         (agent_get_party_id, ":agent_party", ":agent_no"),         
         (try_begin),
            (ge, ":agent_party", 0),
            (party_is_active, ":agent_party"),
            (party_get_morale, ":cur_morale", ":agent_party"),
         (else_try),
            (assign, ":cur_morale", 50),
         (try_end),
#         (party_get_morale, ":cur_morale", ":agent_party"),
         
         (store_sub, ":morale_effect_on_courage", ":cur_morale", 70),
         (val_mul, ":morale_effect_on_courage", 30), #this can effect morale with -2100..900
         (val_add, ":initial_courage_score", ":morale_effect_on_courage"), 
         
         (agent_set_slot, ":agent_no", "slot_agent_courage_score", ":initial_courage_score"),
         ]),
###corage acaba
      (ti_tab_pressed, 0, 0, [],
       [(question_box,"str_do_you_want_to_retreat"),
        ]),
      (ti_question_answered, 0, 0, [],
       [(store_trigger_param_1,":answer"),
        (eq,":answer",0),
        (jump_to_menu, "mnu_monasterio_saqueado"),
        (finish_mission),]),

	  (30,0,ti_once,[],
		[
                                                 (play_sound, "snd_campanas", 1),
		]),

      (ti_tab_pressed, 0, 0, [(display_message,"str_cannot_leave_now")], []),
      (ti_before_mission_start, 0, 0, [], [(call_script, "script_change_banners_and_chest")]),

      (1, 4, ti_once, [(this_or_next|main_hero_fallen),(num_active_teams_le,1)],
       [
           (try_begin),
             (main_hero_fallen),
             (jump_to_menu, "mnu_monasterio_saqueado"),
           (else_try),
             (jump_to_menu, "mnu_monasterio_saqueado"),
           (try_end),
           (finish_mission),
           ]),

    ]+ dplmc_battle_mode_triggers2,
  ),

           (
    "monasterio_atacado2",0,-1,
    "monasterio",
    [
    (0,mtef_team_0|mtef_use_exact_number,af_override_horse,aif_start_alarmed,4,[]),
     (1,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (3,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    (8,mtef_team_0|mtef_use_exact_number,af_override_horse,aif_start_alarmed,4,[]),
     ],
##   (0,mtef_attackers|mtef_use_exact_number,af_override_horse,aif_start_alarmed,4,[]),
##    (1,mtef_attackers|mtef_use_exact_number,af_override_horse,aif_start_alarmed,4,[]),
##    (2,mtef_attackers|mtef_use_exact_number,af_override_horse,aif_start_alarmed,4,[]),
##    (8,mtef_attackers|mtef_use_exact_number,af_override_horse,aif_start_alarmed,4,[]),
##    (10,mtef_defenders|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
##    (11,mtef_defenders|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
##    (12,mtef_defenders|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
##     ],
    [

      common_inventory_not_available,

      common_battle_init_banner,

##  (ti_before_mission_start, 0, 0, [],
##  [   
##      (assign, "$coastal_assault", 1),   # if sea battle=0, if coast assault=1
##    ]),
##      
##	  KLABAUTERMANN_1_weather,
##	  KLABAUTERMANN_2_prepare,
##	  KLABAUTERMANN_3_kill_offboard,
##	  KLABAUTERMANN_4_normal_commands,
##	  KLABAUTERMANN_5_ship_commands,
##	  KLABAUTERMANN_6_camera,
##	  KLABAUTERMANN_7_wind,
##	  KLABAUTERMANN_8_main,
##	  KLABAUTERMANN_11_sound,


      (ti_before_mission_start, 0, 0, [],
       [
		 (assign,"$g_battle_result",0),
##		 (team_set_relation, 0, 2, -1), # -1 for enemy, 1 for friend, 0 for neutral
##		 (team_set_relation,1,2,0),
##		 (team_set_relation,0,1,0),		 
         ]),

##	(0, 0, ti_once,
##					[
##					(assign, "$defender_team_2", 2),
##					], []
##	),
##
##	(0, 0, ti_once,
##					[
##					(set_show_messages, 0),
##					(team_give_order, "$defender_team_2", grc_infantry, mordr_stand_ground),
##					(team_give_order, "$defender_team_2", grc_archers, mordr_stand_ground),
##					(team_give_order, "$defender_team_2", grc_cavalry, mordr_stand_ground),
##					(set_show_messages, 1),
##					], []
##	),
##
##	(800, 0, ti_once,
##					[
##					(set_show_messages, 0),
##					(team_give_order, "$defender_team_2", grc_infantry, mordr_charge),
##					(team_give_order, "$defender_team_2", grc_archers, mordr_charge),
##					(team_give_order, "$defender_team_2", grc_cavalry, mordr_charge),
##					(set_show_messages, 1),
##					], []
##	),
      
###corage empieza
      (ti_on_agent_spawn, 0, 0, [],
       [
         (store_trigger_param_1, ":agent_no"),
         (call_script, "script_agent_reassign_team", ":agent_no"),
         (assign, ":initial_courage_score", 3000), #chief cambia a 3500, menos corage al principio
                  
         (agent_get_troop_id, ":troop_id", ":agent_no"),
         (store_character_level, ":troop_level", ":troop_id"),
         (val_mul, ":troop_level", 15), #chief aumenta a 35 moral por nivel de tropa
         (val_add, ":initial_courage_score", ":troop_level"), #average : 20 * 35 = 700
         
         (store_random_in_range, ":randomized_addition_courage", 0, 1500), #average : 1500 chief reduce a 2500
         (val_add, ":initial_courage_score", ":randomized_addition_courage"), 
                   
         (agent_get_party_id, ":agent_party", ":agent_no"),         
         (try_begin),
            (ge, ":agent_party", 0),
            (party_is_active, ":agent_party"),
            (party_get_morale, ":cur_morale", ":agent_party"),
         (else_try),
            (assign, ":cur_morale", 50),
         (try_end),
#         (party_get_morale, ":cur_morale", ":agent_party"),
         
         (store_sub, ":morale_effect_on_courage", ":cur_morale", 70),
         (val_mul, ":morale_effect_on_courage", 30), #this can effect morale with -2100..900
         (val_add, ":initial_courage_score", ":morale_effect_on_courage"), 
         
         (agent_set_slot, ":agent_no", "slot_agent_courage_score", ":initial_courage_score"),
         ]),
###corage acaba
      (ti_tab_pressed, 0, 0, [],
       [(question_box,"str_do_you_want_to_retreat"),
        ]),
      (ti_question_answered, 0, 0, [],
       [(store_trigger_param_1,":answer"),
        (eq,":answer",0),
        (jump_to_menu, "mnu_monasterio_saqueado"),
        (finish_mission),]),

	  (30,0,ti_once,[],
		[
                                                 (play_sound, "snd_campanas", 1),
		]),

      (ti_tab_pressed, 0, 0, [(display_message,"str_cannot_leave_now")], []),
      (ti_before_mission_start, 0, 0, [], [(call_script, "script_change_banners_and_chest")]),

      (1, 4, ti_once, [(this_or_next|main_hero_fallen),(num_active_teams_le,1)],
       [
           (try_begin),
             (main_hero_fallen),
             (jump_to_menu, "mnu_monasterio_saqueado"),
           (else_try),
             (jump_to_menu, "mnu_monasterio_saqueado"),
           (try_end),
           (finish_mission),
           ]),

    ]+ dplmc_battle_mode_triggers2,
  ),
####monasterio chief acaba

  ####navegar solo chief
             (
    "navegar_solo",0,-1,
    "navegar",
    [

        (0,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,4,[]),
    (1,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,4,[]),
    (2,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,4,[]),
   # (8,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,4,[]),
    (10,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,4,[]),
    (11,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,4,[]),
    (12,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,4,[]),
     ],
    [
        (ti_before_mission_start, 0, 0, [],
  [   
      (assign, "$coastal_assault", 0),   # if sea battle=0, if coast assault=1
    ]),

      common_inventory_not_available,
      common_battle_init_banner,
      common_battle_tab_press,

	  KLABAUTERMANN_1_weather,
	  KLABAUTERMANN_2_prepare,
	  KLABAUTERMANN_3_kill_offboard,
	  KLABAUTERMANN_4_normal_commands,
	  KLABAUTERMANN_5_ship_commands,
	  KLABAUTERMANN_6_camera,
	  KLABAUTERMANN_7_wind,
	  KLABAUTERMANN_8_main,
	  KLABAUTERMANN_11_sound,

      (ti_tab_pressed, 0, 0, [(set_trigger_result,1)], []),

      (ti_on_leave_area, 0, 0, [
          (try_begin),
            (assign,"$g_leave_town",1),
          (try_end),
          ], []),
      (ti_before_mission_start, 0, 0, [], [(call_script, "script_change_banners_and_chest")]),
      common_battle_inventory,      
    ],
  ),
####navegar solo chief acaba
###shore
               (
    "shore",0,-1,
    "navegar",
    [

        (0,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,4,[]),
    (1,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,4,[]),
    (2,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,4,[]),
    (8,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,4,[]),
    (10,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,4,[]),
    (11,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,4,[]),
    (12,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,4,[]),
     ],
    [
      

  (ti_before_mission_start, 0, 0, [],
  [   
      (assign, "$coastal_assault", 1),   # if sea battle=0, if coast assault=1
    ]),

	  KLABAUTERMANN_1_weather,
	  KLABAUTERMANN_2_prepare,
	  KLABAUTERMANN_3_kill_offboard,
	  KLABAUTERMANN_4_normal_commands,
	  KLABAUTERMANN_5_ship_commands,
	  KLABAUTERMANN_6_camera,
	  KLABAUTERMANN_7_wind,
	  KLABAUTERMANN_8_main,
	  KLABAUTERMANN_11_sound,
  
##      (ti_before_mission_start, 0, 0, [],
##       [
##         (store_random_in_range, ":daytime", 0, 24),
##		 (scene_set_day_time, ":daytime"),
##         ]),

      (ti_before_mission_start, 0, 0, [], [(call_script, "script_change_banners_and_chest")]),
      (ti_inventory_key_pressed, 0, 0, [(set_trigger_result,1)], []),

      (ti_tab_pressed, 0, 0, [(set_trigger_result,1)], []),

     (1, 4, ti_once, [(main_hero_fallen,0)],
         [(set_mission_result,-1),(finish_mission,1)]),

      (ti_on_leave_area, 0, 0, [
          (try_begin),
            (assign,"$g_leave_town",1),
          (try_end),
          ], []),

    ],
  ),
###shore acaba chief
  (
    "village_attack_bandits",mtf_battle_mode|mtf_synch_inventory,charge,
    "You lead your men to battle.",
    [
     (3,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
     (1,mtef_team_0|mtef_use_exact_number,0,aif_start_alarmed, 7,[]),
     (1,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
     ],
    [
      common_battle_tab_press,
      common_battle_init_banner,

      (ti_question_answered, 0, 0, [],
       [(store_trigger_param_1,":answer"),
        (eq,":answer",0),
        (assign, "$pin_player_fallen", 0),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 10, 20, 1),
        (assign, "$g_battle_result", -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission,0),]),

      (0, 0, ti_once, [], [(assign, "$g_battle_won", 0),
                           (assign, "$defender_reinforcement_stage", 0),
                           (assign, "$attacker_reinforcement_stage", 0),
                           (try_begin),
                             (eq, "$g_mt_mode", vba_after_training),
                             (add_reinforcements_to_entry, 1, 6),
                           (else_try),
                             (add_reinforcements_to_entry, 1, 29),
                           (try_end),
                           (call_script, "script_combat_music_set_situation_with_culture"),
                           ]),

      common_music_situation_update,
      common_battle_check_friendly_kills,
      common_battle_check_victory_condition,
      common_battle_victory_display,


      (1, 4, 
      ##diplomacy chief begin
      0,
      ##diplomacy end 
      [(main_hero_fallen)],
          [
              ##diplomacy chief begin
              (try_begin),
                (eq, "$g_dplmc_battle_continuation", 0),
                (assign, ":num_allies", 0),
                (try_for_agents, ":agent"),
                 (agent_is_ally, ":agent"),
                 (agent_is_alive, ":agent"),
                 (val_add, ":num_allies", 1),
                (try_end),  
                (gt, ":num_allies", 0),  
                (try_begin),
                  (eq, "$g_dplmc_cam_activated", 0),
                  #(store_mission_timer_a, "$g_dplmc_main_hero_fallen_seconds"),
                  (assign, "$g_dplmc_cam_activated", 1),      
                  (display_message, "@You have been knocked out by the enemy. Watch your men continue the fight without you or press Tab to retreat."),
                  (display_message, "@To watch the fight you can use 'w, a, s, d', and rotate the cam."),
                (try_end), 
              (else_try),
              ##diplomacy end             
              (assign, "$pin_player_fallen", 1),          
              (str_store_string, s5, "str_retreat"),
              (call_script, "script_simulate_retreat", 10, 20, 1),
              (assign, "$g_battle_result", -1),
              (set_mission_result, -1),
              (call_script, "script_count_mission_casualties_from_agents"),
              (finish_mission, 0),
              ##diplomacy chief begin
              (try_end),
              ##diplomacy end             
              ]),

      common_battle_inventory,      
      common_battle_order_panel,
      common_battle_order_panel_tick,
      
    ]+ dplmc_battle_mode_triggers2 + order_skirmish_triggers + formations_triggers + rider_damage + order_volley_triggers + warcry_chel + heridas_chel,
  ),
#diplomacy chief cambios en + encima


  (
    "village_raid",mtf_battle_mode|mtf_synch_inventory,charge,
    "You lead your men to battle.",
    [
     (3,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,19,[]),
     (3,mtef_defenders|mtef_team_0,0,aif_start_alarmed,0,[]),
     (1,mtef_attackers|mtef_team_1,0,aif_start_alarmed,14,[]),
     (1,mtef_attackers|mtef_team_1,0,aif_start_alarmed,0,[]),
     ],
    [

      common_battle_tab_press,
      common_battle_init_banner,

      (ti_question_answered, 0, 0, [],
       [(store_trigger_param_1,":answer"),
        (eq,":answer",0),
        (assign, "$pin_player_fallen", 0),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 10, 20, 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission,0),]),

      (0, 0, ti_once, [], [(assign,"$g_battle_won",0),
                           (assign,"$defender_reinforcement_stage",0),
                           (assign,"$attacker_reinforcement_stage",0),
                           (call_script, "script_combat_music_set_situation_with_culture"),
                           ]),

      common_music_situation_update,
      common_battle_check_friendly_kills,

      (1, 0, 5, [(lt,"$defender_reinforcement_stage",2),
#      (1, 0, 5, [(lt,"$defender_reinforcement_stage","$g_reinforcement_stage"), ## CC chief cambia
                 (store_mission_timer_a,":mission_time"),
                 (ge,":mission_time",10),
                 (store_normalized_team_count,":num_defenders", 0),
                 (lt,":num_defenders",9)],#gdw6
           [(add_reinforcements_to_entry,0,6),(val_add,"$defender_reinforcement_stage",1)]),
      (1, 0, 5, [(lt,"$attacker_reinforcement_stage",2),
#      (1, 0, 5, [(lt,"$attacker_reinforcement_stage","$g_reinforcement_stage"), ## CC chief cambia
                 (store_mission_timer_a,":mission_time"),
                 (ge,":mission_time",10),
                 (store_normalized_team_count,":num_attackers", 1),
                 (lt,":num_attackers",10)],#gdw6
           [(add_reinforcements_to_entry,3,6),(val_add,"$attacker_reinforcement_stage",1)]),

      (1, 60, ti_once,
       [
         (store_mission_timer_a,reg(1)),
         (ge,reg(1),10),
         (all_enemies_defeated, 5),
         (neg|main_hero_fallen, 0),
         (set_mission_result,1),
         (display_message,"str_msg_battle_won"),
         (assign,"$g_battle_won",1),
         (assign, "$g_battle_result", 1),
         (try_begin),
           (eq, "$g_village_raid_evil", 0),
           (call_script, "script_play_victorious_sound"),
         (else_try),
           (play_track, "track_victorious_evil", 1),
         (try_end),
         ],
       [
         (call_script, "script_count_mission_casualties_from_agents"),
         (finish_mission, 1),
         ]),

      common_battle_victory_display,

      (1, 4, 
      ##diplomacy chief begin
      0,
      ##diplomacy end 
      [(main_hero_fallen)],
          [
              ##diplomacy chief begin
              (try_begin),
                (eq, "$g_dplmc_battle_continuation", 0),
                (assign, ":num_allies", 0),
                (try_for_agents, ":agent"),
                 (agent_is_ally, ":agent"),
                 (agent_is_alive, ":agent"),
                 (val_add, ":num_allies", 1),
                (try_end),  
                (gt, ":num_allies", 0),                  
                (try_begin),
                  (eq, "$g_dplmc_cam_activated", 0),
                  #(store_mission_timer_a, "$g_dplmc_main_hero_fallen_seconds"),
                  (assign, "$g_dplmc_cam_activated", 1),
              (display_message, "@You have been knocked out by the enemy. Watch your men continue the fight without you or press Tab to retreat."),
                 (display_message, "@To watch the fight you can use 'w, a, s, d', and rotate the cam."),
                (try_end),
              (else_try),
              ##diplomacy end             
              (assign, "$pin_player_fallen", 1),
              (str_store_string, s5, "str_retreat"),
              (call_script, "script_simulate_retreat", 10, 20, 1),
              (assign, "$g_battle_result", -1),
              (set_mission_result,-1),
              (call_script, "script_count_mission_casualties_from_agents"),
              (finish_mission,0),
              ##diplomacy chief begin
              (try_end),
              ##diplomacy end                 
          ]),

      common_battle_inventory,
      common_battle_order_panel,
      common_battle_order_panel_tick,

##      #AI Tiggers
##      (0, 0, ti_once, [
##          (store_mission_timer_a,reg(1)),(ge,reg(1),4),
##          (call_script, "script_select_battle_tactic"),
##          (call_script, "script_battle_tactic_init"),
##          ], []),
##      (1, 0, 0, [
##          (store_mission_timer_a,reg(1)),(ge,reg(1),4),
##          (call_script, "script_battle_tactic_apply"),
##          ], []),
    ]+ dplmc_battle_mode_triggers2 + order_skirmish_triggers + formations_triggers + order_volley_triggers + warcry_chel + heridas_chel,
  ),
#anadido chief encima diplomacy


##  (
##    "charge_with_allies",mtf_battle_mode,charge_with_ally,
##    "Taking a handful of fighters with you, you set off to patrol the area.",
##    [
##     (1,mtef_defenders,0,0|aif_start_alarmed,8,[]),
##     (0,mtef_defenders,0,0|aif_start_alarmed,0,[]),
##     (4,mtef_attackers,0,aif_start_alarmed,8,[]),
##     (4,mtef_attackers,0,aif_start_alarmed,0,[]),
##     ],
##    [
##      (ti_tab_pressed, 0, 0, [],
##       [
##           (try_begin),
##             (eq, "$battle_won", 1),
##             (finish_mission,0),
##           (else_try),
##             (call_script, "script_cf_check_enemies_nearby"),
##             (question_box,"str_do_you_want_to_retreat"),
##           (else_try),
##             (display_message,"str_can_not_retreat"),
##           (try_end),
##        ]),
##      (ti_question_answered, 0, 0, [],
##       [(store_trigger_param_1,":answer"),
##        (eq,":answer",0),
##        (assign, "$pin_player_fallen", 0),
##        (str_store_string, s5, "str_retreat"),
##        (call_script, "script_simulate_retreat", 10, 30),
##        (finish_mission,0),]),
##
##      (0, 0, ti_once, [], [(assign,"$battle_won",0),(assign,"$defender_reinforcement_stage",0),(assign,"$attacker_reinforcement_stage",0)]),
##      (1, 0, 5, [(lt,"$defender_reinforcement_stage",2),(store_mission_timer_a,reg(1)),(ge,reg(1),10),(store_defender_count,reg(2)),(lt,reg(2),3)],
##           [(add_reinforcements_to_entry,0,4),(val_add,"$defender_reinforcement_stage",1)]),
##      (1, 0, 5, [(lt,"$attacker_reinforcement_stage",2),(store_mission_timer_a,reg(1)),(ge,reg(1),10),(store_attacker_count,reg(2)),(lt,reg(2),3)],
##           [(add_reinforcements_to_entry,3,4),(val_add,"$attacker_reinforcement_stage",1)]),
##      (1, 60, ti_once, [(store_mission_timer_a,reg(1)),
##                        (ge,reg(1),10),(all_enemies_defeated,2),
##                        (neg|main_hero_fallen,0),
##                        (set_mission_result,1),
##                        (assign, "$g_battle_result", 1),
##                        (display_message,"str_msg_battle_won"),
##                        (assign,"$battle_won",1)],
##           [(finish_mission,1)]),
##      (10, 0, 0, [], [(eq,"$battle_won",1),(display_message,"str_msg_battle_won")]),
##
##      (1, 4, ti_once, [(main_hero_fallen)],
##          [
##              (assign, "$pin_player_fallen", 1),
##              (str_store_string, s5, "str_retreat"),
##              (call_script, "script_simulate_retreat", 20, 30),
##              (assign, "$g_battle_result", -1),
##              (set_mission_result,-1),(finish_mission,0)]),
##      (ti_inventory_key_pressed, 0, 0, [(display_message,"str_use_baggage_for_inventory")], []),
##    ],
##  ),

##  (
##    "charge_with_allies_old",mtf_battle_mode,charge_with_ally,
##    "Taking a handful of fighters with you, you set off to patrol the area.",
##    [(1,mtef_leader_only,0,0,1,[]),
##     (1,mtef_no_leader,0,0|aif_start_alarmed,2,[]),
##     (1,mtef_reverse_order|mtef_ally_party,0,0|aif_start_alarmed,3,[]),
##     (0,mtef_no_leader,0,0|aif_start_alarmed,0,[]),
##     (0,mtef_reverse_order|mtef_ally_party,0,0|aif_start_alarmed,0,[]),
##     (3,mtef_reverse_order|mtef_enemy_party,0,aif_start_alarmed,6,[]),
##     (4,mtef_reverse_order|mtef_enemy_party,0,aif_start_alarmed,0,[])],
##    [
##      (ti_tab_pressed, 0, 0, [],
##       [
##           (try_begin),
##             (eq, "$battle_won", 1),
##             (finish_mission,0),
##           (else_try),
##             (call_script, "script_cf_check_enemies_nearby"),
##             (question_box,"str_do_you_want_to_retreat"),
##           (else_try),
##             (display_message,"str_can_not_retreat"),
##           (try_end),
##        ]),
##      (ti_question_answered, 0, 0, [],
##       [(store_trigger_param_1,":answer"),(eq,":answer",0),(finish_mission,0),]),
##
##      (0, 0, ti_once, [], [(assign,"$battle_won",0),(assign,"$enemy_reinforcement_stage",0),(assign,"$friend_reinforcement_stage",0),(assign,"$ally_reinforcement_stage",0)]),
##      
##      (1, 0, 5, [(lt,"$enemy_reinforcement_stage",2),(store_mission_timer_a,reg(1)),(ge,reg(1),10),(store_enemy_count,reg(2)),(lt,reg(2),3)],
##       [(add_reinforcements_to_entry,6,3),(val_add,"$enemy_reinforcement_stage",1)]),
##      (1, 0, 5, [(lt,"$friend_reinforcement_stage",2),(store_mission_timer_a,reg(1)),(ge,reg(1),10),(store_friend_count,reg(2)),(lt,reg(2),2)],
##       [(add_reinforcements_to_entry,3,1),(val_add,"$friend_reinforcement_stage",1)]),
##      (1, 0, 5, [(lt,"$ally_reinforcement_stage",2),(store_mission_timer_a,reg(1)),(ge,reg(1),10),(store_ally_count,reg(2)),  (lt,reg(2),2)],
##       [(add_reinforcements_to_entry,4,2),(val_add,"$ally_reinforcement_stage",1)]),
##      (1, 60, ti_once, [(store_mission_timer_a,reg(1)),
##                        (ge,reg(1),10),
##                        (all_enemies_defeated,2),
##                        (neg|main_hero_fallen,0),
##                        (set_mission_result,1),
##                        (assign, "$g_battle_result", 1),
##                        (display_message,"str_msg_battle_won"),
##                        (assign,"$battle_won",1),
##                        ],
##       [(finish_mission,1)]),
##      (10, 0, 0, [], [(eq,"$battle_won",1),(display_message,"str_msg_battle_won")]),
##      (1, 4, ti_once, [(main_hero_fallen,0)],
##       [(set_mission_result,-1),(finish_mission,1)]),
##      (ti_inventory_key_pressed, 0, 0, [(display_message,"str_use_baggage_for_inventory")], []),
##    ],
##  ),
##  (
##    "lead_charge_old",mtf_battle_mode,charge,
##    "You lead your men to battle.",
##    [
##     (1,mtef_leader_only,0,0,1,[]),
##     (1,mtef_no_leader,0,0|aif_start_alarmed,5,[]),
##     (0,mtef_no_leader,0,0|aif_start_alarmed,0,[]),
##     (3,mtef_enemy_party|mtef_reverse_order,0,aif_start_alarmed,6,[]),
##     (4,mtef_enemy_party|mtef_reverse_order,0,aif_start_alarmed,0,[]),
##     ],
##    [
##      (ti_tab_pressed, 0, 0, [],
##       [
##           (try_begin),
##             (eq, "$battle_won", 1),
##             (finish_mission,0),
##           (else_try),
##             (call_script, "script_cf_check_enemies_nearby"),
##             (question_box,"str_do_you_want_to_retreat"),
##           (else_try),
##             (display_message,"str_can_not_retreat"),
##           (try_end),
##        ]),
##      (ti_question_answered, 0, 0, [],
##       [(store_trigger_param_1,":answer"),(eq,":answer",0),(finish_mission,0),]),
##
##      (0, 0, ti_once, [], [(assign,"$battle_won",0),(assign,"$enemy_reinforcement_stage",0),(assign,"$friend_reinforcement_stage",0)]),
##      (1, 0, 5, [(lt,"$enemy_reinforcement_stage",2),(store_mission_timer_a,reg(1)),(ge,reg(1),10),(store_enemy_count,reg(2)),(lt,reg(2),3)],
##           [(add_reinforcements_to_entry,4,3),(val_add,"$enemy_reinforcement_stage",1)]),
##      (1, 0, 5, [(lt,"$friend_reinforcement_stage",2),(store_mission_timer_a,reg(1)),(ge,reg(1),10),(store_friend_count,reg(2)),(lt,reg(2),3)],
##           [(add_reinforcements_to_entry,2,3),(val_add,"$friend_reinforcement_stage",1)]),
##      (1, 60, ti_once, [(store_mission_timer_a,reg(1)),
##                        (ge,reg(1),10),(all_enemies_defeated,2),
##                        (neg|main_hero_fallen,0),
##                        (set_mission_result,1),
##                        (assign, "$g_battle_result", 1),
##                        (display_message,"str_msg_battle_won"),
##                        (assign,"$battle_won",1)],
##           [(finish_mission,1)]),
##      (10, 0, 0, [], [(eq,"$battle_won",1),(display_message,"str_msg_battle_won")]),
##      (1, 4, ti_once, [(main_hero_fallen)],
##          [
##              (assign, "$g_battle_result", -1),
##              (set_mission_result,-1),(finish_mission,1)]),
##      (ti_inventory_key_pressed, 0, 0, [(display_message,"str_use_baggage_for_inventory")], []),
##    ],
##  ),



  (
    "besiege_inner_battle_castle",mtf_battle_mode,-1,
    "You attack the walls of the castle...",
    [
     (0, mtef_attackers|mtef_use_exact_number|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (6, mtef_attackers|mtef_use_exact_number|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (7, mtef_attackers|mtef_use_exact_number|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (16, mtef_defenders|mtef_use_exact_number|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
     (17, mtef_defenders|mtef_use_exact_number|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
     (18, mtef_defenders|mtef_use_exact_number|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
     (19, mtef_defenders|mtef_use_exact_number|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
     (20, mtef_defenders|mtef_use_exact_number|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
     ],
    [
      (ti_before_mission_start, 0, 0, [], [(call_script, "script_change_banners_and_chest")]),

      common_battle_mission_start, #freelancer chief
      common_battle_tab_press,
      common_battle_init_banner,
      freelancer_siege_triggers, #freelancer chief

      (ti_question_answered, 0, 0, [],
       [(store_trigger_param_1,":answer"),
        (eq,":answer",0),
        (assign, "$pin_player_fallen", 0),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 5, 20, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result,-1),
		(call_script, "script_change_player_party_morale", -25), #anadido chief	
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission,0),
        ]),
        
      (0, 0, ti_once, [], [(assign,"$g_battle_won",0),
                           ##diplomacy chief begin
                           (assign, "$g_dplmc_cam_activated", 0),                                                    
                           ##diplomacy end
                           (call_script, "script_music_set_situation_with_culture", mtf_sit_ambushed),
                           ]),
      
      #AI Tiggers
      (0, 0, ti_once, [
          (assign, "$defender_team", 0),
          (assign, "$attacker_team", 1),
          (assign, "$defender_team_2", 2),
          (assign, "$attacker_team_2", 3),
          ], []),

      common_battle_check_friendly_kills,
      common_battle_check_victory_condition,
      common_battle_victory_display,

      (1, 4, 
      ##diplomacy chief begin
      0,
      ##diplomacy end 
      [(main_hero_fallen)],
          [
              (assign, "$pin_player_fallen", 1),
              ##diplomacy chief begin
              (try_begin),
                (eq, "$g_dplmc_battle_continuation", 0),
                (assign, ":num_allies", 0),
                (try_for_agents, ":agent"),
                 (agent_is_ally, ":agent"),
                 (agent_is_alive, ":agent"),
                 (val_add, ":num_allies", 1),
                (try_end),  
                (gt, ":num_allies", 0),                  
                (try_begin),
                  (eq, "$g_dplmc_cam_activated", 0),
                  #(store_mission_timer_a, "$g_dplmc_main_hero_fallen_seconds"),
                  (assign, "$g_dplmc_cam_activated", 1),
              (display_message, "@You have been knocked out by the enemy. Watch your men continue the fight without you or press Tab to retreat."),
                  (display_message, "@To watch the fight you can use 'w, a, s, d', and rotate the cam."),
                (try_end),
              (else_try),
              ##diplomacy end               
              (assign, "$pin_player_fallen", 1),             
              (str_store_string, s5, "str_retreat"),
              (call_script, "script_simulate_retreat", 5, 20, 0),
              (assign, "$g_battle_result", -1),
              (set_mission_result,-1),
              (call_script, "script_count_mission_casualties_from_agents"),
              (finish_mission,0),
              ##diplomacy chief begin
              (try_end),
              ##diplomacy end               
              ]),
      
      common_battle_order_panel,
      common_battle_order_panel_tick,
      common_battle_inventory,
    ]
   ##diplomacy chief begin
    + dplmc_battle_mode_triggers + warcry_chel + heridas_chel,
    ##diplomacy end
    ),

  (
    "besiege_inner_battle_town_center",mtf_battle_mode,-1,
    "You attack the walls of the castle...",
    [
#chief cambia a mas commander
     (0, mtef_attackers|mtef_use_exact_number|mtef_team_1,af_override_horse,aif_start_alarmed,25,[]),
     (2, mtef_defenders|mtef_use_exact_number|mtef_team_0,af_override_horse,aif_start_alarmed,5,[]),
     (23, mtef_defenders|mtef_use_exact_number|mtef_team_0,af_override_horse,aif_start_alarmed,5,[]),
     (24, mtef_defenders|mtef_use_exact_number|mtef_team_0,af_override_horse,aif_start_alarmed,5,[]),
     (25, mtef_defenders|mtef_use_exact_number|mtef_team_0,af_override_horse,aif_start_alarmed,5,[]),
     (26, mtef_defenders|mtef_use_exact_number|mtef_team_0,af_override_horse,aif_start_alarmed,5,[]),
     (27, mtef_defenders|mtef_use_exact_number|mtef_team_0,af_override_horse,aif_start_alarmed,5,[]),
     (28, mtef_defenders|mtef_use_exact_number|mtef_team_0,af_override_horse,aif_start_alarmed,5,[]),
#chief acaba
     ],
    [
      (ti_before_mission_start, 0, 0, [], [(call_script, "script_change_banners_and_chest")]),

      common_battle_mission_start, #+Freelancer chief
common_battle_tab_press,
      common_battle_init_banner,
      freelancer_siege_triggers, #freelancer chief

      (ti_question_answered, 0, 0, [],
       [(store_trigger_param_1,":answer"),
        (eq,":answer",0),
        (assign, "$pin_player_fallen", 0),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 5, 20, 0),
           (call_script, "script_change_player_party_morale", -25), #chief cambia a mas
        (assign, "$g_battle_result", -1),
        (set_mission_result,-1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission,0),
        ]),
        
      (0, 0, ti_once, [], [(assign,"$g_battle_won",0),
                            ##diplomacy chief begin
                           (assign, "$g_dplmc_cam_activated", 0),                                                  
                          ##diplomacy end
                           (call_script, "script_music_set_situation_with_culture", mtf_sit_ambushed),
                           ]),
      
      #AI Tiggers
      (0, 0, ti_once, [
          (assign, "$defender_team", 0),
          (assign, "$attacker_team", 1),
          (assign, "$defender_team_2", 2),
          (assign, "$attacker_team_2", 3),
          ], []),

      common_battle_check_friendly_kills,
      common_battle_check_victory_condition,
      common_battle_victory_display,

      (1, 4, 
      ##diplomacy chief begin
      0,
      ##diplomacy end  
      [(main_hero_fallen)],
          [
              ##diplomacy chief begin
              (try_begin),
                (eq, "$g_dplmc_battle_continuation", 0),
                (eq, "$g_dplmc_cam_activated", 0),
                (assign, ":num_allies", 0),
                (try_for_agents, ":agent"),
                 (agent_is_ally, ":agent"),
                 (agent_is_alive, ":agent"),
                 (val_add, ":num_allies", 1),
                (try_end),  
                (gt, ":num_allies", 0),                  
                (try_begin),
                  (eq, "$g_dplmc_cam_activated", 0),
                  #(store_mission_timer_a, "$g_dplmc_main_hero_fallen_seconds"),
                  (assign, "$g_dplmc_cam_activated", 1),
              (display_message, "@You have been knocked out by the enemy. Watch your men continue the fight without you or press Tab to retreat."),
                  (display_message, "@To watch the fight you can use 'w, a, s, d', and rotate the cam."),
                (try_end),
              (else_try),
              ##diplomacy end             
              (assign, "$pin_player_fallen", 1),
              (str_store_string, s5, "str_retreat"),
              (call_script, "script_simulate_retreat", 5, 20, 0),
              (assign, "$g_battle_result", -1),
              (set_mission_result,-1),
              (call_script, "script_count_mission_casualties_from_agents"),
              (finish_mission,0),
              ##diplomacy chief begin
              (try_end),
              ##diplomacy end               

              ]),

      common_battle_order_panel,
      common_battle_order_panel_tick,
      common_battle_inventory,
    ]
    ##diplomacy chief begin
    + dplmc_battle_mode_triggers + warcry_chel + heridas_chel,
    ##diplomacy end 
  ),

  (
    "castle_attack_walls_defenders_sally",mtf_battle_mode|mtf_synch_inventory,-1,
    "You attack the walls of the castle...",
    [
     (0,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,12,[]),
     (0,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,0,[]),
     (3,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,12,[]),
     (3,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,0,[]),
     ],
    [
      (ti_on_agent_spawn, 0, 0, [],
       [
         (store_trigger_param_1, ":agent_no"),
         (call_script, "script_force_weapon", ":agent_no"), ###chief anadido para forzar jabalinas
         (call_script, "script_agent_reassign_team", ":agent_no"),
         ]),
      
      (ti_before_mission_start, 0, 0, [],
       [
         (team_set_relation, 0, 2, 1),
         (team_set_relation, 1, 3, 1),
         (call_script, "script_change_banners_and_chest"),
         (call_script, "script_remove_siege_objects"),
         ]),
      
      common_battle_tab_press,
      common_battle_init_banner,

      (ti_on_agent_killed_or_wounded, 0, 0, [], #new
       [
        (store_trigger_param_1, ":dead_agent_no"),
        (store_trigger_param_2, ":killer_agent_no"),
        (store_trigger_param_3, ":is_wounded"),

        (try_begin),
          (ge, ":dead_agent_no", 0),
          (neg|agent_is_ally, ":dead_agent_no"),
          (agent_is_human, ":dead_agent_no"),
          (agent_get_troop_id, ":dead_agent_troop_id", ":dead_agent_no"),
          (str_store_troop_name, s6, ":dead_agent_troop_id"),
          (assign, reg0, ":dead_agent_no"),
          (assign, reg1, ":killer_agent_no"),
          (assign, reg2, ":is_wounded"),
          (agent_get_team, reg3, ":dead_agent_no"),          
          #(display_message, "@{!}dead agent no : {reg0} ; killer agent no : {reg1} ; is_wounded : {reg2} ; dead agent team : {reg3} ; {s6} is added"), 
          (party_add_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1), #addition_to_p_total_enemy_casualties
          (eq, ":is_wounded", 1),
          (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1), 
        (try_end),
       ]),

      (ti_question_answered, 0, 0, [],
       [(store_trigger_param_1,":answer"),
        (eq,":answer",0),
        (assign, "$pin_player_fallen", 0),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 5, 20, 0),
           (call_script, "script_change_player_party_morale", -25), #chief cambia a mas
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission,0),]),
        
      (0, 0, ti_once, [], [(assign,"$g_battle_won",0),
                           ##diplomacy chief begin
                           (assign, "$g_dplmc_cam_activated", 0),                                                    
                           ##diplomacy end
                           (call_script, "script_combat_music_set_situation_with_culture"),
                           ]),
      
      common_music_situation_update,
      common_battle_check_friendly_kills,

      (1, 60, ti_once, [(store_mission_timer_a, reg(1)),
                        (ge, reg(1), 10),
                        (all_enemies_defeated, 2),
                        (neg|main_hero_fallen,0),
                        (set_mission_result,1),
                        (display_message,"str_msg_battle_won"),
                        (assign, "$g_battle_won", 1),
                        (assign, "$g_battle_result", 1),
                        (assign, "$g_siege_sallied_out_once", 1),
                        (assign, "$g_siege_method", 1), #reset siege timer
                        (call_script, "script_play_victorious_sound"),
                        ],
           [(call_script, "script_count_mission_casualties_from_agents"),
            (finish_mission,1)]),

      common_battle_victory_display,

      (1, 4, 
      ##diplomacy chief begin
      0,
      ##diplomacy end 
      [(main_hero_fallen)],
          [
              ##diplomacy chief begin
              (try_begin),
                (eq, "$g_dplmc_battle_continuation", 0),
                (assign, ":num_allies", 0),
                (try_for_agents, ":agent"),
                 (agent_is_ally, ":agent"),
                 (agent_is_alive, ":agent"),
                 (val_add, ":num_allies", 1),
                (try_end),  
                (gt, ":num_allies", 0),                  
                (try_begin),
                  (eq, "$g_dplmc_cam_activated", 0),
                  #(store_mission_timer_a, "$g_dplmc_main_hero_fallen_seconds"),
                  (assign, "$g_dplmc_cam_activated", 1),
              (display_message, "@You have been knocked out by the enemy. Watch your men continue the fight without you or press Tab to retreat."),
                  (display_message, "@To watch the fight you can use 'w, a, s, d', and rotate the cam."),
                (try_end),
              (else_try),
              ##diplomacy end              
              (assign, "$pin_player_fallen", 1),
              (str_store_string, s5, "str_retreat"),
              (call_script, "script_simulate_retreat", 5, 20, 0),
              (assign, "$g_battle_result", -1),
              (set_mission_result, -1),
              (call_script, "script_count_mission_casualties_from_agents"),
              (finish_mission,0),
              ##diplomacy chief begin
              (try_end),
              ##diplomacy end               
]),

      common_battle_order_panel,
      common_battle_order_panel_tick,
      common_battle_inventory,
    ]
        ##diplomacy chief begin
    + dplmc_battle_mode_triggers + order_volley_triggers + warcry_chel + heridas_chel,
    ##diplomacy end    
  ),


  (
    "castle_attack_walls_belfry",mtf_battle_mode|mtf_synch_inventory,-1,
    "You attack the walls of the castle...",
    [
     ## CC chief
     (0,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,18,[]),
     (0,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,0,[]),
     (10,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,0,[]),
     (11,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,4,[]),
     (15,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,0,[]),

     (40,mtef_defenders|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,2,[]),
     (41,mtef_defenders|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,2,[]),
     (42,mtef_defenders|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,2,[]),
     (43,mtef_defenders|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,2,[]),
     (44,mtef_defenders|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,2,[]),
     (45,mtef_defenders|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,2,[]),
     (46,mtef_defenders|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,2,[]),
     (47,mtef_defenders|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,2,[]),
     ## CC
     ],
    [

      common_battle_mission_start,
      common_battle_tab_press,
      common_battle_init_banner,
      common_siege_question_answered,
      common_siege_init,
      common_music_situation_update,
      common_siege_ai_trigger_init,
      common_siege_ai_trigger_init_2,

      freelancer_siege_triggers, #freelancer chief

      (0, 0, ti_once,
       [
         (set_show_messages, 0),
         (team_give_order, "$attacker_team", grc_everyone, mordr_spread_out),
         (team_give_order, "$attacker_team", grc_everyone, mordr_spread_out),
         (team_give_order, "$attacker_team", grc_everyone, mordr_spread_out),
         (set_show_messages, 1),
         (assign, "$g_fire_arrow_mode_enemy", 1), #chief fire arrow anade
         ], []),
      
      (ti_on_agent_killed_or_wounded, 0, 0, [],
       [
        (store_trigger_param_1, ":dead_agent_no"),
        (store_trigger_param_2, ":killer_agent_no"),
        (store_trigger_param_3, ":is_wounded"),

        (try_begin),
          (ge, ":dead_agent_no", 0),
          (neg|agent_is_ally, ":dead_agent_no"),
          (agent_is_human, ":dead_agent_no"),
          (agent_get_troop_id, ":dead_agent_troop_id", ":dead_agent_no"),
          (str_store_troop_name, s6, ":dead_agent_troop_id"),
          (assign, reg0, ":dead_agent_no"),
          (assign, reg1, ":killer_agent_no"),
          (assign, reg2, ":is_wounded"),
          (agent_get_team, reg3, ":dead_agent_no"),          
          #(display_message, "@{!}dead agent no : {reg0} ; killer agent no : {reg1} ; is_wounded : {reg2} ; dead agent team : {reg3} ; {s6} is added"), 
          (party_add_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1), #addition_to_p_total_enemy_casualties
          (eq, ":is_wounded", 1),
          (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1), 
        (try_end),
       ]),
      ############defensores tiran piedras chief siege warfare y otras cosas########################################3
         # Force mounted NPCs to switch to their lance.  This is called once at the
   # start of the battle.
   (0, 1, ti_once, [(eq, "$g_siege_realism", 1),],
   [
    (try_for_agents, ":agent_no"),
        (agent_is_non_player, ":agent_no"),
      (agent_is_human, ":agent_no"),
      (agent_is_alive, ":agent_no"),
      (agent_get_team, ":agent_team", ":agent_no"),
      (this_or_next|eq, ":agent_team", "$defender_team"),
      (eq, ":agent_team", "$defender_team_2"),
#varios
       (this_or_next|eq, ":agent_no", "trp_fresna_recruit"),
       (this_or_next|eq, ":agent_no", "trp_fresna_footmant2"),
       (this_or_next|eq, ":agent_no", "trp_townsman"),
       (this_or_next|eq, ":agent_no", "trp_merc_infantryt2"),
       (this_or_next|eq, ":agent_no", "trp_merc_infantryt3"),
       (this_or_next|eq, ":agent_no", "trp_mercenary_horseman"),
#jutos
       (this_or_next|eq, ":agent_no", "trp_jute_recruit"),
       (this_or_next|eq, ":agent_no", "trp_jute_footmant2"),
       (this_or_next|eq, ":agent_no", "trp_jute_skirmishert3"),
       (this_or_next|eq, ":agent_no", "trp_jute_infantryt3"),
#britones
       (this_or_next|eq, ":agent_no", "trp_briton_recruit"),
       (this_or_next|eq, ":agent_no", "trp_briton_footmant2"),
       (this_or_next|eq, ":agent_no", "trp_briton_infantryt3"),
       (this_or_next|eq, ":agent_no", "trp_briton_skirmt3"),
#sajones
       (this_or_next|eq, ":agent_no", "trp_saxon_recruit"),
       (this_or_next|eq, ":agent_no", "trp_saxon_footmant2"),
       (this_or_next|eq, ":agent_no", "trp_saxon_skirmishert3"),
       (this_or_next|eq, ":agent_no", "trp_saxon_infantryt3"),
#anglos
       (this_or_next|eq, ":agent_no", "trp_engle_recruit"),
       (this_or_next|eq, ":agent_no", "trp_engle_footmant2"),
       (this_or_next|eq, ":agent_no", "trp_engle_skirmishert3"),
       (this_or_next|eq, ":agent_no", "trp_engle_infantryt3"),
       (this_or_next|eq, ":agent_no", "trp_engle_skirmishert4"),
#irish
       (this_or_next|eq, ":agent_no", "trp_irish_recruit"),
       (this_or_next|eq, ":agent_no", "trp_irish_footmant2"),
       (this_or_next|eq, ":agent_no", "trp_irish_infantryt3"),
       (this_or_next|eq, ":agent_no", "trp_irish_skirmishert3"),
       (this_or_next|eq, ":agent_no", "trp_irish_infantryt4"),

#pictos
       (this_or_next|eq, ":agent_no", "trp_pict_recruit"),
       (this_or_next|eq, ":agent_no", "trp_pict_woman"),
       (this_or_next|eq, ":agent_no", "trp_pict_footmant2"),
       (this_or_next|eq, ":agent_no", "trp_pict_horsesquiret3"),
       (this_or_next|eq, ":agent_no", "trp_pict_horseman"),
#otros
       (this_or_next|eq, ":agent_no", "trp_manhunter"),
       (this_or_next|eq, ":agent_no", "trp_slave_driver"),
       (this_or_next|eq, ":agent_no", "trp_follower_woman"),
       (this_or_next|eq, ":agent_no", "trp_hunter_woman"),
       (this_or_next|eq, ":agent_no", "trp_fighter_woman"),

       (this_or_next|eq, ":agent_no", "trp_refugee"),
       (this_or_next|eq, ":agent_no", "trp_peasant_woman"),
       (this_or_next|eq, ":agent_no", "trp_looter"),
       (this_or_next|eq, ":agent_no", "trp_bandit"),
       (this_or_next|eq, ":agent_no", "trp_brigand"),
       (this_or_next|eq, ":agent_no", "trp_mountain_bandit"),
       (this_or_next|eq, ":agent_no", "trp_forest_bandit"),
       (eq, ":agent_no", "trp_taiga_bandit"),
#obtiene piedra
(store_random_in_range, ":rand", 0, 8),
                                              (try_begin),
                                            (eq, ":rand", 0), 
(agent_equip_item, ":agent_no", "itm_siege_supply"),
                                          (else_try),
                                            (eq, ":rand", 1),
(agent_equip_item, ":agent_no", "itm_siege_supply"),
                                          (else_try),
                                            (eq, ":rand", 2),
(agent_equip_item, ":agent_no", "itm_siege_supply"),
                                          (else_try),
                                            (eq, ":rand", 3),
(agent_equip_item, ":agent_no", "itm_boiling_water"),
                                          (else_try),
                                            (eq, ":rand", 4),
(agent_equip_item, ":agent_no", "itm_torch"),
                                           (else_try),
                                            (eq, ":rand", 5),
(agent_equip_item, ":agent_no", "itm_siege_supply"),
                                          (else_try),
                                            (eq, ":rand", 6),
(agent_equip_item, ":agent_no", "itm_siege_supply"),
                                          (else_try),
                                            (eq, ":rand", 7),
(agent_equip_item, ":agent_no", "itm_boiling_water"),
          (try_end),
#(agent_equip_item, ":agent_no", "itm_boiling_water"),
      (try_end),   
   ]),

##   (0, 1, ti_once, [(eq, "$g_siege_realism", 1),],
##   [
##    (try_for_agents, ":agent_no"),
##        (agent_is_non_player, ":agent_no"),
##      (agent_is_human, ":agent_no"),
##      (agent_is_alive, ":agent_no"),
##      (agent_get_team, ":agent_team", ":agent_no"),
##      (this_or_next|eq, ":agent_team", "$defender_team"),
##      (eq, ":agent_team", "$defender_team_2"),
###varios
##       (this_or_next|eq, ":agent_no", "trp_merc_archer"),
##       (this_or_next|eq, ":agent_no", "trp_merc_spy"),
###jutos
##       (this_or_next|eq, ":agent_no", "trp_jute_archert1"),
###britones
##       (this_or_next|eq, ":agent_no", "trp_briton_archer"),
##       (this_or_next|eq, ":agent_no", "trp_briton_longbowman"),
###sajones
##       (this_or_next|eq, ":agent_no", "trp_saxon_archer"),
###anglos
##       (this_or_next|eq, ":agent_no", "trp_engle_archer"),
###irish
##       (this_or_next|eq, ":agent_no", "trp_irish_archer"),
##
###pictos
##       (this_or_next|eq, ":agent_no", "trp_pict_archer"),
###otros
##       (this_or_next|eq, ":agent_no", "trp_desert_bandit"),
##       (this_or_next|eq, ":agent_no", "trp_sword_sister"),
##       (this_or_next|eq, ":agent_no", "trp_follower_woman"),
##       (this_or_next|eq, ":agent_no", "trp_hunter_woman"),
##       (eq, ":agent_no", "trp_fighter_woman"),
###obtiene piedra
##(store_random_in_range, ":rand", 0, 4),
##                                              (try_begin),
##                                            (eq, ":rand", 0), 
##(agent_equip_item, ":agent_no", "itm_khergit_bowreserv"),
##(agent_equip_item, ":agent_no", "itm_barbed_arrows"),
##                                          (else_try),
##                                            (eq, ":rand", 1),
##(agent_equip_item, ":agent_no", "itm_khergit_bowreserv"),
## (agent_equip_item, ":agent_no", "itm_barbed_arrows"),
##                                         (else_try),
##                                            (eq, ":rand", 2),
##(agent_equip_item, ":agent_no", "itm_torch"),
##                                          (else_try),
##                                            (eq, ":rand", 3),
##          (try_end),
###(agent_equip_item, ":agent_no", "itm_boiling_water"),
##      (try_end),   
##   ]),

   (0, 1, ti_once, [(eq, "$g_siege_realism", 1),],
   [
    (try_for_agents, ":agent_no"),
        (agent_is_non_player, ":agent_no"),
      (agent_is_human, ":agent_no"),
      (agent_is_alive, ":agent_no"),
      (agent_get_team, ":agent_team", ":agent_no"),
      (this_or_next|eq, ":agent_team", "$defender_team"),
      (eq, ":agent_team", "$defender_team_2"),
#jutos
       (this_or_next|eq, ":agent_no", "trp_jute_cleric"),
       (this_or_next|eq, ":agent_no", "trp_jute_skirmishert5"),
#britones
       (this_or_next|eq, ":agent_no", "trp_briton_sacerdote"),
       (this_or_next|eq, ":agent_no", "trp_briton_horseman"),
#sajones
       (this_or_next|eq, ":agent_no", "trp_saxon_skirmishert5"),
       (this_or_next|eq, ":agent_no", "trp_saxon_sacerdote"),
#anglos
       (this_or_next|eq, ":agent_no", "trp_engle_skirmishert5"),
       (this_or_next|eq, ":agent_no", "trp_engle_rxpriest"),
#irish
       (this_or_next|eq, ":agent_no", "trp_irish_priest"),
       (this_or_next|eq, ":agent_no", "trp_irish_horseman"),

#pictos
       (this_or_next|eq, ":agent_no", "trp_pict_noblecavalry"),
       (this_or_next|eq, ":agent_no", "trp_picto_sacerdote"),
#otros
       (this_or_next|eq, ":agent_no", "trp_mercenary_horseman"),
       (this_or_next|eq, ":agent_no", "trp_shepherd"),
       (this_or_next|eq, ":agent_no", "trp_fresna_horseman"),
       (eq, ":agent_no", "trp_sea_raider"),
#obtiene piedra
(store_random_in_range, ":rand", 0, 2),
                                              (try_begin),
                                            (eq, ":rand", 0), 
(agent_equip_item, ":agent_no", "itm_torch"),
                                          (else_try),
                                            (eq, ":rand", 1),
(agent_equip_item, ":agent_no", "itm_torch"),
          (try_end),
#(agent_equip_item, ":agent_no", "itm_boiling_water"),
      (try_end),   
   ]),

   (0, 1, ti_once, [(eq, "$g_siege_realism", 1),],
   [
    (try_for_agents, ":agent_no"),
        (agent_is_non_player, ":agent_no"),
      (agent_is_human, ":agent_no"),
      (agent_is_alive, ":agent_no"),
      (agent_get_team, ":agent_team", ":agent_no"),
      (this_or_next|eq, ":agent_team", "$attacker_team"),
      (eq, ":agent_team", "$attacker_team_2"),
#jutos
       (this_or_next|eq, ":agent_no", "trp_jute_cleric"),
       (this_or_next|eq, ":agent_no", "trp_jute_skirmishert5"),
#britones
       (this_or_next|eq, ":agent_no", "trp_briton_sacerdote"),
       (this_or_next|eq, ":agent_no", "trp_briton_horseman"),
#sajones
       (this_or_next|eq, ":agent_no", "trp_saxon_skirmishert5"),
       (this_or_next|eq, ":agent_no", "trp_saxon_sacerdote"),
#anglos
       (this_or_next|eq, ":agent_no", "trp_engle_skirmishert5"),
       (this_or_next|eq, ":agent_no", "trp_engle_rxpriest"),
#irish
       (this_or_next|eq, ":agent_no", "trp_irish_priest"),
       (this_or_next|eq, ":agent_no", "trp_irish_horseman"),

#pictos
       (this_or_next|eq, ":agent_no", "trp_pict_noblecavalry"),
       (this_or_next|eq, ":agent_no", "trp_picto_sacerdote"),
#otros
       (this_or_next|eq, ":agent_no", "trp_mercenary_horseman"),
       (this_or_next|eq, ":agent_no", "trp_shepherd"),
       (this_or_next|eq, ":agent_no", "trp_fresna_horseman"),
       (eq, ":agent_no", "trp_sea_raider"),
#obtiene piedra
(store_random_in_range, ":rand", 0, 2),
                                              (try_begin),
                                            (eq, ":rand", 0), 
(agent_equip_item, ":agent_no", "itm_torch"),
                                          (else_try),
                                            (eq, ":rand", 1),
(agent_equip_item, ":agent_no", "itm_torch"),
          (try_end),
#(agent_equip_item, ":agent_no", "itm_boiling_water"),
      (try_end),   
   ]),

##   (0, 1, ti_once, [(eq, "$g_siege_realism", 1),],
##   [
##    (try_for_agents, ":agent_no"),
##        (agent_is_non_player, ":agent_no"),
##      (agent_is_human, ":agent_no"),
##      (agent_is_alive, ":agent_no"),
##      (agent_get_team, ":agent_team", ":agent_no"),
##      (this_or_next|eq, ":agent_team", "$attacker_team"),
##      (eq, ":agent_team", "$attacker_team_2"),
###varios
##       (this_or_next|eq, ":agent_no", "trp_merc_archer"),
##       (this_or_next|eq, ":agent_no", "trp_merc_spy"),
###jutos
##       (this_or_next|eq, ":agent_no", "trp_jute_archert1"),
###britones
##       (this_or_next|eq, ":agent_no", "trp_briton_archer"),
##       (this_or_next|eq, ":agent_no", "trp_briton_longbowman"),
###sajones
##       (this_or_next|eq, ":agent_no", "trp_saxon_archer"),
###anglos
##       (this_or_next|eq, ":agent_no", "trp_engle_archer"),
###irish
##       (this_or_next|eq, ":agent_no", "trp_irish_archer"),
##
###pictos
##       (this_or_next|eq, ":agent_no", "trp_pict_archer"),
###otros
##       (this_or_next|eq, ":agent_no", "trp_desert_bandit"),
##       (this_or_next|eq, ":agent_no", "trp_sword_sister"),
##       (this_or_next|eq, ":agent_no", "trp_follower_woman"),
##       (this_or_next|eq, ":agent_no", "trp_hunter_woman"),
##       (eq, ":agent_no", "trp_fighter_woman"),
###obtiene piedra
##(store_random_in_range, ":rand", 0, 4),
##                                              (try_begin),
##                                            (eq, ":rand", 0), 
##(agent_equip_item, ":agent_no", "itm_khergit_bowreserv"),
##(agent_equip_item, ":agent_no", "itm_barbed_arrows"),
##                                          (else_try),
##                                            (eq, ":rand", 1),
##(agent_equip_item, ":agent_no", "itm_khergit_bowreserv"),
## (agent_equip_item, ":agent_no", "itm_barbed_arrows"),
##                                         (else_try),
##                                            (eq, ":rand", 2),
##                                          (else_try),
##                                            (eq, ":rand", 3),
##          (try_end),
###(agent_equip_item, ":agent_no", "itm_boiling_water"),
##      (try_end),   
##   ]),
#############3tirar cosas acaba chief
   (0, 1, ti_once, [(eq, "$g_siege_realism", 1),(eq, "$g_mantlets_1", 1),],
   [
           (entry_point_get_position, pos1, 57),
           (set_spawn_position, pos1),
           (spawn_scene_prop, "spr_siege_large_shield_a", 0),         

           (entry_point_get_position, pos1, 58),
           (set_spawn_position, pos1),
           (spawn_scene_prop, "spr_siege_large_shield_a", 0),         
   ]),
#####chief acaba siege warfare

      common_siege_ai_trigger_init_after_2_secs,
      common_siege_defender_reinforcement_check,
      common_siege_defender_reinforcement_archer_reposition,
      common_siege_defender_infantry_patrol, #xenoargh chief
     common_siege_attacker_reinforcement_check,
      common_siege_attacker_do_not_stall,
      common_battle_check_friendly_kills,
      common_battle_check_victory_condition,
      common_battle_victory_display,
      common_siege_refill_ammo,
      common_siege_check_defeat_condition,
      common_battle_order_panel,
      common_battle_order_panel_tick,
      common_inventory_not_available,
      common_siege_init_ai_and_belfry,
      common_siege_move_belfry,
      common_siege_rotate_belfry,
      common_siege_assign_men_to_belfry,
#fire arrow chief
      fire_arrow_initialize,
      destructible_object_initialize,
      toggle_fire_arrow_mode,
      fire_element_life,
      fire_arrow_routine,
    ]
 ##diplomacy begin
    + dplmc_battle_mode_triggers + order_volley_triggers + warcry_chel + heridas_chel,
    ##diplomacy end   
  ),

##############Siege warfare battering ram chief #################33
    #~ Blood & Dust - Battering Ram ~#
  #~ Add this stuff to the end of the mission_templates.py file, before the last ] ~#
  
  #~ Feel free to edit the entry points, etc, this mission templates gives the entry points of
  # 40-47 archers/crossbowmen, entry points 10, 11 and 15 the melee soldiers and 0 as the player
  # and your allies. ~#
  (
    "castle_attack_walls_ram",mtf_battle_mode|mtf_synch_inventory,-1,
    "You attack the walls of the castle with your battering ram...",
    [
     ## CC chief
     (0,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,18,[]),
     (0,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,0,[]),
     (10,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,0,[]),
     (11,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,4,[]),
     (15,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,0,[]),

     (40,mtef_defenders|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,2,[]),
     (41,mtef_defenders|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,2,[]),
     (42,mtef_defenders|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,2,[]),
     (43,mtef_defenders|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,2,[]),
     (44,mtef_defenders|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,2,[]),
     (45,mtef_defenders|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,2,[]),
     (46,mtef_defenders|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,2,[]),
     (47,mtef_defenders|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,2,[]),
     ## CC
     ],
    [
      common_battle_mission_start,
      common_battle_tab_press,
      common_battle_init_banner,
#	  modding_poleax,
      common_siege_question_answered,
      common_siege_init,
      common_music_situation_update,
      common_siege_ai_trigger_init,
      common_siege_ai_trigger_init_2,

      freelancer_siege_triggers, #freelancer chief

      (0, 0, ti_once,
       [
         (set_show_messages, 0),
         (team_give_order, "$attacker_team", grc_everyone, mordr_spread_out),
         (team_give_order, "$attacker_team", grc_everyone, mordr_spread_out),
         (team_give_order, "$attacker_team", grc_everyone, mordr_spread_out),
         (set_show_messages, 1),
         (assign, "$g_fire_arrow_mode_enemy", 1), #fire arrow chief
         ], []),
      
      (ti_on_agent_killed_or_wounded, 0, 0, [],
       [
        (store_trigger_param_1, ":dead_agent_no"),
        (store_trigger_param_2, ":killer_agent_no"),
        (store_trigger_param_3, ":is_wounded"),

        (try_begin),
          (ge, ":dead_agent_no", 0),
          (neg|agent_is_ally, ":dead_agent_no"),
          (agent_is_human, ":dead_agent_no"),
          (agent_get_troop_id, ":dead_agent_troop_id", ":dead_agent_no"),
          (str_store_troop_name, s6, ":dead_agent_troop_id"),
          (assign, reg0, ":dead_agent_no"),
          (assign, reg1, ":killer_agent_no"),
          (assign, reg2, ":is_wounded"),
          (agent_get_team, reg3, ":dead_agent_no"),          
          #(display_message, "@{!}dead agent no : {reg0} ; killer agent no : {reg1} ; is_wounded : {reg2} ; dead agent team : {reg3} ; {s6} is added"), 
          (party_add_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1), #addition_to_p_total_enemy_casualties
          (eq, ":is_wounded", 1),
          (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1), 
        (try_end),
       ]),
      ############defensores tiran piedras chief siege warfare y otras cosas########################################3
         # Force mounted NPCs to switch to their lance.  This is called once at the
   # start of the battle.
   (0, 1, ti_once, [(eq, "$g_siege_realism", 1),],
   [
    (try_for_agents, ":agent_no"),
        (agent_is_non_player, ":agent_no"),
      (agent_is_human, ":agent_no"),
      (agent_is_alive, ":agent_no"),
      (agent_get_team, ":agent_team", ":agent_no"),
      (this_or_next|eq, ":agent_team", "$defender_team"),
      (eq, ":agent_team", "$defender_team_2"),
#varios
       (this_or_next|eq, ":agent_no", "trp_fresna_recruit"),
       (this_or_next|eq, ":agent_no", "trp_fresna_footmant2"),
       (this_or_next|eq, ":agent_no", "trp_townsman"),
       (this_or_next|eq, ":agent_no", "trp_merc_infantryt2"),
       (this_or_next|eq, ":agent_no", "trp_merc_infantryt3"),
       (this_or_next|eq, ":agent_no", "trp_mercenary_horseman"),
#jutos
       (this_or_next|eq, ":agent_no", "trp_jute_recruit"),
       (this_or_next|eq, ":agent_no", "trp_jute_footmant2"),
       (this_or_next|eq, ":agent_no", "trp_jute_skirmishert3"),
       (this_or_next|eq, ":agent_no", "trp_jute_infantryt3"),
#britones
       (this_or_next|eq, ":agent_no", "trp_briton_recruit"),
       (this_or_next|eq, ":agent_no", "trp_briton_footmant2"),
       (this_or_next|eq, ":agent_no", "trp_briton_infantryt3"),
       (this_or_next|eq, ":agent_no", "trp_briton_skirmt3"),
#sajones
       (this_or_next|eq, ":agent_no", "trp_saxon_recruit"),
       (this_or_next|eq, ":agent_no", "trp_saxon_footmant2"),
       (this_or_next|eq, ":agent_no", "trp_saxon_skirmishert3"),
       (this_or_next|eq, ":agent_no", "trp_saxon_infantryt3"),
#anglos
       (this_or_next|eq, ":agent_no", "trp_engle_recruit"),
       (this_or_next|eq, ":agent_no", "trp_engle_footmant2"),
       (this_or_next|eq, ":agent_no", "trp_engle_skirmishert3"),
       (this_or_next|eq, ":agent_no", "trp_engle_infantryt3"),
       (this_or_next|eq, ":agent_no", "trp_engle_skirmishert4"),
#irish
       (this_or_next|eq, ":agent_no", "trp_irish_recruit"),
       (this_or_next|eq, ":agent_no", "trp_irish_footmant2"),
       (this_or_next|eq, ":agent_no", "trp_irish_infantryt3"),
       (this_or_next|eq, ":agent_no", "trp_irish_skirmishert3"),
       (this_or_next|eq, ":agent_no", "trp_irish_infantryt4"),

#pictos
       (this_or_next|eq, ":agent_no", "trp_pict_recruit"),
       (this_or_next|eq, ":agent_no", "trp_pict_woman"),
       (this_or_next|eq, ":agent_no", "trp_pict_footmant2"),
       (this_or_next|eq, ":agent_no", "trp_pict_horsesquiret3"),
       (this_or_next|eq, ":agent_no", "trp_pict_horseman"),
#otros
       (this_or_next|eq, ":agent_no", "trp_manhunter"),
       (this_or_next|eq, ":agent_no", "trp_slave_driver"),
       (this_or_next|eq, ":agent_no", "trp_follower_woman"),
       (this_or_next|eq, ":agent_no", "trp_hunter_woman"),
       (this_or_next|eq, ":agent_no", "trp_fighter_woman"),

       (this_or_next|eq, ":agent_no", "trp_refugee"),
       (this_or_next|eq, ":agent_no", "trp_peasant_woman"),
       (this_or_next|eq, ":agent_no", "trp_looter"),
       (this_or_next|eq, ":agent_no", "trp_bandit"),
       (this_or_next|eq, ":agent_no", "trp_brigand"),
       (this_or_next|eq, ":agent_no", "trp_mountain_bandit"),
       (this_or_next|eq, ":agent_no", "trp_forest_bandit"),
       (eq, ":agent_no", "trp_taiga_bandit"),
#obtiene piedra
(store_random_in_range, ":rand", 0, 8),
                                              (try_begin),
                                            (eq, ":rand", 0), 
(agent_equip_item, ":agent_no", "itm_siege_supply"),
                                          (else_try),
                                            (eq, ":rand", 1),
(agent_equip_item, ":agent_no", "itm_siege_supply"),
                                          (else_try),
                                            (eq, ":rand", 2),
(agent_equip_item, ":agent_no", "itm_siege_supply"),
                                          (else_try),
                                            (eq, ":rand", 3),
(agent_equip_item, ":agent_no", "itm_boiling_water"),
                                          (else_try),
                                            (eq, ":rand", 4),
(agent_equip_item, ":agent_no", "itm_torch"),
                                           (else_try),
                                            (eq, ":rand", 5),
(agent_equip_item, ":agent_no", "itm_siege_supply"),
                                          (else_try),
                                            (eq, ":rand", 6),
(agent_equip_item, ":agent_no", "itm_siege_supply"),
                                          (else_try),
                                            (eq, ":rand", 7),
(agent_equip_item, ":agent_no", "itm_boiling_water"),
          (try_end),
#(agent_equip_item, ":agent_no", "itm_boiling_water"),
      (try_end),   
   ]),

   (0, 1, ti_once, [(eq, "$g_siege_realism", 1),],
   [
    (try_for_agents, ":agent_no"),
        (agent_is_non_player, ":agent_no"),
      (agent_is_human, ":agent_no"),
      (agent_is_alive, ":agent_no"),
      (agent_get_team, ":agent_team", ":agent_no"),
      (this_or_next|eq, ":agent_team", "$defender_team"),
      (eq, ":agent_team", "$defender_team_2"),
#jutos
       (this_or_next|eq, ":agent_no", "trp_jute_cleric"),
       (this_or_next|eq, ":agent_no", "trp_jute_skirmishert5"),
#britones
       (this_or_next|eq, ":agent_no", "trp_briton_sacerdote"),
       (this_or_next|eq, ":agent_no", "trp_briton_horseman"),
#sajones
       (this_or_next|eq, ":agent_no", "trp_saxon_skirmishert5"),
       (this_or_next|eq, ":agent_no", "trp_saxon_sacerdote"),
#anglos
       (this_or_next|eq, ":agent_no", "trp_engle_skirmishert5"),
       (this_or_next|eq, ":agent_no", "trp_engle_rxpriest"),
#irish
       (this_or_next|eq, ":agent_no", "trp_irish_priest"),
       (this_or_next|eq, ":agent_no", "trp_irish_horseman"),

#pictos
       (this_or_next|eq, ":agent_no", "trp_pict_noblecavalry"),
       (this_or_next|eq, ":agent_no", "trp_picto_sacerdote"),
#otros
       (this_or_next|eq, ":agent_no", "trp_mercenary_horseman"),
       (this_or_next|eq, ":agent_no", "trp_shepherd"),
       (this_or_next|eq, ":agent_no", "trp_fresna_horseman"),
       (eq, ":agent_no", "trp_sea_raider"),
#obtiene piedra
(store_random_in_range, ":rand", 0, 2),
                                              (try_begin),
                                            (eq, ":rand", 0), 
(agent_equip_item, ":agent_no", "itm_torch"),
                                          (else_try),
                                            (eq, ":rand", 1),
(agent_equip_item, ":agent_no", "itm_torch"),
          (try_end),
#(agent_equip_item, ":agent_no", "itm_boiling_water"),
      (try_end),   
   ]),

   (0, 1, ti_once, [(eq, "$g_siege_realism", 1),],
   [
    (try_for_agents, ":agent_no"),
        (agent_is_non_player, ":agent_no"),
      (agent_is_human, ":agent_no"),
      (agent_is_alive, ":agent_no"),
      (agent_get_team, ":agent_team", ":agent_no"),
      (this_or_next|eq, ":agent_team", "$attacker_team"),
      (eq, ":agent_team", "$attacker_team_2"),
#jutos
       (this_or_next|eq, ":agent_no", "trp_jute_cleric"),
       (this_or_next|eq, ":agent_no", "trp_jute_skirmishert5"),
#britones
       (this_or_next|eq, ":agent_no", "trp_briton_sacerdote"),
       (this_or_next|eq, ":agent_no", "trp_briton_horseman"),
#sajones
       (this_or_next|eq, ":agent_no", "trp_saxon_skirmishert5"),
       (this_or_next|eq, ":agent_no", "trp_saxon_sacerdote"),
#anglos
       (this_or_next|eq, ":agent_no", "trp_engle_skirmishert5"),
       (this_or_next|eq, ":agent_no", "trp_engle_rxpriest"),
#irish
       (this_or_next|eq, ":agent_no", "trp_irish_priest"),
       (this_or_next|eq, ":agent_no", "trp_irish_horseman"),

#pictos
       (this_or_next|eq, ":agent_no", "trp_pict_noblecavalry"),
       (this_or_next|eq, ":agent_no", "trp_picto_sacerdote"),
#otros
       (this_or_next|eq, ":agent_no", "trp_mercenary_horseman"),
       (this_or_next|eq, ":agent_no", "trp_shepherd"),
       (this_or_next|eq, ":agent_no", "trp_fresna_horseman"),
       (eq, ":agent_no", "trp_sea_raider"),
#obtiene piedra
(store_random_in_range, ":rand", 0, 2),
                                              (try_begin),
                                            (eq, ":rand", 0), 
(agent_equip_item, ":agent_no", "itm_torch"),
                                          (else_try),
                                            (eq, ":rand", 1),
(agent_equip_item, ":agent_no", "itm_torch"),
          (try_end),
#(agent_equip_item, ":agent_no", "itm_boiling_water"),
      (try_end),   
   ]),

####tirar cosas acaba

   (0, 1, ti_once, [(eq, "$g_siege_realism", 1),(eq, "$g_mantlets_1", 1),],
   [
           (entry_point_get_position, pos1, 57),
           (set_spawn_position, pos1),
           (spawn_scene_prop, "spr_siege_large_shield_a", 0),         

           (entry_point_get_position, pos1, 58),
           (set_spawn_position, pos1),
           (spawn_scene_prop, "spr_siege_large_shield_a", 0),         
   ]),
#####chief acaba siege warfare
      common_siege_ai_trigger_init_after_2_secs,
      common_siege_defender_reinforcement_check,
      common_siege_defender_reinforcement_archer_reposition,
      common_siege_defender_infantry_patrol, #xenoargh chief
      common_siege_attacker_reinforcement_check,
      common_siege_attacker_do_not_stall,
      common_battle_check_friendly_kills,
      common_battle_check_victory_condition,
      common_battle_victory_display,
      common_siege_refill_ammo,
      common_siege_check_defeat_condition,
      common_battle_order_panel,
      common_battle_order_panel_tick,
      common_inventory_not_available,
      common_siege_init_ai_and_ram,
      common_siege_move_ram,	  
	  common_ram_move_ram_shaft,
      common_siege_assign_men_to_ram,
#fire arrow chief
      fire_arrow_initialize,
      destructible_object_initialize,
      toggle_fire_arrow_mode,
      fire_element_life,
      fire_arrow_routine,
    ]
 ##diplomacy begin
    + dplmc_battle_mode_triggers + order_volley_triggers + warcry_chel + heridas_chel,
    ##diplomacy end   
  ),
##########siege warfare battering ram chief####################################


  (
    "castle_attack_walls_ladder",mtf_battle_mode|mtf_synch_inventory,-1,
    "You attack the walls of the castle...",
    [
     ## CC chief
     (0,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,18,[]),
     (0,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,0,[]),
     (10,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,0,[]),
     (11,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,4,[]),
     (15,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,0,[]),

     (40,mtef_defenders|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,2,[]),
     (41,mtef_defenders|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,2,[]),
     (42,mtef_defenders|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,2,[]),
     (43,mtef_defenders|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,2,[]),
     (44,mtef_defenders|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,2,[]),
     (45,mtef_defenders|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,2,[]),
     (46,mtef_defenders|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,2,[]),
     ## CC
     ],
    [
	

		#TAKE PRISONERS DURING SIEGES, SIEGE MORALE	chief
      (ti_on_agent_killed_or_wounded, 0, 0, [],
       [
        (store_trigger_param_1, ":dead_agent_no"),
        (store_trigger_param_2, ":killer_agent_no"),
        (store_trigger_param_3, ":is_wounded"),

        (try_begin),
          (ge, ":dead_agent_no", 0),
          (neg|agent_is_ally, ":dead_agent_no"),
          (agent_is_human, ":dead_agent_no"),
          (agent_get_troop_id, ":dead_agent_troop_id", ":dead_agent_no"),
        #menos casualties bajas chief blood#F123
          (party_add_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1), #addition_to_p_total_enemy_casualties
          (eq, ":is_wounded", 1),
          (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1), 
        (try_end),

        (call_script, "script_apply_death_effect_on_courage_scores", ":dead_agent_no", ":killer_agent_no"),
       ]),
#chief bajas realistas acaba
      
####mirathei ladders chief carry puede servir para manteletes
##            (1.0,0,ti_once,[],[(assign,"$ramp",0),(call_script,"script_select_carrier")]),
##     
##      (0.1,0,0 ,[(eq,"$ramp",0)],[(call_script,"script_ramp")]),
##
###      (0.25,0,0,[(eq,"$ramp",1)],[(call_script,"script_waypoint")]),  #you can use my script for this, but I recemend Raz's
##
##      (2.5,0,0,[(eq,"$ramp",-1)],[(call_script,"script_select_carrier"),(call_script,"script_cf_pass_ramp")]), 
##     
####mirathei ladders chief acaba
      ############defensores tiran piedras chief siege warfare y otras cosas########################################3
         # Force mounted NPCs to switch to their lance.  This is called once at the
   # start of the battle.
   (0, 1, ti_once, [(eq, "$g_siege_realism", 1),],
   [
    (try_for_agents, ":agent_no"),
        (agent_is_non_player, ":agent_no"),
      (agent_is_human, ":agent_no"),
      (agent_is_alive, ":agent_no"),
      (agent_get_team, ":agent_team", ":agent_no"),
      (this_or_next|eq, ":agent_team", "$defender_team"),
      (eq, ":agent_team", "$defender_team_2"),
#varios
       (this_or_next|eq, ":agent_no", "trp_fresna_recruit"),
       (this_or_next|eq, ":agent_no", "trp_fresna_footmant2"),
       (this_or_next|eq, ":agent_no", "trp_townsman"),
       (this_or_next|eq, ":agent_no", "trp_merc_infantryt2"),
       (this_or_next|eq, ":agent_no", "trp_merc_infantryt3"),
       (this_or_next|eq, ":agent_no", "trp_mercenary_horseman"),
#jutos
       (this_or_next|eq, ":agent_no", "trp_jute_recruit"),
       (this_or_next|eq, ":agent_no", "trp_jute_footmant2"),
       (this_or_next|eq, ":agent_no", "trp_jute_skirmishert3"),
       (this_or_next|eq, ":agent_no", "trp_jute_infantryt3"),
#britones
       (this_or_next|eq, ":agent_no", "trp_briton_recruit"),
       (this_or_next|eq, ":agent_no", "trp_briton_footmant2"),
       (this_or_next|eq, ":agent_no", "trp_briton_infantryt3"),
       (this_or_next|eq, ":agent_no", "trp_briton_skirmt3"),
#sajones
       (this_or_next|eq, ":agent_no", "trp_saxon_recruit"),
       (this_or_next|eq, ":agent_no", "trp_saxon_footmant2"),
       (this_or_next|eq, ":agent_no", "trp_saxon_skirmishert3"),
       (this_or_next|eq, ":agent_no", "trp_saxon_infantryt3"),
#anglos
       (this_or_next|eq, ":agent_no", "trp_engle_recruit"),
       (this_or_next|eq, ":agent_no", "trp_engle_footmant2"),
       (this_or_next|eq, ":agent_no", "trp_engle_skirmishert3"),
       (this_or_next|eq, ":agent_no", "trp_engle_infantryt3"),
       (this_or_next|eq, ":agent_no", "trp_engle_skirmishert4"),
#irish
       (this_or_next|eq, ":agent_no", "trp_irish_recruit"),
       (this_or_next|eq, ":agent_no", "trp_irish_footmant2"),
       (this_or_next|eq, ":agent_no", "trp_irish_infantryt3"),
       (this_or_next|eq, ":agent_no", "trp_irish_skirmishert3"),
       (this_or_next|eq, ":agent_no", "trp_irish_infantryt4"),

#pictos
       (this_or_next|eq, ":agent_no", "trp_pict_recruit"),
       (this_or_next|eq, ":agent_no", "trp_pict_woman"),
       (this_or_next|eq, ":agent_no", "trp_pict_footmant2"),
       (this_or_next|eq, ":agent_no", "trp_pict_horsesquiret3"),
       (this_or_next|eq, ":agent_no", "trp_pict_horseman"),
#otros
       (this_or_next|eq, ":agent_no", "trp_manhunter"),
       (this_or_next|eq, ":agent_no", "trp_slave_driver"),
       (this_or_next|eq, ":agent_no", "trp_follower_woman"),
       (this_or_next|eq, ":agent_no", "trp_hunter_woman"),
       (this_or_next|eq, ":agent_no", "trp_fighter_woman"),

       (this_or_next|eq, ":agent_no", "trp_refugee"),
       (this_or_next|eq, ":agent_no", "trp_peasant_woman"),
       (this_or_next|eq, ":agent_no", "trp_looter"),
       (this_or_next|eq, ":agent_no", "trp_bandit"),
       (this_or_next|eq, ":agent_no", "trp_brigand"),
       (this_or_next|eq, ":agent_no", "trp_mountain_bandit"),
       (this_or_next|eq, ":agent_no", "trp_forest_bandit"),
       (eq, ":agent_no", "trp_taiga_bandit"),
#obtiene piedra
(store_random_in_range, ":rand", 0, 8),
                                              (try_begin),
                                            (eq, ":rand", 0), 
(agent_equip_item, ":agent_no", "itm_siege_supply"),
                                          (else_try),
                                            (eq, ":rand", 1),
(agent_equip_item, ":agent_no", "itm_siege_supply"),
                                          (else_try),
                                            (eq, ":rand", 2),
(agent_equip_item, ":agent_no", "itm_siege_supply"),
                                          (else_try),
                                            (eq, ":rand", 3),
(agent_equip_item, ":agent_no", "itm_boiling_water"),
                                          (else_try),
                                            (eq, ":rand", 4),
(agent_equip_item, ":agent_no", "itm_torch"),
                                           (else_try),
                                            (eq, ":rand", 5),
(agent_equip_item, ":agent_no", "itm_siege_supply"),
                                          (else_try),
                                            (eq, ":rand", 6),
(agent_equip_item, ":agent_no", "itm_siege_supply"),
                                          (else_try),
                                            (eq, ":rand", 7),
(agent_equip_item, ":agent_no", "itm_boiling_water"),
          (try_end),
#(agent_equip_item, ":agent_no", "itm_boiling_water"),
      (try_end),   
   ]),

   (0, 1, ti_once, [(eq, "$g_siege_realism", 1),],
   [
    (try_for_agents, ":agent_no"),
        (agent_is_non_player, ":agent_no"),
      (agent_is_human, ":agent_no"),
      (agent_is_alive, ":agent_no"),
      (agent_get_team, ":agent_team", ":agent_no"),
      (this_or_next|eq, ":agent_team", "$defender_team"),
      (eq, ":agent_team", "$defender_team_2"),
#jutos
       (this_or_next|eq, ":agent_no", "trp_jute_cleric"),
       (this_or_next|eq, ":agent_no", "trp_jute_skirmishert5"),
#britones
       (this_or_next|eq, ":agent_no", "trp_briton_sacerdote"),
       (this_or_next|eq, ":agent_no", "trp_briton_horseman"),
#sajones
       (this_or_next|eq, ":agent_no", "trp_saxon_skirmishert5"),
       (this_or_next|eq, ":agent_no", "trp_saxon_sacerdote"),
#anglos
       (this_or_next|eq, ":agent_no", "trp_engle_skirmishert5"),
       (this_or_next|eq, ":agent_no", "trp_engle_rxpriest"),
#irish
       (this_or_next|eq, ":agent_no", "trp_irish_priest"),
       (this_or_next|eq, ":agent_no", "trp_irish_horseman"),

#pictos
       (this_or_next|eq, ":agent_no", "trp_pict_noblecavalry"),
       (this_or_next|eq, ":agent_no", "trp_picto_sacerdote"),
#otros
       (this_or_next|eq, ":agent_no", "trp_mercenary_horseman"),
       (this_or_next|eq, ":agent_no", "trp_shepherd"),
       (this_or_next|eq, ":agent_no", "trp_fresna_horseman"),
       (eq, ":agent_no", "trp_sea_raider"),
#obtiene piedra
(store_random_in_range, ":rand", 0, 2),
                                              (try_begin),
                                            (eq, ":rand", 0), 
(agent_equip_item, ":agent_no", "itm_torch"),
                                          (else_try),
                                            (eq, ":rand", 1),
(agent_equip_item, ":agent_no", "itm_torch"),
          (try_end),
#(agent_equip_item, ":agent_no", "itm_boiling_water"),
      (try_end),   
   ]),

   (0, 1, ti_once, [(eq, "$g_siege_realism", 1),],
   [
    (try_for_agents, ":agent_no"),
        (agent_is_non_player, ":agent_no"),
      (agent_is_human, ":agent_no"),
      (agent_is_alive, ":agent_no"),
      (agent_get_team, ":agent_team", ":agent_no"),
      (this_or_next|eq, ":agent_team", "$attacker_team"),
      (eq, ":agent_team", "$attacker_team_2"),
#jutos
       (this_or_next|eq, ":agent_no", "trp_jute_cleric"),
       (this_or_next|eq, ":agent_no", "trp_jute_skirmishert5"),
#britones
       (this_or_next|eq, ":agent_no", "trp_briton_sacerdote"),
       (this_or_next|eq, ":agent_no", "trp_briton_horseman"),
#sajones
       (this_or_next|eq, ":agent_no", "trp_saxon_skirmishert5"),
       (this_or_next|eq, ":agent_no", "trp_saxon_sacerdote"),
#anglos
       (this_or_next|eq, ":agent_no", "trp_engle_skirmishert5"),
       (this_or_next|eq, ":agent_no", "trp_engle_rxpriest"),
#irish
       (this_or_next|eq, ":agent_no", "trp_irish_priest"),
       (this_or_next|eq, ":agent_no", "trp_irish_horseman"),

#pictos
       (this_or_next|eq, ":agent_no", "trp_pict_noblecavalry"),
       (this_or_next|eq, ":agent_no", "trp_picto_sacerdote"),
#otros
       (this_or_next|eq, ":agent_no", "trp_mercenary_horseman"),
       (this_or_next|eq, ":agent_no", "trp_shepherd"),
       (this_or_next|eq, ":agent_no", "trp_fresna_horseman"),
       (eq, ":agent_no", "trp_sea_raider"),
#obtiene piedra
(store_random_in_range, ":rand", 0, 2),
                                              (try_begin),
                                            (eq, ":rand", 0), 
(agent_equip_item, ":agent_no", "itm_torch"),
                                          (else_try),
                                            (eq, ":rand", 1),
(agent_equip_item, ":agent_no", "itm_torch"),
          (try_end),
#(agent_equip_item, ":agent_no", "itm_boiling_water"),
      (try_end),   
   ]),

####tirar cosas acaba chief
   (0, 1, ti_once, [(eq, "$g_siege_realism", 1),(eq, "$g_mantlets_1", 1),],
   [
           (entry_point_get_position, pos1, 57),
           (set_spawn_position, pos1),
           (spawn_scene_prop, "spr_siege_large_shield_a", 0),         

           (entry_point_get_position, pos1, 58),
           (set_spawn_position, pos1),
           (spawn_scene_prop, "spr_siege_large_shield_a", 0),         
   ]),
####chief acaba siege warfare      
     
      common_battle_mission_start,
      freelancer_siege_triggers, #freelancer chief
#fire arrow chief
      (0, 0, ti_once, [],[
        (assign, "$g_fire_arrow_mode_enemy", 1),]),
#fire arrow chief acaba
      common_battle_tab_press,
      common_battle_init_banner,
      common_siege_question_answered,
      common_siege_init,
      common_music_situation_update,
      common_siege_ai_trigger_init,
      common_siege_ai_trigger_init_2,
      common_siege_ai_trigger_init_after_2_secs,
      common_siege_defender_reinforcement_check,
      common_siege_defender_reinforcement_archer_reposition,
      common_siege_defender_infantry_patrol, #xenoargh chief
      common_siege_attacker_reinforcement_check,
      common_siege_attacker_do_not_stall,
      common_battle_check_friendly_kills,
      common_battle_check_victory_condition,
      common_battle_victory_display,
      common_siege_refill_ammo,
      common_siege_check_defeat_condition,
      common_battle_order_panel,
      common_battle_order_panel_tick,
      common_inventory_not_available,
#fire arrow chief
      fire_arrow_initialize,
      destructible_object_initialize,
      toggle_fire_arrow_mode,
      fire_element_life,
      fire_arrow_routine,
#fire arrow chief acaba
#bajas realistas chief lo pone off
##      (ti_on_agent_killed_or_wounded, 0, 0, [],
##       [
##        (store_trigger_param_1, ":dead_agent_no"),
##        (store_trigger_param_2, ":killer_agent_no"),
##        (store_trigger_param_3, ":is_wounded"),
##
##        (try_begin),
##          (ge, ":dead_agent_no", 0),
##          (neg|agent_is_ally, ":dead_agent_no"),
##          (agent_is_human, ":dead_agent_no"),
##          (agent_get_troop_id, ":dead_agent_troop_id", ":dead_agent_no"),
##          (str_store_troop_name, s6, ":dead_agent_troop_id"),
##          (assign, reg0, ":dead_agent_no"),
##          (assign, reg1, ":killer_agent_no"),
##          (assign, reg2, ":is_wounded"),
##          (agent_get_team, reg3, ":dead_agent_no"),          
##          #(display_message, "@{!}dead agent no : {reg0} ; killer agent no : {reg1} ; is_wounded : {reg2} ; dead agent team : {reg3} ; {s6} is added"), 
##          (party_add_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1), #addition_to_p_total_enemy_casualties
##          (eq, ":is_wounded", 1),
##          (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1), 
##        (try_end),
##       ]),

##      (15, 0, 0,
##       [
##         (get_player_agent_no, ":player_agent"),
##         (agent_get_team, ":agent_team", ":player_agent"),
##         (neq, "$attacker_team", ":agent_team"),
##         (assign, ":non_ranged", 0),
##         (assign, ":ranged", 0),
##         (assign, ":ranged_pos_x", 0),
##         (assign, ":ranged_pos_y", 0),
##         (set_fixed_point_multiplier, 100),
##         (try_for_agents, ":agent_no"),
##           (eq, ":non_ranged", 0),
##           (agent_is_human, ":agent_no"),
##           (agent_is_alive, ":agent_no"),
##           (neg|agent_is_defender, ":agent_no"),
##           (agent_get_class, ":agent_class", ":agent_no"),
##           (try_begin),
##             (neq, ":agent_class", grc_archers),
##             (val_add, ":non_ranged", 1),
##           (else_try),
##             (val_add, ":ranged", 1),
##             (agent_get_position, pos0, ":agent_no"),
##             (position_get_x, ":pos_x", pos0),
##             (position_get_y, ":pos_y", pos0),
##             (val_add, ":ranged_pos_x", ":pos_x"),
##             (val_add, ":ranged_pos_y", ":pos_y"),
##           (try_end),
##         (try_end),
##         (try_begin),
##           (eq, ":non_ranged", 0),
##           (gt, ":ranged", 0),
##           (val_div, ":ranged_pos_x", ":ranged"),
##           (val_div, ":ranged_pos_y", ":ranged"),
##           (entry_point_get_position, pos0, 10),
##           (init_position, pos1),
##           (position_set_x, pos1, ":ranged_pos_x"),
##           (position_set_y, pos1, ":ranged_pos_y"),
##           (position_get_z, ":pos_z", pos0),
##           (position_set_z, pos1, ":pos_z"),
##           (get_distance_between_positions, ":dist", pos0, pos1),
##           (gt, ":dist", 1000), #average position of archers is more than 10 meters far from entry point 10
##           (team_give_order, "$attacker_team", grc_archers, mordr_hold),
##           (team_set_order_position, "$attacker_team", grc_archers, pos0),
##         (else_try),
##           (team_give_order, "$attacker_team", grc_everyone, mordr_charge),
##         (try_end),
##         ],
##       []),
    ]
      ##diplomacy chief begin
    + dplmc_battle_mode_triggers + order_volley_triggers + warcry_chel + heridas_chel,
    ##diplomacy end     
  ),
  

  (
    "castle_visit",0,-1,
    "Castle visit",
    [(0,mtef_scene_source|mtef_team_0,af_override_horse|af_override_weapons|af_override_head,0,1,pilgrim_disguise),
     (1,mtef_scene_source|mtef_team_0,af_override_horse,0,1,pilgrim_disguise),
     (2,mtef_scene_source|mtef_team_0,af_override_horse,0,1,pilgrim_disguise),
     (3,mtef_scene_source|mtef_team_0,af_override_horse,0,1,pilgrim_disguise), 
     (4,mtef_scene_source|mtef_team_0,af_override_horse,0,1,pilgrim_disguise), #for doors tef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(19,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (20,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(21,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(22,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(23,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (24,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(25,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(26,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(27,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (28,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(29,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(30,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(31,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (32,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]), ##castle chief walkers
     (33,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]), ##castle chief walkers
     (34,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]), ##castle chief walkers
     (35,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]), ##castle chief walkers
	 (36,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]), ##castle chief walkers
	 (37,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]), ##castle chief walkers
     (38,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]), #castle chief walkers
     (39,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]), #castle chief walkers
     # Party members
     (40,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (41,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (42,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (43,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (44,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (45,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     (46,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     ],
    [    
      (ti_on_agent_spawn, 0, 0, [],
      [
        (store_trigger_param_1, ":agent_no"),
        (call_script, "script_init_town_agent", ":agent_no"),
        (get_player_agent_no, ":player_agent"),
        (try_begin),
          (neq, ":player_agent", ":agent_no"),
          (agent_set_team, ":agent_no", 7),
        (try_end),
        
        (try_begin),
          (this_or_next|eq, "$talk_context", tc_escape),
          (eq, "$talk_context", tc_prison_break),
          (agent_get_troop_id, ":troop_no", ":agent_no"),
          (troop_get_slot, ":will_join_prison_break", ":troop_no", "slot_troop_will_join_prison_break"),
          (eq, ":will_join_prison_break", 1),
          (agent_set_team, ":agent_no", 0),
          (agent_ai_set_aggressiveness, ":agent_no", 5),
          (troop_set_slot, ":troop_no", "slot_troop_will_join_prison_break", 0),

          (try_begin),
            (troop_slot_eq, ":troop_no", "slot_troop_mission_participation", mp_prison_break_stand_back),
            (agent_get_position, pos1, ":agent_no"),                        
            (agent_set_scripted_destination, ":agent_no", pos1),
          (try_end),
        (try_end),
      ]),

###chief walkers
      (1, 0, ti_once, 
      [],
      [
        (try_begin),
          (eq, "$g_mt_mode", tcm_default),
          (store_current_scene, ":cur_scene"),
          (scene_set_slot, ":cur_scene", "slot_scene_visited", 1),
        (try_end),
        (call_script, "script_init_town_walker_agents"),
        (try_begin),
          (eq, "$sneaked_into_town", 1),
          (call_script, "script_music_set_situation_with_culture", mtf_sit_town_infiltrate),
        (else_try),
          (call_script, "script_music_set_situation_with_culture", mtf_sit_town),
        (try_end),
      ]),
#chief walkers acaba

      (ti_on_agent_killed_or_wounded, 0, 0, [],
      [
        (store_trigger_param_1, ":dead_agent_no"),
        (store_trigger_param_2, ":killer_agent_no"),
        #(store_trigger_param_3, ":is_wounded"),
        
        (agent_get_troop_id, ":dead_agent_troop_no", ":dead_agent_no"),
        (agent_get_troop_id, ":killer_agent_troop_no", ":killer_agent_no"),
                
        (try_begin), 
          (this_or_next|eq, ":dead_agent_troop_no", "trp_briton_prisoner_guard"),
          (this_or_next|eq, ":dead_agent_troop_no", "trp_saxon_prison_guard"),
          (this_or_next|eq, ":dead_agent_troop_no", "trp_pict_prison_guard"),
          (this_or_next|eq, ":dead_agent_troop_no", "trp_engle_prison_guard"),
          (this_or_next|eq, ":dead_agent_troop_no", "trp_irish_prison_guard"),
          (eq, ":dead_agent_troop_no", "trp_jute_prison_guard"),
          
          (eq, ":killer_agent_troop_no", "trp_player"),
          
          (display_message, "@You got keys of dungeon."),
        (try_end),
      ]),     

#chief walkers en castillos
      (3, 0, 0, [(call_script, "script_tick_town_walkers")], []),
      (2, 0, 0, [(call_script, "script_center_ambiance_sounds")], []),
#chief walkers en castillo acaba

      #JAILBREAK TRIGGERS 
      #Civilians get out of the way
      (1, 0, 0,
      [
        (this_or_next|eq, "$talk_context", tc_prison_break),
        (eq, "$talk_context", tc_escape),
		(agent_is_active,"$g_main_attacker_agent"),	#MOTO chief avoid invalid agent messages from script_neutral_behavior_in_fight
      ],
      [
        #(agent_get_team, ":prisoner_agent", 0),
        (call_script, "script_neutral_behavior_in_fight"),
        (mission_disable_talk),
      ]),
      
      #The game begins with the town alerted
      (1, 0, ti_once,
      [
        #If I set this to 1, 0, ti_once, then the prisoner spawns twice
        (eq, "$talk_context", tc_escape),
      ],
      [
        (get_player_agent_no, ":player_agent"),
        (assign, reg6, ":player_agent"),
        (call_script, "script_activate_town_guard"),		
        
        (get_player_agent_no, ":player_agent"),
        (agent_get_position, pos4, ":player_agent"),
        
        (try_for_range, ":prisoner", active_npcs_begin, kingdom_ladies_end),
          (troop_slot_ge, ":prisoner", "slot_troop_mission_participation", 1),
          
          (str_store_troop_name, s4, ":prisoner"),
          (display_message, "str_s4_joins_prison_break"),
          
          (store_current_scene, ":cur_scene"), #this might be a better option?
          (modify_visitors_at_site, ":cur_scene"),
          #<entry_no>,<troop_id>,<number_of_troops>, <team_no>, <group_no>), 
          #team no and group no are used in multiplayer mode only. default team in entry is used in single player mode
          (store_current_scene, ":cur_scene"),
          (modify_visitors_at_site, ":cur_scene"),
          (assign, ":nearest_entry_no", 24),
          (add_visitors_to_current_scene, ":nearest_entry_no", ":prisoner", 1, 0, 0),
          (troop_set_slot, ":prisoner", "slot_troop_will_join_prison_break", 1),
        (try_end),
	  ]),

      (ti_tab_pressed, 0, 0,
      [
        (try_begin),
          (this_or_next|eq, "$talk_context", tc_escape),
          (eq, "$talk_context", tc_prison_break),
          (display_message, "str_cannot_leave_now"),
        (else_try),
          (this_or_next|eq, "$g_mt_mode", tcm_default),
          (eq, "$g_mt_mode", tcm_disguised),
          (set_trigger_result, 1),
          (mission_enable_talk),
        (else_try),
          (display_message, "str_cannot_leave_now"),
        (try_end),
      ], 
      []),
            
      (ti_before_mission_start, 0, 0, [], 
      [
        (call_script, "script_change_banners_and_chest"),
        (call_script, "script_remove_siege_objects"),
      ]),
      
      (3, 0, 0, 
      [     
        (main_hero_fallen, 0),
      ],	  
      [
        (try_begin),
          (this_or_next|eq, "$talk_context", tc_prison_break),
          (eq, "$talk_context", tc_escape),
       
          (call_script, "script_deduct_casualties_from_garrison"),
	      (jump_to_menu,"mnu_captivity_start_castle_defeat"), 
	 
	      (assign, ":end_cond", kingdom_ladies_end),
          (try_for_range, ":prisoner", active_npcs_begin, ":end_cond"),
  	        (troop_set_slot, ":prisoner", "slot_troop_mission_participation", 0), #new
  	      (try_end),  
	 
	      (mission_enable_talk),
	      (finish_mission, 0),
	    (else_try),  
	      (mission_enable_talk),
	      (finish_mission, 0),
	      (set_trigger_result, 1),
        (try_end),	 	 
      ]),
      
      (3, 0, 0, 
      [
        (eq, "$talk_context", tc_escape),
        (neg|main_hero_fallen,0),
        (store_mission_timer_a, ":time"),
        (ge, ":time", 10),      
        (all_enemies_defeated), #1 is default enemy team for in-town battles
      ],
      [
        (call_script, "script_deduct_casualties_from_garrison"),
        (try_for_agents, ":agent"),
          (agent_get_troop_id, ":troop", ":agent"),
          (troop_slot_ge, ":troop", "slot_troop_mission_participation", mp_prison_break_fight),
          (try_begin),
            (agent_is_alive, ":agent"),
            (troop_set_slot, ":troop", "slot_troop_mission_participation", mp_prison_break_escaped),
          (else_try),
            (troop_set_slot, ":troop", "slot_troop_mission_participation", mp_prison_break_caught),
          (try_end),
        (try_end),
        (jump_to_menu, "mnu_sneak_into_town_caught_ran_away"),
        (mission_enable_talk),
        (finish_mission, 0),
      ]),
    ] + bodyguard_triggers, #chief bodyboard caba'drin
  ),


  (
    "training_ground_trainer_talk", 0, -1,
    "Training.",
    [
      (0,mtef_scene_source|mtef_team_0,af_override_horse|af_override_weapons,0,1,[]),
      (1,mtef_scene_source|mtef_team_0,af_override_horse|af_override_weapons,0,1,[]),
      (2,mtef_scene_source|mtef_team_0,af_override_horse|af_override_weapons,0,1,[]),
      (3,mtef_scene_source|mtef_team_0,af_override_horse|af_override_weapons,0,1,[]),
      (4,mtef_scene_source|mtef_team_0,af_override_horse|af_override_weapons,0,1,[]),
      (5,mtef_scene_source|mtef_team_0,af_override_horse|af_override_weapons,0,1,[]),
      (6,mtef_scene_source|mtef_team_0,0,0,1,[]),
    ],
    [
      (ti_before_mission_start, 0, 0, [],
       [
         (call_script, "script_change_banners_and_chest"),
         ]),
      (ti_inventory_key_pressed, 0, 0,
       [
         (set_trigger_result,1),
         ], []),
      (ti_tab_pressed, 0, 0,
       [
         (set_trigger_result,1),
         ], []),
     (0.0, 1.0, 2.0,
      [(lt, "$trainer_help_message", 2),
        ],
      [(try_begin),
         (eq, "$trainer_help_message", 0),
#         (tutorial_box, "str_trainer_help_1", "@Tutorial"),
       (else_try),
#         (tutorial_box, "str_trainer_help_2", "@Tutorial"),
       (try_end),
       (val_add, "$trainer_help_message", 1),
          ]),
      
    ],
  ),

  (
    "training_ground_trainer_training",mtf_arena_fight,-1,
    "You will fight a match in the arena.",
    [
      (16, mtef_visitor_source|mtef_team_0,af_override_everything,aif_start_alarmed,1,["itm_shield_4a", "itm_practice_sword", "itm_cheap_shoes"]),
      (17, mtef_visitor_source|mtef_team_1,af_override_everything,aif_start_alarmed,1,["itm_practice_staff", "itm_cheap_shoes"]),
      (18, mtef_visitor_source|mtef_team_2,af_override_everything,aif_start_alarmed,1,["itm_practice_staff", "itm_cheap_shoes"]),
      (19, mtef_visitor_source|mtef_team_3,af_override_everything,aif_start_alarmed,1,["itm_practice_sword", "itm_cheap_shoes"]),
      (20, mtef_visitor_source,0,0,1,[]),
    ],
    [
      (ti_before_mission_start, 0, 0, [], [(call_script, "script_change_banners_and_chest")]),
      
      common_arena_fight_tab_press,
      
      (ti_question_answered, 0, 0, [],
       [
         (store_trigger_param_1, ":answer"),
         (eq, ":answer", 0),
         (set_jump_mission, "mt_training_ground_trainer_talk"),
         (modify_visitors_at_site, "$g_training_ground_melee_training_scene"),
         (reset_visitors),
         (set_jump_entry, 5),
         (jump_to_scene, "$g_training_ground_melee_training_scene"),
         ]),
      (1, 3, ti_once, [(main_hero_fallen,0)],
       [
         (set_jump_mission, "mt_training_ground_trainer_talk"),
         (modify_visitors_at_site, "$g_training_ground_melee_training_scene"),
         (reset_visitors),
         (set_jump_entry, 5),
         (jump_to_scene, "$g_training_ground_melee_training_scene"),
         ]),
      (1, 3, ti_once,
       [
         (store_mission_timer_a, reg1),
         (ge, reg1, 1),
         (num_active_teams_le, 1),
         (neg|main_hero_fallen),
         (assign, "$training_fight_won", 1),
         ],
       [
         (set_jump_mission, "mt_training_ground_trainer_talk"),
         (modify_visitors_at_site, "$g_training_ground_melee_training_scene"),
         (reset_visitors),
         (set_jump_entry, 5),
         (jump_to_scene, "$g_training_ground_melee_training_scene"),
         ]),
      (ti_inventory_key_pressed, 0, 0, [(display_message,"str_cant_use_inventory_arena")], []),
    ],
  ),


  (
    "training_ground_training", mtf_arena_fight, -1,
    "Training.",
    [
      (0,mtef_visitor_source|mtef_team_0,af_override_everything,aif_start_alarmed,1,["itm_practice_staff"]),
      (1,mtef_visitor_source|mtef_team_1,af_override_everything,aif_start_alarmed,1,["itm_practice_staff"]),
      (2,mtef_visitor_source|mtef_team_1,af_override_everything,aif_start_alarmed,1,["itm_practice_staff"]),
      (3,mtef_visitor_source|mtef_team_1,af_override_everything,aif_start_alarmed,1,["itm_practice_staff"]),
      (4,mtef_visitor_source|mtef_team_1,af_override_everything,aif_start_alarmed,1,["itm_practice_staff"]),
      (8,mtef_visitor_source,af_override_weapons|af_override_horse|af_override_head,0,1,[]),
      (9,mtef_visitor_source,af_override_weapons|af_override_horse|af_override_head,0,1,[]),
      (10,mtef_visitor_source,af_override_weapons|af_override_horse|af_override_head,0,1,[]),
      (11,mtef_visitor_source,af_override_weapons|af_override_horse|af_override_head,0,1,[]),
      (12,mtef_visitor_source,af_override_weapons|af_override_horse|af_override_head,0,1,[]),
      (13,mtef_visitor_source,af_override_weapons|af_override_horse|af_override_head,0,1,[]),
      (14,mtef_visitor_source,af_override_weapons|af_override_horse|af_override_head,0,1,[]),
      (15,mtef_visitor_source,af_override_weapons|af_override_horse|af_override_head,0,1,[]),
    ],
    [
      (ti_before_mission_start, 0, 0, [],
       [
         (assign, "$g_last_destroyed_gourds", 0),
         (call_script, "script_change_banners_and_chest")]),
      
      common_arena_fight_tab_press,
      
      (ti_question_answered, 0, 0, [],
       [
         (store_trigger_param_1,":answer"),
         (eq,":answer",0),
         (assign, "$g_training_ground_training_success_ratio", 0),
         (jump_to_menu, "mnu_training_ground_training_result"),
         (finish_mission),
         ]),
      
      common_inventory_not_available,

      (0, 0, ti_once,
       [
         (try_begin),
           (eq, "$g_mt_mode", ctm_ranged),
           (set_fixed_point_multiplier, 100),
           (entry_point_get_position, pos1, 0),
           (init_position, pos2),
           (position_set_y, pos2, "$g_training_ground_ranged_distance"),
           (position_transform_position_to_parent, pos3, pos1, pos2),
           (copy_position, pos1, pos3),
           (assign, ":end_cond", 10),
           (assign, ":shift_value", 0),
           (try_for_range, ":cur_i", 0, ":end_cond"),
             (store_sub, ":cur_instance", ":cur_i", ":shift_value"),
             (scene_prop_get_instance, ":target_object", "spr_gourd", ":cur_instance"),
             (copy_position, pos2, pos1),
             (init_position, pos0),
             (store_random_in_range, ":random_no", 0, 360),
             (position_rotate_z, pos2, ":random_no"),
             (store_random_in_range, ":random_no", 50, 600),
             (position_move_x, pos2, ":random_no"),
             (store_random_in_range, ":random_no", 0, 360),
             (position_transform_position_to_local, pos3, pos1, pos2),
             (position_rotate_z, pos0, ":random_no"),
             (position_transform_position_to_parent, pos4, pos0, pos3),
             (position_transform_position_to_parent, pos2, pos1, pos4),
             (position_set_z_to_ground_level, pos2),
             (position_move_z, pos2, 150),
             (assign, ":valid", 1),
             (try_for_range, ":cur_instance_2", 0, 10),
               (eq, ":valid", 1),
               (neq, ":cur_instance", ":cur_instance_2"),
               (scene_prop_get_instance, ":target_object_2", "spr_gourd", ":cur_instance_2"),
               (prop_instance_get_position, pos3, ":target_object_2"),
               (get_distance_between_positions, ":dist", pos2, pos3),
               (lt, ":dist", 100),
               (assign, ":valid", 0),
             (try_end),
             (try_begin),
               (eq, ":valid", 0),
               (val_add, ":end_cond", 1),
               (val_add, ":shift_value", 1),
             (else_try),
               (prop_instance_set_position, ":target_object", pos2),
               (prop_instance_animate_to_position, ":target_object", pos2, 1),
               (scene_prop_get_instance, ":target_object_2", "spr_gourd_spike", ":cur_instance"),
               (position_move_z, pos2, -150), #moving back to ground level
               (prop_instance_set_position, ":target_object_2", pos2),
               (prop_instance_animate_to_position, ":target_object_2", pos2, 1),
             (try_end),
           (try_end),
         (else_try),
           (eq, "$g_mt_mode", ctm_mounted),
           (assign, ":num_gourds", 0),
           #First, placing gourds on the spikes
           (try_for_range, ":cur_i", 0, 100),
             (scene_prop_get_instance, ":target_object", "spr_gourd", ":cur_i"),
             (scene_prop_get_instance, ":target_object_2", "spr_gourd_spike", ":cur_i"),
             (ge, ":target_object", 0),
             (ge, ":target_object_2", 0),
             (val_add, ":num_gourds", 1),
             (prop_instance_get_position, pos0, ":target_object_2"),
             (position_move_z, pos0, 150),
             (prop_instance_set_position, ":target_object", pos0),
             (prop_instance_animate_to_position, ":target_object", pos0, 1),
           (try_end),
           (store_sub, ":end_cond", ":num_gourds", "$g_training_ground_training_num_gourds_to_destroy"),
           #Second, removing gourds and their spikes randomly
           (try_for_range, ":cur_i", 0, ":end_cond"),
             (store_random_in_range, ":random_instance", 0, ":num_gourds"),
             (scene_prop_get_instance, ":target_object", "spr_gourd", ":random_instance"),
             (prop_instance_get_position, pos0, ":target_object"),
             (position_get_z, ":pos_z", pos0),
             (try_begin),
               (lt, ":pos_z", -50000),
#               (val_add, ":end_cond", 1), #removed already, try again
             (else_try),
               (position_set_z, pos0, -100000),
               (prop_instance_set_position, ":target_object", pos0),
               (prop_instance_animate_to_position, ":target_object", pos0, 1),
               (scene_prop_get_instance, ":target_object_2", "spr_gourd_spike", ":random_instance"),
               (prop_instance_set_position, ":target_object_2", pos0),
               (prop_instance_animate_to_position, ":target_object_2", pos0, 1),
             (try_end),
           (try_end),
         (try_end),
         ],
       []),

      (1, 3, ti_once,
       [
         (eq, "$g_mt_mode", ctm_melee),
         (this_or_next|main_hero_fallen),
         (num_active_teams_le, 1)
         ],
       [
         (try_begin),
           (neg|main_hero_fallen),
           (assign, "$g_training_ground_training_success_ratio", 100),
         (else_try),
           (assign, ":alive_enemies", 0),
           (try_for_agents, ":agent_no"),
             (agent_is_alive, ":agent_no"),
             (agent_is_human, ":agent_no"),
             (agent_get_team, ":team_no", ":agent_no"),
             (eq, ":team_no", 1),
             (val_add, ":alive_enemies", 1),
           (try_end),
           (store_sub, ":dead_enemies", "$g_training_ground_training_num_enemies", ":alive_enemies"),
           (store_mul, "$g_training_ground_training_success_ratio", ":dead_enemies", 100),
           (val_div, "$g_training_ground_training_success_ratio", "$g_training_ground_training_num_enemies"),
         (try_end),
         (jump_to_menu, "mnu_training_ground_training_result"),
         (finish_mission),
         ]),

      (1, 3, ti_once,
       [
         (eq, "$g_mt_mode", ctm_ranged),
         (get_player_agent_no, ":player_agent"),
         (agent_get_ammo, ":ammo", ":player_agent"),
         (store_mission_timer_a, ":cur_seconds"),
         (this_or_next|main_hero_fallen),
         (this_or_next|eq, ":ammo", 0),
         (gt, ":cur_seconds", 116), 
         ],
       [
         (store_mul, "$g_training_ground_training_success_ratio", "$scene_num_total_gourds_destroyed", 10),
         (jump_to_menu, "mnu_training_ground_training_result"),
         (finish_mission),
         ]),

      (1, 3, ti_once,
       [
         (eq, "$g_mt_mode", ctm_mounted),
         (get_player_agent_no, ":player_agent"),
         (agent_get_horse, ":player_horse", ":player_agent"),
         (store_mission_timer_a, ":cur_seconds"),
         (this_or_next|lt, ":player_horse", 0),
         (this_or_next|main_hero_fallen),
         (this_or_next|ge, "$scene_num_total_gourds_destroyed", "$g_training_ground_training_num_gourds_to_destroy"),
         (gt, ":cur_seconds", 120),
         ],
       [
         (store_mul, "$g_training_ground_training_success_ratio", "$scene_num_total_gourds_destroyed", 100),
         (val_div, "$g_training_ground_training_success_ratio", "$g_training_ground_training_num_gourds_to_destroy"),
         (jump_to_menu, "mnu_training_ground_training_result"),
         (finish_mission),
         ]),

      (0, 0, 0,
       [
         (gt, "$g_last_destroyed_gourds", 0),
         (try_begin),
           (eq, "$g_mt_mode", ctm_ranged),
           (entry_point_get_position, pos1, 0),
           (position_move_y, pos1, 100, 0),
           (get_player_agent_no, ":player_agent"),
           (agent_get_position, pos2, ":player_agent"),
           (try_begin),
             (position_is_behind_position, pos2, pos1),
             (val_add, "$scene_num_total_gourds_destroyed", "$g_last_destroyed_gourds"),
           (else_try),
             (display_message, "@You must stay behind the line on the ground! Point is not counted."),
           (try_end),
         (else_try),
           (val_add, "$scene_num_total_gourds_destroyed", "$g_last_destroyed_gourds"),
         (try_end),
         (assign, "$g_last_destroyed_gourds", 0),
         ],
       []),
    ],
  ),

  (
    "sneak_caught_fight",mtf_battle_mode,-1,
    "You must fight your way out!",
    [
     (0,mtef_scene_source|mtef_team_0,af_override_all,aif_start_alarmed,1,pilgrim_disguise),
     (1,mtef_scene_source|mtef_team_0,af_override_all,aif_start_alarmed,1,pilgrim_disguise),
     (2,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (3,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (4,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (5,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (6,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (7,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (8,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (9,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (10,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (11,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (12,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (13,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (14,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (15,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (16,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (17,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (18,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (19,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (20,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (21,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (22,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (23,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (24,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (25,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (26,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (27,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (28,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (29,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (30,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (31,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (32,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (33,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (34,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (35,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (36,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (37,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (38,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (39,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (40,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (41,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (42,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (43,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (44,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (45,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (46,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (47,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (48,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (49,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (50,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (51,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (52,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (53,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (54,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (55,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (56,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (57,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (58,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (59,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (60,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (61,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (62,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (63,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (64,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     
     # (0,mtef_visitor_source|mtef_team_0,af_override_all,aif_start_alarmed,1,pilgrim_disguise),
     # (25,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     # (26,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     # (27,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     # (28,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     # (29,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     # (30,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     # (31,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     # (32,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
    ],
    [    
      (ti_before_mission_start, 0, 0, [], 
      [
        (call_script, "script_change_banners_and_chest"),
      ]),
      
      (ti_after_mission_start, 0, 0, [],
       [
        (assign, ":num_guards", 5),
        
        (try_begin),
          (party_get_slot, ":last_nearby_fire_time", "$current_town", "slot_town_last_nearby_fire_time"),                          
          (store_current_hours, ":cur_time"),
          (store_add, ":fire_finish_time", ":last_nearby_fire_time", 4),                          
          (is_between, ":cur_time", ":fire_finish_time", ":last_nearby_fire_time"),
          (assign, ":num_guards", 2),
        (else_try),  
          (this_or_next|eq, "$talk_context", tc_escape),
          (eq, "$talk_context", tc_prison_break),

          (assign, ":num_guards", 4),
        (try_end),
        
        (try_begin),
          (this_or_next|eq, "$talk_context", tc_escape),
          (eq, "$talk_context", tc_prison_break),
          (entry_point_get_position, pos0, 7), 
        (else_try),          
          (party_slot_eq, "$current_town", "slot_party_type", spt_town),
          (entry_point_get_position, pos0, 0), 
        (else_try),  
          (entry_point_get_position, pos0, 1), 
        (try_end),
                        
        (assign, ":last_nearest_entry_distance", -1),
        (assign, ":last_nearest_entry_point", -1),
        (try_for_range, ":guard_no", 0, ":num_guards"),
          (assign, ":smallest_dist", 100000),
          (try_for_range, ":guard_entry_point", 2, 64),
            (neq, ":last_nearest_entry_point", ":guard_entry_point"),
            (entry_point_get_position, pos1, ":guard_entry_point"), 
            (get_distance_between_positions, ":dist", pos0, pos1),
            (lt, ":dist", ":smallest_dist"),
            (gt, ":dist", ":last_nearest_entry_distance"),
            (assign, ":smallest_dist", ":dist"),
            (assign, ":nearest_entry_point", ":guard_entry_point"),
          (try_end),  
          
          (store_faction_of_party, ":town_faction","$current_town"),
          (try_begin),
            (this_or_next|eq, ":guard_no", 0),
            (eq, ":guard_no", 2),
            (faction_get_slot, ":troop_of_guard", ":town_faction", "slot_faction_tier_2_troop"),
          (else_try),  
            (faction_get_slot, ":troop_of_guard", ":town_faction", "slot_faction_tier_2_troop"),
          (try_end),
          
          (assign, ":last_nearest_entry_point", ":nearest_entry_point"),
          (assign, ":last_nearest_entry_distance", ":smallest_dist"),
                    
          (add_visitors_to_current_scene, ":nearest_entry_point", ":troop_of_guard", 1, 0),                      
        (try_end),
      ]),
      
      (ti_tab_pressed, 0, 0, [],
       [(question_box,"str_do_you_wish_to_surrender")]),
       
      (ti_question_answered, 0, 0, [],
       [(store_trigger_param_1,":answer"),(eq,":answer",0),(jump_to_menu,"mnu_captivity_start_castle_defeat"),(finish_mission,0),]),
      
      (1, 0, ti_once, [],
       [
         (play_sound,"snd_sneak_town_halt"),
         (call_script, "script_music_set_situation_with_culture", mtf_sit_fight),
         ]),
         
      (0, 3, 0,
       [
          (main_hero_fallen,0),
        ],
       [
         (jump_to_menu,"mnu_captivity_start_castle_defeat"),
         (finish_mission,0),
       ]),
       
      (1, 0, 0, [], 
       [
	    (get_player_agent_no, ":player_agent"),
	    (agent_get_position, pos0, ":player_agent"),
	    	    
        (try_for_agents, ":agent_no"),
          (neq, ":agent_no", ":player_agent"),
          (agent_is_alive, ":agent_no"),
          (agent_get_team, ":agent_team", ":agent_no"),
          (eq, ":agent_team", 1),
          
          (agent_get_position, pos1, ":agent_no"),
        
          (get_distance_between_positions, ":dist", pos0, pos1),
         
          (try_begin),
            (le, ":dist", 800),
            (agent_clear_scripted_mode, ":agent_no"),
          (else_try),  
            (agent_set_scripted_destination, ":agent_no", pos0, 0),
          (try_end),
        (try_end),                  	      
       ]), 

	   (5, 1, ti_once, 
	   [
	     (num_active_teams_le,1),
	     (neg|main_hero_fallen),

         (store_mission_timer_a,":cur_time"),
         (ge, ":cur_time", 5),
	   ],
       [
         (assign,"$auto_menu",-1),
         (jump_to_menu,"mnu_sneak_into_town_caught_dispersed_guards"),
         (finish_mission,1),
       ]),
       
	   (ti_on_leave_area, 0, ti_once, [],
       [(assign,"$auto_menu",-1),(jump_to_menu,"mnu_sneak_into_town_caught_ran_away"),(finish_mission,0)]),

      (ti_inventory_key_pressed, 0, 0, [(display_message,"str_cant_use_inventory_arena")], []),
      
    ] + dplmc_battle_mode_triggers3,
  ),

   (
    "ai_training",0,-1,
    "You start training.",
    [
#     (0,0,af_override_horse,aif_start_alarmed,1,[]),
     (0,0,0,aif_start_alarmed,30,[]),
#     (1,mtef_no_leader,0,0|aif_start_alarmed,5,[]),
#     (0,mtef_no_leader,0,0|aif_start_alarmed,0,[]),
#     (3,mtef_enemy_party|mtef_reverse_order,0,aif_start_alarmed,6,[]),
#     (4,mtef_enemy_party|mtef_reverse_order,0,aif_start_alarmed,0,[]),
     ],
    [
#      (ti_before_mission_start, 0, 0, [], [(set_rain, 1,100), (set_fog_distance, 10)]),
      (ti_tab_pressed, 0, 0, [],
       [(finish_mission,0)]),

      common_battle_order_panel,
      common_battle_order_panel_tick,

##      (0, 0, ti_once,
##       [
##         (key_clicked, key_numpad_7),
##        (mission_cam_set_mode,1),
##        (get_player_agent_no, ":player_agent"),
##        (mission_cam_set_target_agent, ":player_agent", 1),
##        (mission_cam_set_animation, "anim_test_cam"),], []),
    ],###gdw doesn't work+ dplmc_battle_mode_triggers2 + order_skirmish_triggers + formations_triggers + rider_damage + order_volley_triggers + warcry_chel + heridas_chel,
  ),
   (
    "camera_test",0,-1,
    "camera Test.",
    [
#     (0,mtef_attackers,0,aif_start_alarmed,5,[]),
     ],
    [
      (1, 0, 0, [(mission_cam_set_mode,1),
          (entry_point_get_position, pos3, 3),
          (mission_cam_set_position, pos3)], []),
#      (ti_before_mission_start, 0, 0, [], [(set_rain, 1,100)]),
      (ti_tab_pressed, 0, 0, [],
       [(finish_mission,0)]),
    ],
  ),
#chief cambia armas en arena
  (
    "arena_melee_fight",mtf_arena_fight,-1,
    "You enter a melee fight in the arena.",
    [
      (0,mtef_visitor_source|mtef_team_0,af_override_all,aif_start_alarmed,1,["itm_practice_sword", "itm_shield_4a", "itm_practice_seaxe", "itm_arena_tunic_red", "itm_arena_skullcap_red", "itm_arena_shieldred"]),
      (1,mtef_visitor_source|mtef_team_0,af_override_all,aif_start_alarmed,1,["itm_practice_sword", "itm_arena_tunic_red"]),
      (2,mtef_visitor_source|mtef_team_0,af_override_all,aif_start_alarmed,1,["itm_practice_sword", "itm_practice_seaxe", "itm_arena_tunic_red", "itm_arena_skullcap_red"]),
      (3,mtef_visitor_source|mtef_team_0,af_override_all,aif_start_alarmed,1,["itm_practice_staff", "itm_shield_4a", "itm_javelins", "itm_arena_tunic_red", "itm_arena_skullcap_red"]),
      (4,mtef_visitor_source|mtef_team_0,af_override_all,aif_start_alarmed,1,["itm_practice_staff", "itm_shield_4a", "itm_arena_tunic_red"]),
      (5,mtef_visitor_source|mtef_team_0,af_override_all,aif_start_alarmed,1,["itm_practice_sword", "itm_shield_4a", "itm_arena_tunic_red"]),
      (6,mtef_visitor_source|mtef_team_0,af_override_all,aif_start_alarmed,1,["itm_practice_staff", "itm_shield_4a", "itm_arena_tunic_red"]),
      (7,mtef_visitor_source|mtef_team_0,af_override_all,aif_start_alarmed,1,["itm_practice_sword", "itm_shield_4a", "itm_saddle_horse1", "itm_arena_tunic_red", "itm_arena_skullcap_red"]),

      (8,mtef_visitor_source|mtef_team_1,af_override_all,aif_start_alarmed,1,["itm_practice_sword", "itm_shield_4a", "itm_practice_seaxe", "itm_arena_tunic_blue"]),
      (9,mtef_visitor_source|mtef_team_1,af_override_all,aif_start_alarmed,1,["itm_practice_sword", "itm_arena_tunic_blue", "itm_arena_helm_blue"]),
      (10,mtef_visitor_source|mtef_team_1,af_override_all,aif_start_alarmed,1,["itm_practice_sword", "itm_practice_seaxe", "itm_arena_tunic_blue"]),
      (11,mtef_visitor_source|mtef_team_1,af_override_all,aif_start_alarmed,1,["itm_practice_staff", "itm_shield_4a", "itm_javelins", "itm_arena_tunic_blue", "itm_arena_helm_blue"]),
      (12,mtef_visitor_source|mtef_team_1,af_override_all,aif_start_alarmed,1,["itm_practice_staff", "itm_shield_4a", "itm_arena_tunic_blue"]),
      (13,mtef_visitor_source|mtef_team_1,af_override_all,aif_start_alarmed,1,["itm_practice_sword", "itm_shield_4a", "itm_arena_tunic_blue", "itm_arena_helm_blue"]),
      (14,mtef_visitor_source|mtef_team_1,af_override_all,aif_start_alarmed,1,["itm_practice_staff", "itm_shield_4a", "itm_arena_tunic_blue"]),
      (15,mtef_visitor_source|mtef_team_1,af_override_all,aif_start_alarmed,1,["itm_practice_sword", "itm_shield_4a", "itm_saddle_horse1", "itm_arena_tunic_blue"]),

      (16,mtef_visitor_source|mtef_team_2,af_override_all,aif_start_alarmed,1,["itm_practice_sword", "itm_shield_4a", "itm_practice_seaxe", "itm_arena_tunic_green", "itm_arena_helm_green"]),
      (17,mtef_visitor_source|mtef_team_2,af_override_all,aif_start_alarmed,1,["itm_practice_sword", "itm_arena_tunic_green", "itm_arena_helm_green"]),
      (18,mtef_visitor_source|mtef_team_2,af_override_all,aif_start_alarmed,1,["itm_practice_sword", "itm_practice_seaxe", "itm_arena_tunic_green", "itm_arena_helm_green"]),
      (19,mtef_visitor_source|mtef_team_2,af_override_all,aif_start_alarmed,1,["itm_practice_staff", "itm_shield_4a", "itm_javelins", "itm_arena_tunic_green", "itm_arena_helm_green"]),
      (20,mtef_visitor_source|mtef_team_2,af_override_all,aif_start_alarmed,1,["itm_practice_staff", "itm_shield_4a", "itm_arena_tunic_green", "itm_arena_helm_green"]),
      (21,mtef_visitor_source|mtef_team_2,af_override_all,aif_start_alarmed,1,["itm_practice_sword", "itm_shield_4a", "itm_arena_tunic_green"]),
      (22,mtef_visitor_source|mtef_team_2,af_override_all,aif_start_alarmed,1,["itm_practice_staff", "itm_shield_4a", "itm_arena_tunic_green"]),
      (23,mtef_visitor_source|mtef_team_2,af_override_all,aif_start_alarmed,1,["itm_practice_sword", "itm_shield_4a", "itm_saddle_horse1", "itm_arena_tunic_green", "itm_arena_helm_green"]),

      (24,mtef_visitor_source|mtef_team_3,af_override_all,aif_start_alarmed,1,["itm_practice_sword", "itm_shield_4a", "itm_practice_seaxe", "itm_arena_tunic_yellow", "itm_arena_helm_yellow"]),
      (25,mtef_visitor_source|mtef_team_3,af_override_all,aif_start_alarmed,1,["itm_practice_sword", "itm_arena_tunic_yellow", "itm_arena_helm_yellow"]),
      (26,mtef_visitor_source|mtef_team_3,af_override_all,aif_start_alarmed,1,["itm_practice_sword", "itm_practice_seaxe", "itm_arena_tunic_yellow", "itm_arena_helm_yellow"]),
      (27,mtef_visitor_source|mtef_team_3,af_override_all,aif_start_alarmed,1,["itm_practice_staff", "itm_shield_4a", "itm_javelins", "itm_arena_tunic_yellow", "itm_arena_helm_yellow"]),
      (28,mtef_visitor_source|mtef_team_3,af_override_all,aif_start_alarmed,1,["itm_practice_staff", "itm_shield_4a", "itm_arena_tunic_yellow", "itm_arena_helm_yellow"]),
      (29,mtef_visitor_source|mtef_team_3,af_override_all,aif_start_alarmed,1,["itm_practice_sword", "itm_shield_4a", "itm_arena_tunic_yellow"]),
      (30,mtef_visitor_source|mtef_team_3,af_override_all,aif_start_alarmed,1,["itm_practice_staff", "itm_shield_4a", "itm_arena_tunic_yellow"]),
      (31,mtef_visitor_source|mtef_team_3,af_override_all,aif_start_alarmed,1,["itm_practice_sword", "itm_shield_4a", "itm_saddle_horse1", "itm_arena_tunic_yellow", "itm_arena_helm_yellow"]),
#32
      (32, mtef_visitor_source|mtef_team_1,af_override_all,aif_start_alarmed,1,["itm_practice_sword"]),
      (33,mtef_visitor_source|mtef_team_2,af_override_all,aif_start_alarmed,1,["itm_practice_staff", "itm_shield_4a"]),
      (34,mtef_visitor_source|mtef_team_3,af_override_all,aif_start_alarmed,1,["itm_practice_sword", "itm_shield_4a"]),
      (35,mtef_visitor_source|mtef_team_4,af_override_all,aif_start_alarmed,1,["itm_practice_staff", "itm_shield_4a"]),
      (36, mtef_visitor_source|mtef_team_1,af_override_all,aif_start_alarmed,1,["itm_practice_sword", "itm_shield_4a", "itm_practice_seaxe"]),
      (37,mtef_visitor_source|mtef_team_2,af_override_all,aif_start_alarmed,1,["itm_practice_sword", "itm_shield_4a"]),
      (38,mtef_visitor_source|mtef_team_3,af_override_all,aif_start_alarmed,1,["itm_practice_sword"]),
      (39,mtef_visitor_source|mtef_team_4,af_override_all,aif_start_alarmed,1,["itm_practice_staff", "itm_shield_4a"]),
#40-49 not used yet
      (24,mtef_visitor_source|mtef_team_3,af_override_all,aif_start_alarmed,1,["itm_practice_sword", "itm_shield_4a", "itm_practice_seaxe", "itm_arena_tunic_yellow", "itm_arena_helm_yellow"]),
      (24,mtef_visitor_source|mtef_team_3,af_override_all,aif_start_alarmed,1,["itm_practice_sword", "itm_arena_tunic_yellow", "itm_arena_helm_yellow"]),
      (24,mtef_visitor_source|mtef_team_3,af_override_all,aif_start_alarmed,1,["itm_practice_sword", "itm_practice_seaxe", "itm_arena_tunic_yellow", "itm_arena_helm_yellow"]),
      (24,mtef_visitor_source|mtef_team_3,af_override_all,aif_start_alarmed,1,["itm_practice_staff", "itm_shield_4a", "itm_javelins", "itm_arena_tunic_yellow", "itm_arena_helm_yellow"]),
      (24,mtef_visitor_source|mtef_team_3,af_override_all,aif_start_alarmed,1,["itm_practice_staff", "itm_shield_4a", "itm_arena_tunic_yellow", "itm_arena_helm_yellow"]),
      (24,mtef_visitor_source|mtef_team_3,af_override_all,aif_start_alarmed,1,["itm_practice_sword", "itm_shield_4a", "itm_arena_tunic_yellow"]),
      (24,mtef_visitor_source|mtef_team_3,af_override_all,aif_start_alarmed,1,["itm_practice_staff", "itm_shield_4a", "itm_arena_tunic_yellow"]),
      (24,mtef_visitor_source|mtef_team_3,af_override_all,aif_start_alarmed,1,["itm_practice_sword", "itm_shield_4a", "itm_saddle_horse1", "itm_arena_tunic_yellow", "itm_arena_helm_yellow"]),
      (24,mtef_visitor_source|mtef_team_3,af_override_all,aif_start_alarmed,1,["itm_practice_sword", "itm_shield_4a", "itm_practice_seaxe", "itm_arena_tunic_yellow", "itm_arena_helm_yellow"]),
      (24,mtef_visitor_source|mtef_team_3,af_override_all,aif_start_alarmed,1,["itm_practice_sword", "itm_shield_4a", "itm_practice_seaxe", "itm_arena_tunic_yellow", "itm_arena_helm_yellow"]),

      (50, mtef_scene_source,af_override_horse|af_override_weapons|af_override_head,0,1,[]),
      (51, mtef_visitor_source,af_override_horse|af_override_weapons|af_override_head,0,1,[]),
      (52, mtef_scene_source,af_override_horse,0,1,[]),
#not used yet:
      (53, mtef_scene_source,af_override_horse,0,1,[]),(54, mtef_scene_source,af_override_horse,0,1,[]),(55, mtef_scene_source,af_override_horse,0,1,[]),
#used for torunament master scene

      (56, mtef_visitor_source|mtef_team_0, af_override_all, aif_start_alarmed, 1, ["itm_practice_sword", "itm_shield_4a", "itm_linen_coatwcloak", "itm_skullcapt1"]), #cambiado chief
      (57, mtef_visitor_source|mtef_team_0, af_override_all, aif_start_alarmed, 1, ["itm_practice_sword", "itm_shield_4a", "itm_linen_coatwcloak", "itm_skullcapt1"]), #cambiado chief
    ],
    tournament_triggers
  ),


#torneos de practica personalizados chief
  ## Created a new template for sparring, just for simplicity - Jinnai
  ("arena_spar_fight",mtf_arena_fight,-1,
    "You enter a sparring match in the arena.",
    [
      (0,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (1,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (2,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (3,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (4,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (5,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (6,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (7,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),

      (8,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
      (9,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
      (10,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
      (11,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
      (12,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
      (13,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
      (14,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
      (15,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),

      (16,mtef_visitor_source|mtef_team_2,0,aif_start_alarmed,1,[]),
      (17,mtef_visitor_source|mtef_team_2,0,aif_start_alarmed,1,[]),
      (18,mtef_visitor_source|mtef_team_2,0,aif_start_alarmed,1,[]),
      (19,mtef_visitor_source|mtef_team_2,0,aif_start_alarmed,1,[]),
      (20,mtef_visitor_source|mtef_team_2,0,aif_start_alarmed,1,[]),
      (21,mtef_visitor_source|mtef_team_2,0,aif_start_alarmed,1,[]),
      (22,mtef_visitor_source|mtef_team_2,0,aif_start_alarmed,1,[]),
      (23,mtef_visitor_source|mtef_team_2,0,aif_start_alarmed,1,[]),

      (24,mtef_visitor_source|mtef_team_3,0,aif_start_alarmed,1,[]),
      (25,mtef_visitor_source|mtef_team_3,0,aif_start_alarmed,1,[]),
      (26,mtef_visitor_source|mtef_team_3,0,aif_start_alarmed,1,[]),
      (27,mtef_visitor_source|mtef_team_3,0,aif_start_alarmed,1,[]),
      (28,mtef_visitor_source|mtef_team_3,0,aif_start_alarmed,1,[]),
      (29,mtef_visitor_source|mtef_team_3,0,aif_start_alarmed,1,[]),
      (30,mtef_visitor_source|mtef_team_3,0,aif_start_alarmed,1,[]),
      (31,mtef_visitor_source|mtef_team_3,0,aif_start_alarmed,1,[]),

      (50, mtef_scene_source,af_override_horse|af_override_weapons|af_override_head,0,1,[]),
      (52, mtef_scene_source,af_override_horse,0,1,[]),
      (53, mtef_scene_source,af_override_horse,0,1,[]),
      (54, mtef_scene_source,af_override_horse,0,1,[]),
      (55, mtef_scene_source,af_override_horse,0,1,[]),
    ],
    [
    (ti_before_mission_start, 0, 0, [], [(call_script, "script_change_banners_and_chest")]),
    (ti_inventory_key_pressed, 0, 0, [(display_message,"str_cant_use_inventory_arena")], []),
    (ti_tab_pressed, 0, 0, [],
      [(question_box,"@End the sparring match?")]),
    (ti_question_answered, 0, 0, [],
      [(store_trigger_param_1,":answer"),
       (eq,":answer",0),
       (assign, "$g_mt_mode", abm_visit),
       (set_jump_mission, "mt_arena_melee_fight"),
       (party_get_slot, ":arena_scene", "$current_town", "slot_town_arena"),
       (modify_visitors_at_site, ":arena_scene"),
       (reset_visitors),
       (set_visitor, 35, "trp_veteran_fighter"),
       (set_visitor, 36, "trp_merc_infantryt5"),
       (set_jump_entry, 50),
       (jump_to_scene, ":arena_scene"),
      ]),

    (0, 0, ti_once, [],
      [(play_sound, "snd_arena_ambiance", sf_looping),
     (call_script, "script_music_set_situation_with_culture", mtf_sit_arena),
      ]),

    (0.1, 0, 0, [],
      [
        (try_for_agents,":agent"),
          (agent_is_alive,":agent"),
          (agent_is_human,":agent"),
          (agent_get_position,pos1,":agent"),
          (position_set_z_to_ground_level, pos1),
          (agent_get_horse,":horse",":agent"),
          (try_begin),
            (gt,":horse",0),
            (position_move_z,pos1,300),
          (else_try),
            (position_move_z,pos1,225),
          (try_end),
          (agent_get_team, ":team", ":agent"),
          (try_begin),
            (eq,":team",0),
            (particle_system_burst,"psys_team_0",pos1,30),
          (else_try),
            (eq,":team",1),
            (particle_system_burst,"psys_team_1",pos1,30),
          (else_try),
            (eq,":team",2),
            (particle_system_burst,"psys_team_2",pos1,30),
          (else_try),
            (eq,":team",3),
            (particle_system_burst,"psys_team_3",pos1,30),
          (try_end),
        (try_end),
      ]),

    (1, 4, ti_once, [(num_active_teams_le, 1)],
      [
       (try_begin),
         (neg|main_hero_fallen),
         (call_script, "script_play_victorious_sound"),
       (try_end),
       (assign, "$g_mt_mode", abm_visit),
       (set_jump_mission, "mt_arena_melee_fight"),
       (party_get_slot, ":arena_scene", "$current_town", "slot_town_arena"),
       (modify_visitors_at_site, ":arena_scene"),
       (reset_visitors),
       (set_visitor, 35, "trp_veteran_fighter"),
       (set_visitor, 36, "trp_merc_infantryt5"),
       (set_jump_entry, 50),
       (jump_to_scene, ":arena_scene"),
      ]),
    ],
  ),
  #torneos personalizados acaba


  (
    "arena_challenge_fight",mtf_arena_fight|mtf_commit_casualties,-1,
    "You enter a melee fight in the arena.",
    [
      (56, mtef_visitor_source|mtef_team_0, 0, aif_start_alarmed, 1, []),
      (58, mtef_visitor_source|mtef_team_2, 0, aif_start_alarmed, 1, []),
    ],
    [
      common_inventory_not_available,
      (ti_tab_pressed, 0, 0, [(display_message, "str_cannot_leave_now")], []),
      (ti_before_mission_start, 0, 0, [], [(call_script, "script_change_banners_and_chest")]),

      (0, 0, ti_once, [],
       [
         (call_script, "script_music_set_situation_with_culture", mtf_sit_arena),
         ]),

		 
	#NOTE -- THIS IS A VESTIGIAL SCRIPT. FOR LORD DUELS, USE THE NEXT SCRIPT DOWN 	 
      (1, 4, ti_once, [
	  (this_or_next|main_hero_fallen),
		(num_active_teams_le,1)],
       [
           (try_begin),
             (main_hero_fallen),
			 (check_quest_active, "qst_duel_for_lady"),
			 (quest_slot_eq, "qst_duel_for_lady", "slot_quest_target_troop", "$g_duel_troop"),
             (call_script, "script_fail_quest", "qst_duel_for_lady"),
           (else_try),
			 (check_quest_active, "qst_duel_for_lady"),
			 (quest_slot_eq, "qst_duel_for_lady", "slot_quest_target_troop", "$g_duel_troop"),
             (call_script, "script_succeed_quest", "qst_duel_for_lady"),
		   (else_try),
             (main_hero_fallen),
			 (check_quest_active, "qst_duel_courtship_rival"),
			 (quest_slot_eq, "qst_duel_courtship_rival", "slot_quest_target_troop", "$g_duel_troop"),
             (call_script, "script_fail_quest", "qst_duel_courtship_rival"),
           (else_try),
			 (check_quest_active, "qst_duel_courtship_rival"),
			 (quest_slot_eq, "qst_duel_courtship_rival", "slot_quest_target_troop", "$g_duel_troop"),
             (call_script, "script_succeed_quest", "qst_duel_courtship_rival"),
		   (else_try),	 
             (main_hero_fallen),
			 (check_quest_active, "qst_duel_avenge_insult"),
			 (quest_slot_eq, "qst_duel_avenge_insult", "slot_quest_target_troop", "$g_duel_troop"),
             (call_script, "script_fail_quest", "qst_duel_avenge_insult"),
           (else_try),
			 (check_quest_active, "qst_duel_avenge_insult"),
			 (quest_slot_eq, "qst_duel_avenge_insult", "slot_quest_target_troop", "$g_duel_troop"),
             (call_script, "script_succeed_quest", "qst_duel_avenge_insult"),
		   (else_try),	 
             (main_hero_fallen),
			 (check_quest_active, "qst_denounce_lord"),
			 (quest_slot_eq, "qst_denounce_lord", "slot_quest_target_troop", "$g_duel_troop"),
             (call_script, "script_fail_quest", "qst_denounce_lord"),
           (else_try),
			 (check_quest_active, "qst_denounce_lord"),
			 (quest_slot_eq, "qst_denounce_lord", "slot_quest_target_troop", "$g_duel_troop"),
             (call_script, "script_succeed_quest", "qst_denounce_lord"),
		   (else_try),
			 (quest_get_slot, ":target_troop", "qst_denounce_lord", "slot_quest_target_troop"),
		     (str_store_troop_name, s4, ":target_troop"),
		   (try_end),
           (finish_mission),
           ]),
torneo_aumenta_dano, #dunde torneo chief
#phaiak camara lenta
  (ti_on_agent_killed_or_wounded, 0, 0, [],
   [
    (try_begin),
      (store_trigger_param_1, ":dead_agent_no"),
      (store_trigger_param_2, ":killer_agent_no"),
          (agent_is_human, ":dead_agent_no"),
      (get_player_agent_no, ":player_agent"),
      (this_or_next|eq, ":player_agent", ":killer_agent_no"),
      (eq, ":player_agent", ":dead_agent_no"),
      # (store_random_in_range, ":chance", 1, 5),
      # (eq, ":chance", 1),

      # (store_random_in_range, ":speed", 16, 18), #chief cambia speed of 10 a 18 y de 4 a 16 MOTO do below
      # (mission_set_time_speed, ":speed"), #this works only when cheat mode is enabled

      (agent_get_position, pos20, ":dead_agent_no"),
      (agent_get_position, pos9, ":killer_agent_no"),
      (position_copy_rotation, pos20, pos9),
      (position_move_z, pos20, 150),
      (store_random_in_range, "$ani_x_angle", -35, 35),
      (store_random_in_range, "$ani_distance", -230, -70),
      (store_random_in_range, ":direktion", -1, 1),
      (try_begin),
        (eq, ":direktion", 0),
        (assign, "$ani_z_angle", 5),
        (position_rotate_z, pos20, 35),
      (else_try),
        (assign, "$ani_z_angle", -5),
        (position_rotate_z, pos20, -35),
      (try_end),
      (mission_cam_set_mode, 1, 10, 0),
      (assign, "$ani_step", 30),
    (try_end),
   ]),


   (0, 0, 0, [(gt, "$ani_step", 0)],

   [
      (store_mission_timer_a_msec, ":time"),
      (ge, ":time", "$kill_cam_end"),
      (try_begin),
        (ge, "$ani_step", 2),

        (store_div, ":interval", 7000, 30),    #desired animation length in milliseconds, divided by animation steps (see above)
        (try_begin),
          (ge, "$cheat_mode", 1),    #can use slo-mo effect
          (store_sub, ":reduction_factor", 32, "$ani_step"),
          (val_div, ":interval", ":reduction_factor"),
          (store_div, ":speed", 1000, ":reduction_factor"),    #reduce mission speed by same ratio to keep animation within the desired time window
          (mission_set_time_speed, ":speed"),
        (try_end),

        (position_rotate_z, pos20, "$ani_z_angle"),
        (copy_position, pos21, pos20),

        (val_sub, "$ani_x_angle", 1),    #MOTO turn camera down
        (position_rotate_x, pos21, "$ani_x_angle"),
        (val_sub, "$ani_distance", 10),    #MOTO back away
        (position_move_y, pos21, "$ani_distance"),
        (mission_cam_animate_to_position,  pos21, ":interval", 0),    #MOTO change to :interval from 5
        # (store_mission_timer_a_msec, "$kill_cam_end"),# for next step
        # (val_add, "$kill_cam_end", 5),
        (store_add, "$kill_cam_end", ":time", ":interval"),

        (val_add, "$ani_step", -1),
      (else_try),
        (eq, "$ani_step", 1),
        (mission_cam_set_mode, 0, 5, 0),

        (mission_set_time_speed, 1000),    #MOTO change from 90 -- 1000 is normal speed

        (assign, "$kill_cam_end", 0),
        (assign, "$ani_step", 0),
      (try_end),

   ]),
      
    ]+ dplmc_battle_mode_triggers3,
  ),

  (
    "duel_with_lord",mtf_arena_fight|mtf_commit_casualties,-1,
    "You enter a melee fight in the arena.",
    [    
	  (0, mtef_visitor_source|mtef_team_0,af_override_all,aif_start_alarmed,1,["itm_espada_historic1", "itm_arena_tunic_blue"]),
	  (16, mtef_visitor_source|mtef_team_1,af_override_all,aif_start_alarmed,1,["itm_espada_historic1", "itm_arena_tunic_blue"]),
    ],
    [
      common_inventory_not_available,
      (ti_tab_pressed, 0, 0, [(display_message, "str_cannot_leave_now")], []),
      (ti_before_mission_start, 0, 0, [], [(call_script, "script_change_banners_and_chest")]),

      (0, 0, ti_once, [],
       [
         (call_script, "script_music_set_situation_with_culture", mtf_sit_arena),
         ]),


      (1, 4, ti_once, [
	  (this_or_next|main_hero_fallen),
		(num_active_teams_le,1)],
       [
           (try_begin),
             (main_hero_fallen),
			 (check_quest_active, "qst_duel_for_lady"),
			 (quest_slot_eq, "qst_duel_for_lady", "slot_quest_target_troop", "$g_duel_troop"),
             (call_script, "script_fail_quest", "qst_duel_for_lady"),
           (else_try),
			 (check_quest_active, "qst_duel_for_lady"),
			 (quest_slot_eq, "qst_duel_for_lady", "slot_quest_target_troop", "$g_duel_troop"),
             (call_script, "script_succeed_quest", "qst_duel_for_lady"),
		   (else_try),
             (main_hero_fallen),
			 (check_quest_active, "qst_duel_courtship_rival"),
			 (quest_slot_eq, "qst_duel_courtship_rival", "slot_quest_target_troop", "$g_duel_troop"),
             (call_script, "script_fail_quest", "qst_duel_courtship_rival"),
           (else_try),
			 (check_quest_active, "qst_duel_courtship_rival"),
			 (quest_slot_eq, "qst_duel_courtship_rival", "slot_quest_target_troop", "$g_duel_troop"),
             (call_script, "script_succeed_quest", "qst_duel_courtship_rival"),
		   (else_try),	 
             (main_hero_fallen),
			 (check_quest_active, "qst_duel_avenge_insult"),
			 (quest_slot_eq, "qst_duel_avenge_insult", "slot_quest_target_troop", "$g_duel_troop"),
             (call_script, "script_fail_quest", "qst_duel_avenge_insult"),
           (else_try),
			 (check_quest_active, "qst_duel_avenge_insult"),
			 (quest_slot_eq, "qst_duel_avenge_insult", "slot_quest_target_troop", "$g_duel_troop"),
             (call_script, "script_succeed_quest", "qst_duel_avenge_insult"),
		   (else_try),	 
             (main_hero_fallen),
			 (check_quest_active, "qst_denounce_lord"),
			 (quest_slot_eq, "qst_denounce_lord", "slot_quest_target_troop", "$g_duel_troop"),
             (call_script, "script_fail_quest", "qst_denounce_lord"),
           (else_try),
			 (check_quest_active, "qst_denounce_lord"),
			 (quest_slot_eq, "qst_denounce_lord", "slot_quest_target_troop", "$g_duel_troop"),
             (call_script, "script_succeed_quest", "qst_denounce_lord"),
		   (else_try),
			 (quest_get_slot, ":target_troop", "qst_denounce_lord", "slot_quest_target_troop"),
		     (str_store_troop_name, s4, ":target_troop"),
		   (try_end),
           (finish_mission),
           ]),
torneo_aumenta_dano, #dunde torneo chief
#phaiak camara lenta
  (ti_on_agent_killed_or_wounded, 0, 0, [],
   [
    (try_begin),
      (store_trigger_param_1, ":dead_agent_no"),
      (store_trigger_param_2, ":killer_agent_no"),
          (agent_is_human, ":dead_agent_no"),
      (get_player_agent_no, ":player_agent"),
      (this_or_next|eq, ":player_agent", ":killer_agent_no"),
      (eq, ":player_agent", ":dead_agent_no"),
      # (store_random_in_range, ":chance", 1, 5),
      # (eq, ":chance", 1),

      # (store_random_in_range, ":speed", 16, 18), #chief cambia speed of 10 a 18 y de 4 a 16 MOTO do below
      # (mission_set_time_speed, ":speed"), #this works only when cheat mode is enabled

      (agent_get_position, pos20, ":dead_agent_no"),
      (agent_get_position, pos9, ":killer_agent_no"),
      (position_copy_rotation, pos20, pos9),
      (position_move_z, pos20, 150),
      (store_random_in_range, "$ani_x_angle", -35, 35),
      (store_random_in_range, "$ani_distance", -230, -70),
      (store_random_in_range, ":direktion", -1, 1),
      (try_begin),
        (eq, ":direktion", 0),
        (assign, "$ani_z_angle", 5),
        (position_rotate_z, pos20, 35),
      (else_try),
        (assign, "$ani_z_angle", -5),
        (position_rotate_z, pos20, -35),
      (try_end),
      (mission_cam_set_mode, 1, 10, 0),
      (assign, "$ani_step", 30),
    (try_end),
   ]),


   (0, 0, 0, [(gt, "$ani_step", 0)],

   [
      (store_mission_timer_a_msec, ":time"),
      (ge, ":time", "$kill_cam_end"),
      (try_begin),
        (ge, "$ani_step", 2),

        (store_div, ":interval", 7000, 30),    #desired animation length in milliseconds, divided by animation steps (see above)
        (try_begin),
          (ge, "$cheat_mode", 1),    #can use slo-mo effect
          (store_sub, ":reduction_factor", 32, "$ani_step"),
          (val_div, ":interval", ":reduction_factor"),
          (store_div, ":speed", 1000, ":reduction_factor"),    #reduce mission speed by same ratio to keep animation within the desired time window
          (mission_set_time_speed, ":speed"),
        (try_end),

        (position_rotate_z, pos20, "$ani_z_angle"),
        (copy_position, pos21, pos20),

        (val_sub, "$ani_x_angle", 1),    #MOTO turn camera down
        (position_rotate_x, pos21, "$ani_x_angle"),
        (val_sub, "$ani_distance", 10),    #MOTO back away
        (position_move_y, pos21, "$ani_distance"),
        (mission_cam_animate_to_position,  pos21, ":interval", 0),    #MOTO change to :interval from 5
        # (store_mission_timer_a_msec, "$kill_cam_end"),# for next step
        # (val_add, "$kill_cam_end", 5),
        (store_add, "$kill_cam_end", ":time", ":interval"),

        (val_add, "$ani_step", -1),
      (else_try),
        (eq, "$ani_step", 1),
        (mission_cam_set_mode, 0, 5, 0),

        (mission_set_time_speed, 1000),    #MOTO change from 90 -- 1000 is normal speed

        (assign, "$kill_cam_end", 0),
        (assign, "$ani_step", 0),
      (try_end),

   ]),
      
    ] + dplmc_battle_mode_triggers3,
  ),  
  
  
##############################  # Duel Mod chief Start ##############################

# Below are 8 sets of 2 templates. These are selected by the choices in the dialog. You can change the weapons by adding/removing to the itm_ list
# Entry points are the same for all mounted options and also for all unmounted since only 2 players spawn at a time.
# Duel scores are only kept for duels against heroes (companions, lords and kings).

(   
"arena_duel_thing_std",mtf_arena_fight,-1,
"The duel begins!",   
[
# visitors 0 and 1 are completely standard
(0, mtef_visitor_source|mtef_team_0, 0, aif_start_alarmed, 1, []),     
(8, mtef_visitor_source|mtef_team_2, 0, aif_start_alarmed, 1, []),
#visitors 2 and 3 are override horse only
(56, mtef_visitor_source|mtef_team_0, af_override_horse, aif_start_alarmed, 1, []),
(58, mtef_visitor_source|mtef_team_2, af_override_horse, aif_start_alarmed, 1, []),
#vistiors 4 and 5 are sword/shield standard
(0, mtef_visitor_source|mtef_team_0, af_override_weapons, aif_start_alarmed, 1, ["itm_spathaswordt2", "itm_cheap_buckler"]),     
(8, mtef_visitor_source|mtef_team_2,af_override_weapons, aif_start_alarmed, 1, ["itm_spathaswordt2", "itm_nordic_buckler"]),
#visitors 6 and 7 are sword/shield no horse
(56, mtef_visitor_source|mtef_team_0, af_override_weapons|af_override_horse, aif_start_alarmed, 1, ["itm_spathaswordt2", "itm_cheap_buckler"]),     
(58, mtef_visitor_source|mtef_team_2,af_override_weapons|af_override_horse, aif_start_alarmed, 1, ["itm_spathaswordt2", "itm_nordic_buckler"]),
#vistiors 8 and 9 are 2-H standard
(0, mtef_visitor_source|mtef_team_0, af_override_weapons, aif_start_alarmed, 1, ["itm_spear_blade2t2", "itm_staff1", "itm_spear_hvy"]),     
(8, mtef_visitor_source|mtef_team_2,af_override_weapons, aif_start_alarmed, 1, ["itm_spear_blade2t2", "itm_staff1", "itm_spear_hvy"]),
#visitors 10 and 11 are 2-H no horse
(56, mtef_visitor_source|mtef_team_0, af_override_weapons|af_override_horse, aif_start_alarmed, 1, ["itm_spear_blade2t2", "itm_staff1", "itm_spear_hasta"]),     
(58, mtef_visitor_source|mtef_team_2,af_override_weapons|af_override_horse, aif_start_alarmed, 1, ["itm_spear_blade2t2", "itm_staff1", "itm_spear_hasta"]),
#vistiors 12 and 13 are ranged standard - note that armor is also changed to light leather stuff
(0, mtef_visitor_source|mtef_team_0, af_override_all_but_horse|af_override_foot, aif_start_alarmed, 1, ["itm_shortbow", "itm_arrows1", "itm_linen_coatwcloak", "itm_skullcap_reinforcedt2", "itm_shoes2bare", "itm_leather_gloves1"]),     
(8, mtef_visitor_source|mtef_team_2, af_override_all_but_horse|af_override_foot, aif_start_alarmed, 1, ["itm_shortbow", "itm_arrows1", "itm_linen_coatwcloak", "itm_skullcap_reinforcedt2", "itm_shoes2bare", "itm_leather_gloves1"]),
#visitors 14 and 15 are ranged no horse - note that armor is also changed to light leather stuff
(0, mtef_visitor_source|mtef_team_0, af_override_everything, aif_start_alarmed, 1, ["itm_shortbow", "itm_arrows1", "itm_linen_coatwcloak", "itm_skullcap_reinforcedt2", "itm_shoes2bare", "itm_leather_gloves1"]),     
(8, mtef_visitor_source|mtef_team_2, af_override_everything, aif_start_alarmed, 1, ["itm_shortbow", "itm_arrows1", "itm_linen_coatwcloak", "itm_skullcap_reinforcedt2", "itm_shoes2bare", "itm_leather_gloves1"]),


],   
[     
common_inventory_not_available,     
 
   (ti_tab_pressed, 0, 0, [],
       [(question_box,"@Do you wish to give up the fight?")]),
    (ti_question_answered, 0, 0, [],
       [(store_trigger_param_1,":answer"),
       (eq,":answer",0),
 #add 1 to the slot for amount of duels the player lost against this troop if it is a tf_hero
      (try_begin),
         (troop_is_hero, "$g_talk_troop"),
         (assign, "$g_duel_result", -1),
         (troop_get_slot, ":duel_losses", "$g_talk_troop", "slot_troop_duel_lost"),
         (val_add, ":duel_losses", 1),
         (troop_set_slot, "$g_talk_troop", "slot_troop_duel_lost", ":duel_losses"),
      (try_end),
 #add 1 to the total amount of duels player lost if it is a tf_hero
      (try_begin),
         (troop_is_hero, "$g_talk_troop"),
         (troop_get_slot, ":duel_losses_player", "trp_player", "slot_troop_duel_lost"),
         (val_add, ":duel_losses_player", 1),
         (troop_set_slot, "trp_player", "slot_troop_duel_lost", ":duel_losses_player"),
         (assign, reg(2), ":duel_losses_player"),
         (display_message, "@You've lost a total number of {reg2} duels."),
      (try_end),
      (assign, "$g_duel_result", -1),
      (finish_mission),
      ]),

(1,3, ti_once, [
    (all_enemies_defeated, 1),
    (neg|main_hero_fallen, 0)
    ],
 [
#add 1 to the slot for amount of duels the player won against this troop if it is a tf_hero
   (assign, "$g_duel_result", 1),
   (try_begin),
      (troop_is_hero, "$g_talk_troop"),
      (troop_get_slot, ":duel_wins", "$g_talk_troop", "slot_troop_duel_won"),
      (val_add, ":duel_wins", 1),
      (troop_set_slot, "$g_talk_troop", "slot_troop_duel_won", ":duel_wins"),

   
#add 1 to the total amount of duels player won if it is a tf_hero

      (troop_get_slot, ":duel_wins_player", "trp_player", "slot_troop_duel_won"),
      (val_add, ":duel_wins_player", 1),
      (troop_set_slot, "trp_player", "slot_troop_duel_won", ":duel_wins_player"),
      (assign, reg(2), ":duel_wins_player"),
      (display_message, "@You've won a total number of {reg2} duels"),
   (try_end),
    (finish_mission),
   ]),

(2, 3, ti_once, [
    (main_hero_fallen),
    ],       
   [
#add 1 to the slot for amount of duels the player lost against this troop if it is a tf_hero
    (assign, "$g_duel_result", -1),
   (try_begin),
      (troop_is_hero, "$g_talk_troop"),
      (troop_get_slot, ":duel_losses", "$g_talk_troop", "slot_troop_duel_lost"),
      (val_add, ":duel_losses", 1),
      (troop_set_slot, "$g_talk_troop", "slot_troop_duel_lost", ":duel_losses"),
      (assign, reg(1), ":duel_losses"),

#add 1 to the total amount of duels player lost if it is a tf_hero
      (troop_get_slot, ":duel_losses_player", "trp_player", "slot_troop_duel_lost"),
      (val_add, ":duel_losses_player", 1),
      (troop_set_slot, "trp_player", "slot_troop_duel_lost", ":duel_losses_player"),
      (assign, reg(2), ":duel_losses_player"),
      (display_message, "@You've lost a total number of {reg2} duels."),
   (try_end),
    (finish_mission),
    ]),   
torneo_aumenta_dano, #dunde torneo chief
#phaiak camara lenta
  (ti_on_agent_killed_or_wounded, 0, 0, [],
   [
    (try_begin),
      (store_trigger_param_1, ":dead_agent_no"),
      (store_trigger_param_2, ":killer_agent_no"),
          (agent_is_human, ":dead_agent_no"),
      (get_player_agent_no, ":player_agent"),
      (this_or_next|eq, ":player_agent", ":killer_agent_no"),
      (eq, ":player_agent", ":dead_agent_no"),
      # (store_random_in_range, ":chance", 1, 5),
      # (eq, ":chance", 1),

      # (store_random_in_range, ":speed", 16, 18), #chief cambia speed of 10 a 18 y de 4 a 16 MOTO do below
      # (mission_set_time_speed, ":speed"), #this works only when cheat mode is enabled

      (agent_get_position, pos20, ":dead_agent_no"),
      (agent_get_position, pos9, ":killer_agent_no"),
      (position_copy_rotation, pos20, pos9),
      (position_move_z, pos20, 150),
      (store_random_in_range, "$ani_x_angle", -35, 35),
      (store_random_in_range, "$ani_distance", -230, -70),
      (store_random_in_range, ":direktion", -1, 1),
      (try_begin),
        (eq, ":direktion", 0),
        (assign, "$ani_z_angle", 5),
        (position_rotate_z, pos20, 35),
      (else_try),
        (assign, "$ani_z_angle", -5),
        (position_rotate_z, pos20, -35),
      (try_end),
      (mission_cam_set_mode, 1, 10, 0),
      (assign, "$ani_step", 30),
    (try_end),
   ]),


   (0, 0, 0, [(gt, "$ani_step", 0)],

   [
      (store_mission_timer_a_msec, ":time"),
      (ge, ":time", "$kill_cam_end"),
      (try_begin),
        (ge, "$ani_step", 2),

        (store_div, ":interval", 7000, 30),    #desired animation length in milliseconds, divided by animation steps (see above)
        (try_begin),
          (ge, "$cheat_mode", 1),    #can use slo-mo effect
          (store_sub, ":reduction_factor", 32, "$ani_step"),
          (val_div, ":interval", ":reduction_factor"),
          (store_div, ":speed", 1000, ":reduction_factor"),    #reduce mission speed by same ratio to keep animation within the desired time window
          (mission_set_time_speed, ":speed"),
        (try_end),

        (position_rotate_z, pos20, "$ani_z_angle"),
        (copy_position, pos21, pos20),

        (val_sub, "$ani_x_angle", 1),    #MOTO turn camera down
        (position_rotate_x, pos21, "$ani_x_angle"),
        (val_sub, "$ani_distance", 10),    #MOTO back away
        (position_move_y, pos21, "$ani_distance"),
        (mission_cam_animate_to_position,  pos21, ":interval", 0),    #MOTO change to :interval from 5
        # (store_mission_timer_a_msec, "$kill_cam_end"),# for next step
        # (val_add, "$kill_cam_end", 5),
        (store_add, "$kill_cam_end", ":time", ":interval"),

        (val_add, "$ani_step", -1),
      (else_try),
        (eq, "$ani_step", 1),
        (mission_cam_set_mode, 0, 5, 0),

        (mission_set_time_speed, 1000),    #MOTO change from 90 -- 1000 is normal speed

        (assign, "$kill_cam_end", 0),
        (assign, "$ani_step", 0),
      (try_end),

   ]),

 ],
),   

########################## Duel Mod chief End ##############################    
  
  
##   (
##    "tutorial",0,-1,
##    "You enter the training ground.",
##    [
##        (1,mtef_leader_only,af_override_horse,0,1,[]), #af_override_weapons
##        (2,mtef_scene_source,af_override_horse,0,1,[]), #af_override_weapons
##     ],
##    [
##      (ti_tab_pressed, 0, 0, [],
##       [(question_box,"str_do_you_wish_to_leave_tutorial")]),
##      (ti_question_answered, 0, 0, [],
##       [(store_trigger_param_1,":answer"),
##        (eq,":answer",0),
##        (finish_mission,0),
##        (leave_encounter),
##        (change_screen_return),
##        (troop_remove_item, "trp_player", "itm_tutorial_sword"),
##        (troop_remove_item, "trp_player", "itm_tutorial_axe"),
##        (troop_remove_item, "trp_player", "itm_tutorial_spear"),
##        (troop_remove_item, "trp_player", "itm_tutorial_club"),
##        (troop_remove_item, "trp_player", "itm_tutorial_battle_axe"),
##        (troop_remove_item, "trp_player", "itm_tutorial_arrows"),
##        (troop_remove_item, "trp_player", "itm_tutorial_bolts"),
##        (troop_remove_item, "trp_player", "itm_tutorial_short_bow"),
##        (troop_remove_item, "trp_player", "itm_tutorial_crossbow"),
##        (troop_remove_item, "trp_player", "itm_tutorial_throwing_daggers"),
##        
##        (check_quest_active, "qst_destroy_dummies"),
##        (cancel_quest,"qst_destroy_dummies"),
##        ]),
###      (ti_inventory_key_pressed, 0, 0, [(display_message,"str_cant_use_inventory_tutorial")], []),
##      (ti_inventory_key_pressed, 0, 0, [(set_trigger_result,1)], []),
##
##        
##      (0, 0, ti_once, [],
##       [
##        (assign, "$tutorial_enter_melee", 0),
##        (assign, "$tutorial_enter_ranged", 0),
##        (assign, "$tutorial_enter_mounted", 0),
##        (assign, "$tutorial_camp_stage", 0),
##        (assign, "$tutorial_quest_taken", 0),
##        (assign, "$tutorial_quest_succeeded", 0),
##        (assign, "$tutorial_num_total_dummies_destroyed", 0),
##        (assign, "$tutorial_melee_chest", 0),
##        (assign, "$tutorial_ranged_chest", 0),
##        (assign, "$tutorial_award_taken", 0),
##
##           
##        (entry_point_get_position,2,2),#Trainer
##        (entry_point_get_position,16,16),#Horse
##        (set_spawn_position, 16),
##        (spawn_horse, "itm_tutorial_saddle_horse"),
##
##        (troop_remove_item, "trp_tutorial_chest_1", "itm_tutorial_sword"),
##        (troop_remove_item, "trp_tutorial_chest_1", "itm_tutorial_axe"),
##        (troop_remove_item, "trp_tutorial_chest_1", "itm_tutorial_spear"),
##        (troop_remove_item, "trp_tutorial_chest_1", "itm_tutorial_club"),
##        (troop_remove_item, "trp_tutorial_chest_1", "itm_tutorial_battle_axe"),
##        (troop_remove_item, "trp_tutorial_chest_2", "itm_tutorial_arrows"),
##        (troop_remove_item, "trp_tutorial_chest_2", "itm_tutorial_bolts"),
##        (troop_remove_item, "trp_tutorial_chest_2", "itm_tutorial_short_bow"),
##        (troop_remove_item, "trp_tutorial_chest_2", "itm_tutorial_crossbow"),
##        (troop_remove_item, "trp_tutorial_chest_2", "itm_tutorial_throwing_daggers"),
##        (troop_add_item, "trp_tutorial_chest_1", "itm_tutorial_sword"),
##        (troop_add_item, "trp_tutorial_chest_1", "itm_tutorial_axe"),
##        (troop_add_item, "trp_tutorial_chest_1", "itm_tutorial_spear"),
##        (troop_add_item, "trp_tutorial_chest_1", "itm_tutorial_club"),
##        (troop_add_item, "trp_tutorial_chest_1", "itm_tutorial_battle_axe"),
##        (troop_add_item, "trp_tutorial_chest_2", "itm_tutorial_arrows"),
##        (troop_add_item, "trp_tutorial_chest_2", "itm_tutorial_bolts"),
##        (troop_add_item, "trp_tutorial_chest_2", "itm_tutorial_short_bow"),
##        (troop_add_item, "trp_tutorial_chest_2", "itm_tutorial_crossbow"),
##        (troop_add_item, "trp_tutorial_chest_2", "itm_tutorial_throwing_daggers"),
##        ]
##       ),
##     
##      (1, 0, ti_once, [(store_character_level, ":player_level", "trp_player"),
##                       (le, ":player_level", 1),
##                       (get_player_agent_no, ":player_agent"),
##                       (ge, ":player_agent", 0),
##                       (agent_get_position, pos1, ":player_agent"),
##                       (entry_point_get_position,3,3),
##                       (get_distance_between_positions, ":distance_to_area", 1, 3),
##                       (lt, ":distance_to_area", 500),
##                       (eq, "$tutorial_enter_melee", 0),],
##       [(tutorial_box,"str_tutorial_enter_melee", "str_tutorial"), (val_add,"$tutorial_enter_melee", 1)]),
##      (1, 0, ti_once, [(store_character_level, ":player_level", "trp_player"),
##                       (le, ":player_level", 1),
##                       (get_player_agent_no, ":player_agent"),
##                       (ge, ":player_agent", 0),
##                       (neg|conversation_screen_is_active),
##                       (agent_get_position, pos1, ":player_agent"),
##                       (entry_point_get_position,4,4),
##                       (get_distance_between_positions, ":distance_to_area", 1, 4),
##                       (lt, ":distance_to_area", 500),
##                       (eq, "$tutorial_enter_ranged", 0),],
##       [(tutorial_box,"str_tutorial_enter_ranged", "str_tutorial"), (val_add,"$tutorial_enter_ranged", 1)]),
##      (1, 0, ti_once, [(store_character_level, ":player_level", "trp_player"),
##                       (le, ":player_level", 1),
##                       (get_player_agent_no, ":player_agent"),
##                       (ge, ":player_agent", 0),
##                       (neg|conversation_screen_is_active),
##                       (agent_get_position, pos1, ":player_agent"),
##                       (entry_point_get_position,5,5),
##                       (get_distance_between_positions, ":distance_to_area", 1, 5),
##                       (lt, ":distance_to_area", 500),
##                       (eq, "$tutorial_enter_mounted", 0),],
##       [(tutorial_box,"str_tutorial_enter_mounted", "str_tutorial"), (val_add,"$tutorial_enter_mounted", 1)]),
##
##
##      (2, 0, ti_once, [(store_character_level, ":player_level", "trp_player"),
##                       (le, ":player_level", 1),
##                       (get_player_agent_no, ":player_agent"),
##                       (ge, ":player_agent", 0),
##                       (neg|conversation_screen_is_active),
##                       (agent_get_position, pos1, ":player_agent"),
##                       (entry_point_get_position,6,6),
##                       (get_distance_between_positions, ":distance_to_area", 1, 6),
##                       (lt, ":distance_to_area", 300),
##                       (eq, "$tutorial_melee_chest", 0),],
##       [(tutorial_box,"str_tutorial_melee_chest", "str_tutorial"), (val_add,"$tutorial_melee_chest", 1)]),
##      (2, 0, ti_once, [(store_character_level, ":player_level", "trp_player"),
##                       (le, ":player_level", 1),
##                       (get_player_agent_no, ":player_agent"),
##                       (ge, ":player_agent", 0),
##                       (agent_get_position, pos1, ":player_agent"),
##                       (entry_point_get_position,7,7),
##                       (get_distance_between_positions, ":distance_to_area", 1, 7),
##                       (lt, ":distance_to_area", 300),
##                       (eq, "$tutorial_ranged_chest", 0),],
##       [(tutorial_box,"str_tutorial_ranged_chest", "str_tutorial"), (val_add,"$tutorial_ranged_chest", 1)]),
##
##      (2, 0, ti_once, [(store_character_level, ":player_level", "trp_player"),
##                       (le, ":player_level", 1),
##                       (eq, "$tutorial_item_equipped", 0),
##                       (try_begin),
##                         (troop_has_item_equipped, "trp_player", "itm_tutorial_sword"),
##                         (assign, "$tutorial_item_equipped", 1),
##                       (else_try),
##                         (troop_has_item_equipped, "trp_player", "itm_tutorial_axe"),
##                         (assign, "$tutorial_item_equipped", 1),
##                       (else_try),
##                         (troop_has_item_equipped, "trp_player", "itm_tutorial_spear"),
##                         (assign, "$tutorial_item_equipped", 1),
##                       (else_try),
##                         (troop_has_item_equipped, "trp_player", "itm_tutorial_club"),
##                         (assign, "$tutorial_item_equipped", 1),
##                       (else_try),
##                         (troop_has_item_equipped, "trp_player", "itm_tutorial_battle_axe"),
##                         (assign, "$tutorial_item_equipped", 1),
##                       (else_try),
##                         (troop_has_item_equipped, "trp_player", "itm_tutorial_arrows"),
##                         (assign, "$tutorial_item_equipped", 1),
##                       (else_try),
##                         (troop_has_item_equipped, "trp_player", "itm_tutorial_bolts"),
##                         (assign, "$tutorial_item_equipped", 1),
##                       (else_try),
##                         (troop_has_item_equipped, "trp_player", "itm_tutorial_short_bow"),
##                         (assign, "$tutorial_item_equipped", 1),
##                       (else_try),
##                         (troop_has_item_equipped, "trp_player", "itm_tutorial_crossbow"),
##                         (assign, "$tutorial_item_equipped", 1),
##                       (else_try),
##                         (troop_has_item_equipped, "trp_player", "itm_tutorial_throwing_daggers"),
##                         (assign, "$tutorial_item_equipped", 1),
##                       (try_end),
##                       (eq, "$tutorial_item_equipped", 1),],
##       [(tutorial_box,"str_tutorial_item_equipped", "str_tutorial")]),
##
##
##      
##
###      (2, 0, ti_once, [(get_player_agent_no, ":player_agent"),
###                       (agent_get_position, pos1, ":player_agent"),
###                       (entry_point_get_position,21,21),
###                       (get_distance_between_positions, ":distance_to_area", 1, 21),
###                       (lt, ":distance_to_area", 200),
###                       (eq, "$tutorial_group_of_weapons", 0),],
###       [(tutorial_box,"str_tutorial_group_of_weapons", "str_tutorial"), (val_add,"$tutorial_group_of_weapons", 1)]),
##
##      
##
##      (1, 5, ti_once, [(eq,"$tutorial_camp_stage",0),
##                       (neg|conversation_screen_is_active),
##                       (eq,"$tutorial_quest_award_taken",0),
##                       (store_character_level, ":player_level", "trp_player"),
##                       (le, ":player_level", 1),
##                       (tutorial_box,"str_tutorial_camp1","str_tutorial"),],
##          [(val_add,"$tutorial_camp_stage",1)]),
##      (1, 3, ti_once, [(eq,"$tutorial_camp_stage",1),
##                       (neg|conversation_screen_is_active),
##                       (tutorial_box,"str_tutorial_camp2","str_tutorial"),],
##          [(val_add,"$tutorial_camp_stage",1)]),
##      (1, 3, ti_once, [(eq,"$tutorial_camp_stage",2),
##                       (neg|conversation_screen_is_active),
##                       (tutorial_box,"str_tutorial_camp3","str_tutorial"),],
##          [(val_add,"$tutorial_camp_stage",1)]),
##      (1, 3, ti_once, [(eq,"$tutorial_camp_stage",3),(eq, "$tutorial_award_taken", 0),
##                       (neg|conversation_screen_is_active),
##                       (tutorial_box,"str_tutorial_camp4","str_tutorial"),],
##          [(val_add,"$tutorial_camp_stage",2)]),
##      
##     
##      (1, 3, ti_once, [(eq,"$tutorial_camp_stage",5),
##                       (neg|conversation_screen_is_active),
##                       (eq,"$tutorial_quest_taken",1),
##                       (tutorial_box,"str_tutorial_camp6","str_tutorial"),],
##          [(val_add,"$tutorial_camp_stage",1)]),
##
##      (1, 3, ti_once, [(eq,"$tutorial_camp_stage",6),
##                       (neg|conversation_screen_is_active),
##                       (ge,"$tutorial_num_total_dummies_destroyed",10),
##                       (tutorial_box,"str_tutorial_camp7","str_tutorial"),],
##          [(val_add,"$tutorial_camp_stage",1), (assign,"$tutorial_quest_succeeded",1),]),
##      
##      (1, 3, ti_once, [(eq,"$tutorial_camp_stage",7),
##                       (neg|conversation_screen_is_active),
##                       (eq,"$tutorial_quest_award_taken",1),
##                       (tutorial_box,"str_tutorial_camp8","str_tutorial"),
##                       (troop_add_proficiency_points, "trp_player", 10),
##                       (assign, "$tutorial_last_proficiency_sum", 0),
##                       (try_for_range, ":cur_attribute", 0, num_weapon_proficiencies),
##                         (store_proficiency_level, ":cur_attribute_point", "trp_player", ":cur_attribute"),
##                         (val_add, "$tutorial_last_proficiency_sum", ":cur_attribute_point"),
##                       (try_end),],
##       [(val_add,"$tutorial_camp_stage",1),]),
##      
##      (1, 3, ti_once, [(eq,"$tutorial_camp_stage",8),
##                       (neg|conversation_screen_is_active),
##                       (assign, ":new_proficiency_sum", 0),
##                       (try_for_range, ":cur_attribute", 0, num_weapon_proficiencies),
##                         (store_proficiency_level, ":cur_attribute_point", "trp_player", ":cur_attribute"),
##                         (val_add, ":new_proficiency_sum", ":cur_attribute_point"),
##                       (try_end),
##                       (assign, reg(48), ":new_proficiency_sum"),
##                       (assign, reg(49), "$tutorial_last_proficiency_sum"),
##                       (lt,"$tutorial_last_proficiency_sum",":new_proficiency_sum"),
##                       (tutorial_box,"str_tutorial_camp9","str_tutorial"),],
##          [(val_add,"$tutorial_camp_stage",1)]),
##
##      (2, 0, 0, [(check_quest_active,"qst_destroy_dummies"),
##                 (le, "$tutorial_num_total_dummies_destroyed", 10),],
##          [
##              (assign, ":progress", "$tutorial_num_total_dummies_destroyed"),
##              (val_mul, ":progress", 10),
##              (set_quest_progression,"qst_destroy_dummies",":progress"),
##              ]
##       ),
##
##    ],
##  ),


  (
    "wedding",0,-1,
    "Wedding",
    [
        (0,mtef_visitor_source,af_override_everything,0,1,["itm_bluepantsbody_woad04", "itm_ankleboots"]),
        (1,mtef_visitor_source,af_override_everything,0,1,["itm_bride_dress", "itm_bride_crown", "itm_bride_shoes"]),
        (2,mtef_visitor_source,af_castle_lord,0,1,[]),
        (3,mtef_visitor_source,af_override_everything,0,1,["itm_courtly_outfit", "itm_leather_shoes"]),
        (4,mtef_visitor_source,af_castle_lord,0,1,[]),
        (5,mtef_visitor_source,af_castle_lord,0,1,[]),
        (6,mtef_visitor_source,af_castle_lord,0,1,[]),
        (7,mtef_visitor_source,af_castle_lord,0,1,[]),
        (8,mtef_visitor_source,af_castle_lord,0,1,[]),
        (9,mtef_visitor_source,af_castle_lord,0,1,[]),
        (10,mtef_visitor_source,af_castle_lord,0,1,[]),
        (11,mtef_visitor_source,af_castle_lord,0,1,[]),
        (12,mtef_visitor_source,af_castle_lord,0,1,[]),
        (13,mtef_visitor_source,af_castle_lord,0,1,[]),
        (14,mtef_visitor_source,af_castle_lord,0,1,[]),
        (15,mtef_visitor_source,af_castle_lord,0,1,[]),
        (16,mtef_visitor_source,af_castle_lord,0,1,[]),
        (17,mtef_visitor_source,af_castle_lord,0,1,[]),
        (18,mtef_visitor_source,af_castle_lord,0,1,[]),
        (19,mtef_visitor_source,af_castle_lord,0,1,[]),
        (20,mtef_visitor_source,af_castle_lord,0,1,[]),
        (21,mtef_visitor_source,af_castle_lord,0,1,[]),
        (22,mtef_visitor_source,af_castle_lord,0,1,[]),
        (23,mtef_visitor_source,af_castle_lord,0,1,[]),
        (24,mtef_visitor_source,af_castle_lord,0,1,[]),
        (25,mtef_visitor_source,af_castle_lord,0,1,[]),
        (26,mtef_visitor_source,af_castle_lord,0,1,[]),
        (27,mtef_visitor_source,af_castle_lord,0,1,[]),
        (28,mtef_visitor_source,af_castle_lord,0,1,[]),
        (29,mtef_visitor_source,af_castle_lord,0,1,[]),
        (30,mtef_visitor_source,af_castle_lord,0,1,[]),
        (31,mtef_visitor_source,af_castle_lord,0,1,[]),
     ],
    [
      (ti_tab_pressed, 0, 0, [],
       [
         (show_object_details_overlay, 1),
         (finish_mission,0),
        ]),
      (ti_question_answered, 0, 0, [],
       [(store_trigger_param_1,":answer"),
        (eq,":answer",0),
        (show_object_details_overlay, 1),
        (finish_mission,0),
        ]),

      (ti_after_mission_start, 0, 0, [],
       [
        (assign, "$g_wedding_state", 0),
        (play_track, "track_wedding", 2),
        (show_object_details_overlay, 0),
         ]),

      (ti_on_agent_spawn, 0, 0, [],
       [
         (store_trigger_param_1, ":agent_no"),
         (agent_get_troop_id, ":troop_no", ":agent_no"),
         (troop_get_type, ":gender", ":troop_no"),
         (set_fixed_point_multiplier, 100),
         (try_begin),
           (eq, ":troop_no", "$g_wedding_bishop_troop"),
         (else_try),
           (eq, ":troop_no", "$g_wedding_bride_troop"),
           (agent_set_no_dynamics, ":agent_no", 1),
           (init_position, pos1),
           (position_set_z, pos1, -1000),
           (agent_set_position, ":agent_no", pos1),
         (else_try),
           (eq, ":troop_no", "$g_wedding_brides_dad_troop"),
           (agent_set_no_dynamics, ":agent_no", 1),
           (init_position, pos1),
           (position_set_z, pos1, -1000),
           (agent_set_position, ":agent_no", pos1),
         (else_try),
           (eq, ":troop_no", "$g_wedding_groom_troop"),
           (agent_set_no_dynamics, ":agent_no", 1),
           (init_position, pos1),
           (position_move_x, pos1, 175),
           (position_move_z, pos1, 10),
           (position_rotate_z, pos1, 180),
           (agent_set_position, ":agent_no", pos1),
           (agent_set_animation, ":agent_no", "anim_wedding_groom_wait"),
         (else_try),
           (try_begin),
###gender fix chief
       (this_or_next|eq, ":gender", 0), #male
       (this_or_next|eq, ":gender", 2), #male
       (this_or_next|eq, ":gender", 4), #male
       (eq, ":gender", 6), #male
#gender fix chief acaba
             (store_random_in_range, ":random_no", 0, 3),
             (try_begin),
               (eq, ":random_no", 0),
               (agent_set_slot, ":agent_no", "slot_agent_cur_animation", "anim_wedding_guest_notr"),
               (agent_set_animation, ":agent_no", "anim_wedding_guest_notr"),
             (else_try),
               (agent_set_slot, ":agent_no", "slot_agent_cur_animation", "anim_wedding_guest"),
               (agent_set_animation, ":agent_no", "anim_wedding_guest"),
             (try_end),
           (else_try), #female
             (agent_set_slot, ":agent_no", "slot_agent_cur_animation", "anim_wedding_guest_woman"),
             (agent_set_animation, ":agent_no", "anim_wedding_guest_woman"),
           (try_end),
           (store_random_in_range, ":progress", 0, 100),
           (agent_set_animation_progress, ":agent_no", ":progress"),
         (try_end),
         ]),

      (0, 0, 0,
       [
         (store_mission_timer_a, ":cur_time"),
         (set_fixed_point_multiplier, 100),
         (try_for_agents, ":agent_no"),
           (agent_get_troop_id, ":troop_no", ":agent_no"),
           (try_begin),
             (eq, ":troop_no", "$g_wedding_groom_troop"),
           (else_try),
             (eq, ":troop_no", "$g_wedding_bride_troop"),
           (else_try),
             (eq, ":troop_no", "$g_wedding_brides_dad_troop"),
           (else_try),
             (eq, ":troop_no", "$g_wedding_bishop_troop"),
           (else_try),
             (agent_get_slot, ":cur_animation", ":agent_no", "slot_agent_cur_animation"),
             (agent_set_animation, ":agent_no", ":cur_animation"),
           (try_end),
         (try_end),
         (try_begin),
           (eq, "$g_wedding_state", 0),
           (mission_cam_set_mode, 1, 0, 0),
           (init_position, pos1),
           (position_rotate_z, pos1, 180),
           (position_rotate_x, pos1, 5),
           (position_set_x, pos1, -500),
           (position_set_y, pos1, 1000),
           (position_set_z, pos1, 600),
           (mission_cam_set_position, pos1),
           (init_position, pos1),
           (position_rotate_z, pos1, 180),
           (position_rotate_x, pos1, -15),
           (position_set_x, pos1, -500),
           (position_set_y, pos1, 1000),
           (position_set_z, pos1, 600),
           (mission_cam_animate_to_position, pos1, 4000, 0),
           (val_add, "$g_wedding_state", 1),
         (else_try),
           (eq, "$g_wedding_state", 1),
           (ge, ":cur_time", 4),
           (init_position, pos1),
           (position_rotate_z, pos1, 90),
           (position_rotate_x, pos1, -10),
           (position_set_x, pos1, -580),
           (position_set_y, pos1, 700),
           (position_set_z, pos1, 200),
           (mission_cam_set_position, pos1),
           (init_position, pos1),
           (position_rotate_z, pos1, 150),
           (position_rotate_x, pos1, -10),
           (position_set_x, pos1, -580),
           (position_set_y, pos1, 100),
           (position_set_z, pos1, 200),
           (mission_cam_animate_to_position, pos1, 6000, 1),
           (val_add, "$g_wedding_state", 1),
         (else_try),
           (eq, "$g_wedding_state", 2),
           (ge, ":cur_time", 9),
           (mission_cam_animate_to_screen_color, 0xFF000000, 1000),
           (val_add, "$g_wedding_state", 1),
         (else_try),
           (eq, "$g_wedding_state", 3),
           (ge, ":cur_time", 10),
           (init_position, pos1),
           (position_move_x, pos1, 175),
           (position_move_z, pos1, 10),
           (position_rotate_z, pos1, 180),
           (try_for_agents, ":agent_no"),
             (agent_get_troop_id, ":agent_troop", ":agent_no"),
             (try_begin),
               (eq, ":agent_troop", "$g_wedding_bride_troop"),
               (agent_set_position, ":agent_no", pos1),
               (agent_set_animation, ":agent_no", "anim_wedding_bride_stairs"),
             (else_try),
               (eq, ":agent_troop", "$g_wedding_brides_dad_troop"),
               (agent_set_position, ":agent_no", pos1),
               (agent_set_animation, ":agent_no", "anim_wedding_dad_stairs"),
             (try_end),
           (try_end),
           (init_position, pos1),
           (position_rotate_z, pos1, -90),
           (position_set_x, pos1, 300),
           (position_set_y, pos1, 950),
           (position_set_z, pos1, 420),
           (mission_cam_set_position, pos1),
           (position_set_x, pos1, 175),
           (position_set_y, pos1, 950),
           (position_set_z, pos1, 320),
           (mission_cam_animate_to_position, pos1, 4000, 0),
           (mission_cam_animate_to_screen_color, 0x00000000, 500),
           (val_add, "$g_wedding_state", 1),
         (else_try),
           (eq, "$g_wedding_state", 4),
           (ge, ":cur_time", 14),
           (init_position, pos1),
           (position_rotate_z, pos1, -60),
           (position_rotate_x, pos1, 10),
           (position_set_x, pos1, -400),
           (position_set_y, pos1, 200),
           (position_set_z, pos1, 115),
           (mission_cam_set_position, pos1),
           (val_add, "$g_wedding_state", 1),
         (else_try),
           (eq, "$g_wedding_state", 5),
           (ge, ":cur_time", 20),
           (init_position, pos1),
           (position_move_x, pos1, 175),
           (position_move_z, pos1, 10),
           (position_rotate_z, pos1, 180),
           (try_for_agents, ":agent_no"),
             (agent_get_troop_id, ":agent_troop", ":agent_no"),
             (try_begin),
               (eq, ":agent_troop", "$g_wedding_bride_troop"),
               (agent_set_position, ":agent_no", pos1),
               (agent_set_animation, ":agent_no", "anim_wedding_bride_walk"),
             (else_try),
               (eq, ":agent_troop", "$g_wedding_brides_dad_troop"),
               (agent_set_position, ":agent_no", pos1),
               (agent_set_animation, ":agent_no", "anim_wedding_dad_walk"),
             (try_end),
           (try_end),
           (init_position, pos1),
           (position_rotate_z, pos1, -140),
           (position_rotate_x, pos1, -15),
           (position_set_x, pos1, -625),
           (position_set_y, pos1, -530),
           (position_set_z, pos1, 180),
           (mission_cam_set_position, pos1),
           (val_add, "$g_wedding_state", 1),
         (else_try),
           (eq, "$g_wedding_state", 6),
           (ge, ":cur_time", 22),
           (init_position, pos1),
           (position_rotate_z, pos1, 45),
           (position_rotate_x, pos1, -10),
           (position_set_x, pos1, -260),
           (position_set_y, pos1, 120),
           (position_set_z, pos1, 275),
           (mission_cam_set_position, pos1),
           (position_rotate_z, pos1, 10),
           (mission_cam_animate_to_position, pos1, 2000, 0),
           (val_add, "$g_wedding_state", 1),
         (else_try),
           (eq, "$g_wedding_state", 7),
           (ge, ":cur_time", 24),
           (init_position, pos1),
           (position_move_x, pos1, 175),
           (position_move_z, pos1, 10),
           (position_rotate_z, pos1, 180),
           (try_for_agents, ":agent_no"),
             (agent_get_troop_id, ":agent_troop", ":agent_no"),
             (try_begin),
               (eq, ":agent_troop", "$g_wedding_bride_troop"),
               (agent_set_position, ":agent_no", pos1),
               (agent_set_animation, ":agent_no", "anim_wedding_bride_last"),
             (else_try),
               (eq, ":agent_troop", "$g_wedding_brides_dad_troop"),
               (agent_set_position, ":agent_no", pos1),
               (agent_set_animation, ":agent_no", "anim_wedding_dad_last"),
             (else_try),
               (eq, ":agent_troop", "$g_wedding_groom_troop"),
               (agent_set_position, ":agent_no", pos1),
               (agent_set_animation, ":agent_no", "anim_wedding_groom_last"),
             (try_end),
           (try_end),
           (init_position, pos1),
           (position_rotate_z, pos1, -45),
           (position_rotate_x, pos1, -10),
           (position_set_x, pos1, -900),
           (position_set_y, pos1, -850),
           (position_set_z, pos1, 230),
           (mission_cam_set_position, pos1),
           (val_add, "$g_wedding_state", 1),
         (else_try),
           (eq, "$g_wedding_state", 8),
           (ge, ":cur_time", 31),
           (init_position, pos1),
           (position_set_x, pos1, -550),
           (position_set_y, pos1, -625),
           (position_set_z, pos1, 1500),
           (particle_system_burst, "psys_wedding_rose", pos1, 750),
           (val_add, "$g_wedding_state", 1),
         (else_try),
           (eq, "$g_wedding_state", 9),
           (ge, ":cur_time", 33),
           (init_position, pos1),
           (position_rotate_z, pos1, 180),
           (position_set_x, pos1, -536),
           (position_set_y, pos1, -415),
           (position_set_z, pos1, 135),
           (mission_cam_set_position, pos1),
           (position_rotate_z, pos1, -8),
           (position_set_z, pos1, 350),
           (position_rotate_x, pos1, 35),
           (mission_cam_animate_to_position_and_aperture, pos1, 10, 9000, 1),
           (val_add, "$g_wedding_state", 1),
         (else_try),
           (eq, "$g_wedding_state", 10),
           (ge, ":cur_time", 41),
           (mission_cam_set_screen_color, 0x00FFFFFF),
           (mission_cam_animate_to_screen_color, 0xFFFFFFFF, 3000),
           (val_add, "$g_wedding_state", 1),
         (else_try),
           (eq, "$g_wedding_state", 11),
           (ge, ":cur_time", 48),
           (show_object_details_overlay, 1),
           (finish_mission,0),
         (try_end),
         ], []),
    ],
  ),

  (
    "tutorial_training_ground",mtf_arena_fight,-1,
    "You enter the training ground.",
    [
      (0,mtef_visitor_source|mtef_team_0,0,0,1,[]),
      (1,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (2,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (3,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (4,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (5,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (6,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (7,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),

      (8,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (9,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (10,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (11,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (12,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (13,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (14,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (15,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),

      (16,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (17,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (18,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (19,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (20,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (21,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (22,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (23,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),

      (24,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (25,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (26,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (27,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (28,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (29,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (30,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (31,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),

      (32,mtef_visitor_source|mtef_team_0,af_override_weapons,aif_start_alarmed,1,["itm_practice_sword"]),
      (33,mtef_visitor_source|mtef_team_0,af_override_weapons,aif_start_alarmed,1,["itm_practice_sword"]),
      (34,mtef_visitor_source|mtef_team_0,af_override_weapons,aif_start_alarmed,1,["itm_practice_sword"]),
      (35,mtef_visitor_source|mtef_team_0,af_override_weapons,aif_start_alarmed,1,["itm_practice_sword"]),
      (36,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (37,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (38,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (39,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),

      (40,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (41,mtef_visitor_source|mtef_team_0,af_override_weapons,aif_start_alarmed,1,["itm_huntingbow", "itm_practice_arrows_75amount"]),
      (42,mtef_visitor_source|mtef_team_0,af_override_weapons,aif_start_alarmed,1,["itm_huntingbow", "itm_practice_arrows_75amount"]),
      (43,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (44,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (45,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (46,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (47,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),

      (48,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (49,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (50,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (51,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (52,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (53,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (54,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (55,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),

      (56,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (57,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (58,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (59,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (60,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (61,mtef_visitor_source|mtef_team_0,af_override_weapons,aif_start_alarmed,1,["itm_practice_sword"]),
      (62,mtef_visitor_source|mtef_team_0,af_override_weapons,aif_start_alarmed,1,["itm_practice_sword"]),
      (63,mtef_visitor_source|mtef_team_0,af_override_weapons,aif_start_alarmed,1,["itm_huntingbow", "itm_practice_arrows_75amount"]),
      (64,mtef_visitor_source|mtef_team_0,af_override_weapons,aif_start_alarmed,1,["itm_huntingbow", "itm_practice_arrows_75amount"]),
      ],
    [
      (ti_tab_pressed, 0, 0, [],
       [(try_begin),
         (lt, "$g_tutorial_training_ground_state", 20),
         (question_box, "str_do_you_wish_to_leave_tutorial"),
        (else_try),
          (finish_mission,0),
        (try_end),
        ]),
      (ti_question_answered, 0, 0, [],
       [(store_trigger_param_1,":answer"),
        (eq,":answer",0),
        (finish_mission,0),
        ]),
      (ti_inventory_key_pressed, 0, 0, [(display_message, "str_cant_use_inventory_tutorial")], []),

      (ti_battle_window_opened, 0, 0, [],
       [
         (start_presentation, "prsnt_tutorial_show_mouse_movement"),
        ]),

      (ti_on_agent_spawn, 0, 0, [],
       [
         (store_trigger_param_1, ":agent_no"),
         (agent_ai_set_always_attack_in_melee, ":agent_no", 1),
         (agent_set_no_death_knock_down_only, ":agent_no", 1),
         (agent_set_invulnerable_shield, ":agent_no", 1),
         (agent_get_position, pos1, ":agent_no"),
         (agent_set_slot, ":agent_no", "slot_agent_spawn_entry_point", -1),
         (get_player_agent_no, ":player_agent"),
         (try_begin),
           (eq, ":agent_no", ":player_agent"),
           (agent_set_team, ":agent_no", 7),
         (try_end),
         (try_for_range, ":cur_entry_point", 0, 64),
           (entry_point_get_position, pos2, ":cur_entry_point"),
           (get_sq_distance_between_positions, ":dist", pos1, pos2),
           (lt, ":dist", 100), #10 cm
           (agent_set_slot, ":agent_no", "slot_agent_spawn_entry_point", ":cur_entry_point"),
         (try_end),
         (agent_get_troop_id, ":cur_agent_troop", ":agent_no"),
         (try_begin),
           (eq, ":cur_agent_troop", "trp_tutorial_archer_1"),
           (agent_get_position, pos1, ":agent_no"),
           (agent_set_scripted_destination, ":agent_no", pos1),
           (scene_prop_get_num_instances, ":num_instances", "spr_archery_target_with_hit_a"),
           (assign, ":shortest_dist", 10000000),
           (assign, ":best_instance", -1),
           (try_for_range, ":cur_instance", 0, ":num_instances"),
             (scene_prop_get_instance, ":spr_instance", "spr_archery_target_with_hit_a", ":cur_instance"),
             (prop_instance_get_position, pos2, ":spr_instance"),
             (get_sq_distance_between_positions, ":cur_dist", pos1, pos2),
             (lt, ":cur_dist", ":shortest_dist"),
             (assign, ":shortest_dist", ":cur_dist"),
             (assign, ":best_instance", ":spr_instance"),
           (try_end),
           (agent_set_slot, ":agent_no", "slot_agent_target_prop_instance", ":best_instance"),
         (else_try),
           (this_or_next|eq, ":cur_agent_troop", "trp_tutorial_rider_1"),
           (eq, ":cur_agent_troop", "trp_tutorial_rider_2"),
           (agent_set_slot, ":agent_no", "slot_agent_target_entry_point", 48),
           (agent_set_slot, ":agent_no", "slot_agent_target_prop_instance", -1),
           (entry_point_get_position, pos1, 48),
           (agent_set_scripted_destination, ":agent_no", pos1),
         (try_end),
         ]),

      (ti_on_agent_knocked_down, 0, 0, [],
       [
         (store_trigger_param_1, ":agent_no"),
         (store_trigger_param_2, ":enemy_agent_no"),
         (agent_get_troop_id, ":agent_troop", ":agent_no"),
         (agent_get_troop_id, ":enemy_agent_troop", ":enemy_agent_no"),
         (try_begin),
           (ge, "$g_tutorial_training_ground_melee_trainer_attack", 0),
           #do nothing
         (else_try),
           (ge, "$g_tutorial_training_ground_melee_trainer_parry", 0),
           (try_begin),
             (eq, ":agent_troop", "trp_player"),
             (eq, ":enemy_agent_troop", "$g_tutorial_training_ground_melee_trainer_parry"),
             (assign, "$g_tutorial_training_ground_melee_state", 0),
             (agent_set_team, ":agent_no", 0),
             (agent_set_team, ":enemy_agent_no", 7),
             (tutorial_message, -1),
             (assign, "$g_tutorial_mouse_dir", -1),
             (assign, "$g_tutorial_mouse_click", -1),
             (assign, "$g_tutorial_training_ground_conversation_state", 2), #player knocked down in parry
             (play_sound, "snd_tutorial_fail"),
             (start_mission_conversation, "$g_tutorial_training_ground_melee_trainer_parry"),
             (assign, "$g_tutorial_training_ground_melee_trainer_parry", -1),
             (try_begin),
               (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 1), #still in attack ready action
               (agent_set_attack_action, ":agent_no", 0, 0), #release
             (try_end),
           (else_try),
             (eq, ":enemy_agent_troop", "trp_player"),
             (eq, ":agent_troop", "$g_tutorial_training_ground_melee_trainer_parry"),
             (agent_set_team, ":agent_no", 7),
             (agent_set_team, ":enemy_agent_no", 0),
             (tutorial_message, -1),
             (assign, "$g_tutorial_mouse_dir", -1),
             (assign, "$g_tutorial_mouse_click", -1),
             (assign, "$g_tutorial_training_ground_conversation_state", 3), #trainer knocked down in parry
             (play_sound, "snd_tutorial_fail"),
             (start_mission_conversation, "$g_tutorial_training_ground_melee_trainer_parry"),
             (assign, "$g_tutorial_training_ground_melee_trainer_parry", -1),
             (try_begin),
               (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 1), #still in attack ready action
               (agent_set_attack_action, ":agent_no", 0, 0), #release
             (try_end),
           (try_end),
         (else_try),
           (ge, "$g_tutorial_training_ground_melee_trainer_chamber", 0),
           (try_begin),
             (eq, ":agent_troop", "trp_player"),
             (eq, ":enemy_agent_troop", "$g_tutorial_training_ground_melee_trainer_chamber"),
             (assign, "$g_tutorial_training_ground_melee_state", 0),
             (agent_set_team, ":agent_no", 0),
             (agent_set_team, ":enemy_agent_no", 7),
             (tutorial_message, -1),
             (assign, "$g_tutorial_mouse_dir", -1),
             (assign, "$g_tutorial_mouse_click", -1),
             (assign, "$g_tutorial_training_ground_conversation_state", 7), #player knocked down in chamber
             (play_sound, "snd_tutorial_fail"),
             (start_mission_conversation, "$g_tutorial_training_ground_melee_trainer_chamber"),
             (assign, "$g_tutorial_training_ground_melee_trainer_chamber", -1),
             (try_begin),
               (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 1), #still in attack ready action
               (agent_set_attack_action, ":agent_no", 0, 0), #release
             (try_end),
           (else_try),
             (eq, ":enemy_agent_troop", "trp_player"),
             (eq, ":agent_troop", "$g_tutorial_training_ground_melee_trainer_chamber"),
             (agent_set_team, ":agent_no", 7),
             (agent_set_team, ":enemy_agent_no", 0),
             (tutorial_message, -1),
             (assign, "$g_tutorial_mouse_dir", -1),
             (assign, "$g_tutorial_mouse_click", -1),
             (assign, "$g_tutorial_training_ground_conversation_state", 8), #trainer knocked down in chamber
             (play_sound, "snd_tutorial_fail"),
             (start_mission_conversation, "$g_tutorial_training_ground_melee_trainer_chamber"),
             (assign, "$g_tutorial_training_ground_melee_trainer_chamber", -1),
             (try_begin),
               (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 1), #still in attack ready action
               (agent_set_attack_action, ":agent_no", 0, 0), #release
             (try_end),
           (try_end),
         (else_try),
           (ge, "$g_tutorial_training_ground_melee_trainer_combat", 0),
           (try_begin),
             (eq, ":agent_troop", "trp_player"),
             (eq, ":enemy_agent_troop", "$g_tutorial_training_ground_melee_trainer_combat"),
             (assign, "$g_tutorial_training_ground_melee_state", 0),
             (agent_set_team, ":agent_no", 0),
             (agent_set_team, ":enemy_agent_no", 7),
             (tutorial_message, -1),
             (assign, "$g_tutorial_training_ground_conversation_state", 4), #player knocked down in combat
             (play_sound, "snd_tutorial_fail"),
             (start_mission_conversation, "$g_tutorial_training_ground_melee_trainer_combat"),
             (assign, "$g_tutorial_training_ground_melee_trainer_combat", -1),
           (else_try),
             (eq, ":enemy_agent_troop", "trp_player"),
             (eq, ":agent_troop", "$g_tutorial_training_ground_melee_trainer_combat"),
             (assign, "$g_tutorial_training_ground_melee_state", 0),
             (agent_set_team, ":agent_no", 7),
             (agent_set_team, ":enemy_agent_no", 0),
##             (assign, "$g_tutorial_training_ground_melee_trainer_combat_completed", 1), #not used
             (tutorial_message, -1),
             (assign, "$g_tutorial_training_ground_conversation_state", 5), #trainer knocked down in combat
             (play_sound, "snd_tutorial_2"),
             (start_mission_conversation, "$g_tutorial_training_ground_melee_trainer_combat"),
             (assign, "$g_tutorial_training_ground_melee_trainer_combat", -1),
           (try_end),
         (else_try),
           (agent_is_human, ":agent_no"),
           (assign, "$g_tutorial_training_ground_melee_last_winner", ":enemy_agent_no"),
           (assign, "$g_tutorial_training_ground_melee_last_loser", ":agent_no"),
           (assign, "$g_tutorial_training_ground_melee_state", 0),
           (agent_set_team, "$g_tutorial_training_ground_melee_cur_fighter_1", 7),
           (agent_set_team, "$g_tutorial_training_ground_melee_cur_fighter_2", 7),
           (agent_force_rethink, "$g_tutorial_training_ground_melee_cur_fighter_1"),
           (agent_force_rethink, "$g_tutorial_training_ground_melee_cur_fighter_2"),
         (try_end),
         (agent_set_hit_points, ":agent_no", 100, 0),
         (agent_set_hit_points, ":enemy_agent_no", 100, 0),
         ]),

      (ti_before_mission_start, 0, 0, [],
       [
         (scene_set_day_time, 13),
         (team_set_relation, 0, 1, 0),
         (team_set_relation, 0, 2, 0),
         (team_set_relation, 0, 3, 0),
         (team_set_relation, 0, 7, 0),
         (team_set_relation, 7, 1, 1),
         (team_set_relation, 7, 2, 1),
         (team_set_relation, 7, 3, 1),
         (team_set_relation, 1, 2, -1),
         (team_set_relation, 1, 3, 1),
         (team_set_relation, 2, 3, 1),
         (assign, "$g_position_to_use_for_replacing_scene_items", pos8),
         (call_script, "script_replace_scene_items_with_spawn_items_before_ms"),
         (assign, "$g_tutorial_training_ground_state", 0),
         (assign, "$g_tutorial_training_ground_conversation_state", 0),
         (assign, "$g_tutorial_training_ground_melee_paused", 0),
         (assign, "$g_tutorial_training_ground_melee_state", 0),
         (assign, "$g_tutorial_training_ground_melee_next_action_time", 0),
         (assign, "$g_tutorial_training_ground_melee_last_winner", -1),
         (assign, "$g_tutorial_training_ground_melee_last_loser", -1),
         (assign, "$g_tutorial_training_ground_melee_cur_fighter_1", -1),
         (assign, "$g_tutorial_training_ground_melee_cur_fighter_2", -1),
         (assign, "$g_tutorial_training_ground_melee_trainer_attack", -1),
         (assign, "$g_tutorial_training_ground_melee_trainer_parry", -1),
         (assign, "$g_tutorial_training_ground_melee_trainer_combat", -1),
         (assign, "$g_tutorial_training_ground_melee_trainer_chamber", -1),
##         (assign, "$g_tutorial_training_ground_melee_trainer_attack_completed", 0), #not used
##         (assign, "$g_tutorial_training_ground_melee_trainer_parry_completed", 0), #not used
##         (assign, "$g_tutorial_training_ground_melee_trainer_combat_completed", 0), #not used
##         (assign, "$g_tutorial_training_ground_melee_trainer_chamber_completed", 0), #not used
         (assign, "$g_tutorial_training_ground_melee_trainer_next_action_time", 0),
         (assign, "$g_tutorial_training_ground_archer_trainer_state", 0),
         (assign, "$g_tutorial_training_ground_archer_trainer_completed_chapters", 0),
         (assign, "$g_tutorial_training_ground_horseman_trainer_state", 0),
         (assign, "$g_tutorial_training_ground_horseman_trainer_completed_chapters", 0),
         (assign, "$g_tutorial_training_ground_next_score_time", 0),
         (assign, "$g_tutorial_mouse_dir", -1),
         (assign, "$g_tutorial_mouse_click", -1),
         (assign, "$g_pointer_arrow_height_adder", -1000),
         ]),

      (0, 0, ti_once, [],
       [
         (tutorial_message_set_size, 17, 17),
         (tutorial_message_set_position, 500, 650),
         (tutorial_message_set_center_justify, 0),
         (mission_enable_talk),
         (call_script, "script_replace_scene_items_with_spawn_items_after_ms"),
         (entry_point_get_position, pos1, 59),
         (set_spawn_position, pos1),
         (spawn_horse, "itm_saddle_horse1", 0),
         (assign, "$g_tutorial_training_ground_intro_message_being_displayed", 1),
         (scene_spawned_item_get_instance, ":item_instance", "itm_practice_bow", 0),
         (prop_instance_get_position, pos0, ":item_instance"),
         (position_move_z, pos0, -1000, 1),
         (prop_instance_set_position, ":item_instance", pos0),
         (scene_spawned_item_get_instance, ":item_instance", "itm_huntingbow", 0),
         (prop_instance_get_position, pos0, ":item_instance"),
         (position_move_z, pos0, -1000, 1),
         (prop_instance_set_position, ":item_instance", pos0),
         (scene_spawned_item_get_instance, ":item_instance", "itm_practice_arrows_75amount", 0),
         (prop_instance_get_position, pos0, ":item_instance"),
         (position_move_z, pos0, -1000, 1),
         (prop_instance_set_position, ":item_instance", pos0),
         (scene_spawned_item_get_instance, ":item_instance", "itm_practice_arrows_75amount", 0),
         (prop_instance_get_position, pos0, ":item_instance"),
         (position_move_z, pos0, -1000, 1),
         (prop_instance_set_position, ":item_instance", pos0),
         (scene_spawned_item_get_instance, ":item_instance", "itm_pict_crossbow", 0),
         (prop_instance_get_position, pos0, ":item_instance"),
         (position_move_z, pos0, -1000, 1),
         (prop_instance_set_position, ":item_instance", pos0),
         (scene_spawned_item_get_instance, ":item_instance", "itm_bolts", 0),
         (prop_instance_get_position, pos0, ":item_instance"),
         (position_move_z, pos0, -1000, 1),
         (prop_instance_set_position, ":item_instance", pos0),
         (scene_spawned_item_get_instance, ":item_instance", "itm_practice_javelin_40amount", 0),
         (prop_instance_get_position, pos0, ":item_instance"),
         (position_move_z, pos0, -1000, 1),
         (prop_instance_set_position, ":item_instance", pos0),
         (scene_spawned_item_get_instance, ":item_instance", "itm_practice_spear", 0),
         (prop_instance_get_position, pos0, ":item_instance"),
         (position_move_z, pos0, -1000, 1),
         (prop_instance_set_position, ":item_instance", pos0),
         ]),

      (0, 1, ti_once, [],
       [
         (tutorial_message_set_background, 1),
         (tutorial_message, "str_tutorial_training_ground_intro_message"),
         ]),

      (0, 0, 0,
       [
         (store_mission_timer_a, ":cur_time"),
         (try_for_agents, ":cur_agent"),
           (agent_get_troop_id, ":cur_agent_troop", ":cur_agent"),
           (eq, ":cur_agent_troop", "trp_tutorial_archer_1"),
           (try_begin),
             (agent_get_wielded_item, ":cur_wielded_item", ":cur_agent", 0),
             (neq, ":cur_wielded_item", "itm_practice_bow"),
             (agent_set_wielded_item, ":cur_agent", "itm_practice_bow"),
           (else_try),
             (agent_get_slot, ":look_spr", ":cur_agent", "slot_agent_target_prop_instance"),
             (prop_instance_get_position, pos1, ":look_spr"),
             (position_move_z, pos1, 10),
             (agent_set_look_target_position, ":cur_agent", pos1),
             (try_begin),
               (neg|agent_slot_ge, ":cur_agent", "slot_agent_next_action_time", ":cur_time"),
               (agent_set_attack_action, ":cur_agent", 0),
               (store_random_in_range, ":next_action_time", 3, 13),
               (val_add, ":next_action_time", ":cur_time"),
               (agent_set_slot, ":cur_agent", "slot_agent_next_action_time", ":next_action_time"),
             (try_end),
           (try_end),
         (try_end),
         ], []),

      (0, 0, 0,
       [
         (set_fixed_point_multiplier, 100),
         (try_for_agents, ":cur_agent"),
           (agent_get_troop_id, ":cur_agent_troop", ":cur_agent"),
           (this_or_next|eq, ":cur_agent_troop", "trp_tutorial_rider_1"),
           (eq, ":cur_agent_troop", "trp_tutorial_rider_2"),
           (agent_get_slot, ":target_entry_point", ":cur_agent", "slot_agent_target_entry_point"),
           (entry_point_get_position, pos1, ":target_entry_point"),
           (agent_get_position, pos2, ":cur_agent"),
           (get_sq_distance_between_positions, ":cur_dist", pos1, pos2),
           (try_begin),
             (lt, ":cur_dist", 6400),
             (val_add, ":target_entry_point", 1),
             (try_begin),
               (gt, ":target_entry_point", 57), #last entry point
               (assign, ":target_entry_point", 48), #first entry point
             (try_end),
             (agent_set_slot, ":cur_agent", "slot_agent_target_entry_point", ":target_entry_point"),
             (entry_point_get_position, pos1, ":target_entry_point"),
             (agent_set_scripted_destination, ":cur_agent", pos1),
           (try_end),
           (try_begin),
             (eq, ":cur_agent_troop", "trp_tutorial_rider_2"),
             (try_begin),
               (agent_get_wielded_item, ":cur_wielded_item", ":cur_agent", 0),
               (neq, ":cur_wielded_item", "itm_practice_bow"),
               (agent_set_wielded_item, ":cur_agent", "itm_practice_bow"),
             (else_try),
               (scene_prop_get_num_instances, ":num_instances", "spr_archery_target_with_hit_a"),
               (assign, ":shortest_dist", 10000000),
               (assign, ":best_instance", -1),
               (try_for_range, ":cur_instance", 0, ":num_instances"),
                 (scene_prop_get_instance, ":spr_instance", "spr_archery_target_with_hit_a", ":cur_instance"),
                 (neg|agent_slot_eq, ":cur_agent", "slot_agent_target_prop_instance", ":spr_instance"),
                 (prop_instance_get_position, pos1, ":spr_instance"),
                 (position_is_behind_position, pos2, pos1), #target is facing towards us
                 (get_sq_distance_between_positions, ":cur_dist", pos1, pos2),
                 (lt, ":cur_dist", ":shortest_dist"),
                 (assign, ":shortest_dist", ":cur_dist"),
                 (assign, ":best_instance", ":spr_instance"),
               (try_end),
               (try_begin),
                 (lt, ":shortest_dist", 40000), #20 meters
                 (prop_instance_get_position, pos1, ":best_instance"),
                 (position_move_z, pos1, 10),
                 (init_position, pos3),
                 (position_set_x, pos3, -160), #1.6 meters
                 (position_transform_position_to_parent, pos4, pos1, pos3),
                 (copy_position, pos1, pos4),
                 (agent_set_look_target_position, ":cur_agent", pos1),
                 (lt, ":shortest_dist", 22500), #15 meters
                 (agent_set_slot, ":cur_agent", "slot_agent_target_prop_instance", ":best_instance"),
                 (agent_set_attack_action, ":cur_agent", 0),
               (else_try),
                 (agent_get_slot, ":last_instance", ":cur_agent", "slot_agent_target_prop_instance"),
                 (ge, ":last_instance", 0),
                 (prop_instance_get_position, pos1, ":last_instance"),
                 (get_sq_distance_between_positions, ":cur_dist", pos1, pos2),
                 (lt, ":cur_dist", 40000), #20 meters
                 (position_move_z, pos1, 10),
                 (init_position, pos3),
                 (position_set_x, pos3, -160), #1.6 meters
                 (position_transform_position_to_parent, pos4, pos1, pos3),
                 (copy_position, pos1, pos4),
                 (agent_set_look_target_position, ":cur_agent", pos1),
               (try_end),
             (try_end),
           (else_try),
             (eq, ":cur_agent_troop", "trp_tutorial_rider_1"),
             (try_begin),
               (agent_get_wielded_item, ":cur_wielded_item", ":cur_agent", 0),
               (neq, ":cur_wielded_item", "itm_practice_sword"),
               (agent_set_wielded_item, ":cur_agent", "itm_practice_sword"),
             (else_try),
               (scene_prop_get_num_instances, ":num_instances", "spr_dummy_a_undestructable"),
               (assign, ":shortest_dist", 10000000),
               (assign, ":best_instance", -1),
               (try_for_range, ":cur_instance", 0, ":num_instances"),
                 (scene_prop_get_instance, ":spr_instance", "spr_dummy_a_undestructable", ":cur_instance"),
                 (neg|agent_slot_eq, ":cur_agent", "slot_agent_target_prop_instance", ":spr_instance"),
                 (prop_instance_get_position, pos1, ":spr_instance"),
                 (get_sq_distance_between_positions, ":cur_dist", pos1, pos2),
                 (lt, ":cur_dist", ":shortest_dist"),
                 (assign, ":shortest_dist", ":cur_dist"),
                 (assign, ":best_instance", ":spr_instance"),
               (try_end),
               (try_begin),
                 (lt, ":shortest_dist", 10000), #10 meters
                 (prop_instance_get_position, pos1, ":best_instance"),
                 (position_transform_position_to_local, pos3, pos2, pos1),
                 (position_get_x, ":local_x", pos3),
                 (position_get_y, ":local_y", pos3),
                 (is_between, ":local_x", -200, 200),
                 (gt, ":local_y", -100),
                 (init_position, pos3),
                 (try_begin),
                   (lt, ":local_x", 0),
                   (position_move_x, pos3, -100),
                   (position_move_z, pos3, 100),
                 (else_try),
                   (position_move_x, pos3, 100),
                   (position_move_z, pos3, 150),
                 (try_end),
                 (position_transform_position_to_parent, pos4, pos2, pos3),
                 (agent_set_look_target_position, ":cur_agent", pos4),
                 (try_begin),
                   (lt, ":local_x", 0),
                   (agent_set_attack_action, ":cur_agent", 2, 1), #left
                 (else_try),
                   (agent_set_attack_action, ":cur_agent", 1, 1), #right
                 (try_end),
                 (this_or_next|lt, ":shortest_dist", 900), #3 meters
                 (lt, ":local_y", 100), #1 meter
                 (agent_set_attack_action, ":cur_agent", 0, 0), #release
                 (agent_set_slot, ":cur_agent", "slot_agent_target_prop_instance", ":best_instance"),
               (else_try),
                 (agent_get_slot, ":last_instance", ":cur_agent", "slot_agent_target_prop_instance"),
                 (ge, ":last_instance", 0),
                 (prop_instance_get_position, pos1, ":last_instance"),
                 (get_sq_distance_between_positions, ":cur_dist", pos1, pos2),
                 (lt, ":cur_dist", 10000), #10 meters
                 (position_transform_position_to_local, pos3, pos2, pos1),
                 (position_get_x, ":local_x", pos3),
                 (position_get_y, ":local_y", pos3),
                 (is_between, ":local_x", -200, 200),
                 (gt, ":local_y", -100),
                 (init_position, pos3),
                 (try_begin),
                   (lt, ":local_x", 0),
                   (position_move_x, pos3, -100),
                   (position_move_z, pos3, 100),
                 (else_try),
                   (position_move_x, pos3, 100),
                   (position_move_z, pos3, 150),
                 (try_end),
                 (position_transform_position_to_parent, pos4, pos2, pos3),
                 (agent_set_look_target_position, ":cur_agent", pos4),
               (try_end),
             (try_end),
           (try_end),
         (try_end),
         ], []),
      
      (0, 0, 0,
       [
         (store_mission_timer_a, ":cur_time"),
         (try_for_agents, ":cur_agent"),
           (agent_get_troop_id, ":cur_agent_troop", ":cur_agent"),
           (eq, ":cur_agent_troop", "trp_tutorial_archer_1"),
           (try_begin),
             (agent_get_wielded_item, ":cur_wielded_item", ":cur_agent", 0),
             (neq, ":cur_wielded_item", "itm_practice_bow"),
             (agent_set_wielded_item, ":cur_agent", "itm_practice_bow"),
           (else_try),
             (agent_get_slot, ":look_spr", ":cur_agent", "slot_agent_target_prop_instance"),
             (prop_instance_get_position, pos1, ":look_spr"),
             (agent_set_look_target_position, ":cur_agent", pos1),
             (try_begin),
               (neg|agent_slot_ge, ":cur_agent", "slot_agent_next_action_time", ":cur_time"),
               (agent_set_attack_action, ":cur_agent", 0),
               (store_random_in_range, ":next_action_time", 3, 13),
               (val_add, ":next_action_time", ":cur_time"),
               (agent_set_slot, ":cur_agent", "slot_agent_next_action_time", ":next_action_time"),
             (try_end),
           (try_end),
         (try_end),
         ], []),

      (0, 0, 0,
       [
         (call_script, "script_iterate_pointer_arrow"),
         ], []),


      (5, 0, 0,
       [
         (try_begin),
           (store_mission_timer_a, ":cur_time"),
           (ge, ":cur_time", 30),
           (eq, "$g_tutorial_training_ground_intro_message_being_displayed", 1),
           (assign, "$g_tutorial_training_ground_intro_message_being_displayed", 0),
           (tutorial_message, -1),
         (try_end),
         (get_player_agent_no, ":player_agent"),
         (try_for_agents, ":cur_agent"),
           (agent_is_human, ":cur_agent"),
           (neq, ":cur_agent", ":player_agent"),
           (agent_refill_ammo, ":cur_agent"),
         (try_end),
         ], []),

      (0, 0, 0,
       [
         (get_player_agent_no, ":player_agent"),
         (agent_get_wielded_item, ":wielded_weapon", ":player_agent", 0),
         (assign, ":refill", 0),
         (try_begin),
           (eq, ":wielded_weapon", "itm_practice_bow"),
           (agent_has_item_equipped, ":player_agent", "itm_practice_arrows_75amount"),
           (agent_get_ammo, ":cur_ammo", ":player_agent", 1),
           (eq, ":cur_ammo", 0),
           (assign, ":refill", 1),
         (else_try),
           (eq, ":wielded_weapon", "itm_huntingbow"),
           (agent_has_item_equipped, ":player_agent", "itm_practice_arrows_75amount"),
           (agent_get_ammo, ":cur_ammo", ":player_agent", 1),
           (eq, ":cur_ammo", 0),
           (assign, ":refill", 1),
         (else_try),
           (eq, ":wielded_weapon", "itm_pict_crossbow"),
           (agent_has_item_equipped, ":player_agent", "itm_bolts"),
           (agent_get_ammo, ":cur_ammo", ":player_agent", 1),
           (eq, ":cur_ammo", 0),
           (assign, ":refill", 1),
         (else_try),
           (eq, ":wielded_weapon", "itm_practice_javelin_40amount"),
           (agent_get_ammo, ":cur_ammo", ":player_agent", 1),
           (le, ":cur_ammo", 1),
           (assign, ":refill", 1),
         (try_end),
         (eq, ":refill", 1),
         (agent_refill_ammo, ":player_agent"),
         (tutorial_box, "str_tutorial_training_ground_ammo_refill", "@Tutorial"),
         ], []),

      (0, 0, 0,
       [
         (get_player_agent_no, ":player_agent"),
         (neq, "$g_tutorial_training_ground_horseman_trainer_state", 0),
         (mission_disable_talk),
         (try_begin),
           (eq, "$g_tutorial_training_ground_horseman_trainer_state", 1),
           (assign, "$g_tutorial_training_ground_current_score", 0),
           (val_add, "$g_tutorial_training_ground_horseman_trainer_state", 1),
         (else_try),
           (eq, "$g_tutorial_training_ground_horseman_trainer_state", 2),
           (try_begin),
             (try_begin),
               (ge, "$g_tutorial_training_ground_horseman_trainer_item_1", 0),
               (scene_spawned_item_get_instance, ":item_instance", "$g_tutorial_training_ground_horseman_trainer_item_1", 0),
               (prop_instance_get_position, pos0, ":item_instance"),
               (position_move_z, pos0, 1000, 1),
               (prop_instance_set_position, ":item_instance", pos0),

               (scene_prop_get_instance, ":pointer_instance", "spr_pointer_arrow", 0),
               (prop_instance_set_position, ":pointer_instance", pos0),
               (assign, "$g_pointer_arrow_height_adder", 200),

               (try_begin),
                 (ge, "$g_tutorial_training_ground_horseman_trainer_item_2", 0),
                 (scene_spawned_item_get_instance, ":item_instance", "$g_tutorial_training_ground_horseman_trainer_item_2", 0),
                 (prop_instance_get_position, pos0, ":item_instance"),
                 (position_move_z, pos0, 1000, 1),
                 (prop_instance_set_position, ":item_instance", pos0),
               (try_end),
             (try_end),
             (val_add, "$g_tutorial_training_ground_horseman_trainer_state", 1),
           (try_end),
         (else_try),
           (eq, "$g_tutorial_training_ground_horseman_trainer_state", 3),
           (try_begin),
             (ge, "$g_tutorial_training_ground_horseman_trainer_item_1", 0),
             (try_begin),
               (str_store_item_name, s0, "$g_tutorial_training_ground_horseman_trainer_item_1"),
               (tutorial_message, "str_tutorial_training_ground_horseman_text_1"),
               (agent_has_item_equipped, ":player_agent", "$g_tutorial_training_ground_horseman_trainer_item_1"),
               (val_add, "$g_tutorial_training_ground_horseman_trainer_state", 1),
               (play_sound, "snd_tutorial_1"),
             (try_end),
           (else_try),
             (val_add, "$g_tutorial_training_ground_horseman_trainer_state", 1),
           (try_end),
         (else_try),
           (eq, "$g_tutorial_training_ground_horseman_trainer_state", 4),
           (try_begin),
             (ge, "$g_tutorial_training_ground_horseman_trainer_item_2", 0),
             (try_begin),
               (str_store_item_name, s0, "$g_tutorial_training_ground_horseman_trainer_item_2"),
               (tutorial_message, "str_tutorial_training_ground_horseman_text_1"),
               (agent_has_item_equipped, ":player_agent", "$g_tutorial_training_ground_horseman_trainer_item_2"),
               (val_add, "$g_tutorial_training_ground_horseman_trainer_state", 1),
               (play_sound, "snd_tutorial_1"),
             (try_end),
           (else_try),
             (val_add, "$g_tutorial_training_ground_horseman_trainer_state", 1),
           (try_end),
         (else_try),
           (eq, "$g_tutorial_training_ground_horseman_trainer_state", 5),
           (try_begin),
             (agent_get_horse, ":player_horse", ":player_agent"),
             (lt, ":player_horse", 0),
             (tutorial_message, "str_tutorial_training_ground_horseman_text_2"),
             (try_begin),
               (assign, ":horse_agent_to_mount", -1),
               (try_for_agents, ":cur_agent"),
                 (agent_get_item_id, ":cur_agent_item", ":cur_agent"),
                 (eq, ":cur_agent_item", "itm_saddle_horse1"),
                 (assign, ":horse_agent_to_mount", ":cur_agent"),
               (try_end),
               (agent_get_position, pos0, ":horse_agent_to_mount"),
               (scene_prop_get_instance, ":pointer_instance", "spr_pointer_arrow", 0),
               (prop_instance_get_position, pos1, ":pointer_instance"),
               (set_fixed_point_multiplier, 100),
               (position_get_x, ":x1", pos0),
               (position_get_x, ":x2", pos1),
               (position_get_y, ":y1", pos0),
               (position_get_y, ":y2", pos1),
               (this_or_next|neq, ":x1", ":x2"),
               (neq, ":y1", ":y2"),
               (prop_instance_set_position, ":pointer_instance", pos0),
               (assign, "$g_pointer_arrow_height_adder", 200),
             (try_end),
           (else_try),
             (val_add, "$g_tutorial_training_ground_horseman_trainer_state", 1),
           (try_end),
         (else_try),
           (eq, "$g_tutorial_training_ground_horseman_trainer_state", 6),
           (try_begin),
             (eq, "$g_tutorial_training_ground_horseman_trainer_completed_chapters", 0),
             (tutorial_message, "str_tutorial_training_ground_horseman_text_3"),
           (else_try),
             (eq, "$g_tutorial_training_ground_horseman_trainer_completed_chapters", 1),
             (assign, ":prop_to_search_for", "spr_dummy_a_undestructable"),
             (tutorial_message, "str_tutorial_training_ground_horseman_text_4"),
           (else_try),
             (assign, ":prop_to_search_for", "spr_archery_target_with_hit_a"),
             (tutorial_message, "str_tutorial_training_ground_horseman_text_5"),
           (try_end),
           (try_begin),
             (eq, "$g_tutorial_training_ground_horseman_trainer_completed_chapters", 0),
             (store_add, ":cur_entry_point", "$g_tutorial_training_ground_current_score", 48),
             (entry_point_get_position, pos0, ":cur_entry_point"),
             (init_position, pos2),
             (position_move_y, pos2, -800),
             (position_transform_position_to_parent, pos3, pos0, pos2),
             (copy_position, pos0, pos3),
             (agent_get_position, pos2, ":player_agent"),
             (try_begin),
               (get_distance_between_positions, ":cur_dist", pos0, pos2),
               (lt, ":cur_dist", 500), #5 meters
               (val_add, "$g_tutorial_training_ground_current_score", 1),
               (ge, "$g_tutorial_training_ground_current_score", 10),
               (assign, "$g_pointer_arrow_height_adder", -1000),
               (tutorial_message, "str_tutorial_training_ground_horseman_text_6", 0, 10),
               (assign, "$g_tutorial_training_ground_horseman_trainer_state", 0),
               (val_add, "$g_tutorial_training_ground_horseman_trainer_completed_chapters", 1),
               (play_sound, "snd_tutorial_2"),
             (try_end),
             (try_begin),
               (scene_prop_get_instance, ":pointer_instance", "spr_pointer_arrow", 0),
               (prop_instance_get_position, pos1, ":pointer_instance"),
               (set_fixed_point_multiplier, 1),
               (position_get_x, ":x1", pos0),
               (position_get_x, ":x2", pos1),
               (position_get_y, ":y1", pos0),
               (position_get_y, ":y2", pos1),
               (this_or_next|neq, ":x1", ":x2"),
               (neq, ":y1", ":y2"),
               (prop_instance_set_position, ":pointer_instance", pos0),
               (assign, "$g_pointer_arrow_height_adder", 150),
               (play_sound, "snd_tutorial_1"),
             (try_end),
           (else_try),
             (scene_prop_get_num_instances, ":end_cond", ":prop_to_search_for"),
             (try_begin),
               (lt, "$g_tutorial_training_ground_current_score", 6),
               (assign, ":next_prop_instance", -1),
               (store_add, ":var_id_to_search_for", "$g_tutorial_training_ground_current_score", 1),
               (try_for_range, ":cur_instance", 0, ":end_cond"),
                 (scene_prop_get_instance, ":prop_instance", ":prop_to_search_for", ":cur_instance"),
                 (prop_instance_get_variation_id_2, ":var_id_2", ":prop_instance"),
                 (eq, ":var_id_to_search_for", ":var_id_2"),
                 (assign, ":next_prop_instance", ":prop_instance"),
                 (assign, ":end_cond", 0),
               (try_end),
               (try_begin),
                 (prop_instance_get_position, pos0, ":next_prop_instance"),
                 (scene_prop_get_instance, ":pointer_instance", "spr_pointer_arrow", 0),
                 (prop_instance_get_position, pos1, ":pointer_instance"),
                 (set_fixed_point_multiplier, 1),
                 (position_get_x, ":x1", pos0),
                 (position_get_x, ":x2", pos1),
                 (position_get_y, ":y1", pos0),
                 (position_get_y, ":y2", pos1),
                 (this_or_next|neq, ":x1", ":x2"),
                 (neq, ":y1", ":y2"),
                 (prop_instance_set_position, ":pointer_instance", pos0),
                 (assign, "$g_pointer_arrow_height_adder", 200),
                 (play_sound, "snd_tutorial_1"),
               (try_end),
             (else_try),
               (assign, "$g_pointer_arrow_height_adder", -1000),
               (try_begin),
                 (ge, "$g_tutorial_training_ground_horseman_trainer_item_2", 0),
                 (agent_unequip_item, ":player_agent", "$g_tutorial_training_ground_horseman_trainer_item_2"),
               (try_end),
               (agent_unequip_item, ":player_agent", "$g_tutorial_training_ground_horseman_trainer_item_1"),
               (tutorial_message, "str_tutorial_training_ground_horseman_text_6", 0, 10),
               (assign, "$g_tutorial_training_ground_horseman_trainer_state", 0),
               (val_add, "$g_tutorial_training_ground_horseman_trainer_completed_chapters", 1),
               (play_sound, "snd_tutorial_2"),
             (try_end),
           (try_end),
         (try_end),
         ], []),
      
      (0, 0, 0,
       [
         (get_player_agent_no, ":player_agent"),
         (neq, "$g_tutorial_training_ground_archer_trainer_state", 0),
         (mission_disable_talk),
         (try_begin),
           (eq, "$g_tutorial_training_ground_archer_trainer_state", 1),
           (try_begin),
             (assign, "$g_last_destroyed_gourds", 0),
             (assign, "$g_tutorial_training_ground_current_score", 0),
             (scene_spawned_item_get_instance, ":item_instance", "$g_tutorial_training_ground_archer_trainer_item_1", 0),
             (prop_instance_get_position, pos0, ":item_instance"),
             (position_move_z, pos0, 1000, 1),
             (prop_instance_set_position, ":item_instance", pos0),

             (scene_prop_get_instance, ":pointer_instance", "spr_pointer_arrow", 0),
             (prop_instance_set_position, ":pointer_instance", pos0),
             (assign, "$g_pointer_arrow_height_adder", 100),

             (try_begin),
               (ge, "$g_tutorial_training_ground_archer_trainer_item_2", 0),
               (scene_spawned_item_get_instance, ":item_instance", "$g_tutorial_training_ground_archer_trainer_item_2", 0),
               (prop_instance_get_position, pos0, ":item_instance"),
               (position_move_z, pos0, 1000, 1),
               (prop_instance_set_position, ":item_instance", pos0),
             (try_end),
             (val_add, "$g_tutorial_training_ground_archer_trainer_state", 1),
           (try_end),
         (else_try),
           (eq, "$g_tutorial_training_ground_archer_trainer_state", 2),
           (try_begin),
             (str_store_item_name, s0, "$g_tutorial_training_ground_archer_trainer_item_1"),
             (tutorial_message, "str_tutorial_training_ground_archer_text_1"),
             (agent_has_item_equipped, ":player_agent", "$g_tutorial_training_ground_archer_trainer_item_1"),
             (val_add, "$g_tutorial_training_ground_archer_trainer_state", 1),
             (play_sound, "snd_tutorial_1"),
           (try_end),
         (else_try),
           (eq, "$g_tutorial_training_ground_archer_trainer_state", 3),
           (try_begin),
             (ge, "$g_tutorial_training_ground_archer_trainer_item_2", 0),
             (try_begin),
               (str_store_item_name, s0, "$g_tutorial_training_ground_archer_trainer_item_2"),
               (tutorial_message, "str_tutorial_training_ground_archer_text_1"),
               (agent_has_item_equipped, ":player_agent", "$g_tutorial_training_ground_archer_trainer_item_2"),
               (val_add, "$g_tutorial_training_ground_archer_trainer_state", 1),
               (play_sound, "snd_tutorial_1"),
             (try_end),
           (else_try),
             (val_add, "$g_tutorial_training_ground_archer_trainer_state", 1),
           (try_end),
         (else_try),
           (eq, "$g_tutorial_training_ground_archer_trainer_state", 4),
           (try_begin),
             (try_for_range, ":cur_instance", 0, 3),
               (scene_prop_get_instance, ":gourd_instance", "spr_gourd", ":cur_instance"),
               (prop_instance_refill_hit_points, ":gourd_instance"),
               (entry_point_get_position, pos0, 45),
               (init_position, pos1),
               (store_sub, ":cur_rotation", ":cur_instance", 1),
               (val_mul, ":cur_rotation", 5),
               (position_rotate_z, pos1, ":cur_rotation"),
               (try_begin),
                 (ge, "$g_tutorial_training_ground_archer_trainer_item_2", 0),
                 (position_move_y, pos1, 1300), #for bow and crossbow
               (else_try),
                 (position_move_y, pos1, 800), #for javelin
                 (val_mul, ":cur_rotation", 2),
               (try_end),
               (position_transform_position_to_parent, pos2, pos0, pos1),
               (position_set_z_to_ground_level, pos2),
               (scene_prop_get_instance, ":spike_instance", "spr_gourd_spike", ":cur_instance"),
               (prop_instance_set_position, ":spike_instance", pos2),
               (position_move_z, pos2, 150, 1),
               (prop_instance_set_position, ":gourd_instance", pos2),
             (try_end),
             (scene_prop_get_instance, ":pointer_instance", "spr_pointer_arrow", 0),
             (scene_prop_get_instance, ":spike_instance", "spr_gourd_spike", 1),
             (prop_instance_get_position, pos1, ":spike_instance"),
             (prop_instance_set_position, ":pointer_instance", pos1),
             (assign, "$g_pointer_arrow_height_adder", 200),
             (tutorial_message, "str_tutorial_training_ground_archer_text_2"),
             (val_add, "$g_tutorial_training_ground_archer_trainer_state", 1),
           (try_end),
         (else_try),
           (eq, "$g_tutorial_training_ground_archer_trainer_state", 5),
           (try_begin),
             (try_begin),
               (neq, "$g_tutorial_training_ground_current_score", "$g_last_destroyed_gourds"),
               (assign, "$g_tutorial_training_ground_current_score", "$g_last_destroyed_gourds"),
               (try_begin),
                 (lt, "$g_last_destroyed_gourds", 3),
                 (play_sound, "snd_tutorial_1"),
               (else_try),
                 (play_sound, "snd_tutorial_2"),
               (try_end),
             (try_end),
             (try_begin),
               (eq, "$g_tutorial_training_ground_archer_trainer_completed_chapters", 0),
               (eq, "$g_last_destroyed_gourds", 0),
               (entry_point_get_position, pos0, 45),
               (agent_get_position, pos1, ":player_agent"),
               (neg|position_is_behind_position, pos1, pos0),
               (tutorial_message, "str_tutorial_training_ground_archer_text_3"),
             (else_try),
               (eq, "$g_tutorial_training_ground_archer_trainer_completed_chapters", 0),
               (eq, "$g_last_destroyed_gourds", 1),
               (tutorial_message, "str_tutorial_training_ground_archer_text_4"),
             (try_end),
             (ge, "$g_last_destroyed_gourds", 3),
             (assign, "$g_pointer_arrow_height_adder", -1000),
             (val_add, "$g_tutorial_training_ground_archer_trainer_state", 1),
           (try_end),
         (else_try),
           (eq, "$g_tutorial_training_ground_archer_trainer_state", 6),
           (try_begin),
             (try_begin),
               (ge, "$g_tutorial_training_ground_archer_trainer_item_2", 0),
               (agent_unequip_item, ":player_agent", "$g_tutorial_training_ground_archer_trainer_item_2"),
             (try_end),
             (agent_unequip_item, ":player_agent", "$g_tutorial_training_ground_archer_trainer_item_1"),
             (tutorial_message, "str_tutorial_training_ground_archer_text_5", 0, 10),
             (assign, "$g_tutorial_training_ground_archer_trainer_state", 0),
             (val_add, "$g_tutorial_training_ground_archer_trainer_completed_chapters", 1),
           (try_end),
         (try_end),
         ], []),
      
      (0, 0, 0,
       [
         (get_player_agent_no, ":player_agent"),
         (neq, "$g_tutorial_training_ground_melee_trainer_attack", -1),
         (mission_disable_talk),
         (try_for_agents, ":cur_agent"),
           (agent_get_troop_id, ":cur_agent_troop", ":cur_agent"),
           (eq, ":cur_agent_troop", "$g_tutorial_training_ground_melee_trainer_attack"),
           (assign, ":trainer_agent", ":cur_agent"),
         (try_end),
         (try_begin),
           (eq, "$g_tutorial_training_ground_melee_state", 0),
           (try_begin),
             (try_for_agents, ":cur_agent"),
               (agent_get_troop_id, ":cur_agent_troop", ":cur_agent"),
               (this_or_next|eq, ":cur_agent_troop", "trp_tutorial_fighter_1"),
               (this_or_next|eq, ":cur_agent_troop", "trp_tutorial_fighter_2"),
               (this_or_next|eq, ":cur_agent_troop", "trp_tutorial_fighter_3"),
               (eq, ":cur_agent_troop", "trp_tutorial_fighter_4"),
               (agent_set_team, ":cur_agent", 7),
               (agent_get_slot, ":spawn_point", ":cur_agent", "slot_agent_spawn_entry_point"),
               (entry_point_get_position, pos1, ":spawn_point"),
               (agent_set_scripted_destination, ":cur_agent", pos1),
               (agent_force_rethink, ":cur_agent"),
             (try_end),
             (agent_set_wielded_item, ":trainer_agent", "itm_practice_sword"), #TODO: change this
             (store_random_in_range, "$g_tutorial_training_ground_melee_state", 1, 5), #random attack dir
             (assign, "$g_tutorial_update_mouse_presentation", 1),
             (assign, "$g_tutorial_training_ground_next_score_time", 0),
           (try_end),
         (else_try),
           (gt, "$g_tutorial_training_ground_melee_state", 0),
           (try_begin),
             (agent_set_team, ":player_agent", 1),
             (agent_set_team, ":trainer_agent", 2),
             (agent_get_position, pos1, ":player_agent"),
             (agent_set_scripted_destination_no_attack, ":trainer_agent", pos1),
             (agent_get_attack_action, ":attack_action", ":player_agent"),
             (try_begin),
               (eq, ":attack_action", 2), #release
               (agent_get_action_dir, ":action_dir_attacker", ":player_agent"),
               (try_begin),
                 (eq, ":action_dir_attacker", 0), #down
                 (agent_set_defend_action, ":trainer_agent", 0, 1),
               (else_try),
                 (eq, ":action_dir_attacker", 3), #up
                 (agent_set_defend_action, ":trainer_agent", 3, 1),
               (else_try),
                 (eq, ":action_dir_attacker", 1), #right
                 (agent_set_defend_action, ":trainer_agent", 2, 1),
               (else_try),
                 (eq, ":action_dir_attacker", 2), #left
                 (agent_set_defend_action, ":trainer_agent", 1, 1),
               (try_end),
             (try_end),
             (try_begin),
               (ge, "$g_tutorial_training_ground_current_score", 5),
               (tutorial_message, -1),
               (assign, "$g_tutorial_training_ground_melee_state", 0),
               (agent_set_team, ":player_agent", 0),
               (agent_set_team, ":trainer_agent", 7),
               (agent_set_hit_points, ":player_agent", 100, 0),
               (agent_set_hit_points, ":trainer_agent", 100, 0),
##               (assign, "$g_tutorial_training_ground_melee_trainer_attack_completed", 1), #not used
               (assign, "$g_tutorial_training_ground_conversation_state", 9), #attack complete
               (start_mission_conversation, "$g_tutorial_training_ground_melee_trainer_attack"),
               (assign, "$g_tutorial_training_ground_melee_trainer_attack", -1),
             (try_end),
           (try_end),
         (try_end),
         (try_begin),
           (agent_get_attack_action, ":attack_action", ":player_agent"),
           (eq, ":attack_action", 2), #release
           (agent_get_action_dir, ":action_dir_attacker", ":player_agent"),
           (store_add, ":attack_state", ":action_dir_attacker", 1),
           (agent_get_wielded_item, ":weapon_item", ":player_agent", 0),
           (call_script, "script_cf_is_melee_weapon_for_tutorial", ":weapon_item"),
           (store_mission_timer_a, ":cur_time"),
           (gt, ":cur_time", "$g_tutorial_training_ground_next_score_time"),
           (try_begin),
             (eq, ":attack_state", "$g_tutorial_training_ground_melee_state"),
             (val_add, "$g_tutorial_training_ground_current_score", 1),
             (try_begin),
               (ge, "$g_tutorial_training_ground_current_score", 5),
               (assign, "$g_tutorial_training_ground_melee_state", 5),
               (play_sound, "snd_tutorial_2"),
             (else_try),
               (play_sound, "snd_tutorial_1"),
               (assign, ":end_cond", 100),
               (try_for_range, ":unused", 0, ":end_cond"),
                 (store_random_in_range, ":random_no", 1, 5), #random attack dir
                 (neq, ":random_no", "$g_tutorial_training_ground_melee_state"),
                 (assign, "$g_tutorial_training_ground_melee_state", ":random_no"),
                 (assign, ":end_cond", 0), #break
               (try_end),
             (try_end),
             (assign, "$g_tutorial_update_mouse_presentation", 1),
           (else_try),
             (val_add, "$g_tutorial_training_ground_current_score_2", 1),
             (play_sound, "snd_tutorial_fail"),
           (try_end),
           (store_add, "$g_tutorial_training_ground_next_score_time", ":cur_time", 1),
         (try_end),
         (assign, reg0, "$g_tutorial_training_ground_current_score"),
         (assign, reg1, "$g_tutorial_training_ground_current_score_2"),
         (str_clear, s0),
         (assign, "$g_tutorial_mouse_dir", -1),
         (assign, "$g_tutorial_mouse_click", -1),
         (try_begin),
           (neq, "$g_tutorial_training_ground_melee_state", 5), #finished
           (store_mission_timer_a, ":cur_time"),
           (this_or_next|eq, "$g_tutorial_update_mouse_presentation", 0),
           (gt, ":cur_time", "$g_tutorial_training_ground_next_score_time"),
           (try_begin),
             (eq, "$g_tutorial_training_ground_melee_state", 1), #down
             (str_store_string, s0, "str_tutorial_training_ground_attack_training_down"),
           (else_try),
             (eq, "$g_tutorial_training_ground_melee_state", 4), #up
             (str_store_string, s0, "str_tutorial_training_ground_attack_training_up"),
           (else_try),
             (eq, "$g_tutorial_training_ground_melee_state", 2), #right
             (str_store_string, s0, "str_tutorial_training_ground_attack_training_right"),
           (else_try),
             (eq, "$g_tutorial_training_ground_melee_state", 3), #left
             (str_store_string, s0, "str_tutorial_training_ground_attack_training_left"),
           (try_end),
           (store_sub, "$g_tutorial_mouse_dir", "$g_tutorial_training_ground_melee_state", 1),
           (assign, "$g_tutorial_mouse_click", 0),
           (try_begin),
             (eq, "$g_tutorial_update_mouse_presentation", 1),
             (assign, "$g_tutorial_update_mouse_presentation", 0),
             (start_presentation, "prsnt_tutorial_show_mouse_movement"),
           (try_end),
         (try_end),
         (try_begin),
           (agent_get_wielded_item, ":weapon_item", ":player_agent", 0),
           (call_script, "script_cf_is_melee_weapon_for_tutorial", ":weapon_item"),
           (tutorial_message, "str_tutorial_training_ground_attack_training"),
         (else_try),
           (tutorial_message, "str_tutorial_training_ground_warning_melee"),
         (try_end),
         ], []),

      (0, 0, 0,
       [
         (get_player_agent_no, ":player_agent"),
         (neq, "$g_tutorial_training_ground_melee_trainer_parry", -1),
         (mission_disable_talk),
         (try_for_agents, ":cur_agent"),
           (agent_get_troop_id, ":cur_agent_troop", ":cur_agent"),
           (eq, ":cur_agent_troop", "$g_tutorial_training_ground_melee_trainer_parry"),
           (assign, ":trainer_agent", ":cur_agent"),
         (try_end),
         (try_begin),
           (eq, "$g_tutorial_training_ground_melee_state", 0),
           (try_begin),
             (try_for_agents, ":cur_agent"),
               (agent_get_troop_id, ":cur_agent_troop", ":cur_agent"),
               (this_or_next|eq, ":cur_agent_troop", "trp_tutorial_fighter_1"),
               (this_or_next|eq, ":cur_agent_troop", "trp_tutorial_fighter_2"),
               (this_or_next|eq, ":cur_agent_troop", "trp_tutorial_fighter_3"),
               (eq, ":cur_agent_troop", "trp_tutorial_fighter_4"),
               (agent_set_team, ":cur_agent", 7),
               (agent_get_slot, ":spawn_point", ":cur_agent", "slot_agent_spawn_entry_point"),
               (entry_point_get_position, pos1, ":spawn_point"),
               (agent_set_scripted_destination, ":cur_agent", pos1),
               (agent_force_rethink, ":cur_agent"),
             (try_end),
             (agent_set_wielded_item, ":trainer_agent", "itm_practice_sword"), #TODO: change this
             (val_add, "$g_tutorial_training_ground_melee_state", 1),
             (store_mission_timer_a, "$g_tutorial_training_ground_melee_next_action_time"),
             (val_add, "$g_tutorial_training_ground_melee_next_action_time", 1),
           (try_end),
         (else_try),
           (eq, "$g_tutorial_training_ground_melee_state", 1),
           (try_begin),
             (store_mission_timer_a, ":cur_time"),
             (gt, ":cur_time", "$g_tutorial_training_ground_melee_next_action_time"),
             (agent_set_team, ":player_agent", 1),
             (agent_set_team, ":trainer_agent", 2),
             (agent_get_position, pos1, ":player_agent"),
             (agent_set_scripted_destination_no_attack, ":trainer_agent", pos1),
             (agent_get_position, pos2, ":trainer_agent"),
             (get_sq_distance_between_positions, ":sq_dist", pos1, pos2),
             (lt, ":sq_dist", 400), #2 meters
             (try_begin),
               (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 0),
               (try_begin),
                 (ge, "$g_tutorial_training_ground_current_score", 5),
                 (assign, "$g_tutorial_mouse_dir", -1),
                 (assign, "$g_tutorial_mouse_click", -1),
                 (tutorial_message, -1),
                 (assign, "$g_tutorial_training_ground_melee_state", 0),
                 (agent_set_team, ":player_agent", 0),
                 (agent_set_team, ":trainer_agent", 7),
                 (agent_set_hit_points, ":player_agent", 100, 0),
                 (agent_set_hit_points, ":trainer_agent", 100, 0),
##                 (assign, "$g_tutorial_training_ground_melee_trainer_parry_completed", 1), #not used
                 (assign, "$g_tutorial_training_ground_conversation_state", 1), #parry complete
                 (start_mission_conversation, "$g_tutorial_training_ground_melee_trainer_parry"),
                 (assign, "$g_tutorial_training_ground_melee_trainer_parry", -1),
               (else_try),
                 (store_random_in_range, ":random_no", 0, 4),
                 (agent_set_attack_action, ":trainer_agent", ":random_no", 1), #ready
                 (val_add, "$g_tutorial_training_ground_melee_trainer_action_state", 1),
                 (assign, "$g_tutorial_mouse_dir", ":random_no"),
                 (try_begin),
                   (is_between, ":random_no", 1, 3), #right or left
                   (store_sub, "$g_tutorial_mouse_dir", 3, ":random_no"), #revert sides
                 (try_end),
                 (assign, "$g_tutorial_mouse_click", 1),
                 (start_presentation, "prsnt_tutorial_show_mouse_movement"),
               (try_end),
             (else_try),
               (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 1),
               (agent_get_defend_action, ":defend_action", ":player_agent"),
               (gt, ":defend_action", 0), #parrying or blocking
               (agent_get_action_dir, ":action_dir_defender", ":player_agent"),
               (agent_get_action_dir, ":action_dir_attacker", ":trainer_agent"),
               (assign, ":actions_match", 0),
               (try_begin),
                 (eq, ":action_dir_attacker", 0), #down
                 (eq, ":action_dir_defender", 0), #down
                 (assign, ":actions_match", 1),
               (else_try),
                 (eq, ":action_dir_attacker", 3), #up
                 (eq, ":action_dir_defender", 3), #up
                 (assign, ":actions_match", 1),
               (else_try),
                 (eq, ":action_dir_attacker", 1), #right
                 (eq, ":action_dir_defender", 2), #left
                 (assign, ":actions_match", 1),
               (else_try),
                 (eq, ":action_dir_attacker", 2), #left
                 (eq, ":action_dir_defender", 1), #right
                 (assign, ":actions_match", 1),
               (try_end),
               (eq, ":actions_match", 1),
               (assign, "$g_tutorial_mouse_dir", -1),
               (assign, "$g_tutorial_mouse_click", -1),
               (agent_set_attack_action, ":trainer_agent", 0, 0), #release
               (val_add, "$g_tutorial_training_ground_melee_trainer_action_state", 1),
               (store_mission_timer_a, "$g_tutorial_training_ground_melee_trainer_next_action_time"),
               (val_add, "$g_tutorial_training_ground_melee_trainer_next_action_time", 2),
             (else_try),
               (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 2),
               (try_begin),
                 (store_mission_timer_a, ":cur_time"),
                 (gt, ":cur_time", "$g_tutorial_training_ground_melee_trainer_next_action_time"),
                 (assign, "$g_tutorial_training_ground_melee_trainer_action_state", 0),
               (try_end),
             (try_end),
           (try_end),
         (try_end),
         (try_begin),
           (agent_is_in_parried_animation, ":trainer_agent"),
           (agent_get_wielded_item, ":shield_item", ":player_agent", 1),
           (eq, ":shield_item", -1),
           (agent_get_wielded_item, ":weapon_item", ":player_agent", 0),
           (neq, ":weapon_item", "itm_practice_seaxe"),
           (call_script, "script_cf_is_melee_weapon_for_tutorial", ":weapon_item"),
           (store_mission_timer_a, ":cur_time"),
           (gt, ":cur_time", "$g_tutorial_training_ground_next_score_time"),
           (val_add, "$g_tutorial_training_ground_current_score", 1),
           (try_begin),
             (lt, "$g_tutorial_training_ground_current_score", 5),
             (play_sound, "snd_tutorial_1"),
           (else_try),
             (play_sound, "snd_tutorial_2"),
           (try_end),
           (store_add, "$g_tutorial_training_ground_next_score_time", ":cur_time", 1),
         (try_end),
         (assign, reg0, "$g_tutorial_training_ground_current_score"),
         (try_begin),
           (agent_get_wielded_item, ":shield_item", ":player_agent", 1),
           (eq, ":shield_item", -1),
           (agent_get_wielded_item, ":weapon_item", ":player_agent", 0),
           (neq, ":weapon_item", "itm_practice_seaxe"),
           (call_script, "script_cf_is_melee_weapon_for_tutorial", ":weapon_item"),
           (tutorial_message, "str_tutorial_training_ground_parry_training"),
         (else_try),
           (neq, ":shield_item", -1),
           (tutorial_message, "str_tutorial_training_ground_warning_shield"),
         (else_try),
           (tutorial_message, "str_tutorial_training_ground_warning_melee_with_parry"),
         (try_end),
         ], []),

      (0, 0, 0,
       [
         (get_player_agent_no, ":player_agent"),
         (neq, "$g_tutorial_training_ground_melee_trainer_chamber", -1),
         (mission_disable_talk),
         (try_for_agents, ":cur_agent"),
           (agent_get_troop_id, ":cur_agent_troop", ":cur_agent"),
           (eq, ":cur_agent_troop", "$g_tutorial_training_ground_melee_trainer_chamber"),
           (assign, ":trainer_agent", ":cur_agent"),
         (try_end),
         (try_begin),
           (eq, "$g_tutorial_training_ground_melee_state", 0),
           (try_begin),
             (try_for_agents, ":cur_agent"),
               (agent_get_troop_id, ":cur_agent_troop", ":cur_agent"),
               (this_or_next|eq, ":cur_agent_troop", "trp_tutorial_fighter_1"),
               (this_or_next|eq, ":cur_agent_troop", "trp_tutorial_fighter_2"),
               (this_or_next|eq, ":cur_agent_troop", "trp_tutorial_fighter_3"),
               (eq, ":cur_agent_troop", "trp_tutorial_fighter_4"),
               (agent_set_team, ":cur_agent", 7),
               (agent_get_slot, ":spawn_point", ":cur_agent", "slot_agent_spawn_entry_point"),
               (entry_point_get_position, pos1, ":spawn_point"),
               (agent_set_scripted_destination, ":cur_agent", pos1),
               (agent_force_rethink, ":cur_agent"),
             (try_end),
##             (entry_point_get_position, pos1, 30),
##             (agent_set_scripted_destination_no_attack, ":trainer_agent", pos1, 1),
##             (agent_get_position, pos2, ":trainer_agent"),
##             (get_sq_distance_between_positions, ":sq_dist_1", pos1, pos2),
##             (lt, ":sq_dist_1", 400), #2 meters
##             (entry_point_get_position, pos1, 31),
##             (agent_get_position, pos2, ":player_agent"),
##             (get_sq_distance_between_positions, ":sq_dist_2", pos1, pos2),
##             (lt, ":sq_dist_2", 400), #2 meters
             (agent_set_wielded_item, ":trainer_agent", "itm_practice_sword"), #TODO: change this
             (val_add, "$g_tutorial_training_ground_melee_state", 1),
             (store_mission_timer_a, "$g_tutorial_training_ground_melee_next_action_time"),
             (val_add, "$g_tutorial_training_ground_melee_next_action_time", 1),
           (try_end),
         (else_try),
           (eq, "$g_tutorial_training_ground_melee_state", 1),
           (try_begin),
             (store_mission_timer_a, ":cur_time"),
             (gt, ":cur_time", "$g_tutorial_training_ground_melee_next_action_time"),
             (agent_set_team, ":player_agent", 1),
             (agent_set_team, ":trainer_agent", 2),
             (agent_get_position, pos1, ":player_agent"),
             (agent_set_scripted_destination_no_attack, ":trainer_agent", pos1),
             (agent_get_position, pos2, ":trainer_agent"),
             (get_sq_distance_between_positions, ":sq_dist", pos1, pos2),
             (lt, ":sq_dist", 400), #2 meters
             (try_begin),
               (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 0),
               (try_begin),
                 (ge, "$g_tutorial_training_ground_current_score", 5),
                 (tutorial_message, -1),
                 (assign, "$g_tutorial_training_ground_melee_state", 0),
                 (agent_set_team, ":player_agent", 0),
                 (agent_set_team, ":trainer_agent", 7),
                 (agent_set_hit_points, ":player_agent", 100, 0),
                 (agent_set_hit_points, ":trainer_agent", 100, 0),
##                 (assign, "$g_tutorial_training_ground_melee_trainer_chamber_completed", 1), #not used
                 (assign, "$g_tutorial_training_ground_conversation_state", 6), #chamber complete
                 (start_mission_conversation, "$g_tutorial_training_ground_melee_trainer_chamber"),
                 (assign, "$g_tutorial_training_ground_melee_trainer_chamber", -1),
               (else_try),
                 (store_random_in_range, "$g_tutorial_training_ground_melee_trainer_attack_dir", 0, 4),
                 (agent_set_attack_action, ":trainer_agent", "$g_tutorial_training_ground_melee_trainer_attack_dir", 1), #ready
                 (val_add, "$g_tutorial_training_ground_melee_trainer_action_state", 1),
                 (store_mission_timer_a, "$g_tutorial_training_ground_melee_trainer_next_action_time"),
                 (val_add, "$g_tutorial_training_ground_melee_trainer_next_action_time", 1),
               (try_end),
             (else_try),
               (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 1),
               (try_begin),
                 (store_mission_timer_a, ":cur_time"),
                 (gt, ":cur_time", "$g_tutorial_training_ground_melee_trainer_next_action_time"),
                 (agent_set_attack_action, ":trainer_agent", -1, 0), #cancel
                 (agent_set_defend_action, ":trainer_agent", 0, 1), #cancel
                 (val_add, "$g_tutorial_training_ground_melee_trainer_action_state", 1),
                 (store_mission_timer_a, "$g_tutorial_training_ground_melee_trainer_next_action_time"),
                 (val_add, "$g_tutorial_training_ground_melee_trainer_next_action_time", 1),
               (try_end),
             (else_try),
               (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 2),
               (try_begin),
                 (store_mission_timer_a, ":cur_time"),
                 (gt, ":cur_time", "$g_tutorial_training_ground_melee_trainer_next_action_time"),
                 (agent_set_attack_action, ":trainer_agent", "$g_tutorial_training_ground_melee_trainer_attack_dir", 0),
                 (val_add, "$g_tutorial_training_ground_melee_trainer_action_state", 1),
                 (store_mission_timer_a, "$g_tutorial_training_ground_melee_trainer_next_action_time"),
                 (val_add, "$g_tutorial_training_ground_melee_trainer_next_action_time", 2),
               (try_end),
             (else_try),
               (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 3),
               (try_begin),
                 (store_mission_timer_a, ":cur_time"),
                 (gt, ":cur_time", "$g_tutorial_training_ground_melee_trainer_next_action_time"),
                 (assign, "$g_tutorial_training_ground_melee_trainer_action_state", 0),
               (try_end),
             (try_end),
           (try_end),
         (try_end),
         (try_begin),
           (agent_is_in_parried_animation, ":trainer_agent"),
           (agent_get_attack_action, ":attack_action", ":player_agent"),
           (store_mission_timer_a, ":cur_time"),
           (gt, ":cur_time", "$g_tutorial_training_ground_next_score_time"),
           #add first, because player might immediately start attacking after parry
           (store_add, "$g_tutorial_training_ground_next_score_time", ":cur_time", 1),
           (eq, ":attack_action", 1), #readying_attack
           (val_add, "$g_tutorial_training_ground_current_score", 1),
           (try_begin),
             (lt, "$g_tutorial_training_ground_current_score", 5),
             (play_sound, "snd_tutorial_1"),
           (else_try),
             (play_sound, "snd_tutorial_2"),
           (try_end),
         (try_end),
         (assign, reg0, "$g_tutorial_training_ground_current_score"),
         (tutorial_message, "str_tutorial_training_ground_chamber_training"),
         ], []),

      (0, 0, 0,
       [
         (get_player_agent_no, ":player_agent"),
         (neq, "$g_tutorial_training_ground_melee_trainer_combat", -1),
         (mission_disable_talk),
         (try_for_agents, ":cur_agent"),
           (agent_get_troop_id, ":cur_agent_troop", ":cur_agent"),
           (eq, ":cur_agent_troop", "$g_tutorial_training_ground_melee_trainer_combat"),
           (assign, ":trainer_agent", ":cur_agent"),
         (try_end),
         (try_begin),
           (eq, "$g_tutorial_training_ground_melee_state", 0),
           (try_begin),
             (try_for_agents, ":cur_agent"),
               (agent_get_troop_id, ":cur_agent_troop", ":cur_agent"),
               (this_or_next|eq, ":cur_agent_troop", "trp_tutorial_fighter_1"),
               (this_or_next|eq, ":cur_agent_troop", "trp_tutorial_fighter_2"),
               (this_or_next|eq, ":cur_agent_troop", "trp_tutorial_fighter_3"),
               (eq, ":cur_agent_troop", "trp_tutorial_fighter_4"),
               (agent_set_team, ":cur_agent", 7),
               (agent_get_slot, ":spawn_point", ":cur_agent", "slot_agent_spawn_entry_point"),
               (entry_point_get_position, pos1, ":spawn_point"),
               (agent_set_scripted_destination, ":cur_agent", pos1),
               (agent_force_rethink, ":cur_agent"),
             (try_end),
##             (entry_point_get_position, pos1, 30),
##             (agent_set_scripted_destination, ":trainer_agent", pos1, 1),
##             (agent_get_position, pos2, ":trainer_agent"),
##             (get_sq_distance_between_positions, ":sq_dist_1", pos1, pos2),
##             (lt, ":sq_dist_1", 400), #2 meters
##             (entry_point_get_position, pos1, 31),
##             (agent_get_position, pos2, ":player_agent"),
##             (get_sq_distance_between_positions, ":sq_dist_2", pos1, pos2),
##             (lt, ":sq_dist_2", 400), #2 meters
             (agent_set_wielded_item, ":trainer_agent", "itm_practice_sword"), #TODO: change this
             (val_add, "$g_tutorial_training_ground_melee_state", 1),
             (store_mission_timer_a, "$g_tutorial_training_ground_melee_next_action_time"),
             (val_add, "$g_tutorial_training_ground_melee_next_action_time", 1),
           (try_end),
         (else_try),
           (eq, "$g_tutorial_training_ground_melee_state", 1),
           (try_begin),
             (store_mission_timer_a, ":cur_time"),
             (gt, ":cur_time", "$g_tutorial_training_ground_melee_next_action_time"),
             (agent_set_team, ":player_agent", 1),
             (agent_set_team, ":trainer_agent", 2),
             (agent_clear_scripted_mode, ":trainer_agent"),
             (agent_force_rethink, ":trainer_agent"),
           (try_end),
         (try_end),
         ], []),

      (0, 0, 0,
       [
         (eq, "$g_tutorial_training_ground_melee_trainer_attack", -1),
         (eq, "$g_tutorial_training_ground_melee_trainer_parry", -1),
         (eq, "$g_tutorial_training_ground_melee_trainer_combat", -1),
         (eq, "$g_tutorial_training_ground_melee_trainer_chamber", -1),
         (eq, "$g_tutorial_training_ground_archer_trainer_state", 0),
         (eq, "$g_tutorial_training_ground_horseman_trainer_state", 0),
         (mission_enable_talk),
         ], []),

      (0, 0, 0,
       [
         (eq, "$g_tutorial_training_ground_melee_trainer_attack", -1),
         (eq, "$g_tutorial_training_ground_melee_trainer_parry", -1),
         (eq, "$g_tutorial_training_ground_melee_trainer_combat", -1),
         (eq, "$g_tutorial_training_ground_melee_trainer_chamber", -1),
         (get_player_agent_no, ":player_agent"),
         (agent_get_position, pos1, ":player_agent"),
         (assign, ":shortest_dist", 10000000),
         (try_for_agents, ":cur_agent"),
           (agent_get_troop_id, ":cur_agent_troop", ":cur_agent"),
           (this_or_next|eq, ":cur_agent_troop", "trp_tutorial_fighter_1"),
           (this_or_next|eq, ":cur_agent_troop", "trp_tutorial_fighter_2"),
           (this_or_next|eq, ":cur_agent_troop", "trp_tutorial_fighter_3"),
           (eq, ":cur_agent_troop", "trp_tutorial_fighter_4"),
           (agent_get_position, pos2, ":cur_agent"),
           (get_sq_distance_between_positions, ":cur_dist", pos1, pos2),
           (lt, ":cur_dist", ":shortest_dist"),
           (assign, ":shortest_dist", ":cur_dist"),
         (try_end),
         (try_begin),
           (le, ":shortest_dist", 1600), #4 meters
           (assign, "$g_tutorial_training_ground_melee_paused", 1),
           (try_for_agents, ":cur_agent"),
             (agent_get_troop_id, ":cur_agent_troop", ":cur_agent"),
             (this_or_next|eq, ":cur_agent_troop", "trp_tutorial_fighter_1"),
             (this_or_next|eq, ":cur_agent_troop", "trp_tutorial_fighter_2"),
             (this_or_next|eq, ":cur_agent_troop", "trp_tutorial_fighter_3"),
             (eq, ":cur_agent_troop", "trp_tutorial_fighter_4"),
             (agent_set_team, ":cur_agent", 7),
             (agent_get_position, pos2, ":cur_agent"),
             (agent_set_scripted_destination, ":cur_agent", pos2),
             (try_begin),
               (neq, ":cur_agent", "$g_tutorial_training_ground_melee_cur_fighter_1"),
               (neq, ":cur_agent", "$g_tutorial_training_ground_melee_cur_fighter_2"),
               (agent_set_wielded_item, ":cur_agent", -1),
             (try_end),
             (agent_force_rethink, ":cur_agent"),
             (agent_set_look_target_agent, ":cur_agent", ":player_agent"),
           (try_end),
         (else_try),
           (gt, "$g_tutorial_training_ground_melee_paused", 0),
           (assign, "$g_tutorial_training_ground_melee_paused", 0),
           (assign, "$g_tutorial_training_ground_melee_state", 0),
         (try_end),
         (try_begin),
           (eq, "$g_tutorial_training_ground_melee_paused", 0),
           (eq, "$g_tutorial_training_ground_melee_state", 0),
           (try_begin),
             (assign, "$g_tutorial_training_ground_melee_cur_fighter_1", -1),
             (assign, "$g_tutorial_training_ground_melee_cur_fighter_2", -1),
             (try_for_range, ":unused", 0, 2),
               (try_begin),
                 (ge, "$g_tutorial_training_ground_melee_last_winner", 0),
                 (assign, "$g_tutorial_training_ground_melee_cur_fighter_1", "$g_tutorial_training_ground_melee_last_winner"),
                 (assign, "$g_tutorial_training_ground_melee_last_winner", -1),
               (try_end),
               (this_or_next|eq, "$g_tutorial_training_ground_melee_cur_fighter_1", -1),
               (eq, "$g_tutorial_training_ground_melee_cur_fighter_2", -1),
               (assign, ":num_candidates", 0),
               (try_for_agents, ":cur_agent"),
                 (agent_get_troop_id, ":cur_agent_troop", ":cur_agent"),
                 (this_or_next|eq, ":cur_agent_troop", "trp_tutorial_fighter_1"),
                 (this_or_next|eq, ":cur_agent_troop", "trp_tutorial_fighter_2"),
                 (this_or_next|eq, ":cur_agent_troop", "trp_tutorial_fighter_3"),
                 (eq, ":cur_agent_troop", "trp_tutorial_fighter_4"),
                 (neq, ":cur_agent", "$g_tutorial_training_ground_melee_cur_fighter_1"),
                 (neq, ":cur_agent", "$g_tutorial_training_ground_melee_cur_fighter_2"),
                 (neq, ":cur_agent", "$g_tutorial_training_ground_melee_last_loser"),
                 (val_add, ":num_candidates", 1),
               (try_end),
               (store_random_in_range, ":random_candidate", 0, ":num_candidates"),
               (try_for_agents, ":cur_agent"),
                 (agent_get_troop_id, ":cur_agent_troop", ":cur_agent"),
                 (this_or_next|eq, ":cur_agent_troop", "trp_tutorial_fighter_1"),
                 (this_or_next|eq, ":cur_agent_troop", "trp_tutorial_fighter_2"),
                 (this_or_next|eq, ":cur_agent_troop", "trp_tutorial_fighter_3"),
                 (eq, ":cur_agent_troop", "trp_tutorial_fighter_4"),
                 (neq, ":cur_agent", "$g_tutorial_training_ground_melee_cur_fighter_1"),
                 (neq, ":cur_agent", "$g_tutorial_training_ground_melee_cur_fighter_2"),
                 (neq, ":cur_agent", "$g_tutorial_training_ground_melee_last_loser"),
                 (val_sub, ":random_candidate", 1),
                 (lt, ":random_candidate", 0),
                 (try_begin),
                   (eq, "$g_tutorial_training_ground_melee_cur_fighter_1", -1),
                   (assign, "$g_tutorial_training_ground_melee_cur_fighter_1", ":cur_agent"),
                 (else_try),
                   (assign, "$g_tutorial_training_ground_melee_cur_fighter_2", ":cur_agent"),
                 (try_end),
               (try_end),
             (try_end),
             (try_for_agents, ":cur_agent"),
               (agent_get_troop_id, ":cur_agent_troop", ":cur_agent"),
               (this_or_next|eq, ":cur_agent_troop", "trp_tutorial_fighter_1"),
               (this_or_next|eq, ":cur_agent_troop", "trp_tutorial_fighter_2"),
               (this_or_next|eq, ":cur_agent_troop", "trp_tutorial_fighter_3"),
               (eq, ":cur_agent_troop", "trp_tutorial_fighter_4"),
               (neq, ":cur_agent", "$g_tutorial_training_ground_melee_cur_fighter_1"),
               (neq, ":cur_agent", "$g_tutorial_training_ground_melee_cur_fighter_2"),
               (agent_set_wielded_item, ":cur_agent", -1),
             (try_end),
             (val_add, "$g_tutorial_training_ground_melee_state", 1), #fighters are chosen
             (store_mission_timer_a, "$g_tutorial_training_ground_melee_next_action_time"),
             (val_add, "$g_tutorial_training_ground_melee_next_action_time", 3),
           (try_end),
         (else_try),
           (eq, "$g_tutorial_training_ground_melee_state", 1),
           (try_begin),
             (store_mission_timer_a, ":cur_time"),
             (gt, ":cur_time", "$g_tutorial_training_ground_melee_next_action_time"),
             (try_for_agents, ":cur_agent"),
               (agent_is_human, ":cur_agent"),
               (agent_get_troop_id, ":cur_agent_troop", ":cur_agent"),
               (this_or_next|eq, ":cur_agent_troop", "trp_tutorial_fighter_1"),
               (this_or_next|eq, ":cur_agent_troop", "trp_tutorial_fighter_2"),
               (this_or_next|eq, ":cur_agent_troop", "trp_tutorial_fighter_3"),
               (eq, ":cur_agent_troop", "trp_tutorial_fighter_4"),
               (try_begin),
                 (eq, ":cur_agent", "$g_tutorial_training_ground_melee_cur_fighter_1"),
                 (entry_point_get_position, pos1, 30),
                 (agent_set_scripted_destination, ":cur_agent", pos1),
               (else_try),
                 (eq, ":cur_agent", "$g_tutorial_training_ground_melee_cur_fighter_2"),
                 (entry_point_get_position, pos1, 31),
                 (agent_set_scripted_destination, ":cur_agent", pos1),
               (else_try),
                 (agent_get_slot, ":spawn_point", ":cur_agent", "slot_agent_spawn_entry_point"),
                 (entry_point_get_position, pos1, ":spawn_point"),
                 (agent_set_scripted_destination, ":cur_agent", pos1),
               (try_end),
             (try_end),
             (val_add, "$g_tutorial_training_ground_melee_state", 1),
           (try_end),
         (else_try),
           (eq, "$g_tutorial_training_ground_melee_state", 2),
           (try_begin),
             (agent_set_look_target_agent, "$g_tutorial_training_ground_melee_cur_fighter_1", "$g_tutorial_training_ground_melee_cur_fighter_2"),
             (agent_set_look_target_agent, "$g_tutorial_training_ground_melee_cur_fighter_2", "$g_tutorial_training_ground_melee_cur_fighter_1"),
             (agent_get_position, pos1, "$g_tutorial_training_ground_melee_cur_fighter_1"),
             (entry_point_get_position, pos2, 30),
             (get_sq_distance_between_positions, ":sq_dist_1", pos1, pos2),
             (lt, ":sq_dist_1", 400), #2 meters
             (agent_get_position, pos1, "$g_tutorial_training_ground_melee_cur_fighter_2"),
             (entry_point_get_position, pos2, 31),
             (get_sq_distance_between_positions, ":sq_dist_2", pos1, pos2),
             (lt, ":sq_dist_2", 400), #2 meters
             (val_add, "$g_tutorial_training_ground_melee_state", 1),
             (store_mission_timer_a, "$g_tutorial_training_ground_melee_next_action_time"),
             (val_add, "$g_tutorial_training_ground_melee_next_action_time", 1),
           (try_end),
         (else_try),
           (eq, "$g_tutorial_training_ground_melee_state", 3),
           (try_begin),
             (agent_set_look_target_agent, "$g_tutorial_training_ground_melee_cur_fighter_1", "$g_tutorial_training_ground_melee_cur_fighter_2"),
             (agent_set_look_target_agent, "$g_tutorial_training_ground_melee_cur_fighter_2", "$g_tutorial_training_ground_melee_cur_fighter_1"),
             (store_mission_timer_a, ":cur_time"),
             (gt, ":cur_time", "$g_tutorial_training_ground_melee_next_action_time"),
             (agent_clear_scripted_mode, "$g_tutorial_training_ground_melee_cur_fighter_1"),
             (agent_clear_scripted_mode, "$g_tutorial_training_ground_melee_cur_fighter_2"),
             (agent_set_team, "$g_tutorial_training_ground_melee_cur_fighter_1", 1),
             (agent_set_team, "$g_tutorial_training_ground_melee_cur_fighter_2", 2),
             (agent_force_rethink, "$g_tutorial_training_ground_melee_cur_fighter_1"),
             (agent_force_rethink, "$g_tutorial_training_ground_melee_cur_fighter_2"),
             (val_add, "$g_tutorial_training_ground_melee_state", 1),
           (try_end),
         (try_end),
##         (try_begin),
##           (store_mission_timer_a, ":cur_time"),
##           (gt, ":cur_time", 0),
##           (tutorial_message, "str_talk_to_the_trainer"),
##           (assign, "$g_tutorial_training_ground_state", 1),
##         (try_end),
##         (else_try),
##           (eq, "$g_tutorial_training_ground_state", 1),
##         (else_try),
##           (eq, "$g_tutorial_training_ground_state", 2),
##         (else_try),
##           (eq, "$g_tutorial_training_ground_state", 3),
##         (else_try),
##           (eq, "$g_tutorial_training_ground_state", 4),
##         (else_try),
##           (eq, "$g_tutorial_training_ground_state", 5),
##         (try_end),
         ], []),

      
    ],
  ),

  (
    "tutorial_1",0,-1,
    "You enter the training ground.",
    [
        (0,mtef_leader_only,af_override_everything,0,1,["itm_tutorial_shield", "itm_tutorial_sword", "itm_tutorial_short_bow", "itm_tutorial_arrows", "itm_leather_tunic1", "itm_leather_boots1"]), #af_override_weapons
     ],
    [
      (ti_tab_pressed, 0, 0, [],
       [(try_begin),
         (lt, "$tutorial_1_state", 5),
         (question_box, "str_do_you_wish_to_leave_tutorial"),
        (else_try),
          (finish_mission,0),
        (try_end),
        ]),
      (ti_question_answered, 0, 0, [],
       [(store_trigger_param_1,":answer"),
        (eq,":answer",0),
        (finish_mission,0),
        ]),
      (ti_inventory_key_pressed, 0, 0, [(display_message, "str_cant_use_inventory_tutorial")], []),

      (0, 0, ti_once, [
      	               (tutorial_message_set_size, 17, 17),
	               (tutorial_message_set_position, 500, 650),
                       (tutorial_message_set_center_justify, 0),

                       (assign, "$tutorial_1_state", 0),
                       (assign, "$tutorial_1_msg_1_displayed", 0),
                       (assign, "$tutorial_1_msg_2_displayed", 0),
                       (assign, "$tutorial_1_msg_3_displayed", 0),
                       (assign, "$tutorial_1_msg_4_displayed", 0),
                       (assign, "$tutorial_1_msg_5_displayed", 0),
                       (assign, "$tutorial_1_msg_6_displayed", 0),
                       ], []),

      (0, 0, 0, [(try_begin),
                   (eq, "$tutorial_1_state", 0),
                   (try_begin),
                     (eq, "$tutorial_1_msg_1_displayed", 0),
                     (store_mission_timer_a, ":cur_time"),
                     (gt, ":cur_time", 0),
                     (assign, "$tutorial_1_msg_1_displayed", 1),
                     (tutorial_message, "str_tutorial_1_msg_1"),
                     (scene_prop_get_instance, ":flag_object", "spr_tutorial_flag_yellow", 0),
                     (entry_point_get_position,pos1,1),
                     (prop_instance_animate_to_position, ":flag_object", pos1, 1),
                   (try_end),
                   (tutorial_message, "str_tutorial_1_msg_1"),
                   (get_player_agent_no, ":player_agent"),
                   (agent_get_position, pos1, ":player_agent"),
                   (entry_point_get_position,pos2,1),
                   (get_distance_between_positions, ":cur_distance", pos1, pos2),
                   (le, ":cur_distance", 100),
                   (val_add, "$tutorial_1_state", 1),
                   (scene_prop_get_instance, ":door_object", "spr_tutorial_door_a", 0),
                   (prop_instance_get_position, pos1, ":door_object"),
                   (position_rotate_z, pos1, -90),
                   (prop_instance_animate_to_position, ":door_object", pos1, 150),
                   (scene_prop_get_instance, ":flag_object", "spr_tutorial_flag_yellow", 0),
                   (entry_point_get_position,pos1,2),
                   (prop_instance_animate_to_position, ":flag_object", pos1, 1),
                 (else_try),
                   (eq, "$tutorial_1_state", 1),
                   (try_begin),
                     (eq, "$tutorial_1_msg_2_displayed", 0),
                     (assign, "$tutorial_1_msg_2_displayed", 1),
                     (tutorial_message, "str_tutorial_1_msg_2"),
                     (play_sound, "snd_tutorial_1"),
                   (try_end),
                   (get_player_agent_no, ":player_agent"),
                   (agent_get_position, pos1, ":player_agent"),
                   (entry_point_get_position,pos2,2),
                   (get_distance_between_positions, ":cur_distance", pos1, pos2),
                   (le, ":cur_distance", 100),
                   (val_add, "$tutorial_1_state", 1),
                   (scene_prop_get_instance, ":door_object", "spr_tutorial_door_a", 1),
                   (prop_instance_get_position, pos1, ":door_object"),
                   (position_rotate_z, pos1, 90),
                   (prop_instance_animate_to_position, ":door_object", pos1, 150),
                   (scene_prop_get_instance, ":flag_object", "spr_tutorial_flag_yellow", 0),
                   (entry_point_get_position,pos1,3),
                   (prop_instance_animate_to_position, ":flag_object", pos1, 1),
                 (else_try),
                   (eq, "$tutorial_1_state", 2),
                   (try_begin),
                     (eq, "$tutorial_1_msg_3_displayed", 0),
                     (assign, "$tutorial_1_msg_3_displayed", 1),
                     (tutorial_message, "str_tutorial_1_msg_3"),
                     (assign, "$tutorial_num_total_dummies_destroyed", 0),
                     (play_sound, "snd_tutorial_1"),
                   (try_end),
                   (ge, "$tutorial_num_total_dummies_destroyed", 4),
                   (val_add, "$tutorial_1_state", 1),
                   (scene_prop_get_instance, ":door_object", "spr_tutorial_door_a", 2),
                   (prop_instance_get_position, pos1, ":door_object"),
                   (position_rotate_z, pos1, 90),
                   (prop_instance_animate_to_position, ":door_object", pos1, 150),
                 (else_try),
                   (eq, "$tutorial_1_state", 3),
                   (try_begin),
                     (eq, "$tutorial_1_msg_4_displayed", 0),
                     (assign, "$tutorial_1_msg_4_displayed", 1),
                     (tutorial_message, "str_tutorial_1_msg_4"),
                     (store_mission_timer_a, "$tutorial_time"),
                     (play_sound, "snd_tutorial_1"),
                   (try_end),
                   (store_mission_timer_a, ":cur_time"),
                   (val_sub, ":cur_time", "$tutorial_time"),
                   (gt, ":cur_time", 10),
                   (val_add, "$tutorial_1_state", 1),
                 (else_try),
                   (eq, "$tutorial_1_state", 4),
                   (try_begin),
                     (eq, "$tutorial_1_msg_5_displayed", 0),
                     (assign, "$tutorial_1_msg_5_displayed", 1),
                     (tutorial_message, "str_tutorial_1_msg_5"),
                     (assign, "$g_last_archery_point_earned", 0),
                     (assign, "$tutorial_num_arrows_hit", 0),
                     (play_sound, "snd_tutorial_1"),
                   (try_end),
                   (try_begin),
                     (get_player_agent_no, ":player_agent"),
                     (agent_get_ammo, ":cur_ammo", ":player_agent"),
                     (le, ":cur_ammo", 0),
                     (agent_refill_ammo, ":player_agent"),
                     (tutorial_message, "str_tutorial_ammo_refilled"),
                   (try_end),
                   (gt, "$g_last_archery_point_earned", 0),
                   (assign, "$g_last_archery_point_earned", 0),
                   (val_add, "$tutorial_num_arrows_hit", 1),
                   (gt, "$tutorial_num_arrows_hit", 2),
                   (val_add, "$tutorial_1_state", 1),
                 (else_try),
                   (eq, "$tutorial_1_state", 5),
                   (eq, "$tutorial_1_msg_6_displayed", 0),
                   (assign, "$tutorial_1_msg_6_displayed", 1),
                   (tutorial_message, "str_tutorial_1_msg_6"),
                   (play_sound, "snd_tutorial_2"),
                   (assign, "$tutorial_1_finished", 1),
                 (try_end),
                 ], []),
    ],
  ),

##  (
##    "tutorial_1",0,-1,
##    "You enter the training ground.",
##    [
##        (0,mtef_leader_only|mtef_team_0,af_override_horse|af_override_weapons,0,1,["itm_tutorial_shield", "itm_tutorial_sword", "itm_tutorial_short_bow", "itm_tutorial_arrows"]), #af_override_weapons
##        (1,mtef_visitor_source|mtef_team_0,0,0,1,[]),
##        (2,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
##        (3,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
##        (4,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
##        (5,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
##        (6,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
##        (7,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
##        (8,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
##        (9,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
##        (10,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
##     ],
##    [
##      (ti_tab_pressed, 0, 0, [],
##       [(try_begin),
##         (lt, "$tutorial_1_state", 5),
##         (question_box, "str_do_you_wish_to_leave_tutorial"),
##        (else_try),
##          (finish_mission,0),
##        (try_end),
##        ]),
##      (ti_question_answered, 0, 0, [],
##       [(store_trigger_param_1,":answer"),
##        (eq,":answer",0),
##        (finish_mission,0),
##        ]),
##      (ti_inventory_key_pressed, 0, 0, [(display_message, "str_cant_use_inventory_tutorial")], []),
##
##      (0, 0, ti_once, [
##      	               (tutorial_message_set_size, 17, 17),
##	               (tutorial_message_set_position, 500, 650),
##                       (tutorial_message_set_center_justify, 0),
##                       (assign, "$tutorial_1_state", 0),
##                       ], []),
##
##      (0, 0, 0, [(try_begin),
##                   (eq, "$tutorial_1_state", 0),
##                   (try_begin),
##                     (store_mission_timer_a, ":cur_time"),
##                     (gt, ":cur_time", 0),
##                     (tutorial_message, "str_talk_to_the_trainer"),
##                     (assign, "$tutorial_1_state", 1),
##                   (try_end),
##                 (else_try),
##                   (eq, "$tutorial_1_state", 1),
##                 (else_try),
##                   (eq, "$tutorial_1_state", 2),
##                 (else_try),
##                   (eq, "$tutorial_1_state", 3),
##                 (else_try),
##                   (eq, "$tutorial_1_state", 4),
##                 (else_try),
##                   (eq, "$tutorial_1_state", 5),
##                 (try_end),
##                 ], []),
##    ],
##  ),


  (
    "tutorial_2",mtf_arena_fight,-1,
    "You enter the training ground.",
    [
        (0,mtef_leader_only|mtef_team_0,af_override_everything,0,1,["itm_tutorial_shield", "itm_leather_tunic1", "itm_leather_boots1"]),
        (2,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
        (4,mtef_visitor_source|mtef_team_1,0,0,1,[]),
     ],
    [
      (ti_tab_pressed, 0, 0, [],
       [(try_begin),
         (lt, "$tutorial_2_state", 9),
         (question_box,"str_do_you_wish_to_leave_tutorial"),
        (else_try),
          (finish_mission,0),
        (try_end),
        ]),
      (ti_question_answered, 0, 0, [],
       [(store_trigger_param_1,":answer"),
        (eq,":answer",0),
        (finish_mission,0),
        ]),
      (ti_inventory_key_pressed, 0, 0, [(display_message,"str_cant_use_inventory_tutorial")], []),
      (0, 0, ti_once, [
          (store_mission_timer_a, ":cur_time"),
          (gt, ":cur_time", 2),
          (main_hero_fallen),
          (assign, "$tutorial_2_state", 100),
        ], []),

      (0, 0, ti_once, [
      	               (tutorial_message_set_size, 17, 17),
	                   (tutorial_message_set_position, 500, 650),
                       (tutorial_message_set_center_justify, 0),
		               
                       (assign, "$tutorial_2_state", 0),
                       (assign, "$tutorial_2_msg_1_displayed", 0),
                       (assign, "$tutorial_2_msg_2_displayed", 0),
                       (assign, "$tutorial_2_msg_3_displayed", 0),
                       (assign, "$tutorial_2_msg_4_displayed", 0),
                       (assign, "$tutorial_2_msg_5_displayed", 0),
                       (assign, "$tutorial_2_msg_6_displayed", 0),
                       (assign, "$tutorial_2_msg_7_displayed", 0),
                       (assign, "$tutorial_2_msg_8_displayed", 0),
                       (assign, "$tutorial_2_msg_9_displayed", 0),
                       (assign, "$tutorial_2_melee_agent_state", 0),
                       ], []),

      (10, 0, 0, [(call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_archer"),
                  (agent_refill_ammo, reg0)], []),

      (0, 0, 0, [(try_begin),
                   (eq, "$tutorial_2_state", 0),
                   (try_begin),
                     (eq, "$tutorial_2_msg_1_displayed", 0),
                     (store_mission_timer_a, ":cur_time"),
                     (gt, ":cur_time", 0),
                     (assign, "$tutorial_2_msg_1_displayed", 1),
                     (tutorial_message, "str_tutorial_2_msg_1"),
                     (team_give_order, 1, grc_everyone, mordr_stand_ground),
                     (team_give_order, 1, grc_infantry, mordr_charge),
                     (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
                     (assign, ":cur_agent", reg0),
                     (agent_get_position, pos1, ":cur_agent"),
                     (agent_set_scripted_destination, ":cur_agent", pos1, 0),
                   (try_end),
                   (get_player_agent_no, ":player_agent"),
                   (ge, ":player_agent", 0),
                   (agent_get_position, pos1, ":player_agent"),
                   (entry_point_get_position,pos2,1),
                   (get_distance_between_positions, ":cur_distance", pos1, pos2),
                   (le, ":cur_distance", 200),
                   (scene_prop_get_instance, ":door_object", "spr_tutorial_door_a", 0),
                   (prop_instance_get_position, pos1, ":door_object"),
                   (position_rotate_z, pos1, 90),
                   (prop_instance_animate_to_position, ":door_object", pos1, 150),
                   (val_add, "$tutorial_2_state", 1),
                 (else_try),
                   (eq, "$tutorial_2_state", 1),
                   (scene_prop_get_instance, ":barrier_object", "spr_barrier_4m", 0),
                   (prop_instance_get_position, pos1, ":barrier_object"),
                   (get_player_agent_no, ":player_agent"),
                   (agent_get_position, pos2, ":player_agent"),
                   (position_is_behind_position, pos2, pos1),
                   (scene_prop_get_instance, ":door_object", "spr_tutorial_door_a", 0),
                   (prop_instance_get_position, pos1, ":door_object"),
                   (position_rotate_z, pos1, -90),
                   (prop_instance_animate_to_position, ":door_object", pos1, 150),
                   (val_add, "$tutorial_2_state", 1),
                 (else_try),
                   (eq, "$tutorial_2_state", 2),
                   (get_player_agent_no, ":player_agent"),
                   (agent_set_kick_allowed, ":player_agent", 0), #don't let player kick while defending
                   (try_begin),
                     (eq, "$tutorial_2_melee_agent_state", 0),
                     (val_add, "$tutorial_2_melee_agent_state", 1),
                     (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
                     (assign, ":cur_agent", reg0),
                     (entry_point_get_position, pos1, 3),
                     (agent_set_scripted_destination, ":cur_agent", pos1, 0),
                   (else_try),
                     (eq, "$tutorial_2_melee_agent_state", 1),
                     (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
                     (assign, ":cur_agent", reg0),
                     (entry_point_get_position, pos1, 3),
                     (agent_get_position, pos2, ":cur_agent"),
                     (get_distance_between_positions, ":cur_distance", pos1, pos2),
                     (le, ":cur_distance", 250),
                     (agent_clear_scripted_mode, ":cur_agent"),
                     (val_add, "$tutorial_2_melee_agent_state", 1),
                     (store_mission_timer_a,"$tutorial_time"),
                   (else_try),
                     (eq, "$tutorial_2_melee_agent_state", 2),
                     (try_begin),
                       (eq, "$tutorial_2_msg_2_displayed", 0),
                       (assign, "$tutorial_2_msg_2_displayed", 1),
                       (play_sound, "snd_tutorial_1"),
                     (try_end),
                     (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
                     (assign, ":cur_agent", reg0),
                     (store_mission_timer_a,":cur_time"),
                     (val_sub, ":cur_time", "$tutorial_time"),
                     (store_sub, reg3, 20, ":cur_time"),
                     (tutorial_message, "str_tutorial_2_msg_2"),
                     (gt, ":cur_time", 20),
                     (entry_point_get_position, pos1, 3),
                     (agent_set_scripted_destination, ":cur_agent", pos1, 0),
                     (val_add, "$tutorial_2_melee_agent_state", 1),
                   (else_try),
                     (eq, "$tutorial_2_melee_agent_state", 3),
                     (try_begin),
                       (eq, "$tutorial_2_msg_3_displayed", 0),
                       (assign, "$tutorial_2_msg_3_displayed", 1),
                       (tutorial_message, "str_tutorial_2_msg_3"),
                       (play_sound, "snd_tutorial_1"),
                     (try_end),
                     (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
                     (assign, ":cur_agent", reg0),
                     (entry_point_get_position, pos1, 3),
                     (agent_get_position, pos2, ":cur_agent"),
                     (get_distance_between_positions, ":cur_distance", pos1, pos2),
                     (le, ":cur_distance", 250),
                     (entry_point_get_position, pos1, 2),
                     (agent_set_scripted_destination, ":cur_agent", pos1, 0),
                     (val_add, "$tutorial_2_melee_agent_state", 1),
                   (else_try),
                     (eq, "$tutorial_2_melee_agent_state", 4),
                     (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
                     (assign, ":cur_agent", reg0),
                     (entry_point_get_position, pos1, 2),
                     (agent_get_position, pos2, ":cur_agent"),
                     (get_distance_between_positions, ":cur_distance", pos1, pos2),
                     (le, ":cur_distance", 250),
                     (entry_point_get_position, pos1, 30),
                     (agent_set_position, ":cur_agent", pos1),
                     (agent_set_scripted_destination, ":cur_agent", pos1, 0),
                     (scene_prop_get_instance, ":door_object", "spr_tutorial_door_a", 1),
                     (prop_instance_get_position, pos1, ":door_object"),
                     (position_rotate_z, pos1, 90),
                     (prop_instance_animate_to_position, ":door_object", pos1, 150),
                     (val_add, "$tutorial_2_melee_agent_state", 1),
                     (val_add, "$tutorial_2_state", 1),
                   (try_end),
                 (else_try),
                   (eq, "$tutorial_2_state", 3),
                   (scene_prop_get_instance, ":barrier_object", "spr_barrier_4m", 1),
                   (prop_instance_get_position, pos1, ":barrier_object"),
                   (get_player_agent_no, ":player_agent"),
                   (agent_set_kick_allowed, ":player_agent", 1), #reenable
                   (agent_get_position, pos2, ":player_agent"),
                   (position_is_behind_position, pos2, pos1),
                   (scene_prop_get_instance, ":door_object", "spr_tutorial_door_a", 1),
                   (prop_instance_get_position, pos1, ":door_object"),
                   (position_rotate_z, pos1, -90),
                   (prop_instance_animate_to_position, ":door_object", pos1, 150),
                   (store_mission_timer_a,"$tutorial_time"),
                   (val_add, "$tutorial_2_state", 1),
                 (else_try),
                   (eq, "$tutorial_2_state", 4),
                   (try_begin),
                     (eq, "$tutorial_2_msg_4_displayed", 0),
                     (assign, "$tutorial_2_msg_4_displayed", 1),
                     (play_sound, "snd_tutorial_1"),
                   (try_end),
                   (store_mission_timer_a,":cur_time"),
                   (val_sub, ":cur_time", "$tutorial_time"),
                   (store_sub, reg3, 20, ":cur_time"),
                   (tutorial_message, "str_tutorial_2_msg_4"),
                   (gt, ":cur_time", 20),
                   (entry_point_get_position,pos1,5),
                   (set_spawn_position, pos1),
                   (spawn_item, "itm_tutorial_sword"),
                   (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
                   (assign, ":cur_agent", reg0),
                   (entry_point_get_position, pos1, 3),
                   (agent_set_position, ":cur_agent", pos1),
                   (agent_set_scripted_destination, ":cur_agent", pos1, 0),
                   (scene_prop_get_instance, ":door_object", "spr_tutorial_door_a", 2),
                   (prop_instance_get_position, pos1, ":door_object"),
                   (position_rotate_z, pos1, 90),
                   (prop_instance_animate_to_position, ":door_object", pos1, 150),
                   (val_add, "$tutorial_2_state", 1),
                 (else_try),
                   (eq, "$tutorial_2_state", 5),
                   (try_begin),
                     (eq, "$tutorial_2_msg_5_displayed", 0),
                     (assign, "$tutorial_2_msg_5_displayed", 1),
                     (tutorial_message, "str_tutorial_2_msg_5"),
                     (play_sound, "snd_tutorial_1"),
                   (try_end),
                   (scene_prop_get_instance, ":barrier_object", "spr_barrier_4m", 2),
                   (prop_instance_get_position, pos1, ":barrier_object"),
                   (get_player_agent_no, ":player_agent"),
                   (agent_get_position, pos2, ":player_agent"),
                   (position_is_behind_position, pos2, pos1),
                   (scene_prop_get_instance, ":door_object", "spr_tutorial_door_a", 2),
                   (prop_instance_get_position, pos1, ":door_object"),
                   (position_rotate_z, pos1, -90),
                   (prop_instance_animate_to_position, ":door_object", pos1, 150),
                   (val_add, "$tutorial_2_state", 1),
                 (else_try),
                   (eq, "$tutorial_2_state", 6),
                   (try_begin),
                     (eq, "$tutorial_2_msg_6_displayed", 0),
                     (assign, "$tutorial_2_msg_6_displayed", 1),
                     (tutorial_message, "str_tutorial_2_msg_6"),
                     (play_sound, "snd_tutorial_1"),
                   (try_end),
                   (get_player_agent_no, ":player_agent"),
                   (agent_has_item_equipped, ":player_agent", "itm_tutorial_sword"),
                   (scene_prop_get_instance, ":door_object", "spr_tutorial_door_a", 3),
                   (prop_instance_get_position, pos1, ":door_object"),
                   (position_rotate_z, pos1, -90),
                   (prop_instance_animate_to_position, ":door_object", pos1, 150),
                   (val_add, "$tutorial_2_state", 1),
                 (else_try),
                   (eq, "$tutorial_2_state", 7),
                   (try_begin),
                     (eq, "$tutorial_2_msg_7_displayed", 0),
                     (assign, "$tutorial_2_msg_7_displayed", 1),
                     (tutorial_message, "str_tutorial_2_msg_7"),
                     (play_sound, "snd_tutorial_1"),
                     (get_player_agent_no, ":player_agent"),
                     (agent_set_hit_points, ":player_agent", 100),
                   (try_end),
                   (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_archer"),
                   (assign, ":cur_agent", reg0),
                   (neg|agent_is_alive, ":cur_agent"),
                   (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
                   (assign, ":cur_agent", reg0),
                   (agent_clear_scripted_mode, ":cur_agent"),
                   (scene_prop_get_instance, ":door_object", "spr_tutorial_door_a", 4),
                   (prop_instance_get_position, pos1, ":door_object"),
                   (position_rotate_z, pos1, -90),
                   (prop_instance_animate_to_position, ":door_object", pos1, 150),
                   (val_add, "$tutorial_2_state", 1),
                 (else_try),
                   (eq, "$tutorial_2_state", 8),
                   (try_begin),
                     (eq, "$tutorial_2_msg_8_displayed", 0),
                     (assign, "$tutorial_2_msg_8_displayed", 1),
                     (tutorial_message, "str_tutorial_2_msg_8"),
                     (play_sound, "snd_tutorial_1"),
                     (get_player_agent_no, ":player_agent"),
                     (agent_set_hit_points, ":player_agent", 100),
                   (try_end),
                   (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
                   (assign, ":cur_agent", reg0),
                   (neg|agent_is_alive, ":cur_agent"),
                   (val_add, "$tutorial_2_state", 1),
                 (else_try),
                   (eq, "$tutorial_2_state", 9),
                   (eq, "$tutorial_2_msg_9_displayed", 0),
                   (assign, "$tutorial_2_msg_9_displayed", 1),
                   (tutorial_message, "str_tutorial_2_msg_9"),
                   (play_sound, "snd_tutorial_2"),
                   (assign, "$tutorial_2_finished", 1),
                 (else_try),
                   (gt, "$tutorial_2_state", 30),
                   (tutorial_message, "str_tutorial_failed"),
                 (try_end),
                 ], []),
    ],
  ),

  (
    "tutorial_3",mtf_arena_fight,-1,
    "You enter the training ground.",
    [
        (0,mtef_leader_only|mtef_team_0,af_override_everything,0,1,["itm_leather_tunic1", "itm_leather_boots1"]),
        (3,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
        (5,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
     ],
    [
      (ti_tab_pressed, 0, 0, [],
       [(try_begin),
         (lt, "$tutorial_3_state", 12),
         (question_box,"str_do_you_wish_to_leave_tutorial"),
        (else_try),
          (finish_mission,0),
        (try_end),
        ]),
      (ti_question_answered, 0, 0, [],
       [(store_trigger_param_1,":answer"),
        (eq,":answer",0),
        (finish_mission,0),
        ]),
      (ti_inventory_key_pressed, 0, 0, [(display_message,"str_cant_use_inventory_tutorial")], []),

      (0, 0, ti_once, [
          (store_mission_timer_a, ":cur_time"),
          (gt, ":cur_time", 2),
          (main_hero_fallen),
          (assign, "$tutorial_3_state", 100),
        ], []),

      (0, 0, ti_once, [
      	               (tutorial_message_set_size, 17, 17),
	                   (tutorial_message_set_position, 500, 650),
                       (tutorial_message_set_center_justify, 0),

                       (assign, "$tutorial_3_state", 0),
                       (assign, "$tutorial_3_msg_1_displayed", 0),
                       (assign, "$tutorial_3_msg_2_displayed", 0),
                       (assign, "$tutorial_3_msg_3_displayed", 0),
                       (assign, "$tutorial_3_msg_4_displayed", 0),
                       (assign, "$tutorial_3_msg_5_displayed", 0),
                       (assign, "$tutorial_3_msg_6_displayed", 0),
                       ], []),

      (0, 0, 0, [(try_begin),
                   (eq, "$tutorial_3_state", 0),
                   (try_begin),
                     (eq, "$tutorial_3_msg_1_displayed", 0),
                     (store_mission_timer_a, ":cur_time"),
                     (gt, ":cur_time", 0),
                     (assign, "$tutorial_3_msg_1_displayed", 1),
                     (tutorial_message, "str_tutorial_3_msg_1"),
                     (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
                     (assign, ":cur_agent", reg0),
                     (agent_get_position, pos1, ":cur_agent"),
                     (agent_set_scripted_destination, ":cur_agent", pos1, 0),
                     (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
                     (assign, ":cur_agent", reg0),
                     (agent_get_position, pos1, ":cur_agent"),
                     (agent_set_scripted_destination, ":cur_agent", pos1, 0),
                     (entry_point_get_position, pos1, 1),
                     (set_spawn_position, pos1),
                     (spawn_item, "itm_tutorial_staff_no_attack"),
                   (try_end),
                   (get_player_agent_no, ":player_agent"),
                   (ge, ":player_agent", 0),
                   (agent_has_item_equipped, ":player_agent", "itm_tutorial_staff_no_attack"),
                   (val_add, "$tutorial_3_state", 1),
                 (else_try),
                   (eq, "$tutorial_3_state", 1),
                   (try_begin),
                     (eq, "$tutorial_3_msg_2_displayed", 0),
                     (assign, "$tutorial_3_msg_2_displayed", 1),
                     (tutorial_message, "str_tutorial_3_msg_2"),
                     (play_sound, "snd_tutorial_1"),
                   (try_end),
                   (get_player_agent_no, ":player_agent"),
                   (agent_get_position, pos1, ":player_agent"),
                   (entry_point_get_position,pos2,2),
                   (get_distance_between_positions, ":cur_distance", pos1, pos2),
                   (le, ":cur_distance", 200),
                   (scene_prop_get_instance, ":door_object", "spr_tutorial_door_b", 0),
                   (prop_instance_get_position, pos1, ":door_object"),
                   (position_rotate_z, pos1, -90),
                   (prop_instance_animate_to_position, ":door_object", pos1, 150),
                   (val_add, "$tutorial_3_state", 1),
                 (else_try),
                   (eq, "$tutorial_3_state", 2),
                   (scene_prop_get_instance, ":barrier_object", "spr_barrier_4m", 0),
                   (prop_instance_get_position, pos1, ":barrier_object"),
                   (get_player_agent_no, ":player_agent"),
                   (agent_get_position, pos2, ":player_agent"),
                   (position_is_behind_position, pos2, pos1),
                   (scene_prop_get_instance, ":door_object", "spr_tutorial_door_b", 0),
                   (prop_instance_get_position, pos1, ":door_object"),
                   (position_rotate_z, pos1, 90),
                   (prop_instance_animate_to_position, ":door_object", pos1, 150),
                   (val_add, "$tutorial_3_state", 1),
                 (else_try),
                   (eq, "$tutorial_3_state", 3),
                   (get_player_agent_no, ":player_agent"),
                   (agent_set_kick_allowed, ":player_agent", 0), #don't let player kick while defending
                   (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
                   (assign, ":cur_agent", reg0),
                   (entry_point_get_position, pos1, 4),
                   (agent_set_scripted_destination, ":cur_agent", pos1, 0),
                   (val_add, "$tutorial_3_state", 1),
                 (else_try),
                   (eq, "$tutorial_3_state", 4),
                   (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
                   (assign, ":cur_agent", reg0),
                   (entry_point_get_position, pos1, 4),
                   (agent_get_position, pos2, ":cur_agent"),
                   (get_distance_between_positions, ":cur_distance", pos1, pos2),
                   (le, ":cur_distance", 250),
                   (agent_clear_scripted_mode, ":cur_agent"),
                   (val_add, "$tutorial_3_state", 1),
                   (store_mission_timer_a,"$tutorial_time"),
                 (else_try),
                   (eq, "$tutorial_3_state", 5),
                   (try_begin),
                     (eq, "$tutorial_3_msg_3_displayed", 0),
                     (assign, "$tutorial_3_msg_3_displayed", 1),
                     (play_sound, "snd_tutorial_1"),
                   (try_end),
                   (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
                   (assign, ":cur_agent", reg0),
                   (store_mission_timer_a,":cur_time"),
                   (val_sub, ":cur_time", "$tutorial_time"),
                   (store_sub, reg3, 20, ":cur_time"),
                   (tutorial_message, "str_tutorial_3_msg_3"),
                   (gt, ":cur_time", 20),
                   (entry_point_get_position, pos1, 4),
                   (agent_set_scripted_destination, ":cur_agent", pos1, 0),
                   (val_add, "$tutorial_3_state", 1),
                 (else_try),
                   (eq, "$tutorial_3_state", 6),
                   (try_begin),
                     (eq, "$tutorial_3_msg_4_displayed", 0),
                     (assign, "$tutorial_3_msg_4_displayed", 1),
                     (tutorial_message, "str_tutorial_3_msg_4"),
                     (play_sound, "snd_tutorial_1"),
                   (try_end),
                   (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
                   (assign, ":cur_agent", reg0),
                   (entry_point_get_position, pos1, 4),
                   (agent_get_position, pos2, ":cur_agent"),
                   (get_distance_between_positions, ":cur_distance", pos1, pos2),
                   (le, ":cur_distance", 250),
                   (entry_point_get_position, pos1, 3),
                   (agent_set_scripted_destination, ":cur_agent", pos1, 0),
                   (val_add, "$tutorial_3_state", 1),
                 (else_try),
                   (eq, "$tutorial_3_state", 7),
                   (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
                   (assign, ":cur_agent", reg0),
                   (entry_point_get_position, pos1, 3),
                   (agent_get_position, pos2, ":cur_agent"),
                   (get_distance_between_positions, ":cur_distance", pos1, pos2),
                   (le, ":cur_distance", 250),
                   (entry_point_get_position, pos1, 7),
                   (agent_set_scripted_destination, ":cur_agent", pos1, 0),
                   (agent_set_position, ":cur_agent", pos1),
                   (scene_prop_get_instance, ":door_object", "spr_tutorial_door_b", 1),
                   (prop_instance_get_position, pos1, ":door_object"),
                   (position_rotate_z, pos1, -90),
                   (prop_instance_animate_to_position, ":door_object", pos1, 150),
                   (scene_prop_get_instance, ":door_object", "spr_tutorial_door_b", 3),
                   (prop_instance_get_position, pos1, ":door_object"),
                   (position_rotate_z, pos1, -90),
                   (prop_instance_animate_to_position, ":door_object", pos1, 150),
                   (val_add, "$tutorial_3_state", 1),
                 (else_try),
                   (eq, "$tutorial_3_state", 8),
                   (scene_prop_get_instance, ":barrier_object", "spr_barrier_4m", 1),
                   (prop_instance_get_position, pos1, ":barrier_object"),
                   (get_player_agent_no, ":player_agent"),
                   (agent_get_position, pos2, ":player_agent"),
                   (position_is_behind_position, pos2, pos1),
                   (scene_prop_get_instance, ":door_object", "spr_tutorial_door_b", 1),
                   (prop_instance_get_position, pos1, ":door_object"),
                   (position_rotate_z, pos1, 90),
                   (prop_instance_animate_to_position, ":door_object", pos1, 150),
                   (val_add, "$tutorial_3_state", 1),
                 (else_try),
                   (eq, "$tutorial_3_state", 9),
                   (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
                   (assign, ":cur_agent", reg0),
                   (entry_point_get_position, pos1, 6),
                   (agent_set_scripted_destination, ":cur_agent", pos1, 0),
                   (val_add, "$tutorial_3_state", 1),
                 (else_try),
                   (eq, "$tutorial_3_state", 10),
                   (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
                   (assign, ":cur_agent", reg0),
                   (entry_point_get_position, pos1, 6),
                   (agent_get_position, pos2, ":cur_agent"),
                   (get_distance_between_positions, ":cur_distance", pos1, pos2),
                   (le, ":cur_distance", 250),
                   (agent_clear_scripted_mode, ":cur_agent"),
                   (val_add, "$tutorial_3_state", 1),
                   (store_mission_timer_a,"$tutorial_time"),
                 (else_try),
                   (eq, "$tutorial_3_state", 11),
                   (try_begin),
                     (eq, "$tutorial_3_msg_5_displayed", 0),
                     (assign, "$tutorial_3_msg_5_displayed", 1),
                     (play_sound, "snd_tutorial_1"),
                   (try_end),
                   (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
                   (assign, ":cur_agent", reg0),
                   (store_mission_timer_a,":cur_time"),
                   (val_sub, ":cur_time", "$tutorial_time"),
                   (store_sub, reg3, 20, ":cur_time"),
                   (tutorial_message, "str_tutorial_3_msg_5"),
                   (gt, ":cur_time", 20),
                   (entry_point_get_position, pos1, 6),
                   (agent_set_scripted_destination, ":cur_agent", pos1, 0),
                   (val_add, "$tutorial_3_state", 1),
                 (else_try),
                   (eq, "$tutorial_3_state", 12),
                   (try_begin),
                     (eq, "$tutorial_3_msg_6_displayed", 0),
                     (assign, "$tutorial_3_msg_6_displayed", 1),
                     (tutorial_message, "str_tutorial_3_msg_6"),
                     (play_sound, "snd_tutorial_1"),
                   (try_end),
                   (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
                   (assign, ":cur_agent", reg0),
                   (entry_point_get_position, pos1, 6),
                   (agent_get_position, pos2, ":cur_agent"),
                   (get_distance_between_positions, ":cur_distance", pos1, pos2),
                   (le, ":cur_distance", 250),
                   (entry_point_get_position, pos1, 5),
                   (agent_set_scripted_destination, ":cur_agent", pos1, 0),
                   (val_add, "$tutorial_3_state", 1),
                 (else_try),
                   (eq, "$tutorial_3_state", 13),
                   (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
                   (assign, ":cur_agent", reg0),
                   (entry_point_get_position, pos1, 5),
                   (agent_get_position, pos2, ":cur_agent"),
                   (get_distance_between_positions, ":cur_distance", pos1, pos2),
                   (le, ":cur_distance", 250),
                   (entry_point_get_position, pos1, 7),
                   (agent_set_scripted_destination, ":cur_agent", pos1, 0),
                   (agent_set_position, ":cur_agent", pos1),
                   (val_add, "$tutorial_3_state", 1),
                 (else_try),
                   (gt, "$tutorial_3_state", 30),
                   (tutorial_message, "str_tutorial_failed"),
                 (try_end),
                 ], []),
    ],
  ),

  (
    "tutorial_3_2",mtf_arena_fight,-1,
    "You enter the training ground.",
    [
        (0,mtef_leader_only|mtef_team_0,af_override_everything,0,1,["itm_tutorial_staff", "itm_leather_tunic1", "itm_leather_boots1"]), 
        (4,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
        (6,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
     ],
    [
      (ti_tab_pressed, 0, 0, [],
       [(try_begin),
         (lt, "$tutorial_3_state", 5),
         (question_box,"str_do_you_wish_to_leave_tutorial"),
        (else_try),
          (finish_mission,0),
        (try_end),
        ]),
      (ti_question_answered, 0, 0, [],
       [(store_trigger_param_1,":answer"),
        (eq,":answer",0),
        (finish_mission,0),
        ]),
      (ti_inventory_key_pressed, 0, 0, [(display_message,"str_cant_use_inventory_tutorial")], []),

      (0, 0, ti_once, [
          (store_mission_timer_a, ":cur_time"),
          (gt, ":cur_time", 2),
          (main_hero_fallen),
          (assign, "$tutorial_3_state", 100),
        ], []),


      (0, 0, ti_once, [
      	               (tutorial_message_set_size, 17, 17),
	                   (tutorial_message_set_position, 500, 650),
                       (tutorial_message_set_center_justify, 0),

                       (assign, "$tutorial_3_state", 0),
                       (assign, "$tutorial_3_msg_1_displayed", 0),
                       (assign, "$tutorial_3_msg_2_displayed", 0),
                       (assign, "$tutorial_3_msg_3_displayed", 0),
                       (assign, "$tutorial_3_msg_4_displayed", 0),
                       (assign, "$tutorial_3_msg_5_displayed", 0),
                       ], []),

      (0, 0, 0, [(try_begin),
                   (eq, "$tutorial_3_state", 0),
                   (try_begin),
                     (eq, "$tutorial_3_msg_1_displayed", 0),
                     (store_mission_timer_a, ":cur_time"),
                     (gt, ":cur_time", 0),
                     (assign, "$tutorial_3_msg_1_displayed", 1),
                     (tutorial_message, "str_tutorial_3_2_msg_1"),
                     (play_sound, "snd_tutorial_1"),
                     (call_script, "script_cf_get_first_agent_with_troop_id","trp_tutorial_maceman"),
                     (assign, ":cur_agent", reg0),
                     (agent_get_position, pos1, ":cur_agent"),
                     (agent_set_scripted_destination, ":cur_agent", pos1, 0),
                     (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
                     (assign, ":cur_agent", reg0),
                     (agent_get_position, pos1, ":cur_agent"),
                     (agent_set_scripted_destination, ":cur_agent", pos1, 0),
                   (try_end),
                   (get_player_agent_no, ":player_agent"),
                   (agent_get_position, pos1, ":player_agent"),
                   (entry_point_get_position,pos2,2),
                   (get_distance_between_positions, ":cur_distance", pos1, pos2),
                   (le, ":cur_distance", 200),
                   (scene_prop_get_instance, ":door_object", "spr_tutorial_door_b", 0),
                   (prop_instance_get_position, pos1, ":door_object"),
                   (position_rotate_z, pos1, -90),
                   (prop_instance_animate_to_position, ":door_object", pos1, 150),
                   (val_add, "$tutorial_3_state", 1),
                 (else_try),
                   (eq, "$tutorial_3_state", 1),
                   (try_begin),
                     (eq, "$tutorial_3_msg_2_displayed", 0),
                     (assign, "$tutorial_3_msg_2_displayed", 1),
                     (tutorial_message, "str_tutorial_3_2_msg_2"),
                     (play_sound, "snd_tutorial_1"),
                   (try_end),
                   (scene_prop_get_instance, ":barrier_object", "spr_barrier_4m", 0),
                   (prop_instance_get_position, pos1, ":barrier_object"),
                   (get_player_agent_no, ":player_agent"),
                   (agent_get_position, pos2, ":player_agent"),
                   (position_is_behind_position, pos2, pos1),
                   (scene_prop_get_instance, ":door_object", "spr_tutorial_door_b", 0),
                   (prop_instance_get_position, pos1, ":door_object"),
                   (position_rotate_z, pos1, 90),
                   (prop_instance_animate_to_position, ":door_object", pos1, 150),
                   (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
                   (agent_clear_scripted_mode, reg0),
                   (val_add, "$tutorial_3_state", 1),
                 (else_try),
                   (eq, "$tutorial_3_state", 2),
                   (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
                   (neg|agent_is_alive, reg0),
                   (scene_prop_get_instance, ":door_object", "spr_tutorial_door_b", 1),
                   (prop_instance_get_position, pos1, ":door_object"),
                   (position_rotate_z, pos1, -90),
                   (prop_instance_animate_to_position, ":door_object", pos1, 150),
                   (scene_prop_get_instance, ":door_object", "spr_tutorial_door_b", 3),
                   (prop_instance_get_position, pos1, ":door_object"),
                   (position_rotate_z, pos1, -90),
                   (prop_instance_animate_to_position, ":door_object", pos1, 150),
                   (val_add, "$tutorial_3_state", 1),
                 (else_try),
                   (eq, "$tutorial_3_state", 3),
                   (try_begin),
                     (eq, "$tutorial_3_msg_3_displayed", 0),
                     (assign, "$tutorial_3_msg_3_displayed", 1),
                     (tutorial_message, "str_tutorial_3_2_msg_3"),
                     (play_sound, "snd_tutorial_1"),
                   (try_end),                 
                   (scene_prop_get_instance, ":barrier_object", "spr_barrier_4m", 1),
                   (prop_instance_get_position, pos1, ":barrier_object"),
                   (get_player_agent_no, ":player_agent"),
                   (agent_get_position, pos2, ":player_agent"),
                   (position_is_behind_position, pos2, pos1),
                   (scene_prop_get_instance, ":door_object", "spr_tutorial_door_b", 1),
                   (prop_instance_get_position, pos1, ":door_object"),
                   (position_rotate_z, pos1, 90),
                   (prop_instance_animate_to_position, ":door_object", pos1, 150),
                   (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
                   (agent_clear_scripted_mode, reg0),
                   (val_add, "$tutorial_3_state", 1),
                 (else_try),
                   (eq, "$tutorial_3_state", 4),
                   (try_begin),
                     (eq, "$tutorial_3_msg_4_displayed", 0),
                     (assign, "$tutorial_3_msg_4_displayed", 1),
                     (tutorial_message, "str_tutorial_3_2_msg_4"),
                     (play_sound, "snd_tutorial_1"),
                   (try_end),
                   (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
                   (neg|agent_is_alive, reg0),
                   (val_add, "$tutorial_3_state", 1),
                 (else_try),
                   (eq, "$tutorial_3_state", 5),
                   (eq, "$tutorial_3_msg_5_displayed", 0),
                   (assign, "$tutorial_3_msg_5_displayed", 1),
                   (tutorial_message, "str_tutorial_3_2_msg_5"),
                   (play_sound, "snd_tutorial_2"),
                   (assign, "$tutorial_3_finished", 1),
                 (else_try),
                   (gt, "$tutorial_3_state", 30),
                   (tutorial_message, "str_tutorial_failed"),
                 (try_end),
                 ], []),

      
    ],
  ),

  (
    "tutorial_4",mtf_arena_fight,-1,
    "You enter the training ground.",
    [
        (0,mtef_leader_only|mtef_team_0,af_override_everything,0,1,["itm_tutorial_sword", "itm_tutorial_short_bow", "itm_tutorial_arrows", "itm_leather_tunic1", "itm_leather_boots1"]), #af_override_weapons
     ],
    [
      (ti_tab_pressed, 0, 0, [],
       [(try_begin),
         (lt, "$tutorial_4_state", 11),
         (question_box,"str_do_you_wish_to_leave_tutorial"),
        (else_try),
          (finish_mission,0),
        (try_end),
        ]),
      (ti_question_answered, 0, 0, [],
       [(store_trigger_param_1,":answer"),
        (eq,":answer",0),
        (finish_mission,0),
        ]),
      (ti_inventory_key_pressed, 0, 0, [(display_message,"str_cant_use_inventory_tutorial")], []),

      (ti_before_mission_start, 0, 0, [],
       [
         (scene_set_day_time, 13),
         ]),

      (0, 0, ti_once, [
      	               (tutorial_message_set_size, 17, 17),
	                   (tutorial_message_set_position, 500, 650),
                       (tutorial_message_set_center_justify, 0),

                       (assign, "$tutorial_4_state", 0),
                       (assign, "$tutorial_4_msg_1_displayed", 0),
                       (assign, "$tutorial_4_msg_2_displayed", 0),
                       (assign, "$tutorial_4_msg_3_displayed", 0),
                       (assign, "$tutorial_4_msg_4_displayed", 0),
                       (assign, "$tutorial_4_msg_5_displayed", 0),
                       (assign, "$tutorial_4_msg_6_displayed", 0),
                       (assign, "$tutorial_4_msg_7_displayed", 0),
                       ], []),

      (0, 0, 0, [(try_begin),
                   (eq, "$tutorial_4_state", 0),
                   (try_begin),
                     (eq, "$tutorial_4_msg_1_displayed", 0),
                     (store_mission_timer_a, ":cur_time"),
                     (gt, ":cur_time", 0),
                     (assign, "$tutorial_4_msg_1_displayed", 1),
                     (tutorial_message, "str_tutorial_4_msg_1"),
                     (entry_point_get_position, pos1, 1),
                     (set_spawn_position, 1),
                     (spawn_horse, "itm_tutorial_saddle_horse"),
                     (assign, "$tutorial_num_total_dummies_destroyed", 0),
                   (try_end),
                   (get_player_agent_no, ":player_agent"),
                   (agent_get_horse, ":horse_agent", ":player_agent"),
                   (ge, ":horse_agent", 0),
                   (val_add, "$tutorial_4_state", 1),
                   (entry_point_get_position, pos1, 2),
                   (scene_prop_get_instance, ":flag_object", "spr_tutorial_flag_yellow", 0),
                   (prop_instance_animate_to_position, ":flag_object", pos1, 1),
                 (else_try),
                   (eq, "$tutorial_4_state", 1),
                   (try_begin),
                     (eq, "$tutorial_4_msg_2_displayed", 0),
                     (assign, "$tutorial_4_msg_2_displayed", 1),
                     (tutorial_message, "str_tutorial_4_msg_2"),
                     (play_sound, "snd_tutorial_1"),
                   (try_end),
                   (get_player_agent_no, ":player_agent"),
                   (agent_get_position, pos1, ":player_agent"),
                   (entry_point_get_position, pos2, 2),
                   (get_distance_between_positions, ":cur_distance", pos1, pos2),
                   (le, ":cur_distance", 200),
                   (val_add, "$tutorial_4_state", 1),
                   (entry_point_get_position, pos1, 3),
                   (scene_prop_get_instance, ":flag_object", "spr_tutorial_flag_yellow", 0),
                   (prop_instance_animate_to_position, ":flag_object", pos1, 1),
                 (else_try),
                   (eq, "$tutorial_4_state", 2),
                   (get_player_agent_no, ":player_agent"),
                   (agent_get_position, pos1, ":player_agent"),
                   (entry_point_get_position, pos2, 3),
                   (get_distance_between_positions, ":cur_distance", pos1, pos2),
                   (le, ":cur_distance", 200),
                   (val_add, "$tutorial_4_state", 1),
                   (entry_point_get_position, pos1, 4),
                   (scene_prop_get_instance, ":flag_object", "spr_tutorial_flag_yellow", 0),
                   (prop_instance_animate_to_position, ":flag_object", pos1, 1),
                 (else_try),
                   (eq, "$tutorial_4_state", 3),
                   (get_player_agent_no, ":player_agent"),
                   (agent_get_position, pos1, ":player_agent"),
                   (entry_point_get_position, pos2, 4),
                   (get_distance_between_positions, ":cur_distance", pos1, pos2),
                   (le, ":cur_distance", 200),
                   (val_add, "$tutorial_4_state", 1),
                   (entry_point_get_position, pos1, 5),
                   (scene_prop_get_instance, ":flag_object", "spr_tutorial_flag_yellow", 0),
                   (prop_instance_animate_to_position, ":flag_object", pos1, 1),
                 (else_try),
                   (eq, "$tutorial_4_state", 4),
                   (get_player_agent_no, ":player_agent"),
                   (agent_get_position, pos1, ":player_agent"),
                   (entry_point_get_position, pos2, 5),
                   (get_distance_between_positions, ":cur_distance", pos1, pos2),
                   (le, ":cur_distance", 200),
                   (val_add, "$tutorial_4_state", 1),
                   (entry_point_get_position, pos1, 6),
                   (scene_prop_get_instance, ":flag_object", "spr_tutorial_flag_yellow", 0),
                   (prop_instance_animate_to_position, ":flag_object", pos1, 1),
                 (else_try),
                   (eq, "$tutorial_4_state", 5),
                   (get_player_agent_no, ":player_agent"),
                   (agent_get_position, pos1, ":player_agent"),
                   (entry_point_get_position, pos2, 6),
                   (get_distance_between_positions, ":cur_distance", pos1, pos2),
                   (le, ":cur_distance", 200),
                   (val_add, "$tutorial_4_state", 1),
                   (entry_point_get_position, pos1, 1),
                   (scene_prop_get_instance, ":flag_object", "spr_tutorial_flag_yellow", 0),
                   (prop_instance_animate_to_position, ":flag_object", pos1, 1),
                 (else_try),
                   (eq, "$tutorial_4_state", 6),
                   (get_player_agent_no, ":player_agent"),
                   (agent_get_position, pos1, ":player_agent"),
                   (entry_point_get_position, pos2, 1),
                   (get_distance_between_positions, ":cur_distance", pos1, pos2),
                   (le, ":cur_distance", 200),
                   (val_add, "$tutorial_4_state", 1),
                   (entry_point_get_position, pos1, 7),
                   (scene_prop_get_instance, ":flag_object", "spr_tutorial_flag_yellow", 0),
                   (prop_instance_animate_to_position, ":flag_object", pos1, 1),
                 (else_try),
                   (eq, "$tutorial_4_state", 7),
                   (try_begin),
                     (eq, "$tutorial_4_msg_3_displayed", 0),
                     (assign, "$tutorial_4_msg_3_displayed", 1),
                     (tutorial_message, "str_tutorial_4_msg_3"),
                     (play_sound, "snd_tutorial_1"),
                   (try_end),
                   (get_player_agent_no, ":player_agent"),
                   (agent_get_position, pos1, ":player_agent"),
                   (entry_point_get_position, pos2, 7),
                   (get_distance_between_positions, ":cur_distance", pos1, pos2),
                   (le, ":cur_distance", 200),
                   (val_add, "$tutorial_4_state", 1),
                   (entry_point_get_position, pos1, 20),
                   (scene_prop_get_instance, ":flag_object", "spr_tutorial_flag_yellow", 0),
                   (prop_instance_animate_to_position, ":flag_object", pos1, 1),
                 (else_try),
                   (eq, "$tutorial_4_state", 8),
                   (try_begin),
                     (eq, "$tutorial_4_msg_4_displayed", 0),
                     (assign, "$tutorial_4_msg_4_displayed", 1),
                     (tutorial_message, "str_tutorial_4_msg_4"),
                     (play_sound, "snd_tutorial_1"),
                   (try_end),
                   (ge, "$tutorial_num_total_dummies_destroyed", 2),
                   (val_add, "$tutorial_4_state", 1),
                   (entry_point_get_position, pos1, 8),
                   (scene_prop_get_instance, ":flag_object", "spr_tutorial_flag_yellow", 0),
                   (prop_instance_animate_to_position, ":flag_object", pos1, 1),
                 (else_try),
                   (eq, "$tutorial_4_state", 9),
                   (try_begin),
                     (eq, "$tutorial_4_msg_5_displayed", 0),
                     (assign, "$tutorial_4_msg_5_displayed", 1),
                     (tutorial_message, "str_tutorial_4_msg_5"),
                     (play_sound, "snd_tutorial_1"),
                   (try_end),
                   (get_player_agent_no, ":player_agent"),
                   (agent_get_position, pos1, ":player_agent"),
                   (entry_point_get_position, pos2, 8),
                   (get_distance_between_positions, ":cur_distance", pos1, pos2),
                   (le, ":cur_distance", 200),
                   (val_add, "$tutorial_4_state", 1),
                   (entry_point_get_position, pos1, 20),
                   (scene_prop_get_instance, ":flag_object", "spr_tutorial_flag_yellow", 0),
                   (prop_instance_animate_to_position, ":flag_object", pos1, 1),
                 (else_try),
                   (eq, "$tutorial_4_state", 10),
                   (try_begin),
                     (eq, "$tutorial_4_msg_6_displayed", 0),
                     (assign, "$tutorial_4_msg_6_displayed", 1),
                     (tutorial_message, "str_tutorial_4_msg_6"),
                     (play_sound, "snd_tutorial_1"),
                     (assign, "$g_last_archery_point_earned", 0),
                     (assign, "$tutorial_num_arrows_hit", 0),
                   (try_end),
                   (try_begin),
                     (get_player_agent_no, ":player_agent"),
                     (agent_get_ammo, ":cur_ammo", ":player_agent"),
                     (le, ":cur_ammo", 0),
                     (agent_refill_ammo, ":player_agent"),
                     (tutorial_message, "str_tutorial_ammo_refilled"),
                   (try_end),
                   (gt, "$g_last_archery_point_earned", 0),
                   (assign, "$g_last_archery_point_earned", 0),
                   (val_add, "$tutorial_num_arrows_hit", 1),
                   (gt, "$tutorial_num_arrows_hit", 2),
                   (val_add, "$tutorial_4_state", 1),
                 (else_try),
                   (eq, "$tutorial_4_state", 11),
                   (eq, "$tutorial_4_msg_7_displayed", 0),
                   (assign, "$tutorial_4_msg_7_displayed", 1),
                   (tutorial_message, "str_tutorial_4_msg_7"),
                   (play_sound, "snd_tutorial_2"),
                   (assign, "$tutorial_4_finished", 1),
                 (try_end),
                 ], []),
    ],
  ),

  (
    "tutorial_5",mtf_arena_fight,-1,
    "You enter the training ground.",
    [
        (0,mtef_visitor_source|mtef_team_0,af_override_everything,0,1,["itm_tutorial_sword", "itm_tutorial_shield", "itm_tutorial_short_bow", "itm_tutorial_arrows", "itm_tutorial_saddle_horse", "itm_leather_tunic1", "itm_shoes1"]), #cambiado chief
        (1,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
        (2,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
        (3,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
        (4,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
        (8,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
        (9,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
        (10,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
        (13,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
        (14,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
        (15,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
        (16,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     ],
    [
      (ti_tab_pressed, 0, 0, [],
       [(try_begin),
         (lt, "$tutorial_5_state", 5),
         (question_box,"str_do_you_wish_to_leave_tutorial"),
        (else_try),
          (finish_mission,0),
        (try_end),
        ]),
      (ti_question_answered, 0, 0, [],
       [(store_trigger_param_1,":answer"),
        (eq,":answer",0),
        (finish_mission,0),
        ]),
      (ti_inventory_key_pressed, 0, 0, [(display_message,"str_cant_use_inventory_tutorial")], []),


      (0, 0, ti_once, [
          (store_mission_timer_a, ":cur_time"),
          (gt, ":cur_time", 2),
          (main_hero_fallen),
          (assign, "$tutorial_5_state", 100),
        ], []),

      (0, 0, ti_once, [
      	               (tutorial_message_set_size, 17, 17),
	                   (tutorial_message_set_position, 500, 650),
                       (tutorial_message_set_center_justify, 0),

                       (assign, "$tutorial_5_state", 0),
                       (assign, "$tutorial_5_msg_1_displayed", 0),
                       (assign, "$tutorial_5_msg_2_displayed", 0),
                       (assign, "$tutorial_5_msg_3_displayed", 0),
                       (assign, "$tutorial_5_msg_4_displayed", 0),
                       (assign, "$tutorial_5_msg_5_displayed", 0),
                       (assign, "$tutorial_5_msg_6_displayed", 0),
                       ], []),

      (0, 0, ti_once, [(set_show_messages, 0),
                       (team_give_order, 0, grc_everyone, mordr_stand_ground),
                       (set_show_messages, 1),
                       (store_mission_timer_a, ":cur_time"),
                       (gt, ":cur_time", 3),
                       ], []),

      (0, 0, 0, [(call_script, "script_cf_turn_windmill_fans", 0)], []),
      
      (0, 0, 0, [(try_begin),
                   (eq, "$tutorial_5_state", 0),
                   (try_begin),
                     (eq, "$tutorial_5_msg_1_displayed", 0),
                     (store_mission_timer_a, ":cur_time"),
                     (gt, ":cur_time", 0),
                     (assign, "$tutorial_5_msg_1_displayed", 1),
                     (tutorial_message, "str_tutorial_5_msg_1"),
                     (entry_point_get_position, pos1, 5),
                     (scene_prop_get_instance, ":flag_object", "spr_tutorial_flag_yellow", 0),
                     (prop_instance_animate_to_position, ":flag_object", pos1, 1),
                   (try_end),
                   (call_script, "script_cf_team_get_average_position_of_agents_with_type_to_pos1", 0, grc_infantry),
                   (entry_point_get_position, pos2, 5),
                   (get_distance_between_positions, ":cur_distance", pos1, pos2),
                   (le, ":cur_distance", 1000),
                   (val_add, "$tutorial_5_state", 1),
                   (entry_point_get_position, pos1, 6),
                   (scene_prop_get_instance, ":flag_object", "spr_tutorial_flag_red", 0),
                   (prop_instance_animate_to_position, ":flag_object", pos1, 1),
                 (else_try),
                   (eq, "$tutorial_5_state", 1),
                   (try_begin),
                     (eq, "$tutorial_5_msg_2_displayed", 0),
                     (assign, "$tutorial_5_msg_2_displayed", 1),
                     (tutorial_message, "str_tutorial_5_msg_2"),
                     (play_sound, "snd_tutorial_1"),
                   (try_end),
                   (call_script, "script_cf_team_get_average_position_of_agents_with_type_to_pos1", 0, grc_infantry),
                   (entry_point_get_position, pos2, 5),
                   (get_distance_between_positions, ":cur_distance", pos1, pos2),
                   (le, ":cur_distance", 1000),
                   (get_player_agent_no, ":player_agent"),
                   (agent_get_position, pos1, ":player_agent"),
                   (entry_point_get_position, pos2, 6),
                   (get_distance_between_positions, ":cur_distance", pos1, pos2),
                   (le, ":cur_distance", 500),
                   (val_add, "$tutorial_5_state", 1),
                   (entry_point_get_position, pos1, 7),
                   (scene_prop_get_instance, ":flag_object", "spr_tutorial_flag_yellow", 0),
                   (prop_instance_animate_to_position, ":flag_object", pos1, 1),
                   (entry_point_get_position, pos1, 30),
                   (scene_prop_get_instance, ":flag_object", "spr_tutorial_flag_red", 0),
                   (prop_instance_animate_to_position, ":flag_object", pos1, 1),
                 (else_try),
                   (eq, "$tutorial_5_state", 2),
                   (try_begin),
                     (eq, "$tutorial_5_msg_3_displayed", 0),
                     (assign, "$tutorial_5_msg_3_displayed", 1),
                     (tutorial_message, "str_tutorial_5_msg_3"),
                     (play_sound, "snd_tutorial_1"),
                   (try_end),
                   (get_player_agent_no, ":player_agent"),
                   (agent_get_position, pos1, ":player_agent"),
                   (entry_point_get_position, pos2, 7),
                   (get_distance_between_positions, ":cur_distance", pos1, pos2),
                   (le, ":cur_distance", 500),
                   (val_add, "$tutorial_5_state", 1),
                   (modify_visitors_at_site,"scn_tutorial_5"),
                   (reset_visitors),
                   (set_visitor,5,"trp_saxon_infantryt4"),
                   (set_visitor,6,"trp_saxon_infantryt4"),
                   (set_visitor,7,"trp_saxon_infantryt4"),
                   (entry_point_get_position, pos1, 11),
                   (scene_prop_get_instance, ":flag_object", "spr_tutorial_flag_yellow", 0),
                   (prop_instance_animate_to_position, ":flag_object", pos1, 1),
                   (entry_point_get_position, pos1, 12),
                   (scene_prop_get_instance, ":flag_object", "spr_tutorial_flag_red", 0),
                   (prop_instance_animate_to_position, ":flag_object", pos1, 1),
                   (set_show_messages, 0),
                   (team_give_order, 0, grc_archers, mordr_stand_ground),
                   (set_show_messages, 1),
                 (else_try),
                   (eq, "$tutorial_5_state", 3),
                   (try_begin),
                     (eq, "$tutorial_5_msg_4_displayed", 0),
                     (assign, "$tutorial_5_msg_4_displayed", 1),
                     (tutorial_message, "str_tutorial_5_msg_4"),
                     (play_sound, "snd_tutorial_1"),
                   (try_end),
                   (call_script, "script_cf_team_get_average_position_of_agents_with_type_to_pos1", 0, grc_archers),
                   (entry_point_get_position, pos2, 11),
                   (get_distance_between_positions, ":cur_distance", pos1, pos2),
                   (le, ":cur_distance", 1000),
                   (call_script, "script_cf_team_get_average_position_of_agents_with_type_to_pos1", 0, grc_infantry),
                   (entry_point_get_position, pos2, 12),
                   (get_distance_between_positions, ":cur_distance", pos1, pos2),
                   (le, ":cur_distance", 1000),
                   (val_add, "$tutorial_5_state", 1),
                   (entry_point_get_position, pos1, 30),
                   (scene_prop_get_instance, ":flag_object", "spr_tutorial_flag_yellow", 0),
                   (prop_instance_animate_to_position, ":flag_object", pos1, 1),
                   (scene_prop_get_instance, ":flag_object", "spr_tutorial_flag_red", 0),
                   (prop_instance_animate_to_position, ":flag_object", pos1, 1),
                   (modify_visitors_at_site,"scn_tutorial_5"),
                   (reset_visitors),
                   (set_visitor,8,"trp_bandit"),
                   (set_visitor,9,"trp_bandit"),
                   (set_visitor,10,"trp_bandit"),
                   (set_visitor,11,"trp_bandit"),
                   (team_give_order, 1, grc_everyone, mordr_charge),
                 (else_try),
                   (eq, "$tutorial_5_state", 4),
                   (try_begin),
                     (eq, "$tutorial_5_msg_5_displayed", 0),
                     (assign, "$tutorial_5_msg_5_displayed", 1),
                     (tutorial_message, "str_tutorial_5_msg_5"),
                     (play_sound, "snd_tutorial_1"),
                   (try_end),
                   (assign, ":enemy_count", 0),
                   (try_for_agents, ":cur_agent"),
                     (agent_is_human, ":cur_agent"),
                     (agent_is_alive, ":cur_agent"),
                     (agent_get_team, ":cur_team", ":cur_agent"),
                     (eq, ":cur_team", 1),
                     (val_add, ":enemy_count", 1),
                   (try_end),
                   (eq, ":enemy_count", 0),
                   (val_add, "$tutorial_5_state", 1),
                 (else_try),
                   (eq, "$tutorial_5_state", 5),
                   (eq, "$tutorial_5_msg_6_displayed", 0),
                   (assign, "$tutorial_5_msg_6_displayed", 1),
                   (tutorial_message, "str_tutorial_5_msg_6"),
                   (play_sound, "snd_tutorial_2"),
                   (assign, "$tutorial_5_finished", 1),
                 (else_try),
                   (gt, "$tutorial_5_state", 30),
                   (tutorial_message, "str_tutorial_failed"),
                   (entry_point_get_position, pos1, 30),
                   (scene_prop_get_instance, ":flag_object", "spr_tutorial_flag_yellow", 0),
                   (prop_instance_animate_to_position, ":flag_object", pos1, 1),
                   (scene_prop_get_instance, ":flag_object", "spr_tutorial_flag_red", 0),
                   (prop_instance_animate_to_position, ":flag_object", pos1, 1),
                 (try_end),
                 ], []),
    ],
  ),

  (
    "quick_battle_battle",mtf_battle_mode,-1,
    "You lead your men to battle.",
    [
      (0,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (1,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (2,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (3,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (4,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (5,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (6,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (7,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),

      (8,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (9,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (10,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (11,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (12,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (13,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (14,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (15,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),

      (16,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
      (17,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
      (18,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
      (19,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
      (20,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
      (21,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
      (22,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
      (23,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),

      (24,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
      (25,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
      (26,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
      (27,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
      (28,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
      (29,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
      (30,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
      (31,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
     ], common_weapon_check + common_ai_order_toggle +
    [
      common_custom_battle_tab_press,
      common_custom_battle_question_answered,
      common_inventory_not_available,

      (ti_before_mission_start, 0, 0, [],
       [
         (scene_set_day_time, 15),
         ]),
      (ti_before_mission_start, 0, 0, [],
        [
          (scene_set_day_time, 15),
          
          # Reassign divisions MOTO chief
          (try_for_range, ":troop_no", soldiers_begin, soldiers_end),
            (call_script, "script_troop_default_division", ":troop_no", 1), # Flag to pick one of three types to match custom battle parameters
            (troop_get_class, ":division", ":troop_no"),
            (neq, ":division", reg0),
            (troop_set_class, ":troop_no", reg0),
          (try_end),
      ]),
      common_battle_init_banner,
      
      (0, 0, ti_once, [],
        [
          (assign, "$g_battle_result", 0),
          (call_script, "script_combat_music_set_situation_with_culture"),
          (display_debug_message, "@calling quick battle scripts"),
          ##gdw testing this below
          #(call_script, "script_get_default_formation", "$fplayer_team_no"),
         # (call_script, "script_form_infantry", "$fplayer_team_no", ":division", "$fplayer_agent_no", ":div_spacing", ":first_member_is_player", ":fformation"),
   #       (call_script, "script_division_reset_places"),
			# (try_for_range, ":division", 0, 9),
			#     (class_is_listening_order, "$fplayer_team_no", ":division"),
			# 	(store_add, ":slot", "slot_team_d0_target_team", ":division"),
			# 	(team_set_slot, "$fplayer_team_no", ":slot", -1),
			# 	(store_add, ":slot", "slot_team_d0_size", ":division"),
			# 	(team_slot_ge, "$fplayer_team_no", ":slot", 1),
			# 	(store_add, ":slot", "slot_team_d0_fclock", ":division"),
			# 	(team_set_slot, "$fplayer_team_no", ":slot", 1),
			# 	(call_script, "script_player_attempt_formation", ":division", formation_ranks, 1),				
			# (try_end),
			# (eq, "$native_display", 1),
			# (start_presentation, "prsnt_order_display"),
        ]),

      common_music_situation_update,
      custom_battle_check_victory_condition,
      common_battle_victory_display,
      custom_battle_check_defeat_condition,
####below new gdw 72715
      common_battle_order_panel,
      common_battle_order_panel_tick,
    ] + AI_triggers + dplmc_battle_mode_triggers + formations_triggers + order_volley_triggers + rider_damage + warcry_chel+ flail_triggers,#+common_weapon_check + common_ai_order_toggle,
  ),
# Puesto encima chief diplomacy
  (
    "quick_battle_siege", mtf_battle_mode,-1,
    "You lead your men to battle.",
    [
      (0,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
      (1,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
      (2,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
      (3,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
      (4,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
      (5,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
      (6,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
      (7,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),

      (8,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
      (9,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
      (10,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
      (11,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
      (12,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
      (13,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
      (14,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
      (15,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),

      (16,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
      (17,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
      (18,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
      (19,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
      (20,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
      (21,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
      (22,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
      (23,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),

      (24,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
      (25,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
      (26,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
      (27,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
      (28,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
      (29,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
      (30,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
      (31,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),

      (32,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
      (33,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
      (34,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
      (35,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
      (36,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
      (37,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
      (38,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
      (39,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),

      (40,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
      (41,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
      (42,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
      (43,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
      (44,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
      (45,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
      (46,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
      (47,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
     ],
    [
      common_battle_mission_start,
      common_battle_init_banner,

      (0, 0, ti_once,
       [
         (assign, "$defender_team", 0),
         (assign, "$attacker_team", 1),
         (assign, "$defender_team_2", 2),
         (assign, "$attacker_team_2", 3),
         ], []),

      (ti_before_mission_start, 0, 0, [],
       [
         (scene_set_day_time, 15),
         ]),

      common_custom_battle_tab_press,
      common_custom_battle_question_answered,
      common_inventory_not_available,
      common_custom_siege_init,
      common_music_situation_update,
      custom_battle_check_victory_condition,
      common_battle_victory_display,
      custom_battle_check_defeat_condition,
      common_siege_attacker_do_not_stall,
      common_siege_refill_ammo,
      common_siege_init_ai_and_belfry,
      common_siege_move_belfry,
      common_siege_rotate_belfry,
      common_siege_assign_men_to_belfry,
      common_siege_ai_trigger_init_2,
      ]+ dplmc_battle_mode_triggers3,
    ),
##gdw this was commented out and not working
 (
   "quick_battle_siege_offense",mtf_battle_mode,-1,
   "You lead your men to battle.",
   [
     (0,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
     (1,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
     (2,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
     (3,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
     (4,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
     (5,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
     (6,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
     (7,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),

     (8,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
     (9,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
     (10,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),

     (11,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (12,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (13,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (14,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (15,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (40,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (41,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (42,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (43,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (44,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (45,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (46,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),
     (47,mtef_visitor_source|mtef_team_1,af_override_horse,aif_start_alarmed,1,[]),

    ],
   [
     common_custom_battle_tab_press,
     common_battle_init_banner,
     common_custom_battle_question_answered,
     common_custom_siege_init,
     common_inventory_not_available,
     common_music_situation_update,
     custom_battle_check_victory_condition,
     common_battle_victory_display,
     custom_battle_check_defeat_condition,
     
     (0, 0, ti_once,
      [
        (assign, "$defender_team", 0),
        (assign, "$attacker_team", 1),
        (assign, "$defender_team_2", 2),
        (assign, "$attacker_team_2", 3),
        ], []),

     common_siege_ai_trigger_init_2,
     common_siege_attacker_do_not_stall,
     common_siege_refill_ammo,
     common_siege_init_ai_and_belfry,
     common_siege_move_belfry,
     common_siege_rotate_belfry,
     common_siege_assign_men_to_belfry,
   ],
 ),

  (
	"bandit_lair",mtf_battle_mode|mtf_synch_inventory,charge,
    "Ambushing a bandit lair",
    [
      (0,mtef_team_0|mtef_use_exact_number,af_override_horse, aif_start_alarmed, 7,[]),
      (1,mtef_visitor_source|mtef_team_1,af_override_horse, aif_start_alarmed,20,[]),
      (2,mtef_visitor_source|mtef_team_1,af_override_horse, aif_start_alarmed,20,[]),
      (3,mtef_visitor_source|mtef_team_1,af_override_horse, aif_start_alarmed,20,[]),
      (4,mtef_visitor_source|mtef_team_1,af_override_horse, aif_start_alarmed,20,[]),
      (5,mtef_visitor_source|mtef_team_1,af_override_horse, aif_start_alarmed,20,[]),
      (6,mtef_visitor_source|mtef_team_1,af_override_horse, aif_start_alarmed,20,[]),
      (7,mtef_visitor_source|mtef_team_1,af_override_horse, aif_start_alarmed,20,[]),
      (8,mtef_visitor_source|mtef_team_1,af_override_horse, aif_start_alarmed,20,[]),
      (9,mtef_visitor_source|mtef_team_1,af_override_horse, aif_start_alarmed,20,[]),
      (10,mtef_visitor_source|mtef_team_1,af_override_horse, aif_start_alarmed,20,[]),
    ],
    [
      common_battle_init_banner,
    
      common_inventory_not_available,

      (ti_tab_pressed, 0, 0,
       [
        (display_message, "str_cannot_leave_now"),
       ], []),
     
      (1, 0, ti_once, [],
       [
        (assign, "$defender_reinforcement_stage", 0),
        (assign, "$bandits_spawned_extra", 0),
	   ]),
	   
	   (1, 0, 0, [],
	   [
        (try_for_agents, ":bandit_id"),
          (agent_is_alive, ":bandit_id"),          
          (agent_get_team, ":agent_team_1", ":bandit_id"),
          (eq, ":agent_team_1", 1),
          (agent_is_in_special_mode, ":bandit_id"),
          (agent_is_human, ":bandit_id"),
          
          (agent_get_position, pos0, ":bandit_id"),
          (try_for_agents, ":player_team_agent_id"),
            (agent_is_alive, ":player_team_agent_id"),
            (agent_get_team, ":agent_team_2", ":player_team_agent_id"),
            (eq, ":agent_team_2", 0),
            (agent_is_human, ":player_team_agent_id"),
                      
            (store_agent_hit_points, ":bandit_hit_points", ":bandit_id"),
            
            (assign, ":continue", 0),
            (try_begin),
              (lt, ":bandit_hit_points", 100),
                            
              (try_for_agents, ":bandit_2_id"),
                (agent_is_alive, ":bandit_2_id"),  
                (agent_get_team, ":bandit_2_team", ":bandit_2_id"),
                (eq, ":bandit_2_team", 1),
                (neq, ":bandit_id", ":bandit_2_id"),
                (agent_is_in_special_mode, ":bandit_2_id"),
                (agent_is_human, ":bandit_2_id"),
                
                (agent_get_position, pos1, ":bandit_id"),
                (agent_get_position, pos2, ":bandit_2_id"),                        
                (get_distance_between_positions, ":distance", pos1, pos2),
                (le, ":distance", 1000),

                (agent_clear_scripted_mode, ":bandit_2_id"),  
              (try_end),                             
              
              (assign, ":continue", 1),
            (else_try),  
              (agent_get_position, pos1, ":bandit_id"),
              (agent_get_position, pos2, ":player_team_agent_id"),                        
              (get_distance_between_positions, ":distance", pos1, pos2),                                                                        
              (le, ":distance", 4000),
              
              (try_for_agents, ":bandit_2_id"),
                (agent_is_alive, ":bandit_2_id"),  
                (agent_get_team, ":bandit_2_team", ":bandit_2_id"),
                (eq, ":bandit_2_team", 1),
                (neq, ":bandit_id", ":bandit_2_id"),
                (agent_is_in_special_mode, ":bandit_2_id"),
                (agent_is_human, ":bandit_2_id"),
                
                (agent_get_position, pos1, ":bandit_id"),
                (agent_get_position, pos2, ":bandit_2_id"),                        
                (get_distance_between_positions, ":distance", pos1, pos2),
                (le, ":distance", 1000),
                
                (agent_clear_scripted_mode, ":bandit_2_id"),  
              (try_end),                

              (assign, ":continue", 1),
            (try_end),  
            
            (eq, ":continue", 1),
            
            (agent_clear_scripted_mode, ":bandit_id"),            
          (try_end),
        (try_end),
	   ]),
	   
	   (30, 0, 0, 
	   [
	     (le, "$defender_reinforcement_stage", 1),
	   ],
	   [          
          (store_character_level, ":player_level", "trp_player"),                   
          (store_add, ":number_of_bandits_will_be_spawned_at_each_period", 5, ":player_level"),
          (val_div, ":number_of_bandits_will_be_spawned_at_each_period", 3),

          (lt, "$bandits_spawned_extra", ":number_of_bandits_will_be_spawned_at_each_period"),
          (val_add, "$bandits_spawned_extra", 1),                   

          (party_get_template_id, ":template", "$g_encountered_party"),
          (store_random_in_range, ":random_value", 0, 2),
          
          (try_begin),
            (eq, ":template", "pt_sea_raider_lair"),
            (eq, ":random_value", 0),
            (assign, ":bandit_troop", "trp_sea_raider"),
          (else_try), #chief anadido
            (eq, ":template", "pt_sea_raider_lair2"),
            (eq, ":random_value", 0),
            (assign, ":bandit_troop", "trp_dena_pirate"),
          (else_try),
            (eq, ":template", "pt_forest_bandit_lair"),
            (eq, ":random_value", 0),
            (assign, ":bandit_troop", "trp_forest_bandit"),
          (else_try),
            (eq, ":template", "pt_desert_bandit_lair"),
            (eq, ":random_value", 0),
            (assign, ":bandit_troop", "trp_desert_bandit"),
          (else_try),
            (eq, ":template", "pt_mountain_bandit_lair"),
            (eq, ":random_value", 0),
            (assign, ":bandit_troop", "trp_mountain_bandit"),
          (else_try),
            (eq, ":template", "pt_taiga_bandit_lair"),
            (eq, ":random_value", 0),
            (assign, ":bandit_troop", "trp_taiga_bandit"),
          (else_try),
            (eq, ":template", "pt_steppe_bandit_lair"),
            (eq, ":random_value", 0),
            (assign, ":bandit_troop", "trp_steppe_bandit"),
          (else_try),
            (this_or_next|eq, ":template", "pt_looter_lair"),
            (neq, ":random_value", 0),
            (assign, ":bandit_troop", "trp_looter"),
          (try_end),

          (store_current_scene, ":cur_scene"), 
          (modify_visitors_at_site, ":cur_scene"),
          (store_random_in_range, ":random_entry_point", 2, 11),
          (add_visitors_to_current_scene, ":random_entry_point", ":bandit_troop", 1),
       ]),	   	   

      (ti_on_agent_killed_or_wounded, 0, 0, [],
       [
        (store_trigger_param_1, ":dead_agent_no"),
        #(store_trigger_param_2, ":killer_agent_no"),
        (store_trigger_param_3, ":is_wounded"),

        (try_begin),
          (ge, ":dead_agent_no", 0),
          (agent_is_human, ":dead_agent_no"),
          (agent_get_troop_id, ":dead_agent_troop_id", ":dead_agent_no"),
          (str_store_troop_name, s6, ":dead_agent_troop_id"),
          (try_begin),
            (neg|agent_is_ally, ":dead_agent_no"),
            (party_add_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1), #addition_to_p_total_enemy_casualties            
            (try_begin),
              (eq, ":is_wounded", 1),
              (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1), 
            (try_end),  
          (try_end),  
          
          (party_add_members, "p_temp_casualties", ":dead_agent_troop_id", 1), #addition_to_p_total_enemy_casualties            
          
          (eq, ":is_wounded", 1),
          (party_wound_members, "p_temp_casualties", ":dead_agent_troop_id", 1), 
        (try_end),
#F123 - 1.41 -> Submod (Text related to casualties was here)   
        (assign, ":number_of_enemies", 0),
        (try_for_agents, ":cur_agent"),
          (agent_is_non_player, ":cur_agent"),
          (agent_is_human, ":cur_agent"),
          (agent_is_alive, ":cur_agent"),
          (neg|agent_is_ally, ":cur_agent"),
          (val_add, ":number_of_enemies", 1),
        (try_end),

        (try_begin),
          (le, ":number_of_enemies", 2),
          (le, "$defender_reinforcement_stage", 1),
          (val_add, "$defender_reinforcement_stage", 1),

          (store_character_level, ":player_level", "trp_player"),                   
          (store_add, ":number_of_bandits_will_be_spawned_at_each_period", 5, ":player_level"),
          (val_div, ":number_of_bandits_will_be_spawned_at_each_period", 3),
          (try_begin),
            (ge, "$defender_reinforcement_stage", 2),
            (val_sub, ":number_of_bandits_will_be_spawned_at_each_period", "$bandits_spawned_extra"),
          (try_end),
          
          (party_get_template_id, ":template", "$g_encountered_party"),          
          (store_random_in_range, ":random_value", 0, 2),
          
          (try_begin),
            (eq, ":template", "pt_sea_raider_lair"),
            (eq, ":random_value", 0),
            (assign, ":bandit_troop", "trp_sea_raider"),
          (else_try), #chief anadido
            (eq, ":template", "pt_sea_raider_lair2"),
            (eq, ":random_value", 0),
            (assign, ":bandit_troop", "trp_dena_pirate"),
          (else_try),
            (eq, ":template", "pt_forest_bandit_lair"),
            (eq, ":random_value", 0),
            (assign, ":bandit_troop", "trp_forest_bandit"),
          (else_try),
            (eq, ":template", "pt_desert_bandit_lair"),
            (eq, ":random_value", 0),
            (assign, ":bandit_troop", "trp_desert_bandit"),
          (else_try),
            (eq, ":template", "pt_mountain_bandit_lair"),
            (eq, ":random_value", 0),
            (assign, ":bandit_troop", "trp_mountain_bandit"),
          (else_try),
            (eq, ":template", "pt_taiga_bandit_lair"),
            (eq, ":random_value", 0),
            (assign, ":bandit_troop", "trp_taiga_bandit"),
          (else_try),
            (eq, ":template", "pt_steppe_bandit_lair"),
            (eq, ":random_value", 0),
            (assign, ":bandit_troop", "trp_steppe_bandit"),
          (else_try),
            (this_or_next|eq, ":template", "pt_looter_lair"),
            (neq, ":random_value", 0),
            (assign, ":bandit_troop", "trp_looter"),
          (try_end),
                                                                       
          (store_current_scene, ":cur_scene"), 
          (modify_visitors_at_site, ":cur_scene"),
          (try_for_range, ":unused", 0, ":number_of_bandits_will_be_spawned_at_each_period"),            
            (store_random_in_range, ":random_entry_point", 2, 11),
            (add_visitors_to_current_scene, ":random_entry_point", ":bandit_troop", 1),
          (try_end),
        (try_end),

        #no need to adjust courage in bandit lair for now
        #(call_script, "script_apply_death_effect_on_courage_scores", ":dead_agent_no", ":killer_agent_no"),
       ]),

      (0, 0, ti_once, [],
       [
         (call_script, "script_music_set_situation_with_culture", mtf_sit_ambushed),
         (set_party_battle_mode),
        ]),

       common_battle_order_panel,
       common_battle_order_panel_tick,

      ] + dplmc_battle_mode_triggers + order_volley_triggers +
        quest_merchant.lair_mission_templates_triggers,
        ),

########################grueso chief final############################
  #quest jik chief
  ("arena_duel_geoffrey",mtf_arena_fight,-1,
    "Dueling Geoffrey",
    [
      (56, mtef_visitor_source|mtef_team_0, af_override_horse, aif_start_alarmed, 1, []),
      (58, mtef_visitor_source|mtef_team_2, af_override_horse, aif_start_alarmed, 1, []),
    ],
    [
      common_inventory_not_available,
      (ti_tab_pressed, 0, 0, [(display_message, "@Geoffrey: Trying to flee, Peasant?")], []),
      (1, 3, ti_once,[(main_hero_fallen),],
       [(quest_set_slot,"qst_mod_trouble","slot_quest_current_state",4),
         (finish_mission),
         ]),
      (2, 3, ti_once,[( all_enemies_defeated, 1),(neg|main_hero_fallen, 0),],
       [(quest_set_slot,"qst_mod_trouble","slot_quest_current_state",3),
           (remove_troop_from_site,"trp_npcneko","scn_town_41_tavern"), ##Remove Geoffrey from the tavern scene   
           (finish_mission),
           ]),
    ],
  ),
#quest jik acaba
#-#-#-#-#-#-#-#-#-#-#-#-#-#-#
#-#-#-#Hunting chief Mod begin#-#-#-#
#-#-#-#-#-#-#-#-#-#-#-#-#-#-#

  (
    "deer_hunting",mtf_battle_mode,-1,
    "You lead your deers to battle.",
    [
     (1,mtef_team_0|mtef_leader_only,0,aif_start_alarmed,12,[]),
     (4,mtef_visitor_source|mtef_team_2,0,aif_start_alarmed,0,[]),
     ],
    [
      (ti_tab_pressed, 0, 0, [
      (set_trigger_result,1)], []), #leaving area
      (0, 0, ti_once, [ #spawing deers
		     (party_count_members_of_type,":num_deers","$g_encountered_party","trp_deer"),
		     (val_sub,":num_deers",1),
		     (ge,":num_deers",0),
                     (assign,"$num_deers_killed",0),
                     (get_scene_boundaries, pos10,pos11),
                     (position_get_x, ":scene_min_x", pos10),
                     (position_get_x, ":scene_max_x", pos11),
                     (position_get_y, ":scene_min_y", pos10),
                     (position_get_y, ":scene_max_y", pos11),
		     (store_div,":border_x",":scene_max_x",10),
		     (val_add,":scene_min_x",":border_x"),
		     (val_sub,":scene_max_x",":border_x"),
		     (store_div,":border_y",":scene_max_y",10),
		     (val_add,":scene_min_y",":border_y"),
		     (val_sub,":scene_max_y",":border_y"),
		     (store_random_in_range,":x_pos",":scene_min_x",":scene_max_x"),
		     (store_random_in_range,":y_pos",":scene_min_y",":scene_max_y"),
                     (init_position, pos1),
		     (position_set_x,pos1,":x_pos"),
		     (position_set_y,pos1,":y_pos"),
		     (position_set_z,pos1,10000),
		     (position_set_z_to_ground_level,pos1),
                     (set_spawn_position, pos1),
                     (spawn_horse, "itm_deer"),
		     (assign,"$leading_deer",reg0),
		     (try_for_range,":unused",0,":num_deers"),
                       (init_position, pos1),
		       (store_random_in_range,":x_pos_add",0,1000),
		       (store_random_in_range,":y_pos_add",0,1000),
		       (val_add,":x_pos_add",":x_pos"),
		       (val_add,":y_pos_add",":y_pos"),
		       (position_set_x,pos1,":x_pos_add"),
		       (position_set_y,pos1,":y_pos_add"),
		       (position_set_z,pos1,10000),
		       (position_set_z_to_ground_level,pos1),
		       (set_spawn_position, pos1),
                       (spawn_horse, "itm_deer"),
		     (try_end),
                 ], []),
#identifica el animal para sonido chief
      (ti_on_agent_killed_or_wounded, 0, 0, [
        (store_trigger_param_1, ":dead_agent_no"),
        (agent_get_troop_id,":cur_troop_id",":dead_agent_no"),

        (eq,":cur_troop_id","trp_deer"),

       ],
       [(play_sound,"snd_ciervomuerto")]),
###sonidos acaba
      (1,0,0,[], #wounded deers move slower
      [(try_for_agents,reg(1)),
       (agent_get_item_id,reg(2),reg(1)),
       (eq,reg(2),"itm_deer"),
       (store_agent_hit_points,reg(2),reg(1)),
       (store_mul,reg(3),20,reg(2)),
       (val_div,reg(3),40),
       (agent_set_speed_limit,reg(1),reg(3)),
       (try_end),
      ]),
      (5,0,0,
      [
      (neg|agent_is_alive,"$leading_deer"),
      ],
      [
      (try_for_agents,reg(1)),
      	(agent_get_item_id,reg(2),reg(1)),
	(eq,reg(2),"itm_deer"),
	(assign,"$leading_deer",reg(1)),
      (try_end),
      ]),
      (1,0,0,[],
      [
              (assign,":num_kills",0),
	      (try_for_agents,reg(1)),
	        (agent_get_item_id,reg(2),reg(1)),
	        (eq,reg(2),"itm_deer"),
                (store_agent_hit_points,reg(2),reg(1)),
		(eq,reg(2),0),
		(val_add,":num_kills",1),
	      (try_end),    
	      (gt,":num_kills","$num_deers_killed"),	      
                     (get_scene_boundaries, pos10,pos11),
                     (position_get_x, ":scene_min_x", pos10),
                     (position_get_x, ":scene_max_x", pos11),
                     (position_get_y, ":scene_min_y", pos10),
                     (position_get_y, ":scene_max_y", pos11),
		     (store_div,":border_x",":scene_max_x",10),
		     (val_add,":scene_min_x",":border_x"),
		     (val_sub,":scene_max_x",":border_x"),
		     (store_div,":border_y",":scene_max_y",10),
		     (val_add,":scene_min_y",":border_y"),
		     (val_sub,":scene_max_y",":border_y"),
		     (store_random_in_range,":x_pos",":scene_min_x",":scene_max_x"),
		     (store_random_in_range,":y_pos",":scene_min_y",":scene_max_y"),
                     (init_position, pos1),
		     (position_set_x,pos1,":x_pos"),
		     (position_set_y,pos1,":y_pos"),
		     (position_set_z,pos1,10000),
		     (position_set_z_to_ground_level,pos1),
                     (agent_set_scripted_destination,"$leading_deer",pos1),
	             (assign,"$num_deers_killed",":num_kills"),
      ]),
      (5,0,0,[],
      [
      (agent_get_position,pos1,"$leading_deer"),
      (position_get_x,":x_pos",pos1),
      (position_get_y,":y_pos",pos1),
      (this_or_next|le,":x_pos",5000),
      (this_or_next|le,":y_pos",5000),
      (this_or_next|ge,":x_pos",38000),
      (ge,":y_pos",38000),
                     (get_scene_boundaries, pos10,pos11),
                     (position_get_x, ":scene_min_x", pos10),
                     (position_get_x, ":scene_max_x", pos11),
                     (position_get_y, ":scene_min_y", pos10),
                     (position_get_y, ":scene_max_y", pos11),
		     (store_div,":border_x",":scene_max_x",10),
		     (val_add,":scene_min_x",":border_x"),
		     (val_sub,":scene_max_x",":border_x"),
		     (store_div,":border_y",":scene_max_y",10),
		     (val_add,":scene_min_y",":border_y"),
		     (val_sub,":scene_max_y",":border_y"),
		     (store_random_in_range,":x_pos",":scene_min_x",":scene_max_x"),
		     (store_random_in_range,":y_pos",":scene_min_y",":scene_max_y"),
                     (init_position, pos1),
		     (position_set_x,pos1,":x_pos"),
		     (position_set_y,pos1,":y_pos"),
		     (position_set_z,pos1,10000),
		     (position_set_z_to_ground_level,pos1),
                     (agent_set_scripted_destination,"$leading_deer",pos1),
      ]),
      (1,0,0,[],
      [
      (try_for_agents,reg(1)),
	(agent_get_item_id,reg(2),reg(1)),
	(eq,reg(2),"itm_deer"),
	(store_agent_hit_points,":health",reg(1)),
	(store_sub,":damage",100,":health"),
	(agent_get_slot,":prev_damage",reg(1),1),
	(neq,":prev_damage",":damage"),
	(agent_set_slot,reg(1),1,":damage"),
        (agent_get_position,pos1,reg(1)),
        (position_get_x,":x_pos",pos1),
	(position_get_y,":y_pos",pos1),
        (store_random_in_range,":x_pos_add",0,1000),
        (store_random_in_range,":y_pos_add",0,1000),
	(val_add,":x_pos",":x_pos_add"),
	(val_add,":y_pos",":y_pos_add"),
	(position_set_x,pos1,":x_pos"),
	(position_set_y,pos1,":y_pos"),
        (agent_set_scripted_destination,reg(1),pos1),
      (try_end),
      ]),
      (0.5,0,0, #deer travelling
      [],
      [
      (get_player_agent_no,reg(1)),
      (agent_get_position,pos1,reg(1)),
      (agent_get_position,pos4,"$leading_deer"),
      (position_get_x,":x_pos",pos4),
      (position_get_y,":y_pos",pos4),
      (try_for_agents,reg(1)),
	(agent_get_item_id,reg(2),reg(1)),
	(eq,reg(2),"itm_deer"),
        (agent_get_position,pos2,reg(1)),
	(get_distance_between_positions,reg(3),pos1,pos2),
	(try_begin),
	        (position_get_x,":pos_x",pos2),
	        (position_get_x,":pos_y",pos2),
		     (position_get_x, ":scene_min_x", pos10),
                     (position_get_x, ":scene_max_x", pos11),
                     (position_get_y, ":scene_min_y", pos10),
                     (position_get_y, ":scene_max_y", pos11),
		     (store_div,":border_x",":scene_max_x",10),
		     (val_add,":scene_min_x",":border_x"),
		     (val_sub,":scene_max_x",":border_x"),
		     (store_div,":border_y",":scene_max_y",10),
		     (val_add,":scene_min_y",":border_y"),
		     (val_sub,":scene_max_y",":border_y"),
		(this_or_next|gt,":pos_x",":scene_max_x"),
		(this_or_next|lt,":pos_x",":scene_min_x"),
		(this_or_next|gt,":pos_y",":scene_max_y"),
		(lt,":pos_y",":scene_min_y"),
		(store_random_in_range,":x_pos",":scene_min_x",":scene_max_x"),
		(store_random_in_range,":y_pos",":scene_min_y",":scene_max_y"),
                (init_position, pos1),
		(position_set_x,pos1,":x_pos"),
		(position_set_y,pos1,":y_pos"),
		(position_set_z,pos1,10000),
		(position_set_z_to_ground_level,pos1),
                (agent_set_scripted_destination,reg(1),pos1),
	(else_try),
		(le,reg(3),2500),
		(position_get_x,reg(4),pos1),
		(position_get_x,reg(5),pos2),
		(store_sub,":x_dist",reg(5),reg(4)),
		(val_mul,":x_dist",10),
		(position_get_y,reg(6),pos1),
		(position_get_y,reg(7),pos2),
		(store_sub,":y_dist",reg(7),reg(6)),
		(val_mul,":y_dist",10),
		(init_position,pos3),
		(val_add,":x_dist",reg(5)),
		(val_add,":y_dist",reg(7)),
		(position_set_x,pos3,":x_dist"),
		(position_set_y,pos3,":y_dist"),
	        (position_set_z,pos3,10000),
	        (position_set_z_to_ground_level,pos3),
		(agent_set_scripted_destination,reg(1),pos3),
	(else_try),
		(get_distance_between_positions,reg(3),pos4,pos2),
		(ge,reg(3),2000),
                       (init_position, pos6),
		       (store_random_in_range,":x_pos_add",0,1000),
		       (store_random_in_range,":y_pos_add",0,1000),
		       (val_add,":x_pos_add",":x_pos"),
		       (val_add,":y_pos_add",":y_pos"),
		       (position_set_x,pos6,":x_pos_add"),
		       (position_set_y,pos6,":y_pos_add"),
		       (position_set_z,pos6,10000),
		       (position_set_z_to_ground_level,pos6),
		       (agent_set_scripted_destination,reg(1),pos6),
	(try_end),
      (try_end),
      ]),
    ]),

    
  (
    "boar_hunting",mtf_battle_mode,-1,
    "You lead your boars to battle.",
    [
     (1,mtef_team_0|mtef_leader_only,0,aif_start_alarmed,12,[]),
     (4,mtef_visitor_source|mtef_team_2,0,aif_start_alarmed,0,[]),
     ],
    [
      (ti_tab_pressed, 0, 0, [ (set_trigger_result,1)], []), #leaving area
      (0, 0, ti_once, [ #spawing boars
		     (party_count_members_of_type,":num_boars","$g_encountered_party","trp_boar"),
		     (val_sub,":num_boars",1),
		     (ge,":num_boars",0),
                     (assign,"$num_boars_killed",0),
                     (get_scene_boundaries, pos10,pos11),
                     (position_get_x, ":scene_min_x", pos10),
                     (position_get_x, ":scene_max_x", pos11),
                     (position_get_y, ":scene_min_y", pos10),
                     (position_get_y, ":scene_max_y", pos11),
		     (store_div,":border_x",":scene_max_x",10),
		     (val_add,":scene_min_x",":border_x"),
		     (val_sub,":scene_max_x",":border_x"),
		     (store_div,":border_y",":scene_max_y",10),
		     (val_add,":scene_min_y",":border_y"),
		     (val_sub,":scene_max_y",":border_y"),
		     (store_random_in_range,":x_pos",":scene_min_x",":scene_max_x"),
		     (store_random_in_range,":y_pos",":scene_min_y",":scene_max_y"),
                     (init_position, pos1),
		     (position_set_x,pos1,":x_pos"),
		     (position_set_y,pos1,":y_pos"),
		     (position_set_z,pos1,10000),
		     (position_set_z_to_ground_level,pos1),
                     (set_spawn_position, pos1),
                     (spawn_horse, "itm_boar"),
		     (assign,"$leading_boar",reg0),
		     (try_for_range,":unused",0,":num_boars"),
                       (init_position, pos1),
		       (store_random_in_range,":x_pos_add",0,1000),
		       (store_random_in_range,":y_pos_add",0,1000),
		       (val_add,":x_pos_add",":x_pos"),
		       (val_add,":y_pos_add",":y_pos"),
		       (position_set_x,pos1,":x_pos_add"),
		       (position_set_y,pos1,":y_pos_add"),
		       (position_set_z,pos1,10000),
		       (position_set_z_to_ground_level,pos1),
		       (set_spawn_position, pos1),
                       (spawn_horse, "itm_boar"),
		     (try_end),
                 ], []),
#identifica el animal para sonido chief
      (ti_on_agent_killed_or_wounded, 0, 0, [
        (store_trigger_param_1, ":dead_agent_no"),
        (agent_get_troop_id,":cur_troop_id",":dead_agent_no"),

        (eq,":cur_troop_id","trp_boar"),

       ],
       [(play_sound,"snd_boarmuerto")]),
###sonidos acaba
      (1,0,0,[], #wounded boars move slower
      [(try_for_agents,reg(1)),
       (agent_get_item_id,reg(2),reg(1)),
       (eq,reg(2),"itm_boar"),
       (store_agent_hit_points,reg(2),reg(1)),
       (store_mul,reg(3),20,reg(2)),
       (val_div,reg(3),100),
       (agent_set_speed_limit,reg(1),reg(3)),
       (try_end),
      ]),
      (5,0,0,
      [
      (neg|agent_is_alive,"$leading_boar"),
      ],
      [
      (try_for_agents,reg(1)),
      	(agent_get_item_id,reg(2),reg(1)),
	(eq,reg(2),"itm_boar"),
	(assign,"$leading_boar",reg(1)),
      (try_end),
      ]),
      (1,0,0,[],
      [
              (assign,":num_kills",0),
	      (try_for_agents,reg(1)),
	        (agent_get_item_id,reg(2),reg(1)),
	        (eq,reg(2),"itm_boar"),
                (store_agent_hit_points,reg(2),reg(1)),
		(eq,reg(2),0),
		(val_add,":num_kills",1),
	      (try_end),    
	      (gt,":num_kills","$num_boars_killed"),	      
                     (get_scene_boundaries, pos10,pos11),
                     (position_get_x, ":scene_min_x", pos10),
                     (position_get_x, ":scene_max_x", pos11),
                     (position_get_y, ":scene_min_y", pos10),
                     (position_get_y, ":scene_max_y", pos11),
		     (store_div,":border_x",":scene_max_x",10),
		     (val_add,":scene_min_x",":border_x"),
		     (val_sub,":scene_max_x",":border_x"),
		     (store_div,":border_y",":scene_max_y",10),
		     (val_add,":scene_min_y",":border_y"),
		     (val_sub,":scene_max_y",":border_y"),
		     (store_random_in_range,":x_pos",":scene_min_x",":scene_max_x"),
		     (store_random_in_range,":y_pos",":scene_min_y",":scene_max_y"),
                     (init_position, pos1),
		     (position_set_x,pos1,":x_pos"),
		     (position_set_y,pos1,":y_pos"),
		     (position_set_z,pos1,10000),
		     (position_set_z_to_ground_level,pos1),
                     (agent_set_scripted_destination,"$leading_boar",pos1),
	             (assign,"$num_boars_killed",":num_kills"),
      ]),
      (5,0,0,[],
      [
      (agent_get_position,pos1,"$leading_boar"),
      (position_get_x,":x_pos",pos1),
      (position_get_y,":y_pos",pos1),
      (this_or_next|le,":x_pos",5000),
      (this_or_next|le,":y_pos",5000),
      (this_or_next|ge,":x_pos",38000),
      (ge,":y_pos",38000),
                     (get_scene_boundaries, pos10,pos11),
                     (position_get_x, ":scene_min_x", pos10),
                     (position_get_x, ":scene_max_x", pos11),
                     (position_get_y, ":scene_min_y", pos10),
                     (position_get_y, ":scene_max_y", pos11),
		     (store_div,":border_x",":scene_max_x",10),
		     (val_add,":scene_min_x",":border_x"),
		     (val_sub,":scene_max_x",":border_x"),
		     (store_div,":border_y",":scene_max_y",10),
		     (val_add,":scene_min_y",":border_y"),
		     (val_sub,":scene_max_y",":border_y"),
		     (store_random_in_range,":x_pos",":scene_min_x",":scene_max_x"),
		     (store_random_in_range,":y_pos",":scene_min_y",":scene_max_y"),
                     (init_position, pos1),
		     (position_set_x,pos1,":x_pos"),
		     (position_set_y,pos1,":y_pos"),
		     (position_set_z,pos1,10000),
		     (position_set_z_to_ground_level,pos1),
                     (agent_set_scripted_destination,"$leading_boar",pos1),
      ]),
      (1,0,0,[],
      [
      (try_for_agents,reg(1)),
	(agent_get_item_id,reg(2),reg(1)),
	(eq,reg(2),"itm_boar"),
	(store_agent_hit_points,":health",reg(1)),
	(store_sub,":damage",100,":health"),
	(agent_get_slot,":prev_damage",reg(1),1),
	(neq,":prev_damage",":damage"),
	(agent_set_slot,reg(1),1,":damage"),
        (agent_get_position,pos1,reg(1)),
        (position_get_x,":x_pos",pos1),
	(position_get_y,":y_pos",pos1),
        (store_random_in_range,":x_pos_add",0,1000),
        (store_random_in_range,":y_pos_add",0,1000),
	(val_add,":x_pos",":x_pos_add"),
	(val_add,":y_pos",":y_pos_add"),
	(position_set_x,pos1,":x_pos"),
	(position_set_y,pos1,":y_pos"),
        (agent_set_scripted_destination,reg(1),pos1),
      (try_end),
      ]),
      (0.5,0,0, #boar travelling
      [],
      [
      (get_player_agent_no,reg(1)),
      (agent_get_position,pos1,reg(1)),
      (agent_get_position,pos4,"$leading_boar"),
      (position_get_x,":x_pos",pos4),
      (position_get_y,":y_pos",pos4),
      (try_for_agents,reg(1)),
	(agent_get_item_id,reg(2),reg(1)),
	(eq,reg(2),"itm_boar"),
        (agent_get_position,pos2,reg(1)),
	(get_distance_between_positions,reg(3),pos1,pos2),
	(try_begin),
	        (position_get_x,":pos_x",pos2),
	        (position_get_x,":pos_y",pos2),
		     (position_get_x, ":scene_min_x", pos10),
                     (position_get_x, ":scene_max_x", pos11),
                     (position_get_y, ":scene_min_y", pos10),
                     (position_get_y, ":scene_max_y", pos11),
		     (store_div,":border_x",":scene_max_x",10),
		     (val_add,":scene_min_x",":border_x"),
		     (val_sub,":scene_max_x",":border_x"),
		     (store_div,":border_y",":scene_max_y",10),
		     (val_add,":scene_min_y",":border_y"),
		     (val_sub,":scene_max_y",":border_y"),
		(this_or_next|gt,":pos_x",":scene_max_x"),
		(this_or_next|lt,":pos_x",":scene_min_x"),
		(this_or_next|gt,":pos_y",":scene_max_y"),
		(lt,":pos_y",":scene_min_y"),
		(store_random_in_range,":x_pos",":scene_min_x",":scene_max_x"),
		(store_random_in_range,":y_pos",":scene_min_y",":scene_max_y"),
                (init_position, pos1),
		(position_set_x,pos1,":x_pos"),
		(position_set_y,pos1,":y_pos"),
		(position_set_z,pos1,10000),
		(position_set_z_to_ground_level,pos1),
                (agent_set_scripted_destination,reg(1),pos1),
	(else_try),
		(le,reg(3),2500),
		(position_get_x,reg(4),pos1),
		(position_get_x,reg(5),pos2),
		(store_sub,":x_dist",reg(5),reg(4)),
		(val_mul,":x_dist",10),
		(position_get_y,reg(6),pos1),
		(position_get_y,reg(7),pos2),
		(store_sub,":y_dist",reg(7),reg(6)),
		(val_mul,":y_dist",10),
		(init_position,pos3),
		(val_add,":x_dist",reg(5)),
		(val_add,":y_dist",reg(7)),
		(position_set_x,pos3,":x_dist"),
		(position_set_y,pos3,":y_dist"),
	        (position_set_z,pos3,10000),
	        (position_set_z_to_ground_level,pos3),
		(agent_set_scripted_destination,reg(1),pos3),
	(else_try),
		(get_distance_between_positions,reg(3),pos4,pos2),
		(ge,reg(3),2000),
                       (init_position, pos6),
		       (store_random_in_range,":x_pos_add",0,1000),
		       (store_random_in_range,":y_pos_add",0,1000),
		       (val_add,":x_pos_add",":x_pos"),
		       (val_add,":y_pos_add",":y_pos"),
		       (position_set_x,pos6,":x_pos_add"),
		       (position_set_y,pos6,":y_pos_add"),
		       (position_set_z,pos6,10000),
		       (position_set_z_to_ground_level,pos6),
		       (agent_set_scripted_destination,reg(1),pos6),
	(try_end),
      (try_end),
      ]),
    ]),

####lobo
    (
    "wolf_hunting",mtf_battle_mode,-1,
    "You lead your wolfs to battle.",
    [
     (1,mtef_team_0|mtef_leader_only,0,aif_start_alarmed,12,[]),
     (4,mtef_visitor_source|mtef_team_2,0,aif_start_alarmed,0,[]),
     ],
    [
      (ti_tab_pressed, 0, 0, [ (set_trigger_result,1)], []), #leaving area
      (0, 0, ti_once, [ #spawing boars
		     (party_count_members_of_type,":num_wolfs","$g_encountered_party","trp_wolf"),
		     (val_sub,":num_wolfs",1),
		     (ge,":num_wolfs",0),
                     (assign,"$num_wolfs_killed",0),
                     (get_scene_boundaries, pos10,pos11),
                     (position_get_x, ":scene_min_x", pos10),
                     (position_get_x, ":scene_max_x", pos11),
                     (position_get_y, ":scene_min_y", pos10),
                     (position_get_y, ":scene_max_y", pos11),
		     (store_div,":border_x",":scene_max_x",10),
		     (val_add,":scene_min_x",":border_x"),
		     (val_sub,":scene_max_x",":border_x"),
		     (store_div,":border_y",":scene_max_y",10),
		     (val_add,":scene_min_y",":border_y"),
		     (val_sub,":scene_max_y",":border_y"),
		     (store_random_in_range,":x_pos",":scene_min_x",":scene_max_x"),
		     (store_random_in_range,":y_pos",":scene_min_y",":scene_max_y"),
                     (init_position, pos1),
		     (position_set_x,pos1,":x_pos"),
		     (position_set_y,pos1,":y_pos"),
		     (position_set_z,pos1,10000),
		     (position_set_z_to_ground_level,pos1),
                     (set_spawn_position, pos1),
                     (spawn_horse, "itm_wolf"),
		     (assign,"$leading_wolf",reg0),
		     (try_for_range,":unused",0,":num_wolfs"),
                       (init_position, pos1),
		       (store_random_in_range,":x_pos_add",0,1000),
		       (store_random_in_range,":y_pos_add",0,1000),
		       (val_add,":x_pos_add",":x_pos"),
		       (val_add,":y_pos_add",":y_pos"),
		       (position_set_x,pos1,":x_pos_add"),
		       (position_set_y,pos1,":y_pos_add"),
		       (position_set_z,pos1,10000),
		       (position_set_z_to_ground_level,pos1),
		       (set_spawn_position, pos1),
                       (spawn_horse, "itm_wolf"),
		     (try_end),
                 ], []),
#identifica el animal para sonido chief
      (ti_on_agent_killed_or_wounded, 0, 0, [
        (store_trigger_param_1, ":dead_agent_no"),
        (agent_get_troop_id,":cur_troop_id",":dead_agent_no"),

        (eq,":cur_troop_id","trp_wolf"),

       ],
       [(play_sound,"snd_wolf_short")]),
###sonidos acaba
      (1,0,0,[], #wounded boars move slower
      [(try_for_agents,reg(1)),
       (agent_get_item_id,reg(2),reg(1)),
       (eq,reg(2),"itm_wolf"),
       (store_agent_hit_points,reg(2),reg(1)),
       (store_mul,reg(3),20,reg(2)),
       (val_div,reg(3),100),
       (agent_set_speed_limit,reg(1),reg(3)),
       (try_end),
      ]),
      (5,0,0,
      [
      (neg|agent_is_alive,"$leading_wolf"),
      ],
      [
      (try_for_agents,reg(1)),
      	(agent_get_item_id,reg(2),reg(1)),
	(eq,reg(2),"itm_wolf"),
	(assign,"$leading_wolf",reg(1)),
      (try_end),
      ]),
      (1,0,0,[],
      [
              (assign,":num_kills",0),
	      (try_for_agents,reg(1)),
	        (agent_get_item_id,reg(2),reg(1)),
	        (eq,reg(2),"itm_wolf"),
                (store_agent_hit_points,reg(2),reg(1)),
		(eq,reg(2),0),
		(val_add,":num_kills",1),
	      (try_end),    
	      (gt,":num_kills","$num_wolfs_killed"),	      
                     (get_scene_boundaries, pos10,pos11),
                     (position_get_x, ":scene_min_x", pos10),
                     (position_get_x, ":scene_max_x", pos11),
                     (position_get_y, ":scene_min_y", pos10),
                     (position_get_y, ":scene_max_y", pos11),
		     (store_div,":border_x",":scene_max_x",10),
		     (val_add,":scene_min_x",":border_x"),
		     (val_sub,":scene_max_x",":border_x"),
		     (store_div,":border_y",":scene_max_y",10),
		     (val_add,":scene_min_y",":border_y"),
		     (val_sub,":scene_max_y",":border_y"),
		     (store_random_in_range,":x_pos",":scene_min_x",":scene_max_x"),
		     (store_random_in_range,":y_pos",":scene_min_y",":scene_max_y"),
                     (init_position, pos1),
		     (position_set_x,pos1,":x_pos"),
		     (position_set_y,pos1,":y_pos"),
		     (position_set_z,pos1,10000),
		     (position_set_z_to_ground_level,pos1),
                     (agent_set_scripted_destination,"$leading_wolf",pos1),
	             (assign,"$num_wolfs_killed",":num_kills"),
      ]),
      (5,0,0,[],
      [
      (agent_get_position,pos1,"$leading_wolf"),
      (position_get_x,":x_pos",pos1),
      (position_get_y,":y_pos",pos1),
      (this_or_next|le,":x_pos",5000),
      (this_or_next|le,":y_pos",5000),
      (this_or_next|ge,":x_pos",38000),
      (ge,":y_pos",38000),
                     (get_scene_boundaries, pos10,pos11),
                     (position_get_x, ":scene_min_x", pos10),
                     (position_get_x, ":scene_max_x", pos11),
                     (position_get_y, ":scene_min_y", pos10),
                     (position_get_y, ":scene_max_y", pos11),
		     (store_div,":border_x",":scene_max_x",10),
		     (val_add,":scene_min_x",":border_x"),
		     (val_sub,":scene_max_x",":border_x"),
		     (store_div,":border_y",":scene_max_y",10),
		     (val_add,":scene_min_y",":border_y"),
		     (val_sub,":scene_max_y",":border_y"),
		     (store_random_in_range,":x_pos",":scene_min_x",":scene_max_x"),
		     (store_random_in_range,":y_pos",":scene_min_y",":scene_max_y"),
                     (init_position, pos1),
		     (position_set_x,pos1,":x_pos"),
		     (position_set_y,pos1,":y_pos"),
		     (position_set_z,pos1,10000),
		     (position_set_z_to_ground_level,pos1),
                     (agent_set_scripted_destination,"$leading_wolf",pos1),
      ]),
      (1,0,0,[],
      [
      (try_for_agents,reg(1)),
	(agent_get_item_id,reg(2),reg(1)),
	(eq,reg(2),"itm_wolf"),
	(store_agent_hit_points,":health",reg(1)),
	(store_sub,":damage",100,":health"),
	(agent_get_slot,":prev_damage",reg(1),1),
	(neq,":prev_damage",":damage"),
	(agent_set_slot,reg(1),1,":damage"),
        (agent_get_position,pos1,reg(1)),
        (position_get_x,":x_pos",pos1),
	(position_get_y,":y_pos",pos1),
        (store_random_in_range,":x_pos_add",0,1000),
        (store_random_in_range,":y_pos_add",0,1000),
	(val_add,":x_pos",":x_pos_add"),
	(val_add,":y_pos",":y_pos_add"),
	(position_set_x,pos1,":x_pos"),
	(position_set_y,pos1,":y_pos"),
        (agent_set_scripted_destination,reg(1),pos1),
      (try_end),
      ]),
      (0.5,0,0, #boar travelling
      [],
      [
      (get_player_agent_no,reg(1)),
      (agent_get_position,pos1,reg(1)),
      (agent_get_position,pos4,"$leading_wolf"),
      (position_get_x,":x_pos",pos4),
      (position_get_y,":y_pos",pos4),
      (try_for_agents,reg(1)),
	(agent_get_item_id,reg(2),reg(1)),
	(eq,reg(2),"itm_wolf"),
        (agent_get_position,pos2,reg(1)),
	(get_distance_between_positions,reg(3),pos1,pos2),
	(try_begin),
	        (position_get_x,":pos_x",pos2),
	        (position_get_x,":pos_y",pos2),
		     (position_get_x, ":scene_min_x", pos10),
                     (position_get_x, ":scene_max_x", pos11),
                     (position_get_y, ":scene_min_y", pos10),
                     (position_get_y, ":scene_max_y", pos11),
		     (store_div,":border_x",":scene_max_x",10),
		     (val_add,":scene_min_x",":border_x"),
		     (val_sub,":scene_max_x",":border_x"),
		     (store_div,":border_y",":scene_max_y",10),
		     (val_add,":scene_min_y",":border_y"),
		     (val_sub,":scene_max_y",":border_y"),
		(this_or_next|gt,":pos_x",":scene_max_x"),
		(this_or_next|lt,":pos_x",":scene_min_x"),
		(this_or_next|gt,":pos_y",":scene_max_y"),
		(lt,":pos_y",":scene_min_y"),
		(store_random_in_range,":x_pos",":scene_min_x",":scene_max_x"),
		(store_random_in_range,":y_pos",":scene_min_y",":scene_max_y"),
                (init_position, pos1),
		(position_set_x,pos1,":x_pos"),
		(position_set_y,pos1,":y_pos"),
		(position_set_z,pos1,10000),
		(position_set_z_to_ground_level,pos1),
                (agent_set_scripted_destination,reg(1),pos1),
	(else_try),
		(le,reg(3),2500),
		(position_get_x,reg(4),pos1),
		(position_get_x,reg(5),pos2),
		(store_sub,":x_dist",reg(5),reg(4)),
		(val_mul,":x_dist",10),
		(position_get_y,reg(6),pos1),
		(position_get_y,reg(7),pos2),
		(store_sub,":y_dist",reg(7),reg(6)),
		(val_mul,":y_dist",10),
		(init_position,pos3),
		(val_add,":x_dist",reg(5)),
		(val_add,":y_dist",reg(7)),
		(position_set_x,pos3,":x_dist"),
		(position_set_y,pos3,":y_dist"),
	        (position_set_z,pos3,10000),
	        (position_set_z_to_ground_level,pos3),
		(agent_set_scripted_destination,reg(1),pos3),
	(else_try),
		(get_distance_between_positions,reg(3),pos4,pos2),
		(ge,reg(3),2000),
                       (init_position, pos6),
		       (store_random_in_range,":x_pos_add",0,1000),
		       (store_random_in_range,":y_pos_add",0,1000),
		       (val_add,":x_pos_add",":x_pos"),
		       (val_add,":y_pos_add",":y_pos"),
		       (position_set_x,pos6,":x_pos_add"),
		       (position_set_y,pos6,":y_pos_add"),
		       (position_set_z,pos6,10000),
		       (position_set_z_to_ground_level,pos6),
		       (agent_set_scripted_destination,reg(1),pos6),
	(try_end),
      (try_end),
      ]),
    ]),

####coat
    (
    "coat_hunting",mtf_battle_mode,-1,
    "You lead your coats to battle.",
    [
     (1,mtef_team_0|mtef_leader_only,0,aif_start_alarmed,12,[]),
     (4,mtef_visitor_source|mtef_team_2,0,aif_start_alarmed,0,[]),
     ],
    [
      (ti_tab_pressed, 0, 0, [
      (set_trigger_result,1)], []), #leaving area
      (0, 0, ti_once, [ #spawing deers
		     (party_count_members_of_type,":num_coats","$g_encountered_party","trp_coat"),
		     (val_sub,":num_coats",1),
		     (ge,":num_coats",0),
                     (assign,"$num_coats_killed",0),
                     (get_scene_boundaries, pos10,pos11),
                     (position_get_x, ":scene_min_x", pos10),
                     (position_get_x, ":scene_max_x", pos11),
                     (position_get_y, ":scene_min_y", pos10),
                     (position_get_y, ":scene_max_y", pos11),
		     (store_div,":border_x",":scene_max_x",10),
		     (val_add,":scene_min_x",":border_x"),
		     (val_sub,":scene_max_x",":border_x"),
		     (store_div,":border_y",":scene_max_y",10),
		     (val_add,":scene_min_y",":border_y"),
		     (val_sub,":scene_max_y",":border_y"),
		     (store_random_in_range,":x_pos",":scene_min_x",":scene_max_x"),
		     (store_random_in_range,":y_pos",":scene_min_y",":scene_max_y"),
                     (init_position, pos1),
		     (position_set_x,pos1,":x_pos"),
		     (position_set_y,pos1,":y_pos"),
		     (position_set_z,pos1,10000),
		     (position_set_z_to_ground_level,pos1),
                     (set_spawn_position, pos1),
                     (spawn_horse, "itm_greenpantsbody_woad03"),
		     (assign,"$leading_coat",reg0),
		     (try_for_range,":unused",0,":num_coats"),
                       (init_position, pos1),
		       (store_random_in_range,":x_pos_add",0,1000),
		       (store_random_in_range,":y_pos_add",0,1000),
		       (val_add,":x_pos_add",":x_pos"),
		       (val_add,":y_pos_add",":y_pos"),
		       (position_set_x,pos1,":x_pos_add"),
		       (position_set_y,pos1,":y_pos_add"),
		       (position_set_z,pos1,10000),
		       (position_set_z_to_ground_level,pos1),
		       (set_spawn_position, pos1),
                       (spawn_horse, "itm_greenpantsbody_woad03"),
		     (try_end),
                 ], []),
#identifica el animal para sonido chief
      (ti_on_agent_killed_or_wounded, 0, 0, [
        (store_trigger_param_1, ":dead_agent_no"),
        (agent_get_troop_id,":cur_troop_id",":dead_agent_no"),

        (eq,":cur_troop_id","trp_coat"),

       ],
       [(play_sound,"snd_ciervomuerto")]),
###sonidos acaba
      (1,0,0,[], #wounded deers move slower
      [(try_for_agents,reg(1)),
       (agent_get_item_id,reg(2),reg(1)),
       (eq,reg(2),"itm_greenpantsbody_woad03"),
       (store_agent_hit_points,reg(2),reg(1)),
       (store_mul,reg(3),20,reg(2)),
       (val_div,reg(3),40),
       (agent_set_speed_limit,reg(1),reg(3)),
       (try_end),
      ]),
      (5,0,0,
      [
      (neg|agent_is_alive,"$leading_coat"),
      ],
      [
      (try_for_agents,reg(1)),
      	(agent_get_item_id,reg(2),reg(1)),
	(eq,reg(2),"itm_greenpantsbody_woad03"),
	(assign,"$leading_coat",reg(1)),
      (try_end),
      ]),
      (1,0,0,[],
      [
              (assign,":num_kills",0),
	      (try_for_agents,reg(1)),
	        (agent_get_item_id,reg(2),reg(1)),
	        (eq,reg(2),"itm_greenpantsbody_woad03"),
                (store_agent_hit_points,reg(2),reg(1)),
		(eq,reg(2),0),
		(val_add,":num_kills",1),
	      (try_end),    
	      (gt,":num_kills","$num_coats_killed"),	      
                     (get_scene_boundaries, pos10,pos11),
                     (position_get_x, ":scene_min_x", pos10),
                     (position_get_x, ":scene_max_x", pos11),
                     (position_get_y, ":scene_min_y", pos10),
                     (position_get_y, ":scene_max_y", pos11),
		     (store_div,":border_x",":scene_max_x",10),
		     (val_add,":scene_min_x",":border_x"),
		     (val_sub,":scene_max_x",":border_x"),
		     (store_div,":border_y",":scene_max_y",10),
		     (val_add,":scene_min_y",":border_y"),
		     (val_sub,":scene_max_y",":border_y"),
		     (store_random_in_range,":x_pos",":scene_min_x",":scene_max_x"),
		     (store_random_in_range,":y_pos",":scene_min_y",":scene_max_y"),
                     (init_position, pos1),
		     (position_set_x,pos1,":x_pos"),
		     (position_set_y,pos1,":y_pos"),
		     (position_set_z,pos1,10000),
		     (position_set_z_to_ground_level,pos1),
                     (agent_set_scripted_destination,"$leading_coat",pos1),
	             (assign,"$num_coats_killed",":num_kills"),
      ]),
      (5,0,0,[],
      [
      (agent_get_position,pos1,"$leading_coat"),
      (position_get_x,":x_pos",pos1),
      (position_get_y,":y_pos",pos1),
      (this_or_next|le,":x_pos",5000),
      (this_or_next|le,":y_pos",5000),
      (this_or_next|ge,":x_pos",38000),
      (ge,":y_pos",38000),
                     (get_scene_boundaries, pos10,pos11),
                     (position_get_x, ":scene_min_x", pos10),
                     (position_get_x, ":scene_max_x", pos11),
                     (position_get_y, ":scene_min_y", pos10),
                     (position_get_y, ":scene_max_y", pos11),
		     (store_div,":border_x",":scene_max_x",10),
		     (val_add,":scene_min_x",":border_x"),
		     (val_sub,":scene_max_x",":border_x"),
		     (store_div,":border_y",":scene_max_y",10),
		     (val_add,":scene_min_y",":border_y"),
		     (val_sub,":scene_max_y",":border_y"),
		     (store_random_in_range,":x_pos",":scene_min_x",":scene_max_x"),
		     (store_random_in_range,":y_pos",":scene_min_y",":scene_max_y"),
                     (init_position, pos1),
		     (position_set_x,pos1,":x_pos"),
		     (position_set_y,pos1,":y_pos"),
		     (position_set_z,pos1,10000),
		     (position_set_z_to_ground_level,pos1),
                     (agent_set_scripted_destination,"$leading_coat",pos1),
      ]),
      (1,0,0,[],
      [
      (try_for_agents,reg(1)),
	(agent_get_item_id,reg(2),reg(1)),
	(eq,reg(2),"itm_greenpantsbody_woad03"),
	(store_agent_hit_points,":health",reg(1)),
	(store_sub,":damage",100,":health"),
	(agent_get_slot,":prev_damage",reg(1),1),
	(neq,":prev_damage",":damage"),
	(agent_set_slot,reg(1),1,":damage"),
        (agent_get_position,pos1,reg(1)),
        (position_get_x,":x_pos",pos1),
	(position_get_y,":y_pos",pos1),
        (store_random_in_range,":x_pos_add",0,1000),
        (store_random_in_range,":y_pos_add",0,1000),
	(val_add,":x_pos",":x_pos_add"),
	(val_add,":y_pos",":y_pos_add"),
	(position_set_x,pos1,":x_pos"),
	(position_set_y,pos1,":y_pos"),
        (agent_set_scripted_destination,reg(1),pos1),
      (try_end),
      ]),
      (0.5,0,0, #deer travelling
      [],
      [
      (get_player_agent_no,reg(1)),
      (agent_get_position,pos1,reg(1)),
      (agent_get_position,pos4,"$leading_coat"),
      (position_get_x,":x_pos",pos4),
      (position_get_y,":y_pos",pos4),
      (try_for_agents,reg(1)),
	(agent_get_item_id,reg(2),reg(1)),
	(eq,reg(2),"itm_greenpantsbody_woad03"),
        (agent_get_position,pos2,reg(1)),
	(get_distance_between_positions,reg(3),pos1,pos2),
	(try_begin),
	        (position_get_x,":pos_x",pos2),
	        (position_get_x,":pos_y",pos2),
		     (position_get_x, ":scene_min_x", pos10),
                     (position_get_x, ":scene_max_x", pos11),
                     (position_get_y, ":scene_min_y", pos10),
                     (position_get_y, ":scene_max_y", pos11),
		     (store_div,":border_x",":scene_max_x",10),
		     (val_add,":scene_min_x",":border_x"),
		     (val_sub,":scene_max_x",":border_x"),
		     (store_div,":border_y",":scene_max_y",10),
		     (val_add,":scene_min_y",":border_y"),
		     (val_sub,":scene_max_y",":border_y"),
		(this_or_next|gt,":pos_x",":scene_max_x"),
		(this_or_next|lt,":pos_x",":scene_min_x"),
		(this_or_next|gt,":pos_y",":scene_max_y"),
		(lt,":pos_y",":scene_min_y"),
		(store_random_in_range,":x_pos",":scene_min_x",":scene_max_x"),
		(store_random_in_range,":y_pos",":scene_min_y",":scene_max_y"),
                (init_position, pos1),
		(position_set_x,pos1,":x_pos"),
		(position_set_y,pos1,":y_pos"),
		(position_set_z,pos1,10000),
		(position_set_z_to_ground_level,pos1),
                (agent_set_scripted_destination,reg(1),pos1),
	(else_try),
		(le,reg(3),2500),
		(position_get_x,reg(4),pos1),
		(position_get_x,reg(5),pos2),
		(store_sub,":x_dist",reg(5),reg(4)),
		(val_mul,":x_dist",10),
		(position_get_y,reg(6),pos1),
		(position_get_y,reg(7),pos2),
		(store_sub,":y_dist",reg(7),reg(6)),
		(val_mul,":y_dist",10),
		(init_position,pos3),
		(val_add,":x_dist",reg(5)),
		(val_add,":y_dist",reg(7)),
		(position_set_x,pos3,":x_dist"),
		(position_set_y,pos3,":y_dist"),
	        (position_set_z,pos3,10000),
	        (position_set_z_to_ground_level,pos3),
		(agent_set_scripted_destination,reg(1),pos3),
	(else_try),
		(get_distance_between_positions,reg(3),pos4,pos2),
		(ge,reg(3),2000),
                       (init_position, pos6),
		       (store_random_in_range,":x_pos_add",0,1000),
		       (store_random_in_range,":y_pos_add",0,1000),
		       (val_add,":x_pos_add",":x_pos"),
		       (val_add,":y_pos_add",":y_pos"),
		       (position_set_x,pos6,":x_pos_add"),
		       (position_set_y,pos6,":y_pos_add"),
		       (position_set_z,pos6,10000),
		       (position_set_z_to_ground_level,pos6),
		       (agent_set_scripted_destination,reg(1),pos6),
	(try_end),
      (try_end),
      ]),
    ]),

    (
    "coatb_hunting",mtf_battle_mode,-1,
    "You lead your coats to battle.",
    [
     (1,mtef_team_0|mtef_leader_only,0,aif_start_alarmed,12,[]),
     (4,mtef_visitor_source|mtef_team_2,0,aif_start_alarmed,0,[]),
     ],
    [
      (ti_tab_pressed, 0, 0, [
      (set_trigger_result,1)], []), #leaving area
      (0, 0, ti_once, [ #spawing deers
		     (party_count_members_of_type,":num_coatbs","$g_encountered_party","trp_coat_b"),
		     (val_sub,":num_coatbs",1),
		     (ge,":num_coatbs",0),
                     (assign,"$num_coatbs_killed",0),
                     (get_scene_boundaries, pos10,pos11),
                     (position_get_x, ":scene_min_x", pos10),
                     (position_get_x, ":scene_max_x", pos11),
                     (position_get_y, ":scene_min_y", pos10),
                     (position_get_y, ":scene_max_y", pos11),
		     (store_div,":border_x",":scene_max_x",10),
		     (val_add,":scene_min_x",":border_x"),
		     (val_sub,":scene_max_x",":border_x"),
		     (store_div,":border_y",":scene_max_y",10),
		     (val_add,":scene_min_y",":border_y"),
		     (val_sub,":scene_max_y",":border_y"),
		     (store_random_in_range,":x_pos",":scene_min_x",":scene_max_x"),
		     (store_random_in_range,":y_pos",":scene_min_y",":scene_max_y"),
                     (init_position, pos1),
		     (position_set_x,pos1,":x_pos"),
		     (position_set_y,pos1,":y_pos"),
		     (position_set_z,pos1,10000),
		     (position_set_z_to_ground_level,pos1),
                     (set_spawn_position, pos1),
                     (spawn_horse, "itm_goatb"),
		     (assign,"$leading_coatb",reg0),
		     (try_for_range,":unused",0,":num_coatbs"),
                       (init_position, pos1),
		       (store_random_in_range,":x_pos_add",0,1000),
		       (store_random_in_range,":y_pos_add",0,1000),
		       (val_add,":x_pos_add",":x_pos"),
		       (val_add,":y_pos_add",":y_pos"),
		       (position_set_x,pos1,":x_pos_add"),
		       (position_set_y,pos1,":y_pos_add"),
		       (position_set_z,pos1,10000),
		       (position_set_z_to_ground_level,pos1),
		       (set_spawn_position, pos1),
                       (spawn_horse, "itm_goatb"),
		     (try_end),
                 ], []),
#identifica el animal para sonido chief
      (ti_on_agent_killed_or_wounded, 0, 0, [
        (store_trigger_param_1, ":dead_agent_no"),
        (agent_get_troop_id,":cur_troop_id",":dead_agent_no"),

        (eq,":cur_troop_id","trp_coat_b"),

       ],
       [(play_sound,"snd_ciervomuerto")]),
###sonidos acaba
      (1,0,0,[], #wounded deers move slower
      [(try_for_agents,reg(1)),
       (agent_get_item_id,reg(2),reg(1)),
       (eq,reg(2),"itm_goatb"),
       (store_agent_hit_points,reg(2),reg(1)),
       (store_mul,reg(3),20,reg(2)),
       (val_div,reg(3),40),
       (agent_set_speed_limit,reg(1),reg(3)),
       (try_end),
      ]),
      (5,0,0,
      [
      (neg|agent_is_alive,"$leading_coatb"),
      ],
      [
      (try_for_agents,reg(1)),
      	(agent_get_item_id,reg(2),reg(1)),
	(eq,reg(2),"itm_goatb"),
	(assign,"$leading_coatb",reg(1)),
      (try_end),
      ]),
      (1,0,0,[],
      [
              (assign,":num_kills",0),
	      (try_for_agents,reg(1)),
	        (agent_get_item_id,reg(2),reg(1)),
	        (eq,reg(2),"itm_goatb"),
                (store_agent_hit_points,reg(2),reg(1)),
		(eq,reg(2),0),
		(val_add,":num_kills",1),
	      (try_end),    
	      (gt,":num_kills","$num_coatbs_killed"),	      
                     (get_scene_boundaries, pos10,pos11),
                     (position_get_x, ":scene_min_x", pos10),
                     (position_get_x, ":scene_max_x", pos11),
                     (position_get_y, ":scene_min_y", pos10),
                     (position_get_y, ":scene_max_y", pos11),
		     (store_div,":border_x",":scene_max_x",10),
		     (val_add,":scene_min_x",":border_x"),
		     (val_sub,":scene_max_x",":border_x"),
		     (store_div,":border_y",":scene_max_y",10),
		     (val_add,":scene_min_y",":border_y"),
		     (val_sub,":scene_max_y",":border_y"),
		     (store_random_in_range,":x_pos",":scene_min_x",":scene_max_x"),
		     (store_random_in_range,":y_pos",":scene_min_y",":scene_max_y"),
                     (init_position, pos1),
		     (position_set_x,pos1,":x_pos"),
		     (position_set_y,pos1,":y_pos"),
		     (position_set_z,pos1,10000),
		     (position_set_z_to_ground_level,pos1),
                     (agent_set_scripted_destination,"$leading_coatb",pos1),
	             (assign,"$num_coatbs_killed",":num_kills"),
      ]),
      (5,0,0,[],
      [
      (agent_get_position,pos1,"$leading_coatb"),
      (position_get_x,":x_pos",pos1),
      (position_get_y,":y_pos",pos1),
      (this_or_next|le,":x_pos",5000),
      (this_or_next|le,":y_pos",5000),
      (this_or_next|ge,":x_pos",38000),
      (ge,":y_pos",38000),
                     (get_scene_boundaries, pos10,pos11),
                     (position_get_x, ":scene_min_x", pos10),
                     (position_get_x, ":scene_max_x", pos11),
                     (position_get_y, ":scene_min_y", pos10),
                     (position_get_y, ":scene_max_y", pos11),
		     (store_div,":border_x",":scene_max_x",10),
		     (val_add,":scene_min_x",":border_x"),
		     (val_sub,":scene_max_x",":border_x"),
		     (store_div,":border_y",":scene_max_y",10),
		     (val_add,":scene_min_y",":border_y"),
		     (val_sub,":scene_max_y",":border_y"),
		     (store_random_in_range,":x_pos",":scene_min_x",":scene_max_x"),
		     (store_random_in_range,":y_pos",":scene_min_y",":scene_max_y"),
                     (init_position, pos1),
		     (position_set_x,pos1,":x_pos"),
		     (position_set_y,pos1,":y_pos"),
		     (position_set_z,pos1,10000),
		     (position_set_z_to_ground_level,pos1),
                     (agent_set_scripted_destination,"$leading_coatb",pos1),
      ]),
      (1,0,0,[],
      [
      (try_for_agents,reg(1)),
	(agent_get_item_id,reg(2),reg(1)),
	(eq,reg(2),"itm_goatb"),
	(store_agent_hit_points,":health",reg(1)),
	(store_sub,":damage",100,":health"),
	(agent_get_slot,":prev_damage",reg(1),1),
	(neq,":prev_damage",":damage"),
	(agent_set_slot,reg(1),1,":damage"),
        (agent_get_position,pos1,reg(1)),
        (position_get_x,":x_pos",pos1),
	(position_get_y,":y_pos",pos1),
        (store_random_in_range,":x_pos_add",0,1000),
        (store_random_in_range,":y_pos_add",0,1000),
	(val_add,":x_pos",":x_pos_add"),
	(val_add,":y_pos",":y_pos_add"),
	(position_set_x,pos1,":x_pos"),
	(position_set_y,pos1,":y_pos"),
        (agent_set_scripted_destination,reg(1),pos1),
      (try_end),
      ]),
      (0.5,0,0, #deer travelling
      [],
      [
      (get_player_agent_no,reg(1)),
      (agent_get_position,pos1,reg(1)),
      (agent_get_position,pos4,"$leading_coatb"),
      (position_get_x,":x_pos",pos4),
      (position_get_y,":y_pos",pos4),
      (try_for_agents,reg(1)),
	(agent_get_item_id,reg(2),reg(1)),
	(eq,reg(2),"itm_goatb"),
        (agent_get_position,pos2,reg(1)),
	(get_distance_between_positions,reg(3),pos1,pos2),
	(try_begin),
	        (position_get_x,":pos_x",pos2),
	        (position_get_x,":pos_y",pos2),
		     (position_get_x, ":scene_min_x", pos10),
                     (position_get_x, ":scene_max_x", pos11),
                     (position_get_y, ":scene_min_y", pos10),
                     (position_get_y, ":scene_max_y", pos11),
		     (store_div,":border_x",":scene_max_x",10),
		     (val_add,":scene_min_x",":border_x"),
		     (val_sub,":scene_max_x",":border_x"),
		     (store_div,":border_y",":scene_max_y",10),
		     (val_add,":scene_min_y",":border_y"),
		     (val_sub,":scene_max_y",":border_y"),
		(this_or_next|gt,":pos_x",":scene_max_x"),
		(this_or_next|lt,":pos_x",":scene_min_x"),
		(this_or_next|gt,":pos_y",":scene_max_y"),
		(lt,":pos_y",":scene_min_y"),
		(store_random_in_range,":x_pos",":scene_min_x",":scene_max_x"),
		(store_random_in_range,":y_pos",":scene_min_y",":scene_max_y"),
                (init_position, pos1),
		(position_set_x,pos1,":x_pos"),
		(position_set_y,pos1,":y_pos"),
		(position_set_z,pos1,10000),
		(position_set_z_to_ground_level,pos1),
                (agent_set_scripted_destination,reg(1),pos1),
	(else_try),
		(le,reg(3),2500),
		(position_get_x,reg(4),pos1),
		(position_get_x,reg(5),pos2),
		(store_sub,":x_dist",reg(5),reg(4)),
		(val_mul,":x_dist",10),
		(position_get_y,reg(6),pos1),
		(position_get_y,reg(7),pos2),
		(store_sub,":y_dist",reg(7),reg(6)),
		(val_mul,":y_dist",10),
		(init_position,pos3),
		(val_add,":x_dist",reg(5)),
		(val_add,":y_dist",reg(7)),
		(position_set_x,pos3,":x_dist"),
		(position_set_y,pos3,":y_dist"),
	        (position_set_z,pos3,10000),
	        (position_set_z_to_ground_level,pos3),
		(agent_set_scripted_destination,reg(1),pos3),
	(else_try),
		(get_distance_between_positions,reg(3),pos4,pos2),
		(ge,reg(3),2000),
                       (init_position, pos6),
		       (store_random_in_range,":x_pos_add",0,1000),
		       (store_random_in_range,":y_pos_add",0,1000),
		       (val_add,":x_pos_add",":x_pos"),
		       (val_add,":y_pos_add",":y_pos"),
		       (position_set_x,pos6,":x_pos_add"),
		       (position_set_y,pos6,":y_pos_add"),
		       (position_set_z,pos6,10000),
		       (position_set_z_to_ground_level,pos6),
		       (agent_set_scripted_destination,reg(1),pos6),
	(try_end),
      (try_end),
      ]),
    ]),

    (
    "wilddonkey_hunting",mtf_battle_mode,-1,
    "You lead your wild donkeys to battle.",
    [
     (1,mtef_team_0|mtef_leader_only,0,aif_start_alarmed,12,[]),
     (4,mtef_visitor_source|mtef_team_2,0,aif_start_alarmed,0,[]),
     ],
    [
      (ti_tab_pressed, 0, 0, [
      (set_trigger_result,1)], []), #leaving area
      (0, 0, ti_once, [ #spawing deers
		     (party_count_members_of_type,":num_wilddonkeys","$g_encountered_party","trp_wilddonkey"),
		     (val_sub,":num_wilddonkeys",1),
		     (ge,":num_wilddonkeys",0),
                     (assign,"$num_wilddonkeys_killed",0),
                     (get_scene_boundaries, pos10,pos11),
                     (position_get_x, ":scene_min_x", pos10),
                     (position_get_x, ":scene_max_x", pos11),
                     (position_get_y, ":scene_min_y", pos10),
                     (position_get_y, ":scene_max_y", pos11),
		     (store_div,":border_x",":scene_max_x",10),
		     (val_add,":scene_min_x",":border_x"),
		     (val_sub,":scene_max_x",":border_x"),
		     (store_div,":border_y",":scene_max_y",10),
		     (val_add,":scene_min_y",":border_y"),
		     (val_sub,":scene_max_y",":border_y"),
		     (store_random_in_range,":x_pos",":scene_min_x",":scene_max_x"),
		     (store_random_in_range,":y_pos",":scene_min_y",":scene_max_y"),
                     (init_position, pos1),
		     (position_set_x,pos1,":x_pos"),
		     (position_set_y,pos1,":y_pos"),
		     (position_set_z,pos1,10000),
		     (position_set_z_to_ground_level,pos1),
                     (set_spawn_position, pos1),
                     (spawn_horse, "itm_wilddonkey"),
		     (assign,"$leading_wilddonkey",reg0),
		     (try_for_range,":unused",0,":num_wilddonkeys"),
                       (init_position, pos1),
		       (store_random_in_range,":x_pos_add",0,1000),
		       (store_random_in_range,":y_pos_add",0,1000),
		       (val_add,":x_pos_add",":x_pos"),
		       (val_add,":y_pos_add",":y_pos"),
		       (position_set_x,pos1,":x_pos_add"),
		       (position_set_y,pos1,":y_pos_add"),
		       (position_set_z,pos1,10000),
		       (position_set_z_to_ground_level,pos1),
		       (set_spawn_position, pos1),
                       (spawn_horse, "itm_wilddonkey"),
		     (try_end),
                 ], []),
      (1,0,0,[], #wounded deers move slower
      [(try_for_agents,reg(1)),
       (agent_get_item_id,reg(2),reg(1)),
       (eq,reg(2),"itm_wilddonkey"),
       (store_agent_hit_points,reg(2),reg(1)),
       (store_mul,reg(3),20,reg(2)),
       (val_div,reg(3),40),
       (agent_set_speed_limit,reg(1),reg(3)),
       (try_end),
      ]),
      (5,0,0,
      [
      (neg|agent_is_alive,"$leading_wilddonkey"),
      ],
      [
      (try_for_agents,reg(1)),
      	(agent_get_item_id,reg(2),reg(1)),
	(eq,reg(2),"itm_wilddonkey"),
	(assign,"$leading_wilddonkey",reg(1)),
      (try_end),
      ]),
      (1,0,0,[],
      [
              (assign,":num_kills",0),
	      (try_for_agents,reg(1)),
	        (agent_get_item_id,reg(2),reg(1)),
	        (eq,reg(2),"itm_wilddonkey"),
                (store_agent_hit_points,reg(2),reg(1)),
		(eq,reg(2),0),
		(val_add,":num_kills",1),
	      (try_end),    
	      (gt,":num_kills","$num_wilddonkeys_killed"),	      
                     (get_scene_boundaries, pos10,pos11),
                     (position_get_x, ":scene_min_x", pos10),
                     (position_get_x, ":scene_max_x", pos11),
                     (position_get_y, ":scene_min_y", pos10),
                     (position_get_y, ":scene_max_y", pos11),
		     (store_div,":border_x",":scene_max_x",10),
		     (val_add,":scene_min_x",":border_x"),
		     (val_sub,":scene_max_x",":border_x"),
		     (store_div,":border_y",":scene_max_y",10),
		     (val_add,":scene_min_y",":border_y"),
		     (val_sub,":scene_max_y",":border_y"),
		     (store_random_in_range,":x_pos",":scene_min_x",":scene_max_x"),
		     (store_random_in_range,":y_pos",":scene_min_y",":scene_max_y"),
                     (init_position, pos1),
		     (position_set_x,pos1,":x_pos"),
		     (position_set_y,pos1,":y_pos"),
		     (position_set_z,pos1,10000),
		     (position_set_z_to_ground_level,pos1),
                     (agent_set_scripted_destination,"$leading_wilddonkey",pos1),
	             (assign,"$num_wilddonkeys_killed",":num_kills"),
      ]),
      (5,0,0,[],
      [
      (agent_get_position,pos1,"$leading_wilddonkey"),
      (position_get_x,":x_pos",pos1),
      (position_get_y,":y_pos",pos1),
      (this_or_next|le,":x_pos",5000),
      (this_or_next|le,":y_pos",5000),
      (this_or_next|ge,":x_pos",38000),
      (ge,":y_pos",38000),
                     (get_scene_boundaries, pos10,pos11),
                     (position_get_x, ":scene_min_x", pos10),
                     (position_get_x, ":scene_max_x", pos11),
                     (position_get_y, ":scene_min_y", pos10),
                     (position_get_y, ":scene_max_y", pos11),
		     (store_div,":border_x",":scene_max_x",10),
		     (val_add,":scene_min_x",":border_x"),
		     (val_sub,":scene_max_x",":border_x"),
		     (store_div,":border_y",":scene_max_y",10),
		     (val_add,":scene_min_y",":border_y"),
		     (val_sub,":scene_max_y",":border_y"),
		     (store_random_in_range,":x_pos",":scene_min_x",":scene_max_x"),
		     (store_random_in_range,":y_pos",":scene_min_y",":scene_max_y"),
                     (init_position, pos1),
		     (position_set_x,pos1,":x_pos"),
		     (position_set_y,pos1,":y_pos"),
		     (position_set_z,pos1,10000),
		     (position_set_z_to_ground_level,pos1),
                     (agent_set_scripted_destination,"$leading_wilddonkey",pos1),
      ]),
      (1,0,0,[],
      [
      (try_for_agents,reg(1)),
	(agent_get_item_id,reg(2),reg(1)),
	(eq,reg(2),"itm_wilddonkey"),
	(store_agent_hit_points,":health",reg(1)),
	(store_sub,":damage",100,":health"),
	(agent_get_slot,":prev_damage",reg(1),1),
	(neq,":prev_damage",":damage"),
	(agent_set_slot,reg(1),1,":damage"),
        (agent_get_position,pos1,reg(1)),
        (position_get_x,":x_pos",pos1),
	(position_get_y,":y_pos",pos1),
        (store_random_in_range,":x_pos_add",0,1000),
        (store_random_in_range,":y_pos_add",0,1000),
	(val_add,":x_pos",":x_pos_add"),
	(val_add,":y_pos",":y_pos_add"),
	(position_set_x,pos1,":x_pos"),
	(position_set_y,pos1,":y_pos"),
        (agent_set_scripted_destination,reg(1),pos1),
      (try_end),
      ]),
      (0.5,0,0, #deer travelling
      [],
      [
      (get_player_agent_no,reg(1)),
      (agent_get_position,pos1,reg(1)),
      (agent_get_position,pos4,"$leading_wilddonkey"),
      (position_get_x,":x_pos",pos4),
      (position_get_y,":y_pos",pos4),
      (try_for_agents,reg(1)),
	(agent_get_item_id,reg(2),reg(1)),
	(eq,reg(2),"itm_wilddonkey"),
        (agent_get_position,pos2,reg(1)),
	(get_distance_between_positions,reg(3),pos1,pos2),
	(try_begin),
	        (position_get_x,":pos_x",pos2),
	        (position_get_x,":pos_y",pos2),
		     (position_get_x, ":scene_min_x", pos10),
                     (position_get_x, ":scene_max_x", pos11),
                     (position_get_y, ":scene_min_y", pos10),
                     (position_get_y, ":scene_max_y", pos11),
		     (store_div,":border_x",":scene_max_x",10),
		     (val_add,":scene_min_x",":border_x"),
		     (val_sub,":scene_max_x",":border_x"),
		     (store_div,":border_y",":scene_max_y",10),
		     (val_add,":scene_min_y",":border_y"),
		     (val_sub,":scene_max_y",":border_y"),
		(this_or_next|gt,":pos_x",":scene_max_x"),
		(this_or_next|lt,":pos_x",":scene_min_x"),
		(this_or_next|gt,":pos_y",":scene_max_y"),
		(lt,":pos_y",":scene_min_y"),
		(store_random_in_range,":x_pos",":scene_min_x",":scene_max_x"),
		(store_random_in_range,":y_pos",":scene_min_y",":scene_max_y"),
                (init_position, pos1),
		(position_set_x,pos1,":x_pos"),
		(position_set_y,pos1,":y_pos"),
		(position_set_z,pos1,10000),
		(position_set_z_to_ground_level,pos1),
                (agent_set_scripted_destination,reg(1),pos1),
	(else_try),
		(le,reg(3),2500),
		(position_get_x,reg(4),pos1),
		(position_get_x,reg(5),pos2),
		(store_sub,":x_dist",reg(5),reg(4)),
		(val_mul,":x_dist",10),
		(position_get_y,reg(6),pos1),
		(position_get_y,reg(7),pos2),
		(store_sub,":y_dist",reg(7),reg(6)),
		(val_mul,":y_dist",10),
		(init_position,pos3),
		(val_add,":x_dist",reg(5)),
		(val_add,":y_dist",reg(7)),
		(position_set_x,pos3,":x_dist"),
		(position_set_y,pos3,":y_dist"),
	        (position_set_z,pos3,10000),
	        (position_set_z_to_ground_level,pos3),
		(agent_set_scripted_destination,reg(1),pos3),
	(else_try),
		(get_distance_between_positions,reg(3),pos4,pos2),
		(ge,reg(3),2000),
                       (init_position, pos6),
		       (store_random_in_range,":x_pos_add",0,1000),
		       (store_random_in_range,":y_pos_add",0,1000),
		       (val_add,":x_pos_add",":x_pos"),
		       (val_add,":y_pos_add",":y_pos"),
		       (position_set_x,pos6,":x_pos_add"),
		       (position_set_y,pos6,":y_pos_add"),
		       (position_set_z,pos6,10000),
		       (position_set_z_to_ground_level,pos6),
		       (agent_set_scripted_destination,reg(1),pos6),
	(try_end),
      (try_end),
      ]),
    ]),
  #-#-#-#-#-#-#-#-#-#-#-#-#-#-#
#-#-#-#Hunting chief Mod end#-#-#-#
#-#-#-#-#-#-#-#-#-#-#-#-#-#-#

####coastal town assaultmtf_battle_mode|mtf_synch_inventory,charge,
    (
    "castle_attack_walls_ladder_coastal",mtf_battle_mode|mtf_synch_inventory,-1,
    "You attack the walls of the castle...",
    [
     ## CC chief
     (0,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,18,[]),
#     (0,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,0,[]),
     (8,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,0,[]),
     (10,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,0,[]),
     (11,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,4,[]),
     (15,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,0,[]),

     (40,mtef_defenders|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,2,[]),
     (41,mtef_defenders|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,2,[]),
     (42,mtef_defenders|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,2,[]),
     (43,mtef_defenders|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,2,[]),
     (44,mtef_defenders|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,2,[]),
     (45,mtef_defenders|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,2,[]),
     (46,mtef_defenders|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,2,[]),
     ## CC
     ],
    [
	
##  (ti_after_mission_start, 0, 0, [],
##  [	
##		(assign, "$coastal_assault", 1),	
##    ]),			
##
##	  KLABAUTERMANN_1_weather,
##	  KLABAUTERMANN_2_prepare,
##	  KLABAUTERMANN_3_kill_offboard,
##	  KLABAUTERMANN_4_normal_commands,
##	  KLABAUTERMANN_5_ship_commands,
##	  KLABAUTERMANN_6_camera,
##	  KLABAUTERMANN_7_wind,
##	  KLABAUTERMANN_8_main,
##	  KLABAUTERMANN_11_sound,
  
  #TAKE PRISONERS DURING SIEGES, SIEGE MORALE	chief
      (ti_on_agent_killed_or_wounded, 0, 0, [],
       [
        (store_trigger_param_1, ":dead_agent_no"),
        (store_trigger_param_2, ":killer_agent_no"),
        (store_trigger_param_3, ":is_wounded"),

        (try_begin),
          (ge, ":dead_agent_no", 0),
          (neg|agent_is_ally, ":dead_agent_no"),
          (agent_is_human, ":dead_agent_no"),
          (agent_get_troop_id, ":dead_agent_troop_id", ":dead_agent_no"),
          (party_add_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1), #addition_to_p_total_enemy_casualties
          (eq, ":is_wounded", 1),
          (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1), 
        (try_end),
#F123 - 1.41 -> Submod (Text related to casualties was here)
        (call_script, "script_apply_death_effect_on_courage_scores", ":dead_agent_no", ":killer_agent_no"),
       ]),
            ############defensores tiran piedras chief siege warfare y otras cosas########################################3
         # Force mounted NPCs to switch to their lance.  This is called once at the
   # start of the battle.
   (0, 1, ti_once, [(eq, "$g_siege_realism", 1),],
   [
    (try_for_agents, ":agent_no"),
        (agent_is_non_player, ":agent_no"),
      (agent_is_human, ":agent_no"),
      (agent_is_alive, ":agent_no"),
      (agent_get_team, ":agent_team", ":agent_no"),
      (this_or_next|eq, ":agent_team", "$defender_team"),
      (eq, ":agent_team", "$defender_team_2"),
#varios
       (this_or_next|eq, ":agent_no", "trp_fresna_recruit"),
       (this_or_next|eq, ":agent_no", "trp_fresna_footmant2"),
       (this_or_next|eq, ":agent_no", "trp_townsman"),
       (this_or_next|eq, ":agent_no", "trp_merc_infantryt2"),
       (this_or_next|eq, ":agent_no", "trp_merc_infantryt3"),
       (this_or_next|eq, ":agent_no", "trp_mercenary_horseman"),
#jutos
       (this_or_next|eq, ":agent_no", "trp_jute_recruit"),
       (this_or_next|eq, ":agent_no", "trp_jute_footmant2"),
       (this_or_next|eq, ":agent_no", "trp_jute_skirmishert3"),
       (this_or_next|eq, ":agent_no", "trp_jute_infantryt3"),
#britones
       (this_or_next|eq, ":agent_no", "trp_briton_recruit"),
       (this_or_next|eq, ":agent_no", "trp_briton_footmant2"),
       (this_or_next|eq, ":agent_no", "trp_briton_infantryt3"),
       (this_or_next|eq, ":agent_no", "trp_briton_skirmt3"),
#sajones
       (this_or_next|eq, ":agent_no", "trp_saxon_recruit"),
       (this_or_next|eq, ":agent_no", "trp_saxon_footmant2"),
       (this_or_next|eq, ":agent_no", "trp_saxon_skirmishert3"),
       (this_or_next|eq, ":agent_no", "trp_saxon_infantryt3"),
#anglos
       (this_or_next|eq, ":agent_no", "trp_engle_recruit"),
       (this_or_next|eq, ":agent_no", "trp_engle_footmant2"),
       (this_or_next|eq, ":agent_no", "trp_engle_skirmishert3"),
       (this_or_next|eq, ":agent_no", "trp_engle_infantryt3"),
       (this_or_next|eq, ":agent_no", "trp_engle_skirmishert4"),
#irish
       (this_or_next|eq, ":agent_no", "trp_irish_recruit"),
       (this_or_next|eq, ":agent_no", "trp_irish_footmant2"),
       (this_or_next|eq, ":agent_no", "trp_irish_infantryt3"),
       (this_or_next|eq, ":agent_no", "trp_irish_skirmishert3"),
       (this_or_next|eq, ":agent_no", "trp_irish_infantryt4"),

#pictos
       (this_or_next|eq, ":agent_no", "trp_pict_recruit"),
       (this_or_next|eq, ":agent_no", "trp_pict_woman"),
       (this_or_next|eq, ":agent_no", "trp_pict_footmant2"),
       (this_or_next|eq, ":agent_no", "trp_pict_horsesquiret3"),
       (this_or_next|eq, ":agent_no", "trp_pict_horseman"),
#otros
       (this_or_next|eq, ":agent_no", "trp_manhunter"),
       (this_or_next|eq, ":agent_no", "trp_slave_driver"),
       (this_or_next|eq, ":agent_no", "trp_follower_woman"),
       (this_or_next|eq, ":agent_no", "trp_hunter_woman"),
       (this_or_next|eq, ":agent_no", "trp_fighter_woman"),

       (this_or_next|eq, ":agent_no", "trp_refugee"),
       (this_or_next|eq, ":agent_no", "trp_peasant_woman"),
       (this_or_next|eq, ":agent_no", "trp_looter"),
       (this_or_next|eq, ":agent_no", "trp_bandit"),
       (this_or_next|eq, ":agent_no", "trp_brigand"),
       (this_or_next|eq, ":agent_no", "trp_mountain_bandit"),
       (this_or_next|eq, ":agent_no", "trp_forest_bandit"),
       (eq, ":agent_no", "trp_taiga_bandit"),
#obtiene piedra
(store_random_in_range, ":rand", 0, 8),
                                              (try_begin),
                                            (eq, ":rand", 0), 
(agent_equip_item, ":agent_no", "itm_siege_supply"),
                                          (else_try),
                                            (eq, ":rand", 1),
(agent_equip_item, ":agent_no", "itm_siege_supply"),
                                          (else_try),
                                            (eq, ":rand", 2),
(agent_equip_item, ":agent_no", "itm_siege_supply"),
                                          (else_try),
                                            (eq, ":rand", 3),
(agent_equip_item, ":agent_no", "itm_boiling_water"),
                                          (else_try),
                                            (eq, ":rand", 4),
(agent_equip_item, ":agent_no", "itm_torch"),
                                           (else_try),
                                            (eq, ":rand", 5),
(agent_equip_item, ":agent_no", "itm_siege_supply"),
                                          (else_try),
                                            (eq, ":rand", 6),
(agent_equip_item, ":agent_no", "itm_siege_supply"),
                                          (else_try),
                                            (eq, ":rand", 7),
(agent_equip_item, ":agent_no", "itm_boiling_water"),
          (try_end),
      (try_end),   
   ]),

   (0, 1, ti_once, [(eq, "$g_siege_realism", 1),],
   [
    (try_for_agents, ":agent_no"),
        (agent_is_non_player, ":agent_no"),
      (agent_is_human, ":agent_no"),
      (agent_is_alive, ":agent_no"),
      (agent_get_team, ":agent_team", ":agent_no"),
      (this_or_next|eq, ":agent_team", "$defender_team"),
      (eq, ":agent_team", "$defender_team_2"),
#jutos
       (this_or_next|eq, ":agent_no", "trp_jute_cleric"),
       (this_or_next|eq, ":agent_no", "trp_jute_skirmishert5"),
#britones
       (this_or_next|eq, ":agent_no", "trp_briton_sacerdote"),
       (this_or_next|eq, ":agent_no", "trp_briton_horseman"),
#sajones
       (this_or_next|eq, ":agent_no", "trp_saxon_skirmishert5"),
       (this_or_next|eq, ":agent_no", "trp_saxon_sacerdote"),
#anglos
       (this_or_next|eq, ":agent_no", "trp_engle_skirmishert5"),
       (this_or_next|eq, ":agent_no", "trp_engle_rxpriest"),
#irish
       (this_or_next|eq, ":agent_no", "trp_irish_priest"),
       (this_or_next|eq, ":agent_no", "trp_irish_horseman"),

#pictos
       (this_or_next|eq, ":agent_no", "trp_pict_noblecavalry"),
       (this_or_next|eq, ":agent_no", "trp_picto_sacerdote"),
#otros
       (this_or_next|eq, ":agent_no", "trp_mercenary_horseman"),
       (this_or_next|eq, ":agent_no", "trp_shepherd"),
       (this_or_next|eq, ":agent_no", "trp_fresna_horseman"),
       (eq, ":agent_no", "trp_sea_raider"),
#obtiene piedra
(store_random_in_range, ":rand", 0, 2),
                                              (try_begin),
                                            (eq, ":rand", 0), 
(agent_equip_item, ":agent_no", "itm_torch"),
                                          (else_try),
                                            (eq, ":rand", 1),
(agent_equip_item, ":agent_no", "itm_torch"),
          (try_end),
#(agent_equip_item, ":agent_no", "itm_boiling_water"),
      (try_end),   
   ]),

   (0, 1, ti_once, [(eq, "$g_siege_realism", 1),],
   [
    (try_for_agents, ":agent_no"),
        (agent_is_non_player, ":agent_no"),
      (agent_is_human, ":agent_no"),
      (agent_is_alive, ":agent_no"),
      (agent_get_team, ":agent_team", ":agent_no"),
      (this_or_next|eq, ":agent_team", "$attacker_team"),
      (eq, ":agent_team", "$attacker_team_2"),
#jutos
       (this_or_next|eq, ":agent_no", "trp_jute_cleric"),
       (this_or_next|eq, ":agent_no", "trp_jute_skirmishert5"),
#britones
       (this_or_next|eq, ":agent_no", "trp_briton_sacerdote"),
       (this_or_next|eq, ":agent_no", "trp_briton_horseman"),
#sajones
       (this_or_next|eq, ":agent_no", "trp_saxon_skirmishert5"),
       (this_or_next|eq, ":agent_no", "trp_saxon_sacerdote"),
#anglos
       (this_or_next|eq, ":agent_no", "trp_engle_skirmishert5"),
       (this_or_next|eq, ":agent_no", "trp_engle_rxpriest"),
#irish
       (this_or_next|eq, ":agent_no", "trp_irish_priest"),
       (this_or_next|eq, ":agent_no", "trp_irish_horseman"),

#pictos
       (this_or_next|eq, ":agent_no", "trp_pict_noblecavalry"),
       (this_or_next|eq, ":agent_no", "trp_picto_sacerdote"),
#otros
       (this_or_next|eq, ":agent_no", "trp_mercenary_horseman"),
       (this_or_next|eq, ":agent_no", "trp_shepherd"),
       (this_or_next|eq, ":agent_no", "trp_fresna_horseman"),
       (eq, ":agent_no", "trp_sea_raider"),
#obtiene piedra
(store_random_in_range, ":rand", 0, 2),
                                              (try_begin),
                                            (eq, ":rand", 0), 
(agent_equip_item, ":agent_no", "itm_torch"),
                                          (else_try),
                                            (eq, ":rand", 1),
(agent_equip_item, ":agent_no", "itm_torch"),
          (try_end),
#(agent_equip_item, ":agent_no", "itm_boiling_water"),
      (try_end),   
   ]),

####tirar cosas acaba chief
   (0, 1, ti_once, [(eq, "$g_siege_realism", 1),(eq, "$g_mantlets_1", 1),],
   [
           (entry_point_get_position, pos1, 57),
           (set_spawn_position, pos1),
           (spawn_scene_prop, "spr_siege_large_shield_a", 0),         

           (entry_point_get_position, pos1, 58),
           (set_spawn_position, pos1),
           (spawn_scene_prop, "spr_siege_large_shield_a", 0),         
   ]),
####chief acaba siege warfare      
     
      common_battle_mission_start,
#fire arrow chief
      (0, 0, ti_once, [],[
        (assign, "$g_fire_arrow_mode_enemy", 1),]),
#fire arrow chief acaba
      common_battle_tab_press,
      common_battle_init_banner,
      common_siege_question_answered,
      common_siege_init,
      common_music_situation_update,
      common_siege_ai_trigger_init,
      common_siege_ai_trigger_init_2,
      common_siege_ai_trigger_init_after_2_secs,
      common_siege_defender_reinforcement_check,
      common_siege_defender_reinforcement_archer_reposition,
      common_siege_defender_infantry_patrol, #xenoargh chief
      common_siege_attacker_reinforcement_check,
      common_siege_attacker_do_not_stall,
      common_battle_check_friendly_kills,
      common_battle_check_victory_condition,
      common_battle_victory_display,
      common_siege_refill_ammo,
      common_siege_check_defeat_condition,
      common_battle_order_panel,
      common_battle_order_panel_tick,
      common_inventory_not_available,
#fire arrow chief
      fire_arrow_initialize,
      destructible_object_initialize,
      toggle_fire_arrow_mode,
      fire_element_life,
      fire_arrow_routine,
#fire arrow chief acaba

    ]
      ##diplomacy chief begin
    + dplmc_battle_mode_triggers + order_volley_triggers + warcry_chel + heridas_chel,
    ##diplomacy end     
  ),


  ############################
  ### Sailing - Shipbattle ###
  ############################
  
(
   "ship_battle",mtf_battle_mode,-1,
   "You enter battle on your longships.",
   [
    (0,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,4,[]),
    (1,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,4,[]),
    (2,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,4,[]),
    #(8,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,4,[]),
    (10,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,4,[]),
    (11,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,4,[]),
    (12,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,4,[]),
    ],
   [
##(0, 0, 0,[(key_clicked, key_k),
##            (tutorial_message, "@ "),
##], []),
##
##      	  (10,0,ti_once,[],
##		[
##        (tutorial_message_set_size, 20, 20),
##        (tutorial_message_set_position, 500, 650),
##        (tutorial_message_set_center_justify, 0),
##        (tutorial_message_set_background, 1),
##        (tutorial_message, "@ Stand by the rudder and use arrow keys: Up, Down, Left and Right to move your ship. It is important that you know the direction of the wind, weather and your speed since it determines the navigation of the ship: use key K ^^To attack an enemy ship, get close to it and board it. To raise / lower the sail, use key: J.^^(press K to finish read)"),
##		]),
  (ti_before_mission_start, 0, 0, [],
  [	
		(assign, "$coastal_assault", 0),	# if sea battle=0, if coast assault=1
    ]),	  
      common_inventory_not_available,

      common_battle_init_banner,
      common_battle_tab_press,

     (ti_on_agent_killed_or_wounded, 0, 0, [],
       [
        (store_trigger_param_1, ":dead_agent_no"),
        (store_trigger_param_2, ":killer_agent_no"),
        (store_trigger_param_3, ":is_wounded"),

        (try_begin),
          (ge, ":dead_agent_no", 0),
          (neg|agent_is_ally, ":dead_agent_no"),
          (agent_is_human, ":dead_agent_no"),
          (agent_get_troop_id, ":dead_agent_troop_id", ":dead_agent_no"),
          (str_store_troop_name, s6, ":dead_agent_troop_id"),
          (assign, reg0, ":dead_agent_no"),
          (assign, reg1, ":killer_agent_no"),
          (assign, reg2, ":is_wounded"),
          (agent_get_team, reg3, ":dead_agent_no"),         
          #(display_message, "@{!}dead agent no : {reg0} ; killer agent no : {reg1} ; is_wounded : {reg2} ; dead agent team : {reg3} ; {s6} is added"),
          (party_add_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1), #addition_to_p_total_enemy_casualties
          (eq, ":is_wounded", 1),
          (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1),
        (try_end),
       ]),

     (0, 0, ti_once, [], [
          (assign,"$g_battle_won",0),
                           (call_script, "script_combat_music_set_situation_with_culture"),
                           ]),

      common_music_situation_update,
      common_battle_check_friendly_kills,
   #  common_battle_tab_press,

      common_battle_check_victory_condition,
      common_battle_victory_display,
      common_battle_order_panel,
      common_battle_order_panel_tick,
#fire arrow chief
      destructible_object_initialize,
      fire_arrow_initialize,
      fire_arrow_routine,
      toggle_fire_arrow_mode,
      fire_element_life,
#fire arrow chief acaba      

### for KLABAUTERMANN begins Phaiak Chief
	  KLABAUTERMANN_1_weather,
	  KLABAUTERMANN_2_prepare,
	  KLABAUTERMANN_3_kill_offboard,
	  KLABAUTERMANN_4_normal_commands,
	  KLABAUTERMANN_5_ship_commands,
	  KLABAUTERMANN_6_camera,
	  KLABAUTERMANN_7_wind,
	  KLABAUTERMANN_8_main,
	  KLABAUTERMANN_9_reinforcement_A,
	  KLABAUTERMANN_10_reinforcement_B,
	  KLABAUTERMANN_11_sound,
      ### for KLABAUTERMANN ends

(ti_question_answered, 0, 0, [],
       [(store_trigger_param_1,":answer"),
        (eq,":answer",0),
        (assign, "$pin_player_fallen", 0),
        (try_begin),
          (store_mission_timer_a, ":elapsed_time"),
          (gt, ":elapsed_time", 20),
          (str_store_string, s5, "str_retreat"),
          (call_script, "script_simulate_retreat", 10, 20, 1),
           (call_script, "script_change_player_party_morale", -25), #chief cambia a mas
        (try_end),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission,0),]),

      (1, 4, ti_once, [(main_hero_fallen)],
          [
              (assign, "$pin_player_fallen", 1),
              (str_store_string, s5, "str_retreat"),
              (call_script, "script_simulate_retreat", 10, 20, 1),
              (assign, "$g_battle_result", -1),
              (set_mission_result,-1),
              (call_script, "script_count_mission_casualties_from_agents"),
              (finish_mission,0)]),
      
      ]+ dplmc_battle_mode_triggers3 + warcry_chel + heridas_chel,
    ),

        #Wulf begin
    (
    "ship_battle2",mtf_battle_mode,-1,
    "You close in and board the enemy ships",
    [(0,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,4,[]),
    (1,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,4,[]),
    (2,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,4,[]),
    (3,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,4,[]),
    (4,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,4,[]),
    (5,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,4,[]),
    (6,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,4,[]),     
    (7,mtef_attackers|mtef_team_1,af_override_horse,aif_start_alarmed,4,[]),
    (10,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,4,[]),
    (11,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,4,[]),
    (8,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,4,[]),
    (9,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,4,[]),
    (12,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,4,[]),
    (13,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,4,[]),
    (14,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,4,[]),
    (15,mtef_defenders|mtef_team_0,af_override_horse,aif_start_alarmed,4,[]),
     ],
    [
      (ti_on_agent_spawn, 0, 0, [],
       [
         (store_trigger_param_1, ":agent_no"),
         (call_script, "script_agent_reassign_team", ":agent_no"),
         ]),
   
      common_battle_init_banner, #sets heraldry on shields and armor

     (ti_on_agent_killed_or_wounded, 0, 0, [],
       [
        (store_trigger_param_1, ":dead_agent_no"),
        (store_trigger_param_2, ":killer_agent_no"),
        (store_trigger_param_3, ":is_wounded"),

        (try_begin),
          (ge, ":dead_agent_no", 0),
          (neg|agent_is_ally, ":dead_agent_no"),
          (agent_is_human, ":dead_agent_no"),
          (agent_get_troop_id, ":dead_agent_troop_id", ":dead_agent_no"),
          (str_store_troop_name, s6, ":dead_agent_troop_id"),
          (assign, reg0, ":dead_agent_no"),
          (assign, reg1, ":killer_agent_no"),
          (assign, reg2, ":is_wounded"),
          (agent_get_team, reg3, ":dead_agent_no"),         
          #(display_message, "@{!}dead agent no : {reg0} ; killer agent no : {reg1} ; is_wounded : {reg2} ; dead agent team : {reg3} ; {s6} is added"),
          (party_add_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1), #addition_to_p_total_enemy_casualties
          (eq, ":is_wounded", 1),
          (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1),
        (try_end),
       ]),
     
      (0, 0, ti_once, [], [
          (assign,"$g_battle_won",0),
                           (assign,"$defender_reinforcement_stage",0),
                           (assign,"$attacker_reinforcement_stage",0),
#                           (assign,"$g_presentation_battle_active", 0),
                           (call_script, "script_place_player_banner_near_inventory"),
                           (call_script, "script_combat_music_set_situation_with_culture"),
                           ]),
      common_music_situation_update,
      common_battle_check_friendly_kills,

      (1, 0, 5, [(lt,"$defender_reinforcement_stage",2),
                 (store_mission_timer_a,":mission_time"),
                 (ge,":mission_time",10),
                 (store_normalized_team_count,":num_defenders", 0),
                 (lt,":num_defenders",10),#gdw
#                 (assign, reg2, ":num_defenders"),
#                 (display_message,"@num_defenders = {reg2}")
                 ],
           [(add_reinforcements_to_entry,0,7),(val_add,"$defender_reinforcement_stage",1)]),
     
      (1, 0, 5, [(lt,"$attacker_reinforcement_stage",2),
                 (store_mission_timer_a,":mission_time"),
                 (ge,":mission_time",10),
                 (store_normalized_team_count,":num_attackers", 1),
                 (lt,":num_attackers",10),#gdw6
#                 (assign, reg2, ":num_attackers"),
#                 (display_message,"@num_attackers = {reg2}")
                 ],
           [(add_reinforcements_to_entry,3,7),(val_add,"$attacker_reinforcement_stage",1)]),
     
      common_battle_check_victory_condition,
      common_battle_victory_display,
      common_battle_tab_press,
	  common_drowning,
      
(ti_question_answered, 0, 0, [],
       [(store_trigger_param_1,":answer"),
        (eq,":answer",0),
        (assign, "$pin_player_fallen", 0),
        (try_begin),
          (store_mission_timer_a, ":elapsed_time"),
          (gt, ":elapsed_time", 20),
          (str_store_string, s5, "str_retreat"),
          (call_script, "script_simulate_retreat", 10, 20, 1),
        (try_end),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission,0),]),

      (1, 4, ti_once, [(main_hero_fallen)],
          [
              (assign, "$pin_player_fallen", 1),
              (str_store_string, s5, "str_retreat"),
              (call_script, "script_simulate_retreat", 10, 20),
              (assign, "$g_battle_result", -1),
              (set_mission_result,-1),
              (call_script, "script_count_mission_casualties_from_agents"),
              (finish_mission,0)]),
#Wulf end
      ]+ dplmc_battle_mode_triggers3 + warcry_chel + heridas_chel,
    ),


  #chief sea battles acaba
  #TEMPERED        chief #### MT_ENTRENCHED_ENCOUNTER ########################################

  (
    "entrenched_encounter",mtf_battle_mode|mtf_synch_inventory,-1,
    "Defend the camp!",
    [
     (0,mtef_defenders|mtef_team_1,0,aif_start_alarmed,12,[]), #enemy spawn point
     (1,mtef_defenders|mtef_team_3,0,aif_start_alarmed,0,[]),  #enemy reinforcements spawn point
     (11,mtef_attackers|mtef_team_0|mtef_no_regulars ,af_override_horse,aif_start_alarmed,12,[]), #player and companions spawn point
     (15,mtef_ally_party|mtef_team_2,0,aif_start_alarmed,0,[]), # Any ally joining battle spawns here
     (40,mtef_attackers|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,1,[]),
     (41,mtef_attackers|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,1,[]),
     (42,mtef_attackers|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,1,[]),
     (43,mtef_attackers|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,1,[]),
     (44,mtef_attackers|mtef_team_0|mtef_archers_first,af_override_horse,aif_start_alarmed,1,[]),
     (45,mtef_attackers|mtef_team_0|mtef_infantry_first,af_override_horse,aif_start_alarmed,2,[]),
	 (10,mtef_attackers|mtef_team_0,af_override_horse,aif_start_alarmed,0,[]), #player reinforcement spawn point MOTO place at index 10
     (46,mtef_attackers|mtef_team_0|mtef_cavalry_first,af_override_horse,aif_start_alarmed,1,[]),
	 # (10,mtef_attackers|mtef_team_0,af_override_horse,aif_start_alarmed,0,[]), #player reinforcement spawn point
     ], common_weapon_check + common_ai_order_toggle +
    [
	
		(0, 0, ti_once,
						[
						(assign, "$defender_team", 0),
						(assign, "$attacker_team", 1),
						(assign, "$defender_team_2", 2),
						(assign, "$attacker_team_2", 3),
						(assign,"$camp_supply",1),
						], []
		),

      (ti_on_agent_spawn, 0, 0, [],
       [ 
         (store_trigger_param_1, ":agent_no"),
         (call_script, "script_force_weapon", ":agent_no"), ###chief anadido para forzar jabalinas
		 (try_begin),#Tempered added to remove invalid party bug from horse spawns
			 (agent_is_human, ":agent_no"),#Tempered added to remove invalid party bug from horse spawns
			(call_script, "script_agent_reassign_team", ":agent_no"),

         (assign, ":initial_courage_score", 4000), #chief cambia a 3500, menos corage al principio
                  
         (agent_get_troop_id, ":troop_id", ":agent_no"),
         (store_character_level, ":troop_level", ":troop_id"),
         (val_mul, ":troop_level", 35), #chief aumenta a 35 moral por nivel de tropa
         (val_add, ":initial_courage_score", ":troop_level"), #average : 20 * 35 = 700
         
#anade corage a tropas al inicio de batalla chief
         (agent_get_troop_id, ":troop_id", ":agent_no"),
         (try_begin),
                (this_or_next|eq,":troop_id","trp_briton_bannerman"),
		(this_or_next|eq,":troop_id","trp_saxon_bannerman"),
                (this_or_next|eq,":troop_id","trp_picto_portaestandarte"),
		(this_or_next|eq,":troop_id","trp_engle_bannerman"),
		(this_or_next|eq,":troop_id","trp_irish_bannerman"),
                (eq,":troop_id","trp_jute_portaestandarte"),
         (val_add, ":initial_courage_score", 400), 
                (else_try), 
                (this_or_next|eq,":troop_id","trp_jute_cleric"),
		(this_or_next|eq,":troop_id","trp_briton_sacerdote"),
                (this_or_next|eq,":troop_id","trp_saxon_sacerdote"),
		(this_or_next|eq,":troop_id","trp_picto_sacerdote"),
		(this_or_next|eq,":troop_id","trp_pagan_priest"),
		(this_or_next|eq,":troop_id","trp_irish_priest"),
                (eq,":troop_id","trp_engle_rxpriest"),
         (val_add, ":initial_courage_score", 100), 
                (else_try), 
		(this_or_next|eq,":troop_id","trp_picto_cuerno"),
                (eq,":troop_id","trp_todos_cuerno"),
         (val_add, ":initial_courage_score", 300), 
                (try_end), 
#anade corage a tropas al inicio de batalla chief acaba       

			(store_random_in_range, ":randomized_addition_courage", 0, 3000), #average : 1500
			(val_add, ":initial_courage_score", ":randomized_addition_courage"), 
                   
			(agent_get_party_id, ":agent_party", ":agent_no"),         
         (party_get_morale, ":cur_morale", ":agent_party"),
         
			(store_sub, ":morale_effect_on_courage", ":cur_morale", 70),
			(val_mul, ":morale_effect_on_courage", 30), #this can effect morale with -2100..900
			(val_add, ":initial_courage_score", ":morale_effect_on_courage"), 
         
			#average = 5000 + 700 + 1500 = 7200; min : 5700, max : 8700
			#morale effect = min : -2100(party morale is 0), average : 0(party morale is 70), max : 900(party morale is 100)
			#min starting : 3600, max starting  : 9600, average starting : 7200
			(agent_set_slot, ":agent_no", "slot_agent_courage_score", ":initial_courage_score"),
		 (try_end),#Tempered added to remove invalid party bug from horse spawns		
         ]),		
		
#trigger to spawn unmounted horses in camp, in line formation (requires a spawn point 47 and 48 for start and end of line).
	(0,0,ti_once,[],[  
                    (mission_disable_talk),#remove when dialog has been made for camp scene, tc_camp
                    (call_script,"script_count_horses"),
                    (gt, reg0, 0),
                    (assign,":horse_count",reg0),
					(entry_point_get_position, pos1, 47),
					(entry_point_get_position, pos2, 48),
					(init_position,pos3),
					(position_copy_rotation,pos3,pos1),
					(position_get_x,":x_start",pos1),
					(position_get_x,":x_end",pos2),
					(position_get_y,":y_start",pos1),
					(position_get_y,":y_end",pos2),					
					(store_sub,":length_x",":x_end",":x_start"),
					(store_div,":adder_x",":length_x",":horse_count"),
					(store_sub,":length_y",":y_end",":y_start"), 
					(store_div,":adder_y",":length_y",":horse_count"),
					(assign,":new_x",":x_start"),
					(assign,":new_y",":y_start"),
					(try_for_range,":unused",0,":horse_count"),
						(val_add,":new_x",":adder_x"),
						(val_add,":new_y",":adder_y"),						
						(position_set_x,pos3,":new_x"),
						(position_set_y,pos3,":new_y"),
						(position_set_z_to_ground_level, pos3),
						(store_random_in_range,":random_no",0,300),
						(try_begin),
							(le,":random_no",100),
							(assign,":horse_type","itm_horsecourser2"),
						(else_try),
							(ge,":random_no",200),
							(assign,":horse_type","itm_pony_horse"),
						(else_try),
							(is_between,":random_no",100,200),
							(assign,":horse_type","itm_frankishhorse1"),
						(try_end),
						(set_spawn_position, pos3),
						(spawn_horse, ":horse_type"),
					(try_end),
				 ]
					
	),

	(0, 0, ti_once,
					[
					(set_show_messages, 0),
					(team_give_order, "$defender_team", grc_infantry, mordr_stand_ground),
					(team_give_order, "$defender_team", grc_archers, mordr_stand_ground),
					(team_give_order, "$defender_team", grc_cavalry, mordr_stand_ground),
					(team_give_order, "$defender_team_2", grc_infantry, mordr_charge),
					(team_give_order, "$defender_team_2", grc_archers, mordr_charge),
					(team_give_order, "$defender_team_2", grc_cavalry, mordr_charge),
					(set_show_messages, 1),
					], []
	),		 		 

      common_battle_init_banner, #sets heraldry on shields and armor
	  
############Habilidades de chel warcry y battlecry chief##########################
       #EGIII WARCRY

     (0, 0, 60, [(key_clicked, key_b),(neg|main_hero_fallen)
   
    ], [
                 
(play_sound,"snd_man_victory"),
             
      (get_player_agent_no, ":player_agent"),
      (agent_get_position, pos1, ":player_agent"),
     (store_character_level,":level","trp_player"),
    # (agent_set_animation, ":player_agent", "anim_cheer"),
      (val_mul,":level",2),
     (val_add,":level",1),

   (try_for_agents,":agent"),
      (set_fixed_point_multiplier, 1),
         (agent_is_alive,":agent"),
         (agent_is_human,":agent"),
       (neg|agent_is_ally,":agent"),
      
       (agent_get_troop_id,":trp_agent", ":agent"),
       (store_character_level,":troop_level",":trp_agent"),
       (ge,":level",":troop_level"),
       (agent_get_position, pos2, ":agent"),
       (get_distance_between_positions,":distance",pos2,pos1),
       (lt,":distance",500),
      
       (set_fixed_point_multiplier, 10),
      
       (position_get_x,":player_x",pos1),
       (position_get_y,":player_y",pos1),
       (position_get_x,":enemy_x",pos2),
       (position_get_y,":enemy_y",pos2),

       (store_sub,":difference_x",":enemy_x",":player_x"),
       (val_mul,":difference_x",12),

       (store_sub,":difference_y",":enemy_y",":player_y"),
       (val_mul,":difference_y",12),
      
       (val_add,":enemy_x",":difference_x"),
       (val_add,":enemy_y",":difference_y"),
      
       (position_set_x,pos2,":enemy_x"),
       (position_set_y,pos2,":enemy_y"),
      
       (agent_set_scripted_destination,":agent",pos2,1),
   (try_end),   

   (display_message,"@You unleash a fearsome cry!",0x6495ed),
        (set_fixed_point_multiplier, 1),
   (call_script, "script_focus_exp_penalty"),   
         ]),
   
   (0, 5, 60, [(key_clicked, key_b),(neg|main_hero_fallen)
   
    ], [
                 
   #(display_message,"@Enemies regain their courage!",0x6495ed),
   (try_for_agents,":agent"),
    (agent_is_alive,":agent"),
         (agent_is_human,":agent"),
       (neg|agent_is_ally,":agent"),
(agent_clear_scripted_mode,":agent"),
   (try_end),   

         ]),   
   (0, 7, 60, [(key_clicked, key_b),(neg|main_hero_fallen)
   
    ], [
                 
   (try_for_agents,":agent"),
    (agent_is_alive,":agent"),
         (agent_is_human,":agent"),
       (neg|agent_is_ally,":agent"),
(agent_clear_scripted_mode,":agent"),
   (try_end),   

         ]),   
# battlecry

     (0, 0, 60, [(key_clicked, key_u),(store_attribute_level,"$attribute","trp_player",3),(neg|main_hero_fallen),
    (play_sound,"snd_man_warcry"),
    ], [
(get_player_agent_no, ":player_agent"),
(try_begin),
      (agent_get_class ,":blah", ":player_agent"),
      (neq,":blah",grc_cavalry),
        (agent_set_animation, ":player_agent", "anim_cheer"),
       (try_end),
         ]),   
    (0, 2, 60, [(key_clicked, key_u),(store_attribute_level,"$attribute","trp_player",3),(neg|main_hero_fallen),
   
#    (get_player_agent_no, ":player_agent")
    ], [

   (store_skill_level,":leadership","skl_leadership","trp_player"),
     (get_player_agent_no, ":player_agent"),
   (store_sub,":cha_bonus","$attribute",0),
   (val_mul,":leadership",3),
   (try_for_agents,":agent"),
   

         (agent_is_alive,":agent"),
         (agent_is_human,":agent"),
       (agent_is_ally,":agent"),
       (neg|eq,":agent",":player_agent"),
       (store_agent_hit_points,":life",":agent",0),
       (try_begin),
      (agent_get_class ,":blah", ":agent"),
      (neq,":blah",grc_cavalry),
        (agent_set_animation, ":agent", "anim_cheer"),
       (try_end),
      
   (val_add,":life",":cha_bonus"),
   (val_add,":life",":leadership"),
   (agent_set_hit_points,":agent",":life",0),      
   #(agent_get_horse,":horse",":agent"),
   (agent_play_sound, ":agent", "snd_man_victory"),
        #(agent_set_animation, ":agent", "anim_cheer"),
       (try_end),
       (store_add,":recovery",":leadership",":cha_bonus"),
       (assign,reg1,":recovery"),
(display_message,"@You rally your men! (wounded troops recover {reg1} % hitpoints)",0x6495ed),      
   (call_script, "script_rage_exp_penalty"),   
         ]),
#terminado habilidades de chel


      (ti_on_agent_killed_or_wounded, 0, 0, [],
       [
        (store_trigger_param_1, ":dead_agent_no"),
        (store_trigger_param_2, ":killer_agent_no"),
        (store_trigger_param_3, ":is_wounded"),

        (try_begin),
          (ge, ":dead_agent_no", 0),
          (neg|agent_is_ally, ":dead_agent_no"),
          (agent_is_human, ":dead_agent_no"),
          (agent_get_troop_id, ":dead_agent_troop_id", ":dead_agent_no"),
          (str_store_troop_name, s6, ":dead_agent_troop_id"),
          (assign, reg0, ":dead_agent_no"),
          (assign, reg1, ":killer_agent_no"),
          (assign, reg2, ":is_wounded"),
          (agent_get_team, reg3, ":dead_agent_no"),          
          #(display_message, "@{!}dead agent no : {reg0} ; killer agent no : {reg1} ; is_wounded : {reg2} ; dead agent team : {reg3} ; {s6} is added"), 
          (party_add_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1), #addition_to_p_total_enemy_casualties
          (eq, ":is_wounded", 1),
          (party_wound_members, "p_total_enemy_casualties", ":dead_agent_troop_id", 1), 
        (try_end),

        (call_script, "script_apply_death_effect_on_courage_scores", ":dead_agent_no", ":killer_agent_no"),
       ]),

      common_battle_tab_press,

      (ti_question_answered, 0, 0, [],
       [(store_trigger_param_1,":answer"),
        (eq,":answer",0),
        (assign, "$pin_player_fallen", 0),
        (try_begin),
          (store_mission_timer_a, ":elapsed_time"),
          (gt, ":elapsed_time", 20),
          (str_store_string, s5, "str_retreat"),
          (call_script, "script_simulate_retreat", 10, 20, 1),
        (try_end),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission,0),]),

      (ti_before_mission_start, 0, 0, [],
       [
	   
         (team_set_relation, 0, 2, 1),
         (team_set_relation, 1, 3, 1),
         (call_script, "script_place_player_banner_near_inventory_bms"),

         (party_clear, "p_routed_enemies"),

         (assign, "$g_latest_order_1", 1), 
         (assign, "$g_latest_order_2", 1), 
         (assign, "$g_latest_order_3", 1), 
         (assign, "$g_latest_order_4", 1), 
         ]),

      
      (0, 0, ti_once, [], [(assign,"$g_battle_won",0),
                           (assign,"$defender_reinforcement_stage",0),
                           (assign,"$attacker_reinforcement_stage",0),
                           #(call_script, "script_place_player_banner_near_inventory"),
                           (call_script, "script_combat_music_set_situation_with_culture"),
                           (assign, "$g_defender_reinforcement_limit", 2),
                           ]),

      common_music_situation_update,
      common_battle_check_friendly_kills,

      (1, 0, 5, [
                              
      #new (25.11.09) starts (sdsd = TODO : make a similar code to also helping ally encounters)
      #count all total (not dead) enemy soldiers (in battle area + not currently placed in battle area)
      (call_script, "script_party_count_members_with_full_health", "p_collective_enemy"),
      (assign, ":total_enemy_soldiers", reg0),
      
      #decrease number of agents already in battle area to find all number of reinforcement enemies
      (assign, ":enemy_soldiers_in_battle_area", 0),
      (try_for_agents,":cur_agent"),
        (agent_is_human, ":cur_agent"),
        (agent_get_party_id, ":agent_party", ":cur_agent"),
        (try_begin),
          (neq, ":agent_party", "p_main_party"),
          (neg|agent_is_ally, ":cur_agent"),
          (val_add, ":enemy_soldiers_in_battle_area", 1),
        (try_end),
      (try_end),
      (store_sub, ":total_enemy_reinforcements", ":total_enemy_soldiers", ":enemy_soldiers_in_battle_area"),

      (try_begin),
        (lt, ":total_enemy_reinforcements", 15),
        (ge, "$defender_reinforcement_stage", 2),
        (eq, "$defender_reinforcement_limit_increased", 0),
        (val_add, "$g_defender_reinforcement_limit", 1),                    
        (assign, "$defender_reinforcement_limit_increased", 1),
      (try_end),    
      #new (25.11.09) ends
      
      (lt,"$defender_reinforcement_stage","$g_defender_reinforcement_limit"),
                 (store_mission_timer_a,":mission_time"),
                 (ge,":mission_time",10),
                 (store_normalized_team_count,":num_defenders", 0),
                 (lt,":num_defenders",10)],#gdw
           [(add_reinforcements_to_entry,1,7),(assign, "$defender_reinforcement_limit_increased", 0),(val_add,"$defender_reinforcement_stage",1)]),
      
      (1, 0, 5, [(lt,"$attacker_reinforcement_stage",2),
                 (store_mission_timer_a,":mission_time"),
                 (ge,":mission_time",10),
                 (store_normalized_team_count,":num_attackers", 1),
                 (lt,":num_attackers",10)],#gdw6
           [(add_reinforcements_to_entry,10,7),(val_add,"$attacker_reinforcement_stage",1)]),

      common_battle_check_victory_condition,
      common_battle_victory_display,

      (1, 4, ti_once, [(main_hero_fallen)],
          [
              (assign, "$pin_player_fallen", 1),
              (str_store_string, s5, "str_retreat"),
              (call_script, "script_simulate_retreat", 10, 20, 1),
              (assign, "$g_battle_result", -1),
              (set_mission_result,-1),
              (call_script, "script_count_mission_casualties_from_agents"),
              (finish_mission,0)]),

      common_battle_inventory,
	  common_camp_supply,
	  common_drowning,

      #AI Triggers
##      (0, 0, ti_once, [
##          (store_mission_timer_a,":mission_time"),(ge,":mission_time",2),
##          ],
##       [(call_script, "script_select_battle_tactic"),
##        (call_script, "script_battle_tactic_init"),
##        #(call_script, "script_battle_calculate_initial_powers"), #deciding run away method changed and that line is erased
##        ]),
      
      (3, 0, 0, [
          (call_script, "script_apply_effect_of_other_people_on_courage_scores"),
              ], []), #calculating and applying effect of people on others courage scores

      (3, 0, 0, [
          (try_for_agents, ":agent_no"),
            (agent_is_human, ":agent_no"),
            (agent_is_alive, ":agent_no"),          
            (store_mission_timer_a,":mission_time"),
            (ge,":mission_time",3),          
            (call_script, "script_decide_run_away_or_not", ":agent_no", ":mission_time"),
          (try_end),          
              ], []), #controlling courage score and if needed deciding to run away for each agent

##      (5, 0, 0, [
##          (store_mission_timer_a,":mission_time"),
##
##          (ge,":mission_time",3),
##          
##          (call_script, "script_battle_tactic_apply"),
##          ], []), #applying battle tactic

      common_battle_order_panel,
      common_battle_order_panel_tick,

	(60,0,0,[(party_get_slot,":entrenched","p_main_party","slot_party_entrenched"),
					(ge,":entrenched",1),
					(ge,"$camp_supply",1),
					], 
					[	(get_player_agent_no, ":player_agent"),
						(try_for_agents,":cur_agent"),
							(neq, ":cur_agent", ":player_agent"),
							(agent_is_alive, ":cur_agent"),
							(agent_is_human, ":cur_agent"),
							(agent_get_team, ":agent_team", ":cur_agent"),
							(eq, ":agent_team", "$defender_team"),
							(agent_refill_ammo, ":cur_agent"),
						(try_end),
					]),	  

    ]+ AI_triggers + heridas_chel + dplmc_battle_mode_triggers + formations_triggers + order_volley_triggers + rider_damage + warcry_chel+ flail_triggers,#+common_weapon_check + common_ai_order_toggle,##gdw added to get formation ability in camp scenese
  ),  

#Tempered visit entrenchment
  (
    "visit_entrenchment",0,-1,
    "Walk around camp.",
    [
     (11,mtef_scene_source,af_override_horse,0,1,[]), #player
     (15,mtef_visitor_source,af_override_horse,0,1,[]), #companion
	 (16,mtef_visitor_source,af_override_horse,0,1,[]), #companion
	 (17,mtef_visitor_source,af_override_horse,0,1,[]), #companion
	 (18,mtef_visitor_source,af_override_horse,0,1,[]), #companion
	 (19,mtef_visitor_source,af_override_horse,0,1,[]), #companion
	 (20,mtef_visitor_source,af_override_horse,0,1,[]), #companion
	 (21,mtef_visitor_source,af_override_horse,0,1,[]), #companion
	 (22,mtef_visitor_source,af_override_horse,0,1,[]), #companion
	 (23,mtef_visitor_source,af_override_horse,0,1,[]), #companion
	 (24,mtef_visitor_source,af_override_horse,0,1,[]), #companion
	 (25,mtef_visitor_source,af_override_horse,0,1,[]), #companion
	 (26,mtef_visitor_source,af_override_horse,0,1,[]), #companion
	 (27,mtef_visitor_source,af_override_horse,0,1,[]), #companion
	 (28,mtef_visitor_source,af_override_horse,0,1,[]), #companion
	 (29,mtef_visitor_source,af_override_horse,0,1,[]), #companion
	 (30,mtef_visitor_source,af_override_horse,0,1,[]), #companion
     (40,mtef_visitor_source,af_override_horse,0,1,[]),#soldier
     (41,mtef_visitor_source,af_override_horse,0,1,[]),#soldier
     (42,mtef_visitor_source,af_override_horse,0,1,[]),#soldier
     (43,mtef_visitor_source,af_override_horse,0,1,[]),#soldier
     (44,mtef_visitor_source,af_override_horse,0,1,[]),#soldier
     (45,mtef_visitor_source,af_override_horse,0,1,[]),#soldier
     (46,mtef_visitor_source,af_override_horse,0,1,[]),#soldier	 
    ],
    [    
      (ti_before_mission_start, 0, 0, [], 
      [  
         (call_script, "script_change_banners_and_chest"),
      ]),
	  
		common_battle_init_banner, #sets heraldry on shields and armor
      
#trigger to spawn unmounted horses in camp, in line formation (requires a spawn point 47 and 48 for start and end of line).
	(0,0,ti_once,[],[
					(mission_disable_talk),#remove when dialog has been made for camp scene, tc_camp
					(call_script,"script_count_horses"),
                                         (gt, reg0, 0),
					(assign,":horse_count",reg0),
					(entry_point_get_position, pos1, 47),
					(entry_point_get_position, pos2, 48),
					(init_position,pos3),
					(position_copy_rotation,pos3,pos1),
					(position_get_x,":x_start",pos1),
					(position_get_x,":x_end",pos2),
					(position_get_y,":y_start",pos1),
					(position_get_y,":y_end",pos2),					
					(store_sub,":length_x",":x_end",":x_start"),
					(store_div,":adder_x",":length_x",":horse_count"),
					(store_sub,":length_y",":y_end",":y_start"), 
					(store_div,":adder_y",":length_y",":horse_count"),
					(assign,":new_x",":x_start"),
					(assign,":new_y",":y_start"),
					(try_for_range,":unused",0,":horse_count"),
						(val_add,":new_x",":adder_x"),
						(val_add,":new_y",":adder_y"),						
						(position_set_x,pos3,":new_x"),
						(position_set_y,pos3,":new_y"),
						(position_set_z_to_ground_level, pos3),
						(store_random_in_range,":random_no",0,300),
						(try_begin),
							(le,":random_no",100),
							(assign,":horse_type","itm_horsecourser2"),
						(else_try),
							(ge,":random_no",200),
							(assign,":horse_type","itm_pony_horse"),
						(else_try),
							(is_between,":random_no",100,200),
							(assign,":horse_type","itm_frankishhorse1"),
						(try_end),
						(set_spawn_position, pos3),
						(spawn_horse, ":horse_type"),
					(try_end),
				 ]
					
	),
	
		(ti_tab_pressed, 0, 0, [],
			[	(finish_mission,0),
				# (jump_to_menu,"mnu_camp"),
			]),	
		common_drowning,
      
    ],
  ),

#TEMPERED     CHALLENGE TO DUEL
  #tempered chief campamentos acaba
   ( "wilderness_duel",mtf_arena_fight|mtf_commit_casualties,-1,
    "Prepare to battle for your honor.",
    [
      (0, mtef_visitor_source|mtef_team_0, af_override_horse, aif_start_alarmed, 1, []), #player start
      (1, mtef_visitor_source|mtef_team_2, af_override_horse, aif_start_alarmed, 1, []), #opponent start
	  (2, mtef_visitor_source|mtef_team_1, af_override_horse, 0, 1, []), #start enemy spectators
	  (3, mtef_visitor_source|mtef_team_1, af_override_horse, 0, 1, []),
	  (4, mtef_visitor_source|mtef_team_1, af_override_horse, 0, 1, []),
	  (5, mtef_visitor_source|mtef_team_1, af_override_horse, 0, 1, []),
	  (6, mtef_visitor_source|mtef_team_1, af_override_horse, 0, 1, []),
	  (7, mtef_visitor_source|mtef_team_1, af_override_horse, 0, 1, []),
	  (8, mtef_visitor_source|mtef_team_1, af_override_horse, 0, 1, []),
	  (9, mtef_visitor_source|mtef_team_1, af_override_horse, 0, 1, []),
	  (10, mtef_visitor_source|mtef_team_1, af_override_horse, 0, 1, []),
	  (11, mtef_visitor_source|mtef_team_1, af_override_horse, 0, 1, []),
	  (12, mtef_visitor_source|mtef_team_3, af_override_horse, 0, 1, []), #start friendly spectators
	  (13, mtef_visitor_source|mtef_team_3, af_override_horse, 0, 1, []),
	  (14, mtef_visitor_source|mtef_team_3, af_override_horse, 0, 1, []),
	  (15, mtef_visitor_source|mtef_team_3, af_override_horse, 0, 1, []),
	  (16, mtef_visitor_source|mtef_team_3, af_override_horse, 0, 1, []),
	  (17, mtef_visitor_source|mtef_team_3, af_override_horse, 0, 1, []),
	  (18, mtef_visitor_source|mtef_team_3, af_override_horse, 0, 1, []),
	  (19, mtef_visitor_source|mtef_team_3, af_override_horse, 0, 1, []),
	  (20, mtef_visitor_source|mtef_team_3, af_override_horse, 0, 1, []),
	  (21, mtef_visitor_source|mtef_team_3, af_override_horse, 0, 1, []),
    ],
    [
		common_inventory_not_available,
		common_duel_cheer_winner, 
		(ti_tab_pressed, 0, 0, [(display_message, "@Cannot leave now.")], []),
		(ti_before_mission_start, 0, 0, [], 	[	(call_script, "script_change_banners_and_chest"),
													(team_set_relation, 0, 2, -1), # -1 for enemy, 1 for friend, 0 for neutral
													(team_set_relation,1,3,0),
													(team_set_relation,0,1,0),
													(team_set_relation,0,3,0),
													(team_set_relation,2,1,0),
													(team_set_relation,2,3,0),
												]),

		(0, 0, ti_once, [],
			[
				(call_script, "script_music_set_situation_with_culture", mtf_sit_arena),
			]),

		(1, 8, ti_once, [	
							(this_or_next|main_hero_fallen),
							(num_active_teams_le,3),
						],
						[
							(try_begin),
								(main_hero_fallen),
								(jump_to_menu,"mnu_wilderness_duel_lose"),
							(else_try),
								(call_script, "script_play_victorious_sound"),
								(jump_to_menu,"mnu_wilderness_duel_win"),				
							(try_end),
							(finish_mission),
						]),

#phaiak camara lenta
  (ti_on_agent_killed_or_wounded, 0, 0, [],
   [
    (try_begin),
      (store_trigger_param_1, ":dead_agent_no"),
      (store_trigger_param_2, ":killer_agent_no"),
          (agent_is_human, ":dead_agent_no"),
      (get_player_agent_no, ":player_agent"),
      (this_or_next|eq, ":player_agent", ":killer_agent_no"),
      (eq, ":player_agent", ":dead_agent_no"),
      # (store_random_in_range, ":chance", 1, 5),
      # (eq, ":chance", 1),

      # (store_random_in_range, ":speed", 16, 18), #chief cambia speed of 10 a 18 y de 4 a 16 MOTO do below
      # (mission_set_time_speed, ":speed"), #this works only when cheat mode is enabled

      (agent_get_position, pos20, ":dead_agent_no"),
      (agent_get_position, pos9, ":killer_agent_no"),
      (position_copy_rotation, pos20, pos9),
      (position_move_z, pos20, 150),
      (store_random_in_range, "$ani_x_angle", -35, 35),
      (store_random_in_range, "$ani_distance", -230, -70),
      (store_random_in_range, ":direktion", -1, 1),
      (try_begin),
        (eq, ":direktion", 0),
        (assign, "$ani_z_angle", 5),
        (position_rotate_z, pos20, 35),
      (else_try),
        (assign, "$ani_z_angle", -5),
        (position_rotate_z, pos20, -35),
      (try_end),
      (mission_cam_set_mode, 1, 10, 0),
      (assign, "$ani_step", 30),
    (try_end),
   ]),


   (0, 0, 0, [(gt, "$ani_step", 0)],

   [
      (store_mission_timer_a_msec, ":time"),
      (ge, ":time", "$kill_cam_end"),
      (try_begin),
        (ge, "$ani_step", 2),

        (store_div, ":interval", 7000, 30),    #desired animation length in milliseconds, divided by animation steps (see above)
        (try_begin),
          (ge, "$cheat_mode", 1),    #can use slo-mo effect
          (store_sub, ":reduction_factor", 32, "$ani_step"),
          (val_div, ":interval", ":reduction_factor"),
          (store_div, ":speed", 1000, ":reduction_factor"),    #reduce mission speed by same ratio to keep animation within the desired time window
          (mission_set_time_speed, ":speed"),
        (try_end),

        (position_rotate_z, pos20, "$ani_z_angle"),
        (copy_position, pos21, pos20),

        (val_sub, "$ani_x_angle", 1),    #MOTO turn camera down
        (position_rotate_x, pos21, "$ani_x_angle"),
        (val_sub, "$ani_distance", 10),    #MOTO back away
        (position_move_y, pos21, "$ani_distance"),
        (mission_cam_animate_to_position,  pos21, ":interval", 0),    #MOTO change to :interval from 5
        # (store_mission_timer_a_msec, "$kill_cam_end"),# for next step
        # (val_add, "$kill_cam_end", 5),
        (store_add, "$kill_cam_end", ":time", ":interval"),

        (val_add, "$ani_step", -1),
      (else_try),
        (eq, "$ani_step", 1),
        (mission_cam_set_mode, 0, 5, 0),

        (mission_set_time_speed, 1000),    #MOTO change from 90 -- 1000 is normal speed

        (assign, "$kill_cam_end", 0),
        (assign, "$ani_step", 0),
      (try_end),

   ]),

    ]+ dplmc_battle_mode_triggers3,
  ),
  
#tempered chief acaba
     #SoD chief RANDOM EVENTS START################################################################################################# 

  (
    "sod_arena_challenge_fight",mtf_arena_fight|mtf_commit_casualties,-1,
    "You enter a melee fight in the arena.",
    [
      (56, mtef_visitor_source|mtef_team_0, 0, aif_start_alarmed, 1, []),
      (58, mtef_visitor_source|mtef_team_2, 0, aif_start_alarmed, 1, []),
    ],
    [
      common_inventory_not_available,
      (ti_tab_pressed, 0, 0, [(display_message, "@Cannot leave now.")], []),
      (ti_before_mission_start, 0, 0, [], [(call_script, "script_change_banners_and_chest")]),

      (0, 0, ti_once, [],
       [
         (call_script, "script_music_set_situation_with_culture", mtf_sit_arena),
         ]),

      (1, 4, ti_once, [(this_or_next|main_hero_fallen),(num_active_teams_le,1)],
       [
           (try_begin),
             (main_hero_fallen),
             (call_script, "script_change_troop_renown", "trp_player", -10),
			 (call_script, "script_change_player_honor", 2),
           (else_try),
             (call_script, "script_change_troop_renown", "trp_player", 5),
			(call_script, "script_change_player_honor", 5),
           (try_end),
           (finish_mission),
		   (change_screen_return),
           ]),
    ],
  ),
#SoD RANDOM EVENTS END################################################################################################# 
#-## Outposts begin
#-## Outposts begin
  (
    "fort_visit",0,-1,
    "Fort visit",
    [
     #Player/companions
     (0,mtef_scene_source|mtef_team_0,0,0,1,pilgrim_disguise),
     (1,mtef_scene_source|mtef_team_0,0,0,1,[]),
     (2,mtef_scene_source|mtef_team_0,af_override_horse,0,1,pilgrim_disguise),
     (3,mtef_scene_source|mtef_team_0,af_override_horse,0,1,pilgrim_disguise),
     (4,mtef_scene_source|mtef_team_0,af_override_horse,0,1,pilgrim_disguise),
     (5,mtef_scene_source|mtef_team_0,af_override_horse,0,1,pilgrim_disguise),
     (6,mtef_scene_source|mtef_team_0,af_override_horse,0,1,pilgrim_disguise),
     (7,mtef_scene_source|mtef_team_0,af_override_horse,0,1,pilgrim_disguise),
     
     #Merchants & Guard Captain
     (8,mtef_visitor_source,af_override_horse,0,1,[]),(9,mtef_visitor_source,af_override_horse,0,1,[]),(10,mtef_visitor_source,af_override_horse,0,1,[]),(11,mtef_visitor_source,af_override_horse,0,1,[]),(12,mtef_visitor_source,af_override_horse,0,1,[]),
     
     #Horses at horse merchant slot
     (13,mtef_visitor_source,0,0,1,[]),
     
     (14,mtef_scene_source,0,0,1,[]),
     
     #These are used for the passages to the tower area
     (15,mtef_visitor_source,af_override_horse,0,1,[]),(16,mtef_visitor_source,af_override_horse,0,1,[]),(17,mtef_visitor_source,af_override_horse,0,1,[]),(18,mtef_visitor_source,af_override_horse,0,1,[]),
     
     (19,mtef_visitor_source,af_override_horse,0,1,[]),
     
     #Perimeter patrol entry and waypoints (corners of the map)
     (20,mtef_visitor_source|mtef_team_0,0,0,1,[]),(21,mtef_visitor_source,0,0,1,[]),(22,mtef_visitor_source,0,0,1,[]),(23,mtef_visitor_source,0,0,1,[]),
     
     #Stationary guards
     (24,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(25,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(26,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(27,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(28,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(29,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     
     #Patrol on the central walkway
     (30,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(31,mtef_visitor_source,af_override_horse,0,1,[]),
     
     #Walkers
     (32,mtef_visitor_source,af_override_horse,0,1,[]),(33,mtef_visitor_source,af_override_horse,0,1,[]),(34,mtef_visitor_source,af_override_horse,0,1,[]),(35,mtef_visitor_source,af_override_horse,0,1,[]),(36,mtef_visitor_source,af_override_horse,0,1,[]),(37,mtef_visitor_source,af_override_horse,0,1,[]),(38,mtef_visitor_source,af_override_horse,0,1,[]),(39,mtef_visitor_source,af_override_horse,0,1,[]),
     
     # Guards & patrols on the front walkways use these slots
     (40,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),(41,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),(42,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),(43|mtef_team_0,mtef_visitor_source,af_override_horse,aif_start_alarmed,1,[]),
     (44,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),(45,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),(46,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),(47|mtef_team_0,mtef_visitor_source,af_override_horse,aif_start_alarmed,1,[]),
     (48,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),(49,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
     
     # Future slots here for enemy starting positions and maybe another cosmetic thing or two, I believe we're allowed up to 60 slots
     ],
    [
      (ti_before_mission_start, 0, 0, [], 
        [
          (call_script, "script_change_banners_and_chest"),
          (call_script, "script_remove_siege_objects"),
          #(scene_prop_disable,"spr_portcullis"),
          #(scene_prop_disable,"spr_ramp_12m"),
        ]),
      (ti_on_agent_spawn, 0, 0, [],
        [
         (store_trigger_param_1, ":agent_no"),
         (call_script, "script_init_town_agent", ":agent_no"),
        ]),
        
      (1, 0, ti_once, [],
        [
           (try_begin),
             (eq, "$g_mt_mode", tcm_default),
             (store_current_scene, ":cur_scene"),
             (scene_set_slot, ":cur_scene", "slot_scene_visited", 1),
           (try_end),
           (call_script, "script_init_town_walker_agents"),
           (call_script, "script_init_fort_patrols"),
           #(get_player_agent_no, ":player_agent"),
           #(team_set_leader, 0, ":player_agent"),
           (entry_point_get_position, pos1, 14),
           (scene_prop_get_num_instances, ":num_props", "spr_inventory"),
           (try_for_range, ":instance_no", 0, ":num_props"),	# move the inventory to the central tower
             (scene_prop_get_instance, ":inventory_id", "spr_inventory", ":instance_no"),
             (prop_instance_set_position, ":inventory_id", pos1),
           (try_end),
           (try_begin),
             (eq, "$sneaked_into_town", 1),
             (call_script, "script_music_set_situation_with_culture", mtf_sit_town_infiltrate),
           (else_try),
             (call_script, "script_music_set_situation_with_culture", mtf_sit_travel),
           (try_end),
        ]),
      (ti_inventory_key_pressed, 0, 0,
        [
           (try_begin),
             (eq, "$g_mt_mode", tcm_default),
             (set_trigger_result,1),
           (else_try),
             (eq, "$g_mt_mode", tcm_disguised),
             (display_message,"str_cant_use_inventory_disguised"),
           (else_try),
             (display_message, "str_cant_use_inventory_now"),
           (try_end),
        ], []),
        (ti_tab_pressed, 0, 0,
         [
           (try_begin),
             (this_or_next|eq, "$g_mt_mode", tcm_default),
             (eq, "$g_mt_mode", tcm_disguised),
             (set_trigger_result,1),
           (else_try),
             (display_message, "@Cannot leave now."),
           (try_end),
           ], []),
        (ti_on_leave_area, 0, 0,
         [
            (try_begin),
              (eq, "$g_defending_against_siege", 0),
              (assign,"$g_leave_town",1),
            (try_end),
            ], []),

        (0, 0, ti_once, [], 
          [
            (party_slot_eq, "$current_town", "slot_party_type", spt_town),
            (call_script, "script_town_init_doors", 0),
            (try_begin),
              (eq, "$town_nighttime", 0),
              (play_sound, "snd_town_ambiance", sf_looping),
            (try_end),
          ]),
		  
		# Lumos: You can modify the patrol base troops here.
        (3, 0, 0, [
                    (call_script, "script_tick_town_walkers"),
                    (try_for_agents, ":cur_agent"),
                      (agent_get_troop_id, ":cur_troop", ":cur_agent"),
                      (try_begin),
                        (eq, ":cur_troop", "trp_fort_walker"),
                        (call_script, "script_cf_tick_fort_patrol", ":cur_agent", 1),
                      (else_try),
                        (agent_get_entry_no, ":entry_no", ":cur_agent"),
                        (this_or_next|eq, ":cur_troop", "trp_fort_rider"), #mounted patrol refuses to stay mounted and move
                        (eq, ":entry_no", 20), # crude hack atm to get this stupid cavalry to patrol properly
                        (agent_is_human, ":cur_agent"),
                        (call_script, "script_cf_tick_fort_patrol", ":cur_agent", 3),
                      (try_end),
                    (try_end),
                  ], []),
        (2, 0, 0, [(call_script, "script_center_ambiance_sounds")], []),
        
      
    ],
  ),
#-## Outposts end
#port visit
  (
    "port_visit",0,-1,
    "Port visit",
    [
     #Player/companions
     (0,mtef_scene_source|mtef_team_0,0,0,1,pilgrim_disguise),
     (1,mtef_scene_source|mtef_team_0,0,0,1,[]),
     (2,mtef_scene_source|mtef_team_0,af_override_horse,0,1,pilgrim_disguise),
     (3,mtef_scene_source|mtef_team_0,af_override_horse,0,1,pilgrim_disguise),
     (4,mtef_scene_source|mtef_team_0,af_override_horse,0,1,pilgrim_disguise),
     (5,mtef_scene_source|mtef_team_0,af_override_horse,0,1,pilgrim_disguise),
     (6,mtef_scene_source|mtef_team_0,af_override_horse,0,1,pilgrim_disguise),
     (7,mtef_scene_source|mtef_team_0,af_override_horse,0,1,pilgrim_disguise),
     
     #Merchants & Guard Captain
     (8,mtef_visitor_source,af_override_horse,0,1,[]),(9,mtef_visitor_source,af_override_horse,0,1,[]),(10,mtef_visitor_source,af_override_horse,0,1,[]),(11,mtef_visitor_source,af_override_horse,0,1,[]),(12,mtef_visitor_source,af_override_horse,0,1,[]),
     
     #Horses at horse merchant slot
     (13,mtef_visitor_source,af_override_horse,0,1,[]),
     
     (14,mtef_visitor_source,af_override_horse,0,1,[]),
     
     #These are used for the passages to the tower area
     (15,mtef_visitor_source,af_override_horse,0,1,[]),(16,mtef_visitor_source,af_override_horse,0,1,[]),(17,mtef_visitor_source,af_override_horse,0,1,[]),(18,mtef_visitor_source,af_override_horse,0,1,[]),
     
     (19,mtef_visitor_source,af_override_horse,0,1,[]),
     
     #Perimeter patrol entry and waypoints (corners of the map)
     (20,mtef_visitor_source|mtef_team_0,0,0,1,[]),(21,mtef_visitor_source,0,0,1,[]),(22,mtef_visitor_source,0,0,1,[]),(23,mtef_visitor_source,0,0,1,[]),
     
     #Stationary guards
     (24,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(25,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(26,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(27,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(28,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(29,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),
     
     #Patrol on the central walkway
     (30,mtef_visitor_source|mtef_team_0,af_override_horse,0,1,[]),(31,mtef_visitor_source,af_override_horse,0,1,[]),
     
     #Walkers
     (32,mtef_visitor_source,af_override_horse,0,1,[]),(33,mtef_visitor_source,af_override_horse,0,1,[]),(34,mtef_visitor_source,af_override_horse,0,1,[]),(35,mtef_visitor_source,af_override_horse,0,1,[]),(36,mtef_visitor_source,af_override_horse,0,1,[]),(37,mtef_visitor_source,af_override_horse,0,1,[]),(38,mtef_visitor_source,af_override_horse,0,1,[]),(39,mtef_visitor_source,af_override_horse,0,1,[]),
     
     # Guards & patrols on the front walkways use these slots
     (40,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),(41,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),(42,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),(43|mtef_team_0,mtef_visitor_source,af_override_horse,aif_start_alarmed,1,[]),
     (44,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),(45,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),(46,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),(47|mtef_team_0,mtef_visitor_source,af_override_horse,aif_start_alarmed,1,[]),
     (48,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),(49,mtef_visitor_source|mtef_team_0,af_override_horse,aif_start_alarmed,1,[]),
     
     # Future slots here for enemy starting positions and maybe another cosmetic thing or two, I believe we're allowed up to 60 slots
     ],
    [
      (ti_before_mission_start, 0, 0, [], 
        [
          (call_script, "script_change_banners_and_chest"),
          (call_script, "script_remove_siege_objects"),
          #(scene_prop_disable,"spr_portcullis"),
          #(scene_prop_disable,"spr_ramp_12m"),
        ]),
      (ti_on_agent_spawn, 0, 0, [],
        [
         (store_trigger_param_1, ":agent_no"),
         (call_script, "script_init_town_agent", ":agent_no"),
        ]),
        
      (1, 0, ti_once, [],
        [
           (try_begin),
             (eq, "$g_mt_mode", tcm_default),
             (store_current_scene, ":cur_scene"),
             (scene_set_slot, ":cur_scene", "slot_scene_visited", 1),
           (try_end),
           (call_script, "script_init_town_walker_agents"),
#           (call_script, "script_init_fort_patrols"),
           #(get_player_agent_no, ":player_agent"),
           #(team_set_leader, 0, ":player_agent"),
##           (entry_point_get_position, pos1, 14),
##           (scene_prop_get_num_instances, ":num_props", "spr_inventory"),
##           (try_for_range, ":instance_no", 0, ":num_props"),	# move the inventory to the central tower
##             (scene_prop_get_instance, ":inventory_id", "spr_inventory", ":instance_no"),
##             (prop_instance_set_position, ":inventory_id", pos1),
##           (try_end),
           (try_begin),
             (eq, "$sneaked_into_town", 1),
             (call_script, "script_music_set_situation_with_culture", mtf_sit_town_infiltrate),
           (else_try),
             (call_script, "script_music_set_situation_with_culture", mtf_sit_travel),
           (try_end),
        ]),
      (ti_inventory_key_pressed, 0, 0,
        [
           (try_begin),
             (eq, "$g_mt_mode", tcm_default),
             (set_trigger_result,1),
           (else_try),
             (eq, "$g_mt_mode", tcm_disguised),
             (display_message,"str_cant_use_inventory_disguised"),
           (else_try),
             (display_message, "str_cant_use_inventory_now"),
           (try_end),
        ], []),
        (ti_tab_pressed, 0, 0,
         [
           (try_begin),
             (this_or_next|eq, "$g_mt_mode", tcm_default),
             (eq, "$g_mt_mode", tcm_disguised),
             (set_trigger_result,1),
           (else_try),
             (display_message, "@Cannot leave now."),
           (try_end),
           ], []),
        (ti_on_leave_area, 0, 0,
         [
            (try_begin),
              (eq, "$g_defending_against_siege", 0),
              (assign,"$g_leave_town",1),
            (try_end),
            ], []),

        (0, 0, ti_once, [], 
          [
            (party_slot_eq, "$current_town", "slot_party_type", spt_town),
            (call_script, "script_town_init_doors", 0),
            (try_begin),
              (eq, "$town_nighttime", 0),
              (play_sound, "snd_town_ambiance", sf_looping),
            (try_end),
          ]),
		  
		# Lumos: You can modify the patrol base troops here.
        (3, 0, 0, [
                    (call_script, "script_tick_town_walkers"),
                    (try_for_agents, ":cur_agent"),
                      (agent_get_troop_id, ":cur_troop", ":cur_agent"),
                      (try_begin),
                        (eq, ":cur_troop", "trp_fort_walker"),
                        (call_script, "script_cf_tick_fort_patrol", ":cur_agent", 1),
                      (else_try),
                        (agent_get_entry_no, ":entry_no", ":cur_agent"),
                        (this_or_next|eq, ":cur_troop", "trp_fort_rider"), #mounted patrol refuses to stay mounted and move
                        (eq, ":entry_no", 20), # crude hack atm to get this stupid cavalry to patrol properly
                        (agent_is_human, ":cur_agent"),
                        (call_script, "script_cf_tick_fort_patrol", ":cur_agent", 3),
                      (try_end),
                    (try_end),
                  ], []),
        (2, 0, 0, [(call_script, "script_center_ambiance_sounds")], []),
        
      
    ],
  ),
#port acaba chief


  #arena player lair chief
  ## Created a new template for sparring, just for simplicity - Jinnai
  ("arena_spar_fight2",mtf_arena_fight,-1,
    "You enter a sparring match in the arena.",
    [
      (0,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (1,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (2,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (3,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (4,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (5,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (6,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),
      (7,mtef_visitor_source|mtef_team_0,0,aif_start_alarmed,1,[]),

      (8,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
      (9,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
      (10,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
      (11,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
      (12,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
      (13,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
      (14,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),
      (15,mtef_visitor_source|mtef_team_1,0,aif_start_alarmed,1,[]),

      (16,mtef_visitor_source|mtef_team_2,0,aif_start_alarmed,1,[]),
      (17,mtef_visitor_source|mtef_team_2,0,aif_start_alarmed,1,[]),
      (18,mtef_visitor_source|mtef_team_2,0,aif_start_alarmed,1,[]),
      (19,mtef_visitor_source|mtef_team_2,0,aif_start_alarmed,1,[]),
      (20,mtef_visitor_source|mtef_team_2,0,aif_start_alarmed,1,[]),
      (21,mtef_visitor_source|mtef_team_2,0,aif_start_alarmed,1,[]),
      (22,mtef_visitor_source|mtef_team_2,0,aif_start_alarmed,1,[]),
      (23,mtef_visitor_source|mtef_team_2,0,aif_start_alarmed,1,[]),

      (24,mtef_visitor_source|mtef_team_3,0,aif_start_alarmed,1,[]),
      (25,mtef_visitor_source|mtef_team_3,0,aif_start_alarmed,1,[]),
      (26,mtef_visitor_source|mtef_team_3,0,aif_start_alarmed,1,[]),
      (27,mtef_visitor_source|mtef_team_3,0,aif_start_alarmed,1,[]),
      (28,mtef_visitor_source|mtef_team_3,0,aif_start_alarmed,1,[]),
      (29,mtef_visitor_source|mtef_team_3,0,aif_start_alarmed,1,[]),
      (30,mtef_visitor_source|mtef_team_3,0,aif_start_alarmed,1,[]),
      (31,mtef_visitor_source|mtef_team_3,0,aif_start_alarmed,1,[]),

      (50, mtef_scene_source,af_override_horse|af_override_weapons|af_override_head,0,1,[]),
      (52, mtef_scene_source,af_override_horse,0,1,[]),
      (53, mtef_scene_source,af_override_horse,0,1,[]),
      (54, mtef_scene_source,af_override_horse,0,1,[]),
      (55, mtef_scene_source,af_override_horse,0,1,[]),
    ],
    [
    (ti_before_mission_start, 0, 0, [], [(call_script, "script_change_banners_and_chest")]),
    (ti_inventory_key_pressed, 0, 0, [(display_message,"str_cant_use_inventory_arena")], []),
		(ti_tab_pressed, 0, 0, [],
			[	(finish_mission,0),
				# (jump_to_menu,"mnu_camp"),
			]),	

    (0, 0, ti_once, [],
      [(play_sound, "snd_arena_ambiance", sf_looping),
     (call_script, "script_music_set_situation_with_culture", mtf_sit_arena),
      ]),

    (0.1, 0, 0, [],
      [
        (try_for_agents,":agent"),
          (agent_is_alive,":agent"),
          (agent_is_human,":agent"),
          (agent_get_position,pos1,":agent"),
          (position_set_z_to_ground_level, pos1),
          (agent_get_horse,":horse",":agent"),
          (try_begin),
            (gt,":horse",0),
            (position_move_z,pos1,300),
          (else_try),
            (position_move_z,pos1,225),
          (try_end),
          (agent_get_team, ":team", ":agent"),
          (try_begin),
            (eq,":team",0),
            (particle_system_burst,"psys_team_0",pos1,30),
          (else_try),
            (eq,":team",1),
            (particle_system_burst,"psys_team_1",pos1,30),
          (else_try),
            (eq,":team",2),
            (particle_system_burst,"psys_team_2",pos1,30),
          (else_try),
            (eq,":team",3),
            (particle_system_burst,"psys_team_3",pos1,30),
          (try_end),
        (try_end),
      ]),

    (1, 4, ti_once, [(num_active_teams_le, 1)],
      [
       (try_begin),
         (neg|main_hero_fallen),
         (call_script, "script_play_victorious_sound"),
       (try_end),
	(finish_mission,0),      ]),
    ],
  ),

  #arena player lair acaba chief

  ##########################grueso chief final acaba##########################
  
] \
+ game_start.mission_templates \
+ multiplayer.mission_templates \
